(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{416:function(t,s,a){t.exports=a.p+"assets/img/ethercat_tool.42460f0c.png"},417:function(t,s,a){t.exports=a.p+"assets/img/application_layer_protocols.d97db174.png"},418:function(t,s,a){t.exports=a.p+"assets/img/ethercat_communication_modules.f5bbb220.png"},419:function(t,s,a){t.exports=a.p+"assets/img/EthercatOperatingPrinciple.669e820e.svg"},420:function(t,s,a){t.exports=a.p+"assets/img/Architecture.d77088f0.png"},421:function(t,s,a){t.exports=a.p+"assets/img/ethercat_frame_datagram.8606699c.png"},422:function(t,s,a){t.exports=a.p+"assets/img/ethercat_state_machine_ESM.2720e449.png"},423:function(t,s,a){t.exports=a.p+"assets/img/ESM_transitions.e0d52235.png"},424:function(t,s,a){t.exports=a.p+"assets/img/address.7916d7a8.png"},425:function(t,s,a){t.exports=a.p+"assets/img/address_fmmu.27b9c0f6.png"},426:function(t,s,a){t.exports=a.p+"assets/img/pdo1.f60ff31b.png"},427:function(t,s,a){t.exports=a.p+"assets/img/pdo2.00706bcf.png"},428:function(t,s,a){t.exports=a.p+"assets/img/multiread.2fd10fcc.png"},496:function(t,s,a){"use strict";a.r(s);var e=a(12),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#igh-ethercat-开源主站安装及测试"}},[t._v("IGH EtherCAT 开源主站安装及测试")])]),e("li",[e("a",{attrs:{href:"#基于-ethercat-的应用"}},[t._v("基于 EtherCAT 的应用")])]),e("li",[e("a",{attrs:{href:"#常见-esc-设备"}},[t._v("常见 ESC 设备")])]),e("li",[e("a",{attrs:{href:"#ethercat-主从环形架构"}},[t._v("EtherCAT 主从环形架构")])]),e("li",[e("a",{attrs:{href:"#帧结构"}},[t._v("帧结构")])]),e("li",[e("a",{attrs:{href:"#状态机"}},[t._v("状态机")])]),e("li",[e("a",{attrs:{href:"#ethercat-取址"}},[t._v("EtherCAT 取址")])]),e("li",[e("a",{attrs:{href:"#soes-库工作内容"}},[t._v("SOES 库工作内容")])]),e("li",[e("a",{attrs:{href:"#soes-库设计"}},[t._v("SOES 库设计")]),e("ul",[e("li",[e("a",{attrs:{href:"#ecat-slv-c-实现-slave-api"}},[t._v("ecat_slv.c 实现 slave API")])]),e("li",[e("a",{attrs:{href:"#特别需要注意"}},[t._v("特别需要注意")])]),e("li",[e("a",{attrs:{href:"#eep-c"}},[t._v("eep.c")])]),e("li",[e("a",{attrs:{href:"#esc-coe-c"}},[t._v("esc_coe.c")])]),e("li",[e("a",{attrs:{href:"#esc-eoe-c"}},[t._v("esc_eoe.c")])]),e("li",[e("a",{attrs:{href:"#esc-foe-c"}},[t._v("esc_foe.c")])]),e("li",[e("a",{attrs:{href:"#eep-c"}},[t._v("eep.c")])]),e("li",[e("a",{attrs:{href:"#esc-c"}},[t._v("esc.c")])]),e("li",[e("a",{attrs:{href:"#options-h"}},[t._v("options.h")])])])]),e("li",[e("a",{attrs:{href:"#soes-样例"}},[t._v("SOES 样例")])]),e("li",[e("a",{attrs:{href:"#soes-中的一些数据规定"}},[t._v("SOES 中的一些数据规定")]),e("ul",[e("li",[e("a",{attrs:{href:"#sii-pdo-和-esi-pdo"}},[t._v("SII-PDO 和 ESI-PDO")])])])]),e("li",[e("a",{attrs:{href:"#od"}},[t._v("OD")]),e("ul",[e("li",[e("a",{attrs:{href:"#sm-事件类型"}},[t._v("SM 事件类型")])])])]),e("li",[e("a",{attrs:{href:"#实现"}},[t._v("实现")])])])]),e("p"),t._v(" "),e("h1",{attrs:{id:"工业物联网通讯笔记"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#工业物联网通讯笔记"}},[t._v("#")]),t._v(" 工业物联网通讯笔记")]),t._v(" "),e("h1",{attrs:{id:"ethercat"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ethercat"}},[t._v("#")]),t._v(" EtherCAT")]),t._v(" "),e("p",[e("a",{attrs:{href:"D:/aiit/ethercat/ethercat_esc_datasheet_sec1_technology_2i3.pdf"}},[t._v("专有缩写")])]),t._v(" "),e("p",[t._v("思路：使用已有的网络连接透明传输构造EtherCAT帧的报文段。")]),t._v(" "),e("h2",{attrs:{id:"igh-ethercat-开源主站安装及测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#igh-ethercat-开源主站安装及测试"}},[t._v("#")]),t._v(" IGH EtherCAT 开源主站安装及测试")]),t._v(" "),e("p",[t._v("参考 "),e("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/150957429",target:"_blank",rel:"noopener noreferrer"}},[t._v("知乎专栏"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("安装好后可以看到一系列参数\n"),e("img",{attrs:{src:a(416),alt:"img"}})]),t._v(" "),e("p",[t._v("如果开机没自动起来需要手动"),e("code",[t._v("/etc/init.d/ethercat start")]),t._v("。")]),t._v(" "),e("h2",{attrs:{id:"基于-ethercat-的应用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基于-ethercat-的应用"}},[t._v("#")]),t._v(" 基于 EtherCAT 的应用")]),t._v(" "),e("p",[e("img",{attrs:{src:a(417),alt:"img"}})]),t._v(" "),e("h2",{attrs:{id:"常见-esc-设备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常见-esc-设备"}},[t._v("#")]),t._v(" 常见 ESC 设备")]),t._v(" "),e("p",[e("img",{attrs:{src:a(418),alt:"img"}})]),t._v(" "),e("h2",{attrs:{id:"ethercat-主从环形架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ethercat-主从环形架构"}},[t._v("#")]),t._v(" EtherCAT 主从环形架构")]),t._v(" "),e("p",[e("img",{attrs:{src:a(419),alt:""}})]),t._v(" "),e("p",[e("img",{attrs:{src:a(420),alt:""}})]),t._v(" "),e("h2",{attrs:{id:"帧结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#帧结构"}},[t._v("#")]),t._v(" 帧结构")]),t._v(" "),e("p",[e("img",{attrs:{src:a(421),alt:""}})]),t._v(" "),e("h2",{attrs:{id:"状态机"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#状态机"}},[t._v("#")]),t._v(" 状态机")]),t._v(" "),e("p",[e("img",{attrs:{src:a(422),alt:""}})]),t._v(" "),e("p",[t._v("下方介绍的 SOES 库在 "),e("code",[t._v("esc.h")]),t._v(" 中定义了状态和状态的转移：")]),t._v(" "),e("div",{staticClass:"language-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("ESCinit")]),t._v("                  "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x01")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("ESCpreop")]),t._v("                 "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x02")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("ESCboot")]),t._v("                  "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x03")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("ESCsafeop")]),t._v("                "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x04")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("ESCop")]),t._v("                    "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x08")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("ESCerror")]),t._v("                 "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x10")])])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("INIT_TO_INIT")]),t._v("             "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x11")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("INIT_TO_PREOP")]),t._v("            "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x21")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("INIT_TO_BOOT")]),t._v("             "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x31")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("INIT_TO_SAFEOP")]),t._v("           "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x41")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("INIT_TO_OP")]),t._v("               "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x81")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("PREOP_TO_INIT")]),t._v("            "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x12")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("PREOP_TO_PREOP")]),t._v("           "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x22")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("PREOP_TO_BOOT")]),t._v("            "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x32")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("PREOP_TO_SAFEOP")]),t._v("          "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x42")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("PREOP_TO_OP")]),t._v("              "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x82")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("BOOT_TO_INIT")]),t._v("             "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x13")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("BOOT_TO_PREOP")]),t._v("            "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x23")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("BOOT_TO_BOOT")]),t._v("             "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x33")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("BOOT_TO_SAFEOP")]),t._v("           "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x43")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("BOOT_TO_OP")]),t._v("               "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x83")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("SAFEOP_TO_INIT")]),t._v("           "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x14")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("SAFEOP_TO_PREOP")]),t._v("          "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x24")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("SAFEOP_TO_BOOT")]),t._v("           "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x34")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("SAFEOP_TO_SAFEOP")]),t._v("         "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x44")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("SAFEOP_TO_OP")]),t._v("             "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x84")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("OP_TO_INIT")]),t._v("               "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x18")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("OP_TO_PREOP")]),t._v("              "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x28")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("OP_TO_BOOT")]),t._v("               "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x38")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("OP_TO_SAFEOP")]),t._v("             "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x48")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("OP_TO_OP")]),t._v("                 "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x88")])])]),t._v("\n")])])]),e("p",[e("img",{attrs:{src:a(423),alt:""}})]),t._v(" "),e("h2",{attrs:{id:"ethercat-取址"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ethercat-取址"}},[t._v("#")]),t._v(" EtherCAT 取址")]),t._v(" "),e("p",[e("img",{attrs:{src:a(424),alt:""}}),t._v(" "),e("img",{attrs:{src:a(425),alt:""}})]),t._v(" "),e("h1",{attrs:{id:"soes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#soes"}},[t._v("#")]),t._v(" SOES")]),t._v(" "),e("p",[t._v("开源 EtherCAT Slave 实现，对应有 SOEM 是 EtherCAT Master 实现。\n通过配置文件配置 ESC，之后通过 "),e("code",[t._v("ESC_read")]),t._v(" 和 "),e("code",[t._v("ESC_write")]),t._v(" 与 ESC 交互数据，由 ESC 负责接收发送。这两个函数是硬件相关的，需要针对硬件实现（参考 "),e("code",[t._v("hal/linux-lan9252")]),t._v(" 对 lan9252 的实现，"),e("code",[t._v("rt-kernel-xmc4/esc_hw.h")]),t._v(" 中 "),e("code",[t._v("esc_registers")]),t._v(" 定义，把指针 "),e("code",[t._v("esc_registers_t * ecat0")]),t._v(" 指向了 "),e("code",[t._v("ECAT0_BASE")]),t._v("，即寄存器的起始地址）。")]),t._v(" "),e("h2",{attrs:{id:"soes-库工作内容"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#soes-库工作内容"}},[t._v("#")]),t._v(" SOES 库工作内容")]),t._v(" "),e("ul",[e("li",[t._v("ESC（EtherCAT Slave Controller）硬件初始化\n"),e("ul",[e("li",[t._v("ESC 重置")]),t._v(" "),e("li",[t._v("ESC 初始化，init SPI")]),t._v(" "),e("li",[t._v("等待 ESC 初始化成功（轮询 ESC 的 DL 寄存器）")])])]),t._v(" "),e("li",[t._v("软件初始化\n"),e("ul",[e("li",[t._v("重置 Slave 状态（覆写 ESC AL 状态寄存器）")]),t._v(" "),e("li",[t._v("重置错误信息 （清除 ESC AL 错误码寄存器）")]),t._v(" "),e("li",[t._v("中止之前的应用层程序（可能有 SyncManager 在 block，等待接收EtherCAT 包）")])])]),t._v(" "),e("li",[t._v("应用\n"),e("ul",[e("li",[t._v("应用层事件（ALevent）处理，ALevent 携带了 ALControl 或 SyncManagers 的更改信息。ALControl 是用来控制状态改变的，SyncManagers 是用来将 EtherCAT 的改动写入到本地内存中的。")]),t._v(" "),e("li",[t._v("ESC_state 用来处理状态，例如状态变化、错误处理、告知接收到信息。")]),t._v(" "),e("li",[t._v("Mailbox handler，提供应用层协议使用的 mailboxes。")]),t._v(" "),e("li",[t._v("在 mailbox 中，也会检查是否需要使用特定协议的 handler 来处理接收/发送的数据。")])])])]),t._v(" "),e("h2",{attrs:{id:"soes-库设计"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#soes-库设计"}},[t._v("#")]),t._v(" SOES 库设计")]),t._v(" "),e("h3",{attrs:{id:"ecat-slv-c-实现-slave-api"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ecat-slv-c-实现-slave-api"}},[t._v("#")]),t._v(" "),e("code",[t._v("ecat_slv.c")]),t._v(" 实现 slave API")]),t._v(" "),e("h4",{attrs:{id:"全局变量"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#全局变量"}},[t._v("#")]),t._v(" 全局变量")]),t._v(" "),e("ul",[e("li",[t._v("定义全局变量 "),e("code",[t._v("_ESCvar")]),t._v(" 类型（定义在 "),e("code",[t._v("esc.h")]),t._v(" 中）的 "),e("code",[t._v("ESCvar")]),t._v("，负责存储 ESC 状态信息。")]),t._v(" "),e("li",[t._v("全局变量 "),e("code",[t._v("MBX")]),t._v(" 是 Mailbox，存储 "),e("code",[t._v("MBXBUFFERS * MAX(MBXSIZE,MBXSIZEBOOT)")]),t._v(" 规模的 "),e("code",[t._v("uint8_t")]),t._v(" 数据；"),e("code",[t._v("_MBXcontrol")]),t._v(" 则是 Mailbox 对应的 Controller。")]),t._v(" "),e("li",[t._v("全局变量 "),e("code",[t._v("_SMmap")]),t._v(" 类型的 "),e("code",[t._v("SMmap2")]),t._v(" 和 "),e("code",[t._v("SMmap3")]),t._v(" 分别映射输出、输入的 SM（SyncManager）。")])]),t._v(" "),e("h4",{attrs:{id:"初始化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#初始化"}},[t._v("#")]),t._v(" 初始化")]),t._v(" "),e("p",[e("code",[t._v("ecat_slv_init")]),t._v(" 接收 "),e("code",[t._v("esc_cfg_t")]),t._v(" 类型的设置选项进行初始化。")]),t._v(" "),e("h4",{attrs:{id:"应用处理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#应用处理"}},[t._v("#")]),t._v(" 应用处理")]),t._v(" "),e("p",[e("code",[t._v("ecat_slv")]),t._v(" 是一个需要周期性调用的函数，它内部会调用 ecat_slv_poll 和 DIG_process。前者 poll EtherCAT event，检查状态机，检查 SM，检查 Mailbox，如果收到数据就根据编译选项依次检查是否为 CoE（CAN over EtherCAT）、EoE（EtherNet over EtherCAT）、FoE （File over EtherCAT），最后检查是否为 XoE（错误的报文）应用，视需要处理 eeprom；后者更新局部变量，读入收到的 EtherCAT 帧，写出发送帧。")]),t._v(" "),e("h4",{attrs:{id:"应用相关"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#应用相关"}},[t._v("#")]),t._v(" 应用相关")]),t._v(" "),e("p",[e("code",[t._v("DIG_process")]),t._v(" 会阅读、修改 "),e("code",[t._v("ESCvar")]),t._v("。首先检查是否处于可以修改 Output 信息的的状态下，即 Operational state。")]),t._v(" "),e("h5",{attrs:{id:"output-esc-视角的-ouput-即用户态的接收"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#output-esc-视角的-ouput-即用户态的接收"}},[t._v("#")]),t._v(" Output：ESC 视角的 Ouput，即用户态的接收")]),t._v(" "),e("ul",[e("li",[t._v("如果我们在 OP 状态下，我们能够阅读 3-buffer SM 中被映射到输出的 SM 中的 PDO（Process Data Objects）数据, 默认的是 SyncManager2。我们阅读 SM2 的 ESC RAM 地址，存储到本地。我们将会读入 RXPDOsize bytes 的数据来触发一个完整的 SM 读操作。")]),t._v(" "),e("li",[t._v("在局部变量被更新后，我们将本地的 PDO 变量传递到用户应用中。")]),t._v(" "),e("li",[t._v("这个函数也包含了 watchdog 机制的实现，如果触发了它，会关闭输出，状态机改变到 Safe Operational。会更新 AlError 信息，告知 Master 发生了错误。")])]),t._v(" "),e("h5",{attrs:{id:"input-esc-视角的-input-即用户态的发送"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#input-esc-视角的-input-即用户态的发送"}},[t._v("#")]),t._v(" Input：ESC 视角的 Input，即用户态的发送")]),t._v(" "),e("ul",[e("li",[t._v("和输出类似，是反过来的，但是更加简单。即使是在 Safe Operational 状态下也会继续更新输入信息。")]),t._v(" "),e("li",[t._v("首先阅读用户应用数据，写入到本地的 PDO 变量中。在局部变量刷新后，把他们写入到 Input 对应的 SM，一般是 SyncManager3。这样就可以使用用户应用数据更新 ESC 的 RAM了。")])]),t._v(" "),e("h3",{attrs:{id:"特别需要注意"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#特别需要注意"}},[t._v("#")]),t._v(" 特别需要注意")]),t._v(" "),e("p",[t._v("在实现应用的时候，必须自己定义回调函数 "),e("code",[t._v("cb_get_inputs")]),t._v(" 和 "),e("code",[t._v("cb_get_outputs")]),t._v("，这两者声明在 "),e("code",[t._v("ecat_slv.h")]),t._v(" 中，会在 "),e("code",[t._v("DIG_process")]),t._v(" 中获取输入和输出时分别触发。")]),t._v(" "),e("p",[e("code",[t._v("esc_cfg_t")]),t._v(" 设置项中也有定义不同的hook，是可选的。")]),t._v(" "),e("h3",{attrs:{id:"eep-c"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#eep-c"}},[t._v("#")]),t._v(" "),e("code",[t._v("eep.c")])]),t._v(" "),e("p",[t._v("ESI EEPROM 模拟模块。")]),t._v(" "),e("h3",{attrs:{id:"esc-coe-c"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#esc-coe-c"}},[t._v("#")]),t._v(" "),e("code",[t._v("esc_coe.c")])]),t._v(" "),e("h3",{attrs:{id:"esc-eoe-c"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#esc-eoe-c"}},[t._v("#")]),t._v(" "),e("code",[t._v("esc_eoe.c")])]),t._v(" "),e("p",[t._v("ESI EEPROM 模拟模块。")]),t._v(" "),e("h3",{attrs:{id:"esc-foe-c"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#esc-foe-c"}},[t._v("#")]),t._v(" "),e("code",[t._v("esc_foe.c")])]),t._v(" "),e("p",[t._v("ESI EEPROM 模拟模块。")]),t._v(" "),e("h3",{attrs:{id:"eep-c-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#eep-c-2"}},[t._v("#")]),t._v(" "),e("code",[t._v("eep.c")])]),t._v(" "),e("p",[t._v("ESI EEPROM 模拟模块。")]),t._v(" "),e("h3",{attrs:{id:"esc-c"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#esc-c"}},[t._v("#")]),t._v(" "),e("code",[t._v("esc.c")])]),t._v(" "),e("p",[t._v("全局变量：\n"),e("code",[t._v("ESC_MBX1_sma")]),t._v(" sm address？（参考"),e("code",[t._v("ESC_write (ESC_MBX1_sma, MBh, ESC_MBXHSIZE + length);")]),t._v("）\n"),e("code",[t._v("ESC_MBX1_sml")]),t._v(" sm length?\n"),e("code",[t._v("ESC_MBX1_sme")]),t._v(" sm end?\n"),e("code",[t._v("ESC_MBX1_smc")]),t._v(" sm controller?")]),t._v(" "),e("p",[t._v("函数：\n"),e("code",[t._v("ESC_xoeprocess")]),t._v(" 负责处理错误的帧。\n"),e("code",[t._v("ESC_read")]),t._v(" 写 ESC 寄存器。\n"),e("code",[t._v("ESC_write")]),t._v(" 写 ESC 寄存器。\n"),e("code",[t._v("ESC_ALeventmaskread")]),t._v(" 读 ALeventMask 寄存器。\n"),e("code",[t._v("ESC_ALeventmaskwrite")]),t._v(" 写 ALeventMask 寄存器。")]),t._v(" "),e("p",[e("code",[t._v("ESC_outreqbuffer")]),t._v(" 从全局的"),e("code",[t._v("MBXcontrol")]),t._v("中寻找请求发送到 outbox 的mailbox 的下标。\n"),e("code",[t._v("ESC_mbxprocess")]),t._v(" 是实现 mailbox protocol 的，负责 mailbox 的读、发送、重传、mailbox full event 处理。\n"),e("code",[t._v("ESC_writembx")]),t._v("将 "),e("code",[t._v("esc_slv.c")]),t._v(" 中的全局变量 MBX 中 "),e("code",[t._v("ESC_outreqbuffer")]),t._v(" 查询到的 mailbox 发送出去。")]),t._v(" "),e("p",[t._v("mailbox 的状态：")]),t._v(" "),e("ul",[e("li",[t._v("0 : idle")]),t._v(" "),e("li",[t._v("1 : claimed for inbox")]),t._v(" "),e("li",[t._v("2 : claimed for outbox")]),t._v(" "),e("li",[t._v("3 : request post outbox")]),t._v(" "),e("li",[t._v("4 : outbox posted not send")]),t._v(" "),e("li",[t._v("5 : backup outbox")]),t._v(" "),e("li",[t._v("6 : mailbox needs to be transmitted again\n分别对应宏")])]),t._v(" "),e("div",{staticClass:"language-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MBXstate_idle")]),t._v("                   "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x00")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MBXstate_inclaim")]),t._v("                "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x01")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MBXstate_outclaim")]),t._v("               "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x02")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MBXstate_outreq")]),t._v("                 "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x03")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MBXstate_outpost")]),t._v("                "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x04")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MBXstate_backup")]),t._v("                 "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x05")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("MBXstate_again")]),t._v("                  "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x06")])])]),t._v("\n")])])]),e("h3",{attrs:{id:"options-h"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#options-h"}},[t._v("#")]),t._v(" "),e("code",[t._v("options.h")])]),t._v(" "),e("p",[t._v("默认的宏定义。用户程序可以通过定义 "),e("code",[t._v("ecat_options.h")]),t._v(" 覆盖他们。")]),t._v(" "),e("h2",{attrs:{id:"soes-样例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#soes-样例"}},[t._v("#")]),t._v(" SOES 样例")]),t._v(" "),e("p",[t._v("目录下的 "),e("code",[t._v("rtl_slave_demo")]),t._v(" 是一个简短的led亮灯示例。在这个例子中，SOES 相关 API 的应用例子封装在了 "),e("code",[t._v("void soes (void *arg)")]),t._v(" 函数中通过一个线程执行，另一个线程去读取 ESCvar.ALstatus 状态和 ESCvar.ALerror 错误码，根据状态机的状态和错误码来点亮 LED，设定闪烁频次。")]),t._v(" "),e("p",[e("code",[t._v("rtl_lwip_eoe")]),t._v(" 是一个基于 lwip 的 EtherNet over EtherCAT 示例。"),e("code",[t._v("mbox_fetch_tmo/mbox_post_tmo")]),t._v(" 是带 timeout（tmo）的 mailbox fetch/post API。")]),t._v(" "),e("h2",{attrs:{id:"soes-中的一些数据规定"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#soes-中的一些数据规定"}},[t._v("#")]),t._v(" SOES 中的一些数据规定")]),t._v(" "),e("h3",{attrs:{id:"sii-pdo-和-esi-pdo"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sii-pdo-和-esi-pdo"}},[t._v("#")]),t._v(" SII-PDO 和 ESI-PDO")]),t._v(" "),e("p",[t._v("为了通过总线获取 SII-EEPROM（Slave Information Interface）和 ESI（EtherCAT Slave Information, 存储在 SII-EEPROM），规定了相关数据结构。其中：必须的参数，mandatory 用 M 代表；可选的参数，optional 用 O 代表。")]),t._v(" "),e("p",[e("img",{attrs:{src:a(426),alt:"img"}})]),t._v(" "),e("p",[e("img",{attrs:{src:a(427),alt:"img"}})]),t._v(" "),e("h2",{attrs:{id:"od"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#od"}},[t._v("#")]),t._v(" OD")]),t._v(" "),e("p",[t._v("同时，对于比较复杂的 Slave 还可以定义可选的 Object Dictionary（OD）。可以在 CoE 中使用它，它遵循 CANopen DS301。")]),t._v(" "),e("ul",[e("li",[t._v("0x0000 - 0x0FFF, Data Type Area")]),t._v(" "),e("li",[t._v("0x1000 - 0x1FFF, Communication Area\n"),e("ul",[e("li",[t._v("RxPDO , 0x1600 - 0x17FF")]),t._v(" "),e("li",[t._v("TxPDO , 0x1A00 - 0x1BFF")])])]),t._v(" "),e("li",[t._v("0x2000 - 0x5FFF, Manufacture specific area")]),t._v(" "),e("li",[t._v("0x6000 - 0x6FFF, Input area")]),t._v(" "),e("li",[t._v("0x7000 - 0x7FFF, Output area")]),t._v(" "),e("li",[t._v("0x8000 - 0x8FFF, Configuration area")]),t._v(" "),e("li",[t._v("0x9000 - 0x9FFF, Information area")]),t._v(" "),e("li",[t._v("0xA000 - 0xAFFF, Diagnosis Area")]),t._v(" "),e("li",[t._v("0xB000 - 0xBFFF, Service Transfer Area")]),t._v(" "),e("li",[t._v("0xC000 - 0xEFFF, Reserved Area")]),t._v(" "),e("li",[t._v("0xF000 - 0xFFFF, Device Area")])]),t._v(" "),e("h3",{attrs:{id:"sm-事件类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sm-事件类型"}},[t._v("#")]),t._v(" SM 事件类型")]),t._v(" "),e("ul",[e("li",[t._v("0, Unused")]),t._v(" "),e("li",[t._v("1, MailBox Receive, master to slave")]),t._v(" "),e("li",[t._v("2, MailBox Send, slave to master")]),t._v(" "),e("li",[t._v("3, Processdata output, master to slave")]),t._v(" "),e("li",[t._v("4, Processdata input, slave to master")])]),t._v(" "),e("h2",{attrs:{id:"实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[t._v("#")]),t._v(" 实现")]),t._v(" "),e("p",[t._v("HFA21 支持硬件offloading，上层透明。用透传来写的话，只需要在 UDP datagram 里去构造 EtherCAT 包，当然这样没有 ECS，而且在传输层之上，当作应用层协议来写了，也就不具备快速的on-the-fly能力了。")]),t._v(" "),e("p",[t._v("为了方便做解析，这么写的（具体定义参考上面 EtherCAT 帧结构的图解）")]),t._v(" "),e("div",{staticClass:"language-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stdint.h>")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// gcc6 以上支持强制指定大小端（big-endian、little-endian、default）")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("BIG_ENDIAN")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("__attribute__")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("packed"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scalar_storage_order")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")])]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"big-endian"')]),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")])])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token macro property"}},[e("span",{pre:!0,attrs:{class:"token directive-hash"}},[t._v("#")]),e("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("define")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token macro-name"}},[t._v("ETHERCAT_PORT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token expression"}},[e("span",{pre:!0,attrs:{class:"token number"}},[t._v("34980")]),t._v(" ")]),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 0x88A4")])]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" BIG_ENDIAN "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" type "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" res "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" length "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" EcatHeader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("EcatHeaderPtr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" BIG_ENDIAN "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    BIG_ENDIAN "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" position"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" offset"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" position"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Position Addressing")]),t._v("\n    BIG_ENDIAN "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" address"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" offset"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Node Addressing")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint32_t")]),t._v(" logical"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" EcatAddress"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("EcatAddressPtr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" cmd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" idx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    EcatAddress address"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    BIG_ENDIAN "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("union")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        BIG_ENDIAN "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" length "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" r "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" m "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// followed by more datagrams or not")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" u"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// for easy parse")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" irq "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" EcatDataHeader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("EcatDataHeaderPtr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    EcatDataHeader header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 10 bytes")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("data"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("         "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 0-1486 bytes")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" work_counter"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 2bytes")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" EcatDatagram"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("EcatDatagramPtr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    EcatHeader header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    EcatDatagram datagram"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" EcatData"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("EcatDataPtr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("用 union 来包裹位域，否则要挨个解析，即依次将相同的数字赋值给占用不同位域的变量，而用了union只需要赋值给对应的 "),e("code",[t._v("EcatDataHeader.suffix.u")]),t._v("。整个强制指定为符合网络序的大端，否则需要手动处理主机序的转换。\n比如，假设收到的帧中， "),e("code",[t._v("EcatDataHeader.suffix")]),t._v(" 对应的值是0x12345678。\n当前可以这么赋值：")]),t._v(" "),e("div",{staticClass:"language-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[t._v("EcatDataHeader header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" suffix "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x1234")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nheader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("u "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%x,%x,%x,%x"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("r"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("但是如果")]),t._v(" "),e("div",{staticClass:"language-C extra-class"},[e("pre",{pre:!0,attrs:{class:"language-c"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("typedef")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" cmd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint8_t")]),t._v(" idx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    EcatAddress address"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" length "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("11")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" r "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" m "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// followed by more datagrams or not")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" irq "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" EcatDataHeader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("EcatDataHeaderPtr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nEcatDataHeader header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("uint16_t")]),t._v(" suffix "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0x1234")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nheader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nheader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("r "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nheader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("c "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nheader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" suffix"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%x,%x,%x,%x"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("r"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("header"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("m"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("此时还会有大小端的问题，需要用 "),e("code",[t._v("htonl")]),t._v(" 等转换。")]),t._v(" "),e("h1",{attrs:{id:"s7-库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#s7-库"}},[t._v("#")]),t._v(" S7 库")]),t._v(" "),e("p",[t._v("关于 S7，有几篇不错的博客：")]),t._v(" "),e("p",[e("a",{attrs:{href:"http://gmiru.com/article/s7comm/",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Siemens S7 Communication - Part 1 General Structure"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"http://gmiru.com/article/s7comm-part2/",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Siemens S7 Communication - Part 2 Job Requests and Ack Data"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://www.jianshu.com/p/0e9f74d683b4",target:"_blank",rel:"noopener noreferrer"}},[t._v("上面两篇博客的翻译"),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"http://blog.nsfocus.net/s7comm-readszl-0427/",target:"_blank",rel:"noopener noreferrer"}},[t._v("对 ReadSZL 的详解"),e("OutboundLink")],1),t._v("，SZL 是系统状态列表（德语：System-ZustandsListen，英语：System Status Lists），用于描述PLC的当前状态，只能读取不能修改。")]),t._v(" "),e("p",[t._v("注意在 wireshark 中可以用 "),e("code",[t._v("s7comm")]),t._v(" 或 "),e("code",[t._v("tcp.port == 102")]),t._v(" 来过滤 S7 的包，但是前者只能在展示时起效，后者可以在过滤时起效。")]),t._v(" "),e("p",[t._v("该库是 Siemens 给自家 PLC 写的通讯库，使用时需要指定 IP、port、Rack，Slot。")]),t._v(" "),e("p",[t._v("具体地：")]),t._v(" "),e("p",[t._v("建立连接是用的TSnap7Peer的PeerConnect函数，调用了TIsoTcpSocket的 isoConnect。")]),t._v(" "),e("p",[t._v("s7_isotcp.cpp\n里面定义了TIsoTcpSocket的构造函数，设置的Timeout是3000，tcp port是用的102端口。（Rack默认是0，Slot默认是2，我们的设备Slot需要设置成1。）。")]),t._v(" "),e("p",[t._v("发送过去的载荷是在TIsoTcpSocket 的 BuildControlPDU 里构造的 FControlPDU。")]),t._v(" "),e("p",[t._v("Client 的具体的 Operation 都是通过 TSnap7Job 结构体代理的，定义在 s7_micro_client 中。在PerformOperation() 被调用后，就会填充它。")]),t._v(" "),e("p",[t._v("填充方法是，比如TSnap7MicroClient::opGetOrderCode()中，在opReadSZL()中写入到TS7Buffer opData里将 void* 的TSnap7Job::pData 转换成目标类型的.。然后再从这个 TS7Buffer 里读取出来复制到TSnap7Job::pData的各个成员里。")]),t._v(" "),e("p",[t._v("opReadMultiVars/opWriteMultiVars 会自动忽略掉Area不是DB的 DBNumber。把请求的DBNumber都填充到ReqParams里，随着首部PS7ReqHeader TSnap7Peer::PDUH_out 作为PDU的数据单元。")]),t._v(" "),e("p",[t._v("opDBGet/opDBFill 调用了 opReadArea/opWriteArea。")]),t._v(" "),e("p",[t._v("所有的operation都是通过PerformOperation()去管理的，而每个operation中，都是通过TIsoTcpSocket::isoExchangeBuffer来完成的发送和接收，这个函数可以接收data来修改发送出去的PDU.payload，如果接收了空指针（一半都会传入0），则会使用默认的 PDU.payload。")]),t._v(" "),e("p",[t._v("接收到的数据会存储到ResData中，并复制到Target结束（Target是Job.pData偏移后 byte 类型的指针）。")]),t._v(" "),e("p",[t._v("主要类的继承关系：")]),t._v(" "),e("p",[e("img",{attrs:{src:"s7socket.png",alt:"img"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"s7server.png",alt:"img"}})]),t._v(" "),e("p",[t._v("测试情况：")]),t._v(" "),e("p",[e("img",{attrs:{src:a(428),alt:"img"}})]),t._v(" "),e("Comment",{attrs:{lang:"zh-CN"}})],1)}),[],!1,null,null,null);s.default=r.exports}}]);