(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{465:function(t,e,r){"use strict";r.r(e);var n=r(12),a=Object(n.a)({},(function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[r("h1",{attrs:{id:"学习rcore"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#学习rcore"}},[t._v("#")]),t._v(" 学习rCore")]),t._v(" "),r("p"),r("div",{staticClass:"table-of-contents"},[r("ul",[r("li",[r("a",{attrs:{href:"#第一章-独立可执行程序"}},[t._v("第一章 独立可执行程序")])]),r("li",[r("a",{attrs:{href:"#第二章-最小化内核"}},[t._v("第二章 最小化内核")])])])]),r("p"),t._v(" "),r("p",[t._v("之前花了好长时间去读"),r("a",{attrs:{href:"https://doc.rust-lang.org/book/#the-rust-programming-language",target:"_blank",rel:"noopener noreferrer"}},[t._v("The Rust Programming Language"),r("OutboundLink")],1),t._v("，写了写书里的实例，也在LeetCode上用Rust"),r("a",{attrs:{href:"https://github.com/Forsworns/OJ_Diary",target:"_blank",rel:"noopener noreferrer"}},[t._v("写了一些题"),r("OutboundLink")],1),t._v("，但是一直没有动手做一个项目。")]),t._v(" "),r("p",[t._v("最近发现同学在github上点赞了rCore项目，再次感叹人与人的差距，这就是强者的os课设么。网抑云，启动！我os课设计当时写的是调度器，现在想起来能跑起来都是一件神奇的事情。当时也没有记笔记的习惯，现在基本忘光了，这次就边学习边记录一下，内容基本都来源于"),r("a",{attrs:{href:"https://rcore-os.github.io/rCore_tutorial_doc/",target:"_blank",rel:"noopener noreferrer"}},[t._v("rCore的教程"),r("OutboundLink")],1),t._v("。也算激励自己学习（狒狒14太好玩了不想写代码了orz）。")]),t._v(" "),r("h2",{attrs:{id:"第一章-独立可执行程序"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第一章-独立可执行程序"}},[t._v("#")]),t._v(" 第一章 独立可执行程序")]),t._v(" "),r("ul",[r("li",[r("p",[t._v("使用nightly的Rust需要指定版本确保"),r("a",{attrs:{href:"https://stackoverflow.com/questions/2171177/what-is-an-application-binary-interface-abi/2456882",target:"_blank",rel:"noopener noreferrer"}},[t._v("ABI"),r("OutboundLink")],1),t._v("稳定性，需要在工作目录下建一个名为 "),r("code",[t._v("rust-toolchain")]),t._v(" 的文件，写入如"),r("code",[t._v("nightly-2020-01-27")]),t._v("的工具链版本。")])]),t._v(" "),r("li",[r("p",[r("code",[t._v("rustup show")]),t._v("或"),r("code",[t._v("rustc --version")]),t._v("查看Rust版本。")])]),t._v(" "),r("li",[r("p",[r("code",[t._v("cargo new --bin")]),t._v("和"),r("code",[t._v("cargo new --lib")]),t._v("分别创建binary和library项目。")])]),t._v(" "),r("li",[r("p",[t._v("使用"),r("code",[t._v("#![no_std]")]),t._v("禁用标准库，这类宏只能置于文件头部；之后需要实现错误处理，使用宏"),r("code",[t._v("#[panic_handler]")]),t._v("并实现"),r("code",[t._v("panic")]),t._v("函数。")])]),t._v(" "),r("li",[r("p",[t._v("在"),r("code",[t._v("Cargo.toml")]),t._v("中禁用exception handling")]),t._v(" "),r("div",{staticClass:"language-toml extra-class"},[r("pre",{pre:!0,attrs:{class:"language-toml"}},[r("code",[r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),r("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("profile.dev")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cargo build")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token key property"}},[t._v("panic")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"abort"')]),t._v("\n\n"),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),r("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("profile.release")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cargo build --release")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token key property"}},[t._v("panic")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"abort"')]),t._v("\n")])])])]),t._v(" "),r("li",[r("p",[t._v("移除runtime system（链接到标准库的rust程序会先跳转到 C runtime library 中的 "),r("strong",[t._v("crt0(C runtime zero)")]),t._v(" 进入 C runtime 设置 C 程序运行所需要的环境(比如：创建堆栈，设置寄存器参数等，之后跳转到 Rust runtime 的 "),r("strong",[t._v("入口点(entry point)")]),t._v(" 进入 Rust runtime 继续设置）。使用"),r("code",[t._v("#![no_main]")]),t._v("移除后并去除main函数后，显式地添加C runtime的入口，C语言函数"),r("code",[t._v("_start()")]),t._v("，并使用宏"),r("code",[t._v("#[no_mangle]")]),t._v("防止编译器改变函数名。")])]),t._v(" "),r("li",[r("p",[t._v("用rustc编译时，"),r("code",[t._v("cargo rustc -- -C link-arg=-nostartfiles")]),t._v("可以防止链接到C runtime。注意前一个"),r("code",[t._v("--")]),t._v("是cargo的参数，后面的是编译器rustc的参数。")])])]),t._v(" "),r("h2",{attrs:{id:"第二章-最小化内核"}},[r("a",{staticClass:"header-anchor",attrs:{href:"#第二章-最小化内核"}},[t._v("#")]),t._v(" 第二章 最小化内核")]),t._v(" "),r("ul",[r("li",[r("p",[t._v("Rust的编译需要指定目标元组：（cpu 架构、供应商、操作系统和 ABI），如"),r("code",[t._v("x86_64-unknown-linux-gnu")]),t._v("。使用"),r("code",[t._v("rustc --version --verbose")]),t._v("可以查看当前默认的目标平台，使用"),r("code",[t._v("rustc -Z unstable-options --print target-spec-json --target x86_64-unknown-linux-gnu")]),t._v("。")])]),t._v(" "),r("li",[r("p",[t._v("rCore使用了riscv，因此需要用"),r("code",[t._v("cargo build --target riscv64imac-unknown-none-elf")]),t._v("命令或直接在"),r("code",[t._v(".cargo/config")]),t._v("中写入")]),t._v(" "),r("div",{staticClass:"language-toml extra-class"},[r("pre",{pre:!0,attrs:{class:"language-toml"}},[r("code",[r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),r("span",{pre:!0,attrs:{class:"token table class-name"}},[t._v("build")]),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),r("span",{pre:!0,attrs:{class:"token key property"}},[t._v("target")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),r("span",{pre:!0,attrs:{class:"token string"}},[t._v('"riscv64imac-unknown-none-elf"')]),t._v("\n")])])]),r("p",[t._v("来为项目设置目标三元组。")])]),t._v(" "),r("li",[r("p",[t._v("使用"),r("code",[t._v("cargo install cargo-binutils")]),t._v("和"),r("code",[t._v("rustup component add llvm-tools-preview")]),t._v("安装binutils命令行工具，以使用objdump、objcopy等工具。")]),t._v(" "),r("p",[t._v("具体得，使用file工具查看文件类型等信息；使用 "),r("code",[t._v("rust-objdump target/riscv64imac-unknown-none-elf/debug/xxx -x --arch-name=riscv64")]),t._v("查看文件元信息，使用"),r("code",[t._v("-d")]),t._v("则可进行反汇编；使用"),r("code",[t._v("rust-objcopy target/riscv64imac-unknown-none-elf/debug/xxx --strip-all -O binary target/riscv64imac-unknown-none-elf/debug/kernel.bin")]),t._v("丢弃所有符号表及调试信息，生成二进制内核镜像文件。")])]),t._v(" "),r("li")]),t._v(" "),r("p",[r("RouterLink",{attrs:{to:"/zh/blogs/"}},[t._v("返回")])],1),t._v(" "),r("Comment",{attrs:{lang:"zh-CN"}})],1)}),[],!1,null,null,null);e.default=a.exports}}]);