(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{467:function(t,s,a){"use strict";a.r(s);var e=a(12),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"webrtc-on-wsl2-ubuntu2-折腾笔记"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#webrtc-on-wsl2-ubuntu2-折腾笔记"}},[t._v("#")]),t._v(" WebRTC on WSL2 Ubuntu2 折腾笔记")]),t._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#android环境搭建"}},[t._v("Android环境搭建")])])])]),a("p"),t._v(" "),a("p",[t._v("WebRTC的安卓开发环境只能在Linux系统上使用，因此我在Windows下的WSL2中搭建了环境，我的WSL2安装的是Ubuntu20，在搭建过程中遇到了一些坑，记录下来。部分内容参考自"),a("a",{attrs:{href:"https://www.cnblogs.com/hejunlin/p/12526727.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("博客"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"android环境搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#android环境搭建"}},[t._v("#")]),t._v(" Android环境搭建")]),t._v(" "),a("p",[t._v("首先我们需要参考"),a("a",{attrs:{href:"https://webrtc.googlesource.com/src/+/refs/heads/master/docs/native-code/android/index.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方文档"),a("OutboundLink")],1),t._v("，发现需要先安装"),a("a",{attrs:{href:"https://webrtc.googlesource.com/src/+/refs/heads/master/docs/native-code/development/prerequisite-sw/index.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("prerequisite software"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone https://chromium.googlesource.com/chromium/tools/depot_tools.git\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("PATH")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/path/to/depot_tools:"),a("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$PATH")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 建议写入~/.bashrc")]),t._v("\n")])])]),a("p",[t._v("接着运行")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("fetch --nohooks webrtc_android "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 会下很久……万幸有输出会提示没断开连接")]),t._v("\ngclient --nohooks "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),t._v("\ngclient runhooks\n")])])]),a("p",[t._v("在这一步WSL2需要配置代理，同时后面用到"),a("code",[t._v("download_google_storage")]),t._v("也可能有代理问题，所以同时最好给gclient单独配置"),a("code",[t._v("your_webrtc_directory/http_proxy.boto")]),t._v("文件设置代理规则，建议将下述命令写入"),a("code",[t._v("~/.bashrc")])]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("hostip")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /etc/resolv.conf "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" -oP "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'(?<=nameserver\\ ).*'")]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" -e "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"[Boto]'),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("proxy = "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${hostip}")]),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v('proxy_port = 8888"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" your_webrtc_directory/http_proxy.boto\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("alias")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("setss")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'export https_proxy="http://${hostip}:8888";export http_proxy="http://${hostip}:8888";export all_proxy="http://${hostip}:8888";\'')]),t._v("\n")])])]),a("p",[t._v("之后在windows中打开SSR/V2Ray/Clash等代理工具，设置允许本地代理，选择允许来自局域网的连接，将端口设置到8888，运行"),a("code",[t._v("source ~/.bashrc")]),t._v("和"),a("code",[t._v("setss")]),t._v("，设置WSL2下的代理规则。")]),t._v(" "),a("p",[t._v("在运行"),a("code",[t._v("gclient runhook")]),t._v("时，Ubuntu20中因为没有安装python2.7会报相关错误，"),a("code",[t._v("sudo apt install python")]),t._v("后解决。")]),t._v(" "),a("p",[t._v("重新运行"),a("code",[t._v("gclient runhook")]),t._v("，接着会产生无法下载debian_sid_i386-sysroot的问题，这是DNS有问题，直接在浏览器打开"),a("a",{attrs:{href:"https://commondatastorage.googleapis.com/chrome-linux-sysroot/toolchain/d967bcef40477dbc39acef141ff22bf73f3e7cdb/debian_sid_i386_sysroot.tar.xz",target:"_blank",rel:"noopener noreferrer"}},[t._v("下载链接"),a("OutboundLink")],1),t._v("也下载不到。修改Windows下无线网卡的DNS为谷歌的8.8.8.8/8.8.4.4后，可以在浏览器中下载到，移动到了"),a("code",[t._v("your_webrtc_directory/src/build/linux/debian_sid_i386-sysroot")]),t._v("中，修改"),a("code",[t._v("your_webrtc_directory/src/build/linux/sysroot_scripts/install-sysroot.py")]),t._v("为")]),t._v(" "),a("div",{staticClass:"language-python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("tarball "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("join"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sysroot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" tarball_filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exists"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tarball"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 检查是否已经有了 ")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isdir"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sysroot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        shutil"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rmtree"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sysroot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t……\n        response "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" urlopen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 或者在这里设置代理为hostip:8888也行")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("open")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tarball"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wb"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  \t\t……\n")])])]),a("p",[t._v("重新运行"),a("code",[t._v("gclient runhook")]),t._v("，同样方法处理之后的amd64 sysroot下载不到的问题。之后可能会有clang-llvm的安装问题，通过在Windows下的代理中设置DNS为谷歌的8.8.8.8后解决。")]),t._v(" "),a("p",[t._v("之后的就都正常下载下来了，如果出问题，重新跑一下"),a("code",[t._v("setss")]),t._v("。")]),t._v(" "),a("p",[t._v("之后开始安装编译过程中必要的工具")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在your_webrtc_directory下")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" src \nbuild/install-build-deps-android.sh \ngn gen out/Debug --args"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'target_os="android" target_cpu="arm"\'')]),t._v("\nautoninja -C out/Debug "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 会花费很长时间")]),t._v("\nautoninja -C out/Debug AppRTCMobile "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 只编译AppRTCMobile")]),t._v("\n")])])]),a("p",[t._v("至此，编译完成了！")]),t._v(" "),a("p",[t._v("切换到Release m85，之后固定在这个版本")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout -b m85 refs/remotes/branch-heads/4183\n")])])]),a("h1",{attrs:{id:"linux环境搭建"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#linux环境搭建"}},[t._v("#")]),t._v(" Linux环境搭建")]),t._v(" "),a("p",[t._v("项目结构和上面类似，但是有一些example没有，也不知道别的有没有区别……就直接重新搭建了一份")]),t._v(" "),a("p",[t._v("过程类似，因为depot_tools安过了，所以第一步可以跳过了")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("fetch --nohooks webrtc_android\ngclient --nohooks "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),t._v("\ngclient runhooks\n")])])]),a("p",[t._v("同样会遇到root image下不到的情况，类似上面可以处理掉")]),t._v(" "),a("p",[t._v("之后使用GN生产Ninja编译配置文件")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("gn gen out/Default\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gn gen out/Default --args='is_debug=false' # release version")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# gn clean out/Default # clean builds")]),t._v("\nninja -C out/Default "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# compile")]),t._v("\n")])])]),a("p",[t._v("切换到Release m85，之后固定在这个版本")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout -b m85 refs/remotes/branch-heads/4183\n")])])]),a("p",[t._v("在"),a("code",[t._v("src")]),t._v("目录下查看一下文件大小")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("du")]),t._v(" --max-depth"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" -h\n\n27M     ./data\n17G     ./third_party\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".9M    ./p2p\n968K    ./rtc_tools\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v(".9M    ./sdk\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".3M    ./call\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(".3M    ./rtc_base\n104K    ./stats\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(".3M    ./pc\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(".3G    ./out\n502M    ./examples\n325M    ./.git\n164K    ./docs\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".8M    ./video\n696K    ./audio\n948K    ./logging\n83M     ./base\n188K    ./system_wrappers\n92M     ./buildtools\n49M     ./testing\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".9M    ./media\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".5M    ./tools_webrtc\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("6")]),t._v(".7M    ./test\n640M    ./build\n20K     ./build_overrides\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".4G    ./resources\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".3M    ./common_audio\n12K     ./style-guide\n368K    ./common_video\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(".1G    ./tools\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(".8M    ./api\n20M     ./modules\n25G     "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),a("p",[t._v("过滤掉大的、没必要改动的文件夹")]),t._v(" "),a("h1",{attrs:{id:"android-studio配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#android-studio配置"}},[t._v("#")]),t._v(" Android Studio配置")]),t._v(" "),a("p",[t._v("官网上的方法已经标出了无法使用，推荐直接将"),a("code",[t._v("src/examples/androidapp/")]),t._v("下的代码拷贝出来。")]),t._v(" "),a("p",[t._v("用Android Studio创建一个项目，创建时"),a("code",[t._v("minSdkVersion")]),t._v("设置为21而不是默认的16，因为webrtc包不支持更低的版本。package name建议设置成了"),a("code",[t._v("org.appspot.apprtc")]),t._v("，在Android Studio项目目录结构中，把"),a("code",[t._v("src/examples/androidapp/")]),t._v("下的文件放到对应位置。注意 "),a("code",[t._v("src/examples/androidapp/third_party/autobanh/lib/autobanh.jar")]),t._v("文件需要拷贝到 "),a("code",[t._v("src/libs")]),t._v(" 目录下，"),a("code",[t._v("third_party")]),t._v("中的其他文件可以删掉了。其他的比如"),a("code",[t._v("build.gradle")]),t._v("在"),a("code",[t._v("app")]),t._v(" Module下，"),a("code",[t._v("res")]),t._v("文件夹是在"),a("code",[t._v("src/main")]),t._v("下，"),a("code",[t._v("org")]),t._v("放到"),a("code",[t._v("src/main/java")]),t._v("下。")]),t._v(" "),a("p",[t._v("这时需要用Android Studio的Refactor选项中的Migrate to AndroidX，升级陈旧的依赖。但是这里有个坑是Nullable注解依赖不会自动更新，所以需要将java源代码中所有的"),a("code",[t._v("import android.support.annotation.Nullable;")]),t._v("替换为"),a("code",[t._v("import androidx.annotation.Nullable;")]),t._v("。然后sync一下gradle，就可以build了。")]),t._v(" "),a("p",[a("RouterLink",{attrs:{to:"/zh/blogs/"}},[t._v("返回")])],1),t._v(" "),a("Comment",{attrs:{lang:"zh-CN"}})],1)}),[],!1,null,null,null);s.default=n.exports}}]);