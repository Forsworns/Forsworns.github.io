<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rust宏学习笔记 | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.c401dc4c.css" as="style"><link rel="preload" href="/assets/js/app.64e41af0.js" as="script"><link rel="preload" href="/assets/js/1.b822baa6.js" as="script"><link rel="preload" href="/assets/js/58.7cee13f9.js" as="script"><link rel="preload" href="/assets/js/12.331c1b95.js" as="script"><link rel="prefetch" href="/assets/js/10.70c355fc.js"><link rel="prefetch" href="/assets/js/11.753893eb.js"><link rel="prefetch" href="/assets/js/13.a4e8aabf.js"><link rel="prefetch" href="/assets/js/14.24b3becc.js"><link rel="prefetch" href="/assets/js/15.00ff0e6a.js"><link rel="prefetch" href="/assets/js/16.d99681a9.js"><link rel="prefetch" href="/assets/js/17.e83aede1.js"><link rel="prefetch" href="/assets/js/18.c101c0e5.js"><link rel="prefetch" href="/assets/js/19.dcc78c73.js"><link rel="prefetch" href="/assets/js/20.521a8bf7.js"><link rel="prefetch" href="/assets/js/21.7bd51a4c.js"><link rel="prefetch" href="/assets/js/22.5734c1b8.js"><link rel="prefetch" href="/assets/js/23.3019517c.js"><link rel="prefetch" href="/assets/js/24.f10332fd.js"><link rel="prefetch" href="/assets/js/25.8a6166c9.js"><link rel="prefetch" href="/assets/js/26.a0f9572e.js"><link rel="prefetch" href="/assets/js/27.6fbd40e6.js"><link rel="prefetch" href="/assets/js/28.412744c7.js"><link rel="prefetch" href="/assets/js/29.61bdab72.js"><link rel="prefetch" href="/assets/js/3.462f36af.js"><link rel="prefetch" href="/assets/js/30.502699f8.js"><link rel="prefetch" href="/assets/js/31.e54d3e42.js"><link rel="prefetch" href="/assets/js/32.cb38bcb3.js"><link rel="prefetch" href="/assets/js/33.35a0d2a0.js"><link rel="prefetch" href="/assets/js/34.dfb7a7d8.js"><link rel="prefetch" href="/assets/js/35.d5480fa9.js"><link rel="prefetch" href="/assets/js/36.7dd0e3f3.js"><link rel="prefetch" href="/assets/js/37.ef5781a6.js"><link rel="prefetch" href="/assets/js/38.953c02c4.js"><link rel="prefetch" href="/assets/js/39.74890a7e.js"><link rel="prefetch" href="/assets/js/4.ecd12c72.js"><link rel="prefetch" href="/assets/js/40.227ad2e8.js"><link rel="prefetch" href="/assets/js/41.5db4f49f.js"><link rel="prefetch" href="/assets/js/42.62bbf1aa.js"><link rel="prefetch" href="/assets/js/43.0c221fa7.js"><link rel="prefetch" href="/assets/js/44.9cace7d0.js"><link rel="prefetch" href="/assets/js/45.b212e848.js"><link rel="prefetch" href="/assets/js/46.389632d3.js"><link rel="prefetch" href="/assets/js/47.2c698c81.js"><link rel="prefetch" href="/assets/js/48.a5fd78b8.js"><link rel="prefetch" href="/assets/js/49.a9e74e3e.js"><link rel="prefetch" href="/assets/js/5.5b6ccdda.js"><link rel="prefetch" href="/assets/js/50.5f58b67b.js"><link rel="prefetch" href="/assets/js/51.648fc41d.js"><link rel="prefetch" href="/assets/js/52.82fa340f.js"><link rel="prefetch" href="/assets/js/53.d2bd7567.js"><link rel="prefetch" href="/assets/js/54.0e48d9bf.js"><link rel="prefetch" href="/assets/js/55.df8d58d2.js"><link rel="prefetch" href="/assets/js/56.628aafb9.js"><link rel="prefetch" href="/assets/js/57.70a594da.js"><link rel="prefetch" href="/assets/js/59.c6a690f4.js"><link rel="prefetch" href="/assets/js/6.38321375.js"><link rel="prefetch" href="/assets/js/60.92f8a773.js"><link rel="prefetch" href="/assets/js/61.b9000fcd.js"><link rel="prefetch" href="/assets/js/62.b24c5821.js"><link rel="prefetch" href="/assets/js/63.d8ac060f.js"><link rel="prefetch" href="/assets/js/64.e408e5a8.js"><link rel="prefetch" href="/assets/js/65.67665fed.js"><link rel="prefetch" href="/assets/js/66.bdaea6cf.js"><link rel="prefetch" href="/assets/js/67.cf2ee58d.js"><link rel="prefetch" href="/assets/js/68.49432d26.js"><link rel="prefetch" href="/assets/js/69.aba46e78.js"><link rel="prefetch" href="/assets/js/7.ab777b2a.js"><link rel="prefetch" href="/assets/js/70.42396fff.js"><link rel="prefetch" href="/assets/js/71.170b2f05.js"><link rel="prefetch" href="/assets/js/72.d017290f.js"><link rel="prefetch" href="/assets/js/73.a7c0bf95.js"><link rel="prefetch" href="/assets/js/74.0796c0ed.js"><link rel="prefetch" href="/assets/js/8.6e1963ab.js"><link rel="prefetch" href="/assets/js/9.197a57a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c401dc4c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210224/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210224/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#rust中宏的分类">Rust中宏的分类</a></li><li><a href="#声明式宏">声明式宏</a></li><li><a href="#过程式宏">过程式宏</a><ul><li><a href="#custom-derive-宏">Custom Derive 宏</a></li><li><a href="#attribute-like-宏">Attribute-Like 宏</a></li><li><a href="#function-like-宏">Function-Like 宏</a></li></ul></li><li><a href="#好用的库">好用的库</a></li><li><a href="#收录有趣的宏样例">收录有趣的宏样例</a><ul><li><a href="#你这写的啥啊">你这写的啥啊</a></li><li><a href="#还得学习一个">还得学习一个</a></li></ul></li><li><a href="#references">References</a></li></ul></div><p></p> <h1 id="rust宏学习笔记"><a href="#rust宏学习笔记" class="header-anchor">#</a> Rust宏学习笔记</h1> <p>前面的部分基本是 Rust 语言手册翻译。</p> <p>Rust 中的宏相较C++更为强大。C++ 中的宏在预处理阶段可以展开为文本，Rust 的宏则是对语法的扩展，是在构建语法树时，才展开的宏。</p> <h2 id="rust中宏的分类"><a href="#rust中宏的分类" class="header-anchor">#</a> Rust中宏的分类</h2> <p>Rust 中宏可以分为很多类，包括通过 macro_rules 定义的<strong>声明式宏</strong>和三种<strong>过程式宏</strong></p> <ul><li>custom derive 可推导宏，借助 <code>#[derive]</code> 属性标签，它可以用在 struct 和 enum 上</li> <li>attribute-like 本身就是一个标签，可以作用于任何地方</li> <li>function-like 看上去像函数，但是作用在 token 上，即把token作为函数参数</li></ul> <p>所以为什么需要宏？</p> <p>为了偷懒、为了让代码更简洁。使用宏可以快速生成大量代码，避免重复劳动。Rust 宏扩展了语法，你是不会想要每次都老老实实地写繁复的代码的，所以学一点魔法！</p> <p>为什么不用函数或者模板？</p> <ul><li>Rust 的函数必须限定好参数类型和参数个数，而且他并没有提供变长模板参数，所以嘛，哈哈。事实上有不少库为了应对未知个数参数的情况，手写了不同个数参数的函数，而且很蛋疼的是 Rust 也不允许同名函数的重载 😃 当然我还是最喜欢Rust了。</li> <li>宏在编译期展开，所以可以用来给 struct 添加 trait，这必须在运行前完成，而函数需要等到运行时才会执行。</li></ul> <p>但是坏处（如果算的话）就是宏更难书写、理解和维护；同时函数可以定义、引入在文件里的任何地方，而在使用宏之前必须确保他被定义、引入到上方的代码中了。</p> <p>下面开始记录宏的写法！</p> <h2 id="声明式宏"><a href="#声明式宏" class="header-anchor">#</a> 声明式宏</h2> <p>在Rust中，应用最广泛的一种宏就是声明式宏，类似于模式匹配的写法，将传入的 Rust 代码与预先指定的模式进行比较，在不同模式下生成不同的代码。</p> <p>使用<code>macro_rules!</code>来定义一个声明式宏。</p> <p>最基础的例子是很常见的<code>vec!</code>：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> v<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>简化版的定义是（实际的版本有其他分支，而且该分支下要预先分配内存防止在push时候再动态分划）</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> vec <span class="token punctuation">{</span>
    <span class="token punctuation">(</span> $<span class="token punctuation">(</span> <span class="token variable">$x</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> temp_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            $<span class="token punctuation">(</span>
                temp_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">)</span><span class="token operator">*</span>
            temp_vec
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>#[macro_export]</code>标签是用来声明：只要 use 了这个crate，就可以使用该宏。同时包含被 export 出的宏的模块，在声明时必须放在前面，否则靠前的模块里找不到这些宏。</p> <p>按照官方文档的说法，<code>macro_rules!</code>目前有一些设计上的问题，日后将推出新的机制来取代他。但是他依然是一个很有效的语法扩展方法。</p> <p>这里一个注意点是：如果想要创建临时变量，那么必须要像上面这个例子这样，放在某个块级作用域内，以便自动清理掉，否则会认为是不安全的行为。</p> <p>:::声明宏中支持的语法树元变量类型</p> <p>出自 <a href="https://doc.rust-lang.org/reference/macros-by-example.html#metavariables" target="_blank" rel="noopener noreferrer">Macros By Example - The Rust Reference<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>回顾编译原理 😃</p> <ul><li><code>item</code>: 随便一个什么 <a href="https://doc.rust-lang.org/reference/items.html" target="_blank" rel="noopener noreferrer">东西<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，准确定义参考上述手册中</li> <li><code>block</code>: 一个 <a href="https://doc.rust-lang.org/reference/expressions/block-expr.html" target="_blank" rel="noopener noreferrer">块表达式<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>stmt</code>: 一个 <a href="https://doc.rust-lang.org/reference/statements.html" target="_blank" rel="noopener noreferrer">语句<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，但是不包含结尾的分号，除了必须有分号的 item statements</li> <li><code>pat_param</code>: 一个 <a href="https://doc.rust-lang.org/reference/patterns.html" target="_blank" rel="noopener noreferrer">匹配模式<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>pat</code>: 等价于 <code>pat_param</code></li> <li><code>expr</code>: 一个 <a href="https://doc.rust-lang.org/reference/expressions.html" target="_blank" rel="noopener noreferrer">表达式<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>ty</code>: 一种 <a href="https://doc.rust-lang.org/reference/types.html#type-expressions" target="_blank" rel="noopener noreferrer">类型<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>ident</code>: 一个 <a href="https://doc.rust-lang.org/reference/identifiers.html" target="_blank" rel="noopener noreferrer">标识符或关键字<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>path</code>: 一条 <a href="https://doc.rust-lang.org/reference/paths.html#paths-in-types" target="_blank" rel="noopener noreferrer">TypePath<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 形式的路径</li> <li><code>tt</code>: <a href="https://doc.rust-lang.org/reference/macros.html#macro-invocation" target="_blank" rel="noopener noreferrer">Token 树<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> （一个独立的 <a href="https://doc.rust-lang.org/reference/tokens.html" target="_blank" rel="noopener noreferrer">token<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或一系列在匹配完整的定界符 <code>()</code>、<code>[]</code> 或 <code>{}</code> 中的 token）</li> <li><code>meta</code>:  <a href="https://doc.rust-lang.org/reference/attributes.html" target="_blank" rel="noopener noreferrer">标签<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中的内容</li> <li><code>lifetime</code>:  一个 <a href="https://doc.rust-lang.org/reference/tokens.html#lifetimes-and-loop-labels" target="_blank" rel="noopener noreferrer">生命周期标识<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>vis</code>: 可能不存在的 <a href="https://doc.rust-lang.org/reference/visibility-and-privacy.html" target="_blank" rel="noopener noreferrer">可见性标记<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（并不是所有函数、类型都会使用 <code>pub</code> 进行标记，所以可能是不存在的）</li> <li><code>literal</code>: 匹配 <a href="https://doc.rust-lang.org/reference/expressions/literal-expr.html" target="_blank" rel="noopener noreferrer">文本表达式<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>:::</p> <h2 id="过程式宏"><a href="#过程式宏" class="header-anchor">#</a> 过程式宏</h2> <p>第二类是过程式的宏，它更像函数，他接受一些代码作为参数输入，然后对他们进行加工，生成新的代码，他不是在做声明式宏那样的模式匹配。三种过程式宏都是这种思路。</p> <p>不能在原始的crate中直接写过程式宏，需要把过程式宏放到一个单独的crate中（以后可能会消除这种约定）。定义过程式宏的方法如下：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> proc_macro<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[some_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">some_name</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>需要引入<code>proc_macro</code> 这个 crate，然后标签是用来声明它是哪种过程式宏的，接着就是一个函数定义，函数接受 <code>TokenStream</code>，返回 <code>TokenStream</code>。<code>TokenStream</code> 类型就定义在 <code>proc_macro</code> 包中，表示 token 序列。除了标准库中的这个包，还可以使用<code>proc_macro2</code> 包，使用 <code>proc_macro2::TokenStream::from()</code> 和 <code>proc_macro::TokenStream::from()</code> 可以很便捷地在两个包的类型间进行转换。使用 <code>proc_macro2</code> 的好处是可以在过程宏外部使用 <code>proc_macro2</code> 的类型，相反 <code>proc_macro</code> 中的类型只可以在过程宏的上下文中使用。且 <code>proc_macro2</code> 写出的宏更容易编写测试代码。</p> <p>下面详细说明如何定义三类过程宏。</p> <h3 id="custom-derive-宏"><a href="#custom-derive-宏" class="header-anchor">#</a> Custom Derive 宏</h3> <p>在本节中，我们的目的是实现下面的代码，使用编译器为我们生成名为 <code>HelloMacro</code> 的 <code>Trait</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">hello_macro<span class="token punctuation">::</span></span><span class="token class-name">HelloMacro</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">hello_macro_derive<span class="token punctuation">::</span></span><span class="token class-name">HelloMacro</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(HelloMacro)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Pancakes</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Pancakes</span><span class="token punctuation">::</span><span class="token function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该 <code>Trait</code> 的定义如下，目的是打印实现该宏的类型名</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">HelloMacro</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由于过程宏不能在原 crate 中实现，我们需要如下在 <code>hello_crate</code> 的目录下新建一个 <code>hello_macro_derive</code> crate</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cargo new hello_macro_derive --lib
</code></pre></div><p>在新的 crate 内，我们需要修改 <code>Cargo.toml</code> 配置文件，</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token key property">proc-macro</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">syn</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
<span class="token key property">quote</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
</code></pre></div><p>在 <code>src/lib.rs</code> 中可以着手实现该宏，其中 <code>syn</code> 是用来解析 rust 代码的，而quote则可以用已有的变量生成代码的 <code>TokenStream</code>，可以认为 <code>quote!</code> 宏内的就是我们想要生成的代码</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">proc_macro</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">proc_macro<span class="token punctuation">::</span></span><span class="token class-name">TokenStream</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">quote<span class="token punctuation">::</span></span>quote<span class="token punctuation">;</span>
<span class="token keyword">use</span> syn<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[proc_macro_derive(HelloMacro)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">hello_macro_derive</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
    <span class="token comment">// Construct a representation of Rust code as a syntax tree</span>
    <span class="token comment">// that we can manipulate</span>
    <span class="token keyword">let</span> ast <span class="token operator">=</span> <span class="token namespace">syn<span class="token punctuation">::</span></span><span class="token function">parse</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build the trait implementation</span>
    <span class="token function">impl_hello_macro</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ast<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">impl_hello_macro</span><span class="token punctuation">(</span>ast<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">syn<span class="token punctuation">::</span></span><span class="token class-name">DeriveInput</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token operator">&amp;</span>ast<span class="token punctuation">.</span>ident<span class="token punctuation">;</span>
    <span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
        <span class="token keyword">impl</span> <span class="token class-name">HelloMacro</span> <span class="token keyword">for</span> #name <span class="token punctuation">{</span>
            <span class="token keyword">fn</span> <span class="token function-definition function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, Macro! My name is {}!&quot;</span><span class="token punctuation">,</span> <span class="token macro property">stringify!</span><span class="token punctuation">(</span>#name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gen<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>另外，<strong>Custom Derive 宏可以携带Attributes，称为 Derive macro helper attributes</strong>，具体编写方法可以参考 <a href="https://doc.rust-lang.org/reference/procedural-macros.html#derive-macro-helper-attributes" target="_blank" rel="noopener noreferrer">Reference<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（Rust 中共有<a href="https://doc.rust-lang.org/reference/attributes.html" target="_blank" rel="noopener noreferrer">四类 Attributes<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。关于 Derive macro helper attributes 这里有一个坑就是在使用 <code>cfg_attr</code> 时，需要把 Attributes 放在宏之前。举个栗子：</p> <p>使用 kube-rs 可以很方便地定义 CRD（Custom Resource Definition）：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(CustomResource, Clone, Debug, Deserialize, Serialize, JsonSchema)]</span>
<span class="token attribute attr-name">#[kube(group = <span class="token string">&quot;clux.dev&quot;</span>, version = <span class="token string">&quot;v1&quot;</span>, kind = <span class="token string">&quot;Foo&quot;</span>, namespaced)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FooSpec</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我第一反应是 #[kube] 在这里是下面提到的 Attribute-Like 宏，但是 kubers 文档才发现是 <code>CustomResource</code> Custom Derive 宏的 Attribute。这里我们想用 <code>cfg_attr</code> 来控制是否去做 derive，一开始就想当然地这么写了：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg_attr(feature=<span class="token string">&quot;use_kube_rs&quot;</span>,
    derive(CustomResource, Clone, Debug, Deserialize, Serialize, JsonSchema),
    kube(group = <span class="token string">&quot;clux.dev&quot;</span>, version = <span class="token string">&quot;v1&quot;</span>, kind = <span class="token string">&quot;Foo&quot;</span>, namespaced)
)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FooSpec</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然而这是错误的打开方式，需要写成：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg_attr(feature=<span class="token string">&quot;use_kube_rs&quot;</span>,
    kube(group = <span class="token string">&quot;clux.dev&quot;</span>, version = <span class="token string">&quot;v1&quot;</span>, kind = <span class="token string">&quot;Foo&quot;</span>, namespaced),
    derive(CustomResource, Clone, Debug, Deserialize, Serialize, JsonSchema)
)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FooSpec</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Attributes 需要写在宏的 derive 前面。</p> <h3 id="attribute-like-宏"><a href="#attribute-like-宏" class="header-anchor">#</a> Attribute-Like 宏</h3> <p>attribute-like 宏和 custom derive 宏很相似，只是标签可以自定义，更加灵活，甚至可以使用在函数上。他的使用方法如下，比如假设有一个宏为 <code>route</code> 的宏</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[route(GET, <span class="token string">&quot;/&quot;</span>)]</span> 
<span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>
</code></pre></div><p>按下面的语法定义 <code>route</code> 宏</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[proc_maco_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">route</span><span class="token punctuation">(</span>attr<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>
</code></pre></div><p>其中 <code>attr</code> 参数是上面的 <code>Get</code>，<code>&quot;/&quot;</code> ；<code>item</code> 参数是 <code>fn index(){}</code> 。</p> <h3 id="function-like-宏"><a href="#function-like-宏" class="header-anchor">#</a> Function-Like 宏</h3> <p>这种宏看上去和 <code>macro_rules!</code> 比较类似，但是在声明式宏只能用 <code>match</code> 去做模式匹配，但是在这里可以有更复杂的解析方式，所以可以写出来</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token macro property">sql!</span><span class="token punctuation">(</span><span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> posts <span class="token constant">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面这个 <code>sql</code> 宏的定义方法如下</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[proc_macro]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sql</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>
</code></pre></div><h2 id="好用的库"><a href="#好用的库" class="header-anchor">#</a> 好用的库</h2> <p><a href="https://doc.rust-lang.org/proc_macro/index.html" target="_blank" rel="noopener noreferrer">proc_macro<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：默认 token 流库，只能在过程宏中使用，编译器要用它，将它作为过程宏的返回值，大多数情况我们不需要，只需要在宏返回结果的时候把 <code>proc_macro2::TokenSteam</code> 的流 <code>into()</code> 到 <code>proc_macro::TokenSteam</code> 就行了。</p> <p><a href="https://crates.io/crates/proc_macro2" target="_blank" rel="noopener noreferrer">proc_macro2<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：我们真正在使用的过程宏库，可以在过程宏外使用。</p> <p><a href="https://crates.io/crates/syn" target="_blank" rel="noopener noreferrer">syn<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：过程宏左护法，可以将 <code>TokenStream</code> 解析成语法树，注意两个 <code>proc_macro</code> 和 <code>proc_macro</code> 都支持，需要看文档搞清楚库函数到底是在解析哪个库中的 <code>TokenStream</code>。</p> <p><a href="https://crates.io/crates/quote" target="_blank" rel="noopener noreferrer">quote<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：过程宏右护法，将语法树解析成 <code>TokenStream</code>。只要一个 <code>quote!{}</code> 就够了！<code>quote!{}</code> 宏内都是字面量，即纯纯的代码，要替换进去的变量是用的 <code>#</code> 符号标注，为了和声明宏中使用的 <code>$</code> 相区分（也就意味着用 <code>quote</code> 写过程宏的时候，可以和声明宏结合 🤤 ）。模式匹配时用到的表示重复的符号和声明宏中一样，是使用 <code>*</code>。</p> <p><a href="https://crates.io/crates/darling" target="_blank" rel="noopener noreferrer">darling<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 好用到跺 jio jio 的标签宏解析库，让人直呼 Darling！</p> <h2 id="收录有趣的宏样例"><a href="#收录有趣的宏样例" class="header-anchor">#</a> 收录有趣的宏样例</h2> <p>本章收录到的宏尽可能短小、独立、有趣。</p> <h3 id="你这写的啥啊"><a href="#你这写的啥啊" class="header-anchor">#</a> 你这写的啥啊</h3> <p>记录一下自己写的一些有趣的宏，以防下次碰到这种情况忘记咋写。</p> <ul><li><p>这里的实际需求是处理标签宏参数，用了 <a href="https://crates.io/crates/darling" target="_blank" rel="noopener noreferrer">darling<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 库做解析，然后处理一些 <code>Option</code> 类型的可选参数，如果标签宏参数中没有它（即 <code>darling</code> 解析出 <code>None</code>），就不理会它，在后续构造中使用默认值。感觉有意思的地方在于过程宏和声明宏的混合使用，在写出来之前我没想到这么写真能跑 = =</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">macro_rules!</span> expand_attribute <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$attr</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> token <span class="token operator">=</span> <span class="token class-name">TokenStream2</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            $<span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$attr</span> <span class="token punctuation">{</span>
                token<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token macro property">quote!</span><span class="token punctuation">{</span><span class="token variable">$attr</span><span class="token punctuation">:</span> #val<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">*</span>
            token
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用时是这么用的</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">darling<span class="token punctuation">::</span></span><span class="token class-name">FromMeta</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug, FromMeta)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Attrs</span><span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[darling(default)]</span>
    <span class="token keyword">pub</span> param1<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[darling(default)]</span>
    <span class="token keyword">pub</span> param2<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[darling(default)]</span>
    <span class="token keyword">pub</span> param3<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug, Default)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Struct</span><span class="token punctuation">{</span>
    <span class="token keyword">pub</span> param1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> param2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> neccessary<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// cannot be empty or any default value</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[proc_macro_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">an_attribute</span><span class="token punctuation">(</span>attr<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token class-name">Attrs</span> <span class="token punctuation">{</span>
        param1<span class="token punctuation">,</span> 
        param2<span class="token punctuation">,</span> 
        <span class="token punctuation">...</span> <span class="token comment">// Attrs::param3 is not useful in Struct</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span>  <span class="token keyword">match</span> <span class="token class-name">Attrs</span><span class="token punctuation">::</span><span class="token function">from_list</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">,</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">TokenStream</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">write_errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> optional_params <span class="token operator">=</span> <span class="token macro property">expand_attribute!</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> build_a_struct <span class="token operator">=</span> <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
        <span class="token class-name">Struct</span> <span class="token punctuation">{</span>
            neccessary<span class="token punctuation">:</span> <span class="token string">&quot;0817&quot;</span><span class="token punctuation">,</span> 
            #optional_params
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// TL;DR</span>
<span class="token punctuation">}</span>
</code></pre></div><p>看得出来还是比较繁琐的，</p></li> <li><p>这里的实际需求是用标签宏修改原函数返回值为 Result，是在 <a href="https://github.com/sentinel-group/sentinel-rust" target="_blank" rel="noopener noreferrer">sentinel-group/sentinel-rust<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的实现中，用来快速给一个函数或方法创建 sentinel 的。当时的想法是用 Result 来表达某个流是否被阻碍，同时可以传递 Sentinel 的告警给用户，实现出来的很垃圾，可以说是只支持使用一个规则。没有试过多个这样的标签宏嵌套，但是估计是回调地狱重现世间 😅 （或许可以用 <code>std::Result::flatten()</code> 来避免，但是它目前还是 nightly 的 API）。</p> <p>这里的实现也有点蠢，是用的 quote 和 syn 自动解析的修改后的函数签名，尝试过手动构造，但是太恶心了构造不来。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">process_func</span><span class="token punctuation">(</span><span class="token keyword">mut</span> func<span class="token punctuation">:</span> <span class="token class-name">ItemFn</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ItemFn</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> output <span class="token operator">=</span> func<span class="token punctuation">.</span>sig<span class="token punctuation">.</span>output<span class="token punctuation">;</span>
    <span class="token comment">// Currently, use quote/syn to automatically generate it,</span>
    <span class="token comment">// don't know if there is a better way.</span>
    <span class="token comment">// Seems hard to parse new ReturnType only or construct ReturnType by hand.</span>
    <span class="token keyword">let</span> dummy_func <span class="token operator">=</span> <span class="token keyword">match</span> output <span class="token punctuation">{</span>
        <span class="token class-name">ReturnType</span><span class="token punctuation">::</span><span class="token class-name">Default</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
                <span class="token keyword">fn</span> <span class="token function-definition function">dummy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ReturnType</span><span class="token punctuation">::</span><span class="token class-name">Type</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> return_type<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
                <span class="token keyword">fn</span> <span class="token function-definition function">dummy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span>#return_type<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dummy_func<span class="token punctuation">:</span> <span class="token class-name">ItemFn</span> <span class="token operator">=</span> <span class="token namespace">syn<span class="token punctuation">::</span></span><span class="token function">parse2</span><span class="token punctuation">(</span>dummy_func<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// replace the old ReturnType to the dummy function ReturnType</span>
    func<span class="token punctuation">.</span>sig<span class="token punctuation">.</span>output <span class="token operator">=</span> dummy_func<span class="token punctuation">.</span>sig<span class="token punctuation">.</span>output<span class="token punctuation">;</span>
    func
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="还得学习一个"><a href="#还得学习一个" class="header-anchor">#</a> 还得学习一个</h3> <p>本章节抄录一些别人写的黑魔法宏。</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <p><a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener noreferrer">Macros - The Rust Programming Language (rust-lang.org)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://doc.rust-lang.org/reference/macros.html" target="_blank" rel="noopener noreferrer">Macros - The Rust Reference (rust-lang.org)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://danielkeep.github.io/tlborm/book/index.html" target="_blank" rel="noopener noreferrer">The Little Book of Rust Macros (danielkeep.github.io)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://dengjianping.github.io/2019/02/28/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%BF%87%E7%A8%8B%E5%AE%8F(proc-macro).html" target="_blank" rel="noopener noreferrer">如何编写一个过程宏(proc-macro)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/2/15 下午12:23:37</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.64e41af0.js" defer></script><script src="/assets/js/1.b822baa6.js" defer></script><script src="/assets/js/58.7cee13f9.js" defer></script><script src="/assets/js/12.331c1b95.js" defer></script>
  </body>
</html>
