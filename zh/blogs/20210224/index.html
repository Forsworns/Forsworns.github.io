<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rustå®å­¦ä¹ ç¬”è®° | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.5f87357d.css" as="style"><link rel="preload" href="/assets/js/app.a390c3bc.js" as="script"><link rel="preload" href="/assets/js/1.489a6dc0.js" as="script"><link rel="preload" href="/assets/js/59.1b42ac73.js" as="script"><link rel="preload" href="/assets/js/13.e56158ac.js" as="script"><link rel="prefetch" href="/assets/js/10.0a8552e5.js"><link rel="prefetch" href="/assets/js/11.7544d912.js"><link rel="prefetch" href="/assets/js/12.4abf2689.js"><link rel="prefetch" href="/assets/js/14.84181d18.js"><link rel="prefetch" href="/assets/js/15.dab14606.js"><link rel="prefetch" href="/assets/js/16.98da8228.js"><link rel="prefetch" href="/assets/js/17.0ba0e8e3.js"><link rel="prefetch" href="/assets/js/18.d2c98111.js"><link rel="prefetch" href="/assets/js/19.86bdbfa9.js"><link rel="prefetch" href="/assets/js/20.22caf17f.js"><link rel="prefetch" href="/assets/js/21.c75712be.js"><link rel="prefetch" href="/assets/js/22.c0c99274.js"><link rel="prefetch" href="/assets/js/23.214355cd.js"><link rel="prefetch" href="/assets/js/24.a9557518.js"><link rel="prefetch" href="/assets/js/25.fb756fe5.js"><link rel="prefetch" href="/assets/js/26.88bc672c.js"><link rel="prefetch" href="/assets/js/27.a047953c.js"><link rel="prefetch" href="/assets/js/28.0aa927b7.js"><link rel="prefetch" href="/assets/js/29.599475e0.js"><link rel="prefetch" href="/assets/js/3.db885a38.js"><link rel="prefetch" href="/assets/js/30.ac4304d9.js"><link rel="prefetch" href="/assets/js/31.378fb91c.js"><link rel="prefetch" href="/assets/js/32.72e1c0ea.js"><link rel="prefetch" href="/assets/js/33.358b985a.js"><link rel="prefetch" href="/assets/js/34.92d54470.js"><link rel="prefetch" href="/assets/js/35.3ee5ae15.js"><link rel="prefetch" href="/assets/js/36.f3bd4bb7.js"><link rel="prefetch" href="/assets/js/37.27456d40.js"><link rel="prefetch" href="/assets/js/38.ac3e3512.js"><link rel="prefetch" href="/assets/js/39.623032e6.js"><link rel="prefetch" href="/assets/js/4.5ebe3061.js"><link rel="prefetch" href="/assets/js/40.81db8d94.js"><link rel="prefetch" href="/assets/js/41.dcc11868.js"><link rel="prefetch" href="/assets/js/42.5ad0c9c8.js"><link rel="prefetch" href="/assets/js/43.d8a7f45f.js"><link rel="prefetch" href="/assets/js/44.78c0feaa.js"><link rel="prefetch" href="/assets/js/45.1b1f0dc8.js"><link rel="prefetch" href="/assets/js/46.eed83510.js"><link rel="prefetch" href="/assets/js/47.6eac4cc5.js"><link rel="prefetch" href="/assets/js/48.b7e6b32a.js"><link rel="prefetch" href="/assets/js/49.bbb7666a.js"><link rel="prefetch" href="/assets/js/5.86d38cb0.js"><link rel="prefetch" href="/assets/js/50.2f8f6c98.js"><link rel="prefetch" href="/assets/js/51.cd539748.js"><link rel="prefetch" href="/assets/js/52.a4605abf.js"><link rel="prefetch" href="/assets/js/53.027cd8a1.js"><link rel="prefetch" href="/assets/js/54.d7e6f527.js"><link rel="prefetch" href="/assets/js/55.fdbf2d23.js"><link rel="prefetch" href="/assets/js/56.b88cb66b.js"><link rel="prefetch" href="/assets/js/57.eaebbeb1.js"><link rel="prefetch" href="/assets/js/58.a8aab8e9.js"><link rel="prefetch" href="/assets/js/6.834bec42.js"><link rel="prefetch" href="/assets/js/60.1602d25a.js"><link rel="prefetch" href="/assets/js/61.cf2b696f.js"><link rel="prefetch" href="/assets/js/62.8659cf17.js"><link rel="prefetch" href="/assets/js/63.00655be8.js"><link rel="prefetch" href="/assets/js/64.669e347b.js"><link rel="prefetch" href="/assets/js/65.2bf8094b.js"><link rel="prefetch" href="/assets/js/66.327070d4.js"><link rel="prefetch" href="/assets/js/67.810b2fee.js"><link rel="prefetch" href="/assets/js/68.e3476a72.js"><link rel="prefetch" href="/assets/js/69.35da038b.js"><link rel="prefetch" href="/assets/js/7.edffe57c.js"><link rel="prefetch" href="/assets/js/70.75827cae.js"><link rel="prefetch" href="/assets/js/71.225214a5.js"><link rel="prefetch" href="/assets/js/72.a84f7192.js"><link rel="prefetch" href="/assets/js/73.ffe311be.js"><link rel="prefetch" href="/assets/js/74.3b69b9c2.js"><link rel="prefetch" href="/assets/js/75.aaf712aa.js"><link rel="prefetch" href="/assets/js/76.c3292f62.js"><link rel="prefetch" href="/assets/js/77.7fb25a78.js"><link rel="prefetch" href="/assets/js/8.2fb98e50.js"><link rel="prefetch" href="/assets/js/9.c640c61b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5f87357d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  ä¸»é¡µ
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  å…³äºæˆ‘
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="åšå®¢" class="dropdown-title"><span class="title">åšå®¢</span> <span class="arrow down"></span></button> <button type="button" aria-label="åšå®¢" class="mobile-dropdown-title"><span class="title">åšå®¢</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  æ‰€æœ‰åšå®¢
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  æ ‡ç­¾åˆ†ç±»
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210224/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  ç®€ä½“ä¸­æ–‡
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  ä¸»é¡µ
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  å…³äºæˆ‘
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="åšå®¢" class="dropdown-title"><span class="title">åšå®¢</span> <span class="arrow down"></span></button> <button type="button" aria-label="åšå®¢" class="mobile-dropdown-title"><span class="title">åšå®¢</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  æ‰€æœ‰åšå®¢
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  æ ‡ç­¾åˆ†ç±»
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210224/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  ç®€ä½“ä¸­æ–‡
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#rustä¸­å®çš„åˆ†ç±»">Rustä¸­å®çš„åˆ†ç±»</a></li><li><a href="#å£°æ˜å¼å®">å£°æ˜å¼å®</a></li><li><a href="#è¿‡ç¨‹å¼å®">è¿‡ç¨‹å¼å®</a><ul><li><a href="#custom-derive-å®">Custom Derive å®</a></li><li><a href="#attribute-like-å®">Attribute-Like å®</a></li><li><a href="#function-like-å®">Function-Like å®</a></li></ul></li><li><a href="#å¥½ç”¨çš„åº“">å¥½ç”¨çš„åº“</a></li><li><a href="#æ”¶å½•æœ‰è¶£çš„å®æ ·ä¾‹">æ”¶å½•æœ‰è¶£çš„å®æ ·ä¾‹</a><ul><li><a href="#ä½ è¿™å†™çš„å•¥å•Š">ä½ è¿™å†™çš„å•¥å•Š</a></li><li><a href="#è¿˜å¾—å­¦ä¹ ä¸€ä¸ª">è¿˜å¾—å­¦ä¹ ä¸€ä¸ª</a></li></ul></li><li><a href="#references">References</a></li></ul></div><p></p> <h1 id="rustå®å­¦ä¹ ç¬”è®°"><a href="#rustå®å­¦ä¹ ç¬”è®°" class="header-anchor">#</a> Rustå®å­¦ä¹ ç¬”è®°</h1> <p>å‰é¢çš„éƒ¨åˆ†åŸºæœ¬æ˜¯ Rust è¯­è¨€æ‰‹å†Œç¿»è¯‘ã€‚</p> <p>Rust ä¸­çš„å®ç›¸è¾ƒC++æ›´ä¸ºå¼ºå¤§ã€‚C++ ä¸­çš„å®åœ¨é¢„å¤„ç†é˜¶æ®µå¯ä»¥å±•å¼€ä¸ºæ–‡æœ¬ï¼ŒRust çš„å®åˆ™æ˜¯å¯¹è¯­æ³•çš„æ‰©å±•ï¼Œæ˜¯åœ¨æ„å»ºè¯­æ³•æ ‘æ—¶ï¼Œæ‰å±•å¼€çš„å®ã€‚</p> <h2 id="rustä¸­å®çš„åˆ†ç±»"><a href="#rustä¸­å®çš„åˆ†ç±»" class="header-anchor">#</a> Rustä¸­å®çš„åˆ†ç±»</h2> <p>Rust ä¸­å®å¯ä»¥åˆ†ä¸ºå¾ˆå¤šç±»ï¼ŒåŒ…æ‹¬é€šè¿‡ macro_rules å®šä¹‰çš„<strong>å£°æ˜å¼å®</strong>å’Œä¸‰ç§<strong>è¿‡ç¨‹å¼å®</strong></p> <ul><li>custom derive å¯æ¨å¯¼å®ï¼Œå€ŸåŠ© <code>#[derive]</code> å±æ€§æ ‡ç­¾ï¼Œå®ƒå¯ä»¥ç”¨åœ¨ struct å’Œ enum ä¸Š</li> <li>attribute-like æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ ‡ç­¾ï¼Œå¯ä»¥ä½œç”¨äºä»»ä½•åœ°æ–¹</li> <li>function-like çœ‹ä¸Šå»åƒå‡½æ•°ï¼Œä½†æ˜¯ä½œç”¨åœ¨ token ä¸Šï¼Œå³æŠŠtokenä½œä¸ºå‡½æ•°å‚æ•°</li></ul> <p>æ‰€ä»¥ä¸ºä»€ä¹ˆéœ€è¦å®ï¼Ÿ</p> <p>ä¸ºäº†å·æ‡’ã€ä¸ºäº†è®©ä»£ç æ›´ç®€æ´ã€‚ä½¿ç”¨å®å¯ä»¥å¿«é€Ÿç”Ÿæˆå¤§é‡ä»£ç ï¼Œé¿å…é‡å¤åŠ³åŠ¨ã€‚Rust å®æ‰©å±•äº†è¯­æ³•ï¼Œä½ æ˜¯ä¸ä¼šæƒ³è¦æ¯æ¬¡éƒ½è€è€å®å®åœ°å†™ç¹å¤çš„ä»£ç çš„ï¼Œæ‰€ä»¥å­¦ä¸€ç‚¹é­”æ³•ï¼</p> <p>ä¸ºä»€ä¹ˆä¸ç”¨å‡½æ•°æˆ–è€…æ¨¡æ¿ï¼Ÿ</p> <ul><li>Rust çš„å‡½æ•°å¿…é¡»é™å®šå¥½å‚æ•°ç±»å‹å’Œå‚æ•°ä¸ªæ•°ï¼Œè€Œä¸”ä»–å¹¶æ²¡æœ‰æä¾›å˜é•¿æ¨¡æ¿å‚æ•°ï¼Œæ‰€ä»¥å˜›ï¼Œå“ˆå“ˆã€‚äº‹å®ä¸Šæœ‰ä¸å°‘åº“ä¸ºäº†åº”å¯¹æœªçŸ¥ä¸ªæ•°å‚æ•°çš„æƒ…å†µï¼Œæ‰‹å†™äº†ä¸åŒä¸ªæ•°å‚æ•°çš„å‡½æ•°ï¼Œè€Œä¸”å¾ˆè›‹ç–¼çš„æ˜¯ Rust ä¹Ÿä¸å…è®¸åŒåå‡½æ•°çš„é‡è½½ ğŸ˜ƒ å½“ç„¶æˆ‘è¿˜æ˜¯æœ€å–œæ¬¢Rustäº†ã€‚</li> <li>å®åœ¨ç¼–è¯‘æœŸå±•å¼€ï¼Œæ‰€ä»¥å¯ä»¥ç”¨æ¥ç»™ struct æ·»åŠ  traitï¼Œè¿™å¿…é¡»åœ¨è¿è¡Œå‰å®Œæˆï¼Œè€Œå‡½æ•°éœ€è¦ç­‰åˆ°è¿è¡Œæ—¶æ‰ä¼šæ‰§è¡Œã€‚</li></ul> <p>ä½†æ˜¯åå¤„ï¼ˆå¦‚æœç®—çš„è¯ï¼‰å°±æ˜¯å®æ›´éš¾ä¹¦å†™ã€ç†è§£å’Œç»´æŠ¤ï¼›åŒæ—¶å‡½æ•°å¯ä»¥å®šä¹‰ã€å¼•å…¥åœ¨æ–‡ä»¶é‡Œçš„ä»»ä½•åœ°æ–¹ï¼Œè€Œåœ¨ä½¿ç”¨å®ä¹‹å‰å¿…é¡»ç¡®ä¿ä»–è¢«å®šä¹‰ã€å¼•å…¥åˆ°ä¸Šæ–¹çš„ä»£ç ä¸­äº†ã€‚</p> <p>ä¸‹é¢å¼€å§‹è®°å½•å®çš„å†™æ³•ï¼</p> <h2 id="å£°æ˜å¼å®"><a href="#å£°æ˜å¼å®" class="header-anchor">#</a> å£°æ˜å¼å®</h2> <p>åœ¨Rustä¸­ï¼Œåº”ç”¨æœ€å¹¿æ³›çš„ä¸€ç§å®å°±æ˜¯å£°æ˜å¼å®ï¼Œç±»ä¼¼äºæ¨¡å¼åŒ¹é…çš„å†™æ³•ï¼Œå°†ä¼ å…¥çš„ Rust ä»£ç ä¸é¢„å…ˆæŒ‡å®šçš„æ¨¡å¼è¿›è¡Œæ¯”è¾ƒï¼Œåœ¨ä¸åŒæ¨¡å¼ä¸‹ç”Ÿæˆä¸åŒçš„ä»£ç ã€‚</p> <p>ä½¿ç”¨<code>macro_rules!</code>æ¥å®šä¹‰ä¸€ä¸ªå£°æ˜å¼å®ã€‚</p> <p>æœ€åŸºç¡€çš„ä¾‹å­æ˜¯å¾ˆå¸¸è§çš„<code>vec!</code>ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> v<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u32</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>ç®€åŒ–ç‰ˆçš„å®šä¹‰æ˜¯ï¼ˆå®é™…çš„ç‰ˆæœ¬æœ‰å…¶ä»–åˆ†æ”¯ï¼Œè€Œä¸”è¯¥åˆ†æ”¯ä¸‹è¦é¢„å…ˆåˆ†é…å†…å­˜é˜²æ­¢åœ¨pushæ—¶å€™å†åŠ¨æ€åˆ†åˆ’ï¼‰</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[macro_export]</span>
<span class="token macro property">macro_rules!</span> vec <span class="token punctuation">{</span>
    <span class="token punctuation">(</span> $<span class="token punctuation">(</span> <span class="token variable">$x</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span> <span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> temp_vec <span class="token operator">=</span> <span class="token class-name">Vec</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            $<span class="token punctuation">(</span>
                temp_vec<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">)</span><span class="token operator">*</span>
            temp_vec
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>#[macro_export]</code>æ ‡ç­¾æ˜¯ç”¨æ¥å£°æ˜ï¼šåªè¦ use äº†è¿™ä¸ªcrateï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥å®ã€‚åŒæ—¶åŒ…å«è¢« export å‡ºçš„å®çš„æ¨¡å—ï¼Œåœ¨å£°æ˜æ—¶å¿…é¡»æ”¾åœ¨å‰é¢ï¼Œå¦åˆ™é å‰çš„æ¨¡å—é‡Œæ‰¾ä¸åˆ°è¿™äº›å®ã€‚</p> <p>æŒ‰ç…§å®˜æ–¹æ–‡æ¡£çš„è¯´æ³•ï¼Œ<code>macro_rules!</code>ç›®å‰æœ‰ä¸€äº›è®¾è®¡ä¸Šçš„é—®é¢˜ï¼Œæ—¥åå°†æ¨å‡ºæ–°çš„æœºåˆ¶æ¥å–ä»£ä»–ã€‚ä½†æ˜¯ä»–ä¾ç„¶æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ•ˆçš„è¯­æ³•æ‰©å±•æ–¹æ³•ã€‚</p> <p>è¿™é‡Œä¸€ä¸ªæ³¨æ„ç‚¹æ˜¯ï¼šå¦‚æœæƒ³è¦åˆ›å»ºä¸´æ—¶å˜é‡ï¼Œé‚£ä¹ˆå¿…é¡»è¦åƒä¸Šé¢è¿™ä¸ªä¾‹å­è¿™æ ·ï¼Œæ”¾åœ¨æŸä¸ªå—çº§ä½œç”¨åŸŸå†…ï¼Œä»¥ä¾¿è‡ªåŠ¨æ¸…ç†æ‰ï¼Œå¦åˆ™ä¼šè®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„è¡Œä¸ºã€‚</p> <p>:::å£°æ˜å®ä¸­æ”¯æŒçš„è¯­æ³•æ ‘å…ƒå˜é‡ç±»å‹</p> <p>å‡ºè‡ª <a href="https://doc.rust-lang.org/reference/macros-by-example.html#metavariables" target="_blank" rel="noopener noreferrer">Macros By Example - The Rust Reference<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚</p> <p>å›é¡¾ç¼–è¯‘åŸç† ğŸ˜ƒ</p> <ul><li><code>item</code>: éšä¾¿ä¸€ä¸ªä»€ä¹ˆ <a href="https://doc.rust-lang.org/reference/items.html" target="_blank" rel="noopener noreferrer">ä¸œè¥¿<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œå‡†ç¡®å®šä¹‰å‚è€ƒä¸Šè¿°æ‰‹å†Œä¸­</li> <li><code>block</code>: ä¸€ä¸ª <a href="https://doc.rust-lang.org/reference/expressions/block-expr.html" target="_blank" rel="noopener noreferrer">å—è¡¨è¾¾å¼<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>stmt</code>: ä¸€ä¸ª <a href="https://doc.rust-lang.org/reference/statements.html" target="_blank" rel="noopener noreferrer">è¯­å¥<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œä½†æ˜¯ä¸åŒ…å«ç»“å°¾çš„åˆ†å·ï¼Œé™¤äº†å¿…é¡»æœ‰åˆ†å·çš„ item statements</li> <li><code>pat_param</code>: ä¸€ä¸ª <a href="https://doc.rust-lang.org/reference/patterns.html" target="_blank" rel="noopener noreferrer">åŒ¹é…æ¨¡å¼<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>pat</code>: ç­‰ä»·äº <code>pat_param</code></li> <li><code>expr</code>: ä¸€ä¸ª <a href="https://doc.rust-lang.org/reference/expressions.html" target="_blank" rel="noopener noreferrer">è¡¨è¾¾å¼<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>ty</code>: ä¸€ç§ <a href="https://doc.rust-lang.org/reference/types.html#type-expressions" target="_blank" rel="noopener noreferrer">ç±»å‹<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>ident</code>: ä¸€ä¸ª <a href="https://doc.rust-lang.org/reference/identifiers.html" target="_blank" rel="noopener noreferrer">æ ‡è¯†ç¬¦æˆ–å…³é”®å­—<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>path</code>: ä¸€æ¡ <a href="https://doc.rust-lang.org/reference/paths.html#paths-in-types" target="_blank" rel="noopener noreferrer">TypePath<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> å½¢å¼çš„è·¯å¾„</li> <li><code>tt</code>: <a href="https://doc.rust-lang.org/reference/macros.html#macro-invocation" target="_blank" rel="noopener noreferrer">Token æ ‘<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ï¼ˆä¸€ä¸ªç‹¬ç«‹çš„ <a href="https://doc.rust-lang.org/reference/tokens.html" target="_blank" rel="noopener noreferrer">token<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> æˆ–ä¸€ç³»åˆ—åœ¨åŒ¹é…å®Œæ•´çš„å®šç•Œç¬¦ <code>()</code>ã€<code>[]</code> æˆ– <code>{}</code> ä¸­çš„ tokenï¼‰</li> <li><code>meta</code>:  <a href="https://doc.rust-lang.org/reference/attributes.html" target="_blank" rel="noopener noreferrer">æ ‡ç­¾<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ä¸­çš„å†…å®¹</li> <li><code>lifetime</code>:  ä¸€ä¸ª <a href="https://doc.rust-lang.org/reference/tokens.html#lifetimes-and-loop-labels" target="_blank" rel="noopener noreferrer">ç”Ÿå‘½å‘¨æœŸæ ‡è¯†<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><code>vis</code>: å¯èƒ½ä¸å­˜åœ¨çš„ <a href="https://doc.rust-lang.org/reference/visibility-and-privacy.html" target="_blank" rel="noopener noreferrer">å¯è§æ€§æ ‡è®°<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼ˆå¹¶ä¸æ˜¯æ‰€æœ‰å‡½æ•°ã€ç±»å‹éƒ½ä¼šä½¿ç”¨ <code>pub</code> è¿›è¡Œæ ‡è®°ï¼Œæ‰€ä»¥å¯èƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼‰</li> <li><code>literal</code>: åŒ¹é… <a href="https://doc.rust-lang.org/reference/expressions/literal-expr.html" target="_blank" rel="noopener noreferrer">æ–‡æœ¬è¡¨è¾¾å¼<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>:::</p> <h2 id="è¿‡ç¨‹å¼å®"><a href="#è¿‡ç¨‹å¼å®" class="header-anchor">#</a> è¿‡ç¨‹å¼å®</h2> <p>ç¬¬äºŒç±»æ˜¯è¿‡ç¨‹å¼çš„å®ï¼Œå®ƒæ›´åƒå‡½æ•°ï¼Œä»–æ¥å—ä¸€äº›ä»£ç ä½œä¸ºå‚æ•°è¾“å…¥ï¼Œç„¶åå¯¹ä»–ä»¬è¿›è¡ŒåŠ å·¥ï¼Œç”Ÿæˆæ–°çš„ä»£ç ï¼Œä»–ä¸æ˜¯åœ¨åšå£°æ˜å¼å®é‚£æ ·çš„æ¨¡å¼åŒ¹é…ã€‚ä¸‰ç§è¿‡ç¨‹å¼å®éƒ½æ˜¯è¿™ç§æ€è·¯ã€‚</p> <p>ä¸èƒ½åœ¨åŸå§‹çš„crateä¸­ç›´æ¥å†™è¿‡ç¨‹å¼å®ï¼Œéœ€è¦æŠŠè¿‡ç¨‹å¼å®æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„crateä¸­ï¼ˆä»¥åå¯èƒ½ä¼šæ¶ˆé™¤è¿™ç§çº¦å®šï¼‰ã€‚å®šä¹‰è¿‡ç¨‹å¼å®çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> proc_macro<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[some_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">some_name</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>éœ€è¦å¼•å…¥<code>proc_macro</code> è¿™ä¸ª crateï¼Œç„¶åæ ‡ç­¾æ˜¯ç”¨æ¥å£°æ˜å®ƒæ˜¯å“ªç§è¿‡ç¨‹å¼å®çš„ï¼Œæ¥ç€å°±æ˜¯ä¸€ä¸ªå‡½æ•°å®šä¹‰ï¼Œå‡½æ•°æ¥å— <code>TokenStream</code>ï¼Œè¿”å› <code>TokenStream</code>ã€‚<code>TokenStream</code> ç±»å‹å°±å®šä¹‰åœ¨ <code>proc_macro</code> åŒ…ä¸­ï¼Œè¡¨ç¤º token åºåˆ—ã€‚é™¤äº†æ ‡å‡†åº“ä¸­çš„è¿™ä¸ªåŒ…ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>proc_macro2</code> åŒ…ï¼Œä½¿ç”¨ <code>proc_macro2::TokenStream::from()</code> å’Œ <code>proc_macro::TokenStream::from()</code> å¯ä»¥å¾ˆä¾¿æ·åœ°åœ¨ä¸¤ä¸ªåŒ…çš„ç±»å‹é—´è¿›è¡Œè½¬æ¢ã€‚ä½¿ç”¨ <code>proc_macro2</code> çš„å¥½å¤„æ˜¯å¯ä»¥åœ¨è¿‡ç¨‹å®å¤–éƒ¨ä½¿ç”¨ <code>proc_macro2</code> çš„ç±»å‹ï¼Œç›¸å <code>proc_macro</code> ä¸­çš„ç±»å‹åªå¯ä»¥åœ¨è¿‡ç¨‹å®çš„ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨ã€‚ä¸” <code>proc_macro2</code> å†™å‡ºçš„å®æ›´å®¹æ˜“ç¼–å†™æµ‹è¯•ä»£ç ã€‚</p> <p>ä¸‹é¢è¯¦ç»†è¯´æ˜å¦‚ä½•å®šä¹‰ä¸‰ç±»è¿‡ç¨‹å®ã€‚</p> <h3 id="custom-derive-å®"><a href="#custom-derive-å®" class="header-anchor">#</a> Custom Derive å®</h3> <p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯å®ç°ä¸‹é¢çš„ä»£ç ï¼Œä½¿ç”¨ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬ç”Ÿæˆåä¸º <code>HelloMacro</code> çš„ <code>Trait</code></p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">hello_macro<span class="token punctuation">::</span></span><span class="token class-name">HelloMacro</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">hello_macro_derive<span class="token punctuation">::</span></span><span class="token class-name">HelloMacro</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(HelloMacro)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Pancakes</span><span class="token punctuation">;</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Pancakes</span><span class="token punctuation">::</span><span class="token function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¯¥ <code>Trait</code> çš„å®šä¹‰å¦‚ä¸‹ï¼Œç›®çš„æ˜¯æ‰“å°å®ç°è¯¥å®çš„ç±»å‹å</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">HelloMacro</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç”±äºè¿‡ç¨‹å®ä¸èƒ½åœ¨åŸ crate ä¸­å®ç°ï¼Œæˆ‘ä»¬éœ€è¦å¦‚ä¸‹åœ¨ <code>hello_crate</code> çš„ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ª <code>hello_macro_derive</code> crate</p> <div class="language-bash extra-class"><pre class="language-bash"><code>cargo new hello_macro_derive --lib
</code></pre></div><p>åœ¨æ–°çš„ crate å†…ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ <code>Cargo.toml</code> é…ç½®æ–‡ä»¶ï¼Œ</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token punctuation">[</span><span class="token table class-name">lib</span><span class="token punctuation">]</span>
<span class="token key property">proc-macro</span> <span class="token punctuation">=</span> <span class="token boolean">true</span>

<span class="token punctuation">[</span><span class="token table class-name">dependencies</span><span class="token punctuation">]</span>
<span class="token key property">syn</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
<span class="token key property">quote</span> <span class="token punctuation">=</span> <span class="token string">&quot;1.0&quot;</span>
</code></pre></div><p>åœ¨ <code>src/lib.rs</code> ä¸­å¯ä»¥ç€æ‰‹å®ç°è¯¥å®ï¼Œå…¶ä¸­ <code>syn</code> æ˜¯ç”¨æ¥è§£æ rust ä»£ç çš„ï¼Œè€Œquoteåˆ™å¯ä»¥ç”¨å·²æœ‰çš„å˜é‡ç”Ÿæˆä»£ç çš„ <code>TokenStream</code>ï¼Œå¯ä»¥è®¤ä¸º <code>quote!</code> å®å†…çš„å°±æ˜¯æˆ‘ä»¬æƒ³è¦ç”Ÿæˆçš„ä»£ç </p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">extern</span> <span class="token keyword">crate</span> <span class="token module-declaration namespace">proc_macro</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token namespace">proc_macro<span class="token punctuation">::</span></span><span class="token class-name">TokenStream</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">quote<span class="token punctuation">::</span></span>quote<span class="token punctuation">;</span>
<span class="token keyword">use</span> syn<span class="token punctuation">;</span>

<span class="token attribute attr-name">#[proc_macro_derive(HelloMacro)]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">hello_macro_derive</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
    <span class="token comment">// Construct a representation of Rust code as a syntax tree</span>
    <span class="token comment">// that we can manipulate</span>
    <span class="token keyword">let</span> ast <span class="token operator">=</span> <span class="token namespace">syn<span class="token punctuation">::</span></span><span class="token function">parse</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Build the trait implementation</span>
    <span class="token function">impl_hello_macro</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ast<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">impl_hello_macro</span><span class="token punctuation">(</span>ast<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">syn<span class="token punctuation">::</span></span><span class="token class-name">DeriveInput</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token operator">&amp;</span>ast<span class="token punctuation">.</span>ident<span class="token punctuation">;</span>
    <span class="token keyword">let</span> gen <span class="token operator">=</span> <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
        <span class="token keyword">impl</span> <span class="token class-name">HelloMacro</span> <span class="token keyword">for</span> #name <span class="token punctuation">{</span>
            <span class="token keyword">fn</span> <span class="token function-definition function">hello_macro</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;Hello, Macro! My name is {}!&quot;</span><span class="token punctuation">,</span> <span class="token macro property">stringify!</span><span class="token punctuation">(</span>#name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    gen<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦å¤–ï¼Œ<strong>Custom Derive å®å¯ä»¥æºå¸¦Attributesï¼Œç§°ä¸º Derive macro helper attributes</strong>ï¼Œå…·ä½“ç¼–å†™æ–¹æ³•å¯ä»¥å‚è€ƒ <a href="https://doc.rust-lang.org/reference/procedural-macros.html#derive-macro-helper-attributes" target="_blank" rel="noopener noreferrer">Reference<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼ˆRust ä¸­å…±æœ‰<a href="https://doc.rust-lang.org/reference/attributes.html" target="_blank" rel="noopener noreferrer">å››ç±» Attributes<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼‰ã€‚å…³äº Derive macro helper attributes è¿™é‡Œæœ‰ä¸€ä¸ªå‘å°±æ˜¯åœ¨ä½¿ç”¨ <code>cfg_attr</code> æ—¶ï¼Œéœ€è¦æŠŠ Attributes æ”¾åœ¨å®ä¹‹å‰ã€‚ä¸¾ä¸ªæ —å­ï¼š</p> <p>ä½¿ç”¨ kube-rs å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®šä¹‰ CRDï¼ˆCustom Resource Definitionï¼‰ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(CustomResource, Clone, Debug, Deserialize, Serialize, JsonSchema)]</span>
<span class="token attribute attr-name">#[kube(group = <span class="token string">&quot;clux.dev&quot;</span>, version = <span class="token string">&quot;v1&quot;</span>, kind = <span class="token string">&quot;Foo&quot;</span>, namespaced)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FooSpec</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ç¬¬ä¸€ååº”æ˜¯ #[kube] åœ¨è¿™é‡Œæ˜¯ä¸‹é¢æåˆ°çš„ Attribute-Like å®ï¼Œä½†æ˜¯ kubers æ–‡æ¡£æ‰å‘ç°æ˜¯ <code>CustomResource</code> Custom Derive å®çš„ Attributeã€‚è¿™é‡Œæˆ‘ä»¬æƒ³ç”¨ <code>cfg_attr</code> æ¥æ§åˆ¶æ˜¯å¦å»åš deriveï¼Œä¸€å¼€å§‹å°±æƒ³å½“ç„¶åœ°è¿™ä¹ˆå†™äº†ï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg_attr(feature=<span class="token string">&quot;use_kube_rs&quot;</span>,
    derive(CustomResource, Clone, Debug, Deserialize, Serialize, JsonSchema),
    kube(group = <span class="token string">&quot;clux.dev&quot;</span>, version = <span class="token string">&quot;v1&quot;</span>, kind = <span class="token string">&quot;Foo&quot;</span>, namespaced)
)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FooSpec</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç„¶è€Œè¿™æ˜¯é”™è¯¯çš„æ‰“å¼€æ–¹å¼ï¼Œéœ€è¦å†™æˆï¼š</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg_attr(feature=<span class="token string">&quot;use_kube_rs&quot;</span>,
    kube(group = <span class="token string">&quot;clux.dev&quot;</span>, version = <span class="token string">&quot;v1&quot;</span>, kind = <span class="token string">&quot;Foo&quot;</span>, namespaced),
    derive(CustomResource, Clone, Debug, Deserialize, Serialize, JsonSchema)
)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">FooSpec</span> <span class="token punctuation">{</span>
    info<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Attributes éœ€è¦å†™åœ¨å®çš„ derive å‰é¢ã€‚</p> <h3 id="attribute-like-å®"><a href="#attribute-like-å®" class="header-anchor">#</a> Attribute-Like å®</h3> <p>attribute-like å®å’Œ custom derive å®å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯æ ‡ç­¾å¯ä»¥è‡ªå®šä¹‰ï¼Œæ›´åŠ çµæ´»ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨åœ¨å‡½æ•°ä¸Šã€‚ä»–çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼Œæ¯”å¦‚å‡è®¾æœ‰ä¸€ä¸ªå®ä¸º <code>route</code> çš„å®</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[route(GET, <span class="token string">&quot;/&quot;</span>)]</span> 
<span class="token keyword">fn</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>
</code></pre></div><p>æŒ‰ä¸‹é¢çš„è¯­æ³•å®šä¹‰ <code>route</code> å®</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[proc_maco_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">route</span><span class="token punctuation">(</span>attr<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>
</code></pre></div><p>å…¶ä¸­ <code>attr</code> å‚æ•°æ˜¯ä¸Šé¢çš„ <code>Get</code>ï¼Œ<code>&quot;/&quot;</code> ï¼›<code>item</code> å‚æ•°æ˜¯ <code>fn index(){}</code> ã€‚</p> <h3 id="function-like-å®"><a href="#function-like-å®" class="header-anchor">#</a> Function-Like å®</h3> <p>è¿™ç§å®çœ‹ä¸Šå»å’Œ <code>macro_rules!</code> æ¯”è¾ƒç±»ä¼¼ï¼Œä½†æ˜¯åœ¨å£°æ˜å¼å®åªèƒ½ç”¨ <code>match</code> å»åšæ¨¡å¼åŒ¹é…ï¼Œä½†æ˜¯åœ¨è¿™é‡Œå¯ä»¥æœ‰æ›´å¤æ‚çš„è§£ææ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥å†™å‡ºæ¥</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> sql <span class="token operator">=</span> <span class="token macro property">sql!</span><span class="token punctuation">(</span><span class="token constant">SELECT</span> <span class="token operator">*</span> <span class="token constant">FROM</span> posts <span class="token constant">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>ä¸Šé¢è¿™ä¸ª <code>sql</code> å®çš„å®šä¹‰æ–¹æ³•å¦‚ä¸‹</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[proc_macro]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sql</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span> <span class="token punctuation">...</span> <span class="token punctuation">}</span>
</code></pre></div><h2 id="å¥½ç”¨çš„åº“"><a href="#å¥½ç”¨çš„åº“" class="header-anchor">#</a> å¥½ç”¨çš„åº“</h2> <p><a href="https://doc.rust-lang.org/proc_macro/index.html" target="_blank" rel="noopener noreferrer">proc_macro<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼šé»˜è®¤ token æµåº“ï¼Œåªèƒ½åœ¨è¿‡ç¨‹å®ä¸­ä½¿ç”¨ï¼Œç¼–è¯‘å™¨è¦ç”¨å®ƒï¼Œå°†å®ƒä½œä¸ºè¿‡ç¨‹å®çš„è¿”å›å€¼ï¼Œå¤§å¤šæ•°æƒ…å†µæˆ‘ä»¬ä¸éœ€è¦ï¼Œåªéœ€è¦åœ¨å®è¿”å›ç»“æœçš„æ—¶å€™æŠŠ <code>proc_macro2::TokenSteam</code> çš„æµ <code>into()</code> åˆ° <code>proc_macro::TokenSteam</code> å°±è¡Œäº†ã€‚</p> <p><a href="https://crates.io/crates/proc_macro2" target="_blank" rel="noopener noreferrer">proc_macro2<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼šæˆ‘ä»¬çœŸæ­£åœ¨ä½¿ç”¨çš„è¿‡ç¨‹å®åº“ï¼Œå¯ä»¥åœ¨è¿‡ç¨‹å®å¤–ä½¿ç”¨ã€‚</p> <p><a href="https://crates.io/crates/syn" target="_blank" rel="noopener noreferrer">syn<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼šè¿‡ç¨‹å®å·¦æŠ¤æ³•ï¼Œå¯ä»¥å°† <code>TokenStream</code> è§£ææˆè¯­æ³•æ ‘ï¼Œæ³¨æ„ä¸¤ä¸ª <code>proc_macro</code> å’Œ <code>proc_macro</code> éƒ½æ”¯æŒï¼Œéœ€è¦çœ‹æ–‡æ¡£ææ¸…æ¥šåº“å‡½æ•°åˆ°åº•æ˜¯åœ¨è§£æå“ªä¸ªåº“ä¸­çš„ <code>TokenStream</code>ã€‚</p> <p><a href="https://crates.io/crates/quote" target="_blank" rel="noopener noreferrer">quote<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼šè¿‡ç¨‹å®å³æŠ¤æ³•ï¼Œå°†è¯­æ³•æ ‘è§£ææˆ <code>TokenStream</code>ã€‚åªè¦ä¸€ä¸ª <code>quote!{}</code> å°±å¤Ÿäº†ï¼<code>quote!{}</code> å®å†…éƒ½æ˜¯å­—é¢é‡ï¼Œå³çº¯çº¯çš„ä»£ç ï¼Œè¦æ›¿æ¢è¿›å»çš„å˜é‡æ˜¯ç”¨çš„ <code>#</code> ç¬¦å·æ ‡æ³¨ï¼Œä¸ºäº†å’Œå£°æ˜å®ä¸­ä½¿ç”¨çš„ <code>$</code> ç›¸åŒºåˆ†ï¼ˆä¹Ÿå°±æ„å‘³ç€ç”¨ <code>quote</code> å†™è¿‡ç¨‹å®çš„æ—¶å€™ï¼Œå¯ä»¥å’Œå£°æ˜å®ç»“åˆ ğŸ¤¤ ï¼‰ã€‚æ¨¡å¼åŒ¹é…æ—¶ç”¨åˆ°çš„è¡¨ç¤ºé‡å¤çš„ç¬¦å·å’Œå£°æ˜å®ä¸­ä¸€æ ·ï¼Œæ˜¯ä½¿ç”¨ <code>*</code>ã€‚</p> <p><a href="https://crates.io/crates/darling" target="_blank" rel="noopener noreferrer">darling<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> å¥½ç”¨åˆ°è·º jio jio çš„æ ‡ç­¾å®è§£æåº“ï¼Œè®©äººç›´å‘¼ Darlingï¼</p> <h2 id="æ”¶å½•æœ‰è¶£çš„å®æ ·ä¾‹"><a href="#æ”¶å½•æœ‰è¶£çš„å®æ ·ä¾‹" class="header-anchor">#</a> æ”¶å½•æœ‰è¶£çš„å®æ ·ä¾‹</h2> <p>æœ¬ç« æ”¶å½•åˆ°çš„å®å°½å¯èƒ½çŸ­å°ã€ç‹¬ç«‹ã€æœ‰è¶£ã€‚</p> <h3 id="ä½ è¿™å†™çš„å•¥å•Š"><a href="#ä½ è¿™å†™çš„å•¥å•Š" class="header-anchor">#</a> ä½ è¿™å†™çš„å•¥å•Š</h3> <p>è®°å½•ä¸€ä¸‹è‡ªå·±å†™çš„ä¸€äº›æœ‰è¶£çš„å®ï¼Œä»¥é˜²ä¸‹æ¬¡ç¢°åˆ°è¿™ç§æƒ…å†µå¿˜è®°å’‹å†™ã€‚</p> <ul><li><p>è¿™é‡Œçš„å®é™…éœ€æ±‚æ˜¯å¤„ç†æ ‡ç­¾å®å‚æ•°ï¼Œç”¨äº† <a href="https://crates.io/crates/darling" target="_blank" rel="noopener noreferrer">darling<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> åº“åšè§£æï¼Œç„¶åå¤„ç†ä¸€äº› <code>Option</code> ç±»å‹çš„å¯é€‰å‚æ•°ï¼Œå¦‚æœæ ‡ç­¾å®å‚æ•°ä¸­æ²¡æœ‰å®ƒï¼ˆå³ <code>darling</code> è§£æå‡º <code>None</code>ï¼‰ï¼Œå°±ä¸ç†ä¼šå®ƒï¼Œåœ¨åç»­æ„é€ ä¸­ä½¿ç”¨é»˜è®¤å€¼ã€‚æ„Ÿè§‰æœ‰æ„æ€çš„åœ°æ–¹åœ¨äºè¿‡ç¨‹å®å’Œå£°æ˜å®çš„æ··åˆä½¿ç”¨ï¼Œåœ¨å†™å‡ºæ¥ä¹‹å‰æˆ‘æ²¡æƒ³åˆ°è¿™ä¹ˆå†™çœŸèƒ½è·‘ = =</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token macro property">macro_rules!</span> expand_attribute <span class="token punctuation">{</span>
    <span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token variable">$attr</span><span class="token punctuation">:</span><span class="token fragment-specifier punctuation">expr</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> token <span class="token operator">=</span> <span class="token class-name">TokenStream2</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            $<span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token variable">$attr</span> <span class="token punctuation">{</span>
                token<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token macro property">quote!</span><span class="token punctuation">{</span><span class="token variable">$attr</span><span class="token punctuation">:</span> #val<span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">*</span>
            token
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä½¿ç”¨æ—¶æ˜¯è¿™ä¹ˆç”¨çš„</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">darling<span class="token punctuation">::</span></span><span class="token class-name">FromMeta</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(Debug, FromMeta)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Attrs</span><span class="token punctuation">{</span>
    <span class="token attribute attr-name">#[darling(default)]</span>
    <span class="token keyword">pub</span> param1<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[darling(default)]</span>
    <span class="token keyword">pub</span> param2<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token attribute attr-name">#[darling(default)]</span>
    <span class="token keyword">pub</span> param3<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token keyword">f64</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(Debug, Default)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Struct</span><span class="token punctuation">{</span>
    <span class="token keyword">pub</span> param1<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> param2<span class="token punctuation">:</span> <span class="token keyword">f64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> neccessary<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token comment">// cannot be empty or any default value</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[proc_macro_attribute]</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">an_attribute</span><span class="token punctuation">(</span>attr<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">,</span> item<span class="token punctuation">:</span> <span class="token class-name">TokenStream</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">TokenStream</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token class-name">Attrs</span> <span class="token punctuation">{</span>
        param1<span class="token punctuation">,</span> 
        param2<span class="token punctuation">,</span> 
        <span class="token punctuation">...</span> <span class="token comment">// Attrs::param3 is not useful in Struct</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span>  <span class="token keyword">match</span> <span class="token class-name">Attrs</span><span class="token punctuation">::</span><span class="token function">from_list</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>attr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">,</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">TokenStream</span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">write_errors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> optional_params <span class="token operator">=</span> <span class="token macro property">expand_attribute!</span><span class="token punctuation">(</span>param1<span class="token punctuation">,</span> param2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> build_a_struct <span class="token operator">=</span> <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
        <span class="token class-name">Struct</span> <span class="token punctuation">{</span>
            neccessary<span class="token punctuation">:</span> <span class="token string">&quot;0817&quot;</span><span class="token punctuation">,</span> 
            #optional_params
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// TL;DR</span>
<span class="token punctuation">}</span>
</code></pre></div><p>çœ‹å¾—å‡ºæ¥è¿˜æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œ</p></li> <li><p>è¿™é‡Œçš„å®é™…éœ€æ±‚æ˜¯ç”¨æ ‡ç­¾å®ä¿®æ”¹åŸå‡½æ•°è¿”å›å€¼ä¸º Resultï¼Œæ˜¯åœ¨ <a href="https://github.com/sentinel-group/sentinel-rust" target="_blank" rel="noopener noreferrer">sentinel-group/sentinel-rust<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> çš„å®ç°ä¸­ï¼Œç”¨æ¥å¿«é€Ÿç»™ä¸€ä¸ªå‡½æ•°æˆ–æ–¹æ³•åˆ›å»º sentinel çš„ã€‚å½“æ—¶çš„æƒ³æ³•æ˜¯ç”¨ Result æ¥è¡¨è¾¾æŸä¸ªæµæ˜¯å¦è¢«é˜»ç¢ï¼ŒåŒæ—¶å¯ä»¥ä¼ é€’ Sentinel çš„å‘Šè­¦ç»™ç”¨æˆ·ï¼Œå®ç°å‡ºæ¥çš„å¾ˆåƒåœ¾ï¼Œå¯ä»¥è¯´æ˜¯åªæ”¯æŒä½¿ç”¨ä¸€ä¸ªè§„åˆ™ã€‚æ²¡æœ‰è¯•è¿‡å¤šä¸ªè¿™æ ·çš„æ ‡ç­¾å®åµŒå¥—ï¼Œä½†æ˜¯ä¼°è®¡æ˜¯å›è°ƒåœ°ç‹±é‡ç°ä¸–é—´ ğŸ˜… ï¼ˆæˆ–è®¸å¯ä»¥ç”¨ <code>std::Result::flatten()</code> æ¥é¿å…ï¼Œä½†æ˜¯å®ƒç›®å‰è¿˜æ˜¯ nightly çš„ APIï¼‰ã€‚</p> <p>è¿™é‡Œçš„å®ç°ä¹Ÿæœ‰ç‚¹è ¢ï¼Œæ˜¯ç”¨çš„ quote å’Œ syn è‡ªåŠ¨è§£æçš„ä¿®æ”¹åçš„å‡½æ•°ç­¾åï¼Œå°è¯•è¿‡æ‰‹åŠ¨æ„é€ ï¼Œä½†æ˜¯å¤ªæ¶å¿ƒäº†æ„é€ ä¸æ¥ã€‚</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">)</span> <span class="token keyword">fn</span> <span class="token function-definition function">process_func</span><span class="token punctuation">(</span><span class="token keyword">mut</span> func<span class="token punctuation">:</span> <span class="token class-name">ItemFn</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ItemFn</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> output <span class="token operator">=</span> func<span class="token punctuation">.</span>sig<span class="token punctuation">.</span>output<span class="token punctuation">;</span>
    <span class="token comment">// Currently, use quote/syn to automatically generate it,</span>
    <span class="token comment">// don't know if there is a better way.</span>
    <span class="token comment">// Seems hard to parse new ReturnType only or construct ReturnType by hand.</span>
    <span class="token keyword">let</span> dummy_func <span class="token operator">=</span> <span class="token keyword">match</span> output <span class="token punctuation">{</span>
        <span class="token class-name">ReturnType</span><span class="token punctuation">::</span><span class="token class-name">Default</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
                <span class="token keyword">fn</span> <span class="token function-definition function">dummy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">ReturnType</span><span class="token punctuation">::</span><span class="token class-name">Type</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> return_type<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">quote!</span> <span class="token punctuation">{</span>
                <span class="token keyword">fn</span> <span class="token function-definition function">dummy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span>#return_type<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dummy_func<span class="token punctuation">:</span> <span class="token class-name">ItemFn</span> <span class="token operator">=</span> <span class="token namespace">syn<span class="token punctuation">::</span></span><span class="token function">parse2</span><span class="token punctuation">(</span>dummy_func<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// replace the old ReturnType to the dummy function ReturnType</span>
    func<span class="token punctuation">.</span>sig<span class="token punctuation">.</span>output <span class="token operator">=</span> dummy_func<span class="token punctuation">.</span>sig<span class="token punctuation">.</span>output<span class="token punctuation">;</span>
    func
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="è¿˜å¾—å­¦ä¹ ä¸€ä¸ª"><a href="#è¿˜å¾—å­¦ä¹ ä¸€ä¸ª" class="header-anchor">#</a> è¿˜å¾—å­¦ä¹ ä¸€ä¸ª</h3> <p>æœ¬ç« èŠ‚æŠ„å½•ä¸€äº›åˆ«äººå†™çš„é»‘é­”æ³•å®ã€‚</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <p><a href="https://doc.rust-lang.org/book/ch19-06-macros.html" target="_blank" rel="noopener noreferrer">Macros - The Rust Programming Language (rust-lang.org)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://doc.rust-lang.org/reference/macros.html" target="_blank" rel="noopener noreferrer">Macros - The Rust Reference (rust-lang.org)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://danielkeep.github.io/tlborm/book/index.html" target="_blank" rel="noopener noreferrer">The Little Book of Rust Macros (danielkeep.github.io)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://dengjianping.github.io/2019/02/28/%E5%A6%82%E4%BD%95%E7%BC%96%E5%86%99%E4%B8%80%E4%B8%AA%E8%BF%87%E7%A8%8B%E5%AE%8F(proc-macro).html" target="_blank" rel="noopener noreferrer">å¦‚ä½•ç¼–å†™ä¸€ä¸ªè¿‡ç¨‹å®(proc-macro)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">2022/11/8 ä¸‹åˆ4:22:18</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.a390c3bc.js" defer></script><script src="/assets/js/1.489a6dc0.js" defer></script><script src="/assets/js/59.1b42ac73.js" defer></script><script src="/assets/js/13.e56158ac.js" defer></script>
  </body>
</html>
