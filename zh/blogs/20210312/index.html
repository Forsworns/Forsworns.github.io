<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Rust基础备忘 | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.5f87357d.css" as="style"><link rel="preload" href="/assets/js/app.f299d9eb.js" as="script"><link rel="preload" href="/assets/js/1.489a6dc0.js" as="script"><link rel="preload" href="/assets/js/61.cf2b696f.js" as="script"><link rel="preload" href="/assets/js/13.e56158ac.js" as="script"><link rel="prefetch" href="/assets/js/10.0a8552e5.js"><link rel="prefetch" href="/assets/js/11.7544d912.js"><link rel="prefetch" href="/assets/js/12.4abf2689.js"><link rel="prefetch" href="/assets/js/14.84181d18.js"><link rel="prefetch" href="/assets/js/15.dab14606.js"><link rel="prefetch" href="/assets/js/16.98da8228.js"><link rel="prefetch" href="/assets/js/17.0ba0e8e3.js"><link rel="prefetch" href="/assets/js/18.d2c98111.js"><link rel="prefetch" href="/assets/js/19.86bdbfa9.js"><link rel="prefetch" href="/assets/js/20.22caf17f.js"><link rel="prefetch" href="/assets/js/21.c75712be.js"><link rel="prefetch" href="/assets/js/22.c0c99274.js"><link rel="prefetch" href="/assets/js/23.214355cd.js"><link rel="prefetch" href="/assets/js/24.a9557518.js"><link rel="prefetch" href="/assets/js/25.fb756fe5.js"><link rel="prefetch" href="/assets/js/26.88bc672c.js"><link rel="prefetch" href="/assets/js/27.a047953c.js"><link rel="prefetch" href="/assets/js/28.0aa927b7.js"><link rel="prefetch" href="/assets/js/29.599475e0.js"><link rel="prefetch" href="/assets/js/3.db885a38.js"><link rel="prefetch" href="/assets/js/30.ac4304d9.js"><link rel="prefetch" href="/assets/js/31.378fb91c.js"><link rel="prefetch" href="/assets/js/32.72e1c0ea.js"><link rel="prefetch" href="/assets/js/33.358b985a.js"><link rel="prefetch" href="/assets/js/34.92d54470.js"><link rel="prefetch" href="/assets/js/35.3ee5ae15.js"><link rel="prefetch" href="/assets/js/36.f3bd4bb7.js"><link rel="prefetch" href="/assets/js/37.27456d40.js"><link rel="prefetch" href="/assets/js/38.ac3e3512.js"><link rel="prefetch" href="/assets/js/39.623032e6.js"><link rel="prefetch" href="/assets/js/4.5ebe3061.js"><link rel="prefetch" href="/assets/js/40.81db8d94.js"><link rel="prefetch" href="/assets/js/41.dcc11868.js"><link rel="prefetch" href="/assets/js/42.5ad0c9c8.js"><link rel="prefetch" href="/assets/js/43.d8a7f45f.js"><link rel="prefetch" href="/assets/js/44.78c0feaa.js"><link rel="prefetch" href="/assets/js/45.1b1f0dc8.js"><link rel="prefetch" href="/assets/js/46.eed83510.js"><link rel="prefetch" href="/assets/js/47.6eac4cc5.js"><link rel="prefetch" href="/assets/js/48.b7e6b32a.js"><link rel="prefetch" href="/assets/js/49.bbb7666a.js"><link rel="prefetch" href="/assets/js/5.86d38cb0.js"><link rel="prefetch" href="/assets/js/50.2f8f6c98.js"><link rel="prefetch" href="/assets/js/51.cd539748.js"><link rel="prefetch" href="/assets/js/52.a4605abf.js"><link rel="prefetch" href="/assets/js/53.027cd8a1.js"><link rel="prefetch" href="/assets/js/54.d7e6f527.js"><link rel="prefetch" href="/assets/js/55.fdbf2d23.js"><link rel="prefetch" href="/assets/js/56.b88cb66b.js"><link rel="prefetch" href="/assets/js/57.eaebbeb1.js"><link rel="prefetch" href="/assets/js/58.a8aab8e9.js"><link rel="prefetch" href="/assets/js/59.2fd0e12e.js"><link rel="prefetch" href="/assets/js/6.834bec42.js"><link rel="prefetch" href="/assets/js/60.1602d25a.js"><link rel="prefetch" href="/assets/js/62.8659cf17.js"><link rel="prefetch" href="/assets/js/63.00655be8.js"><link rel="prefetch" href="/assets/js/64.669e347b.js"><link rel="prefetch" href="/assets/js/65.2bf8094b.js"><link rel="prefetch" href="/assets/js/66.327070d4.js"><link rel="prefetch" href="/assets/js/67.810b2fee.js"><link rel="prefetch" href="/assets/js/68.e3476a72.js"><link rel="prefetch" href="/assets/js/69.35da038b.js"><link rel="prefetch" href="/assets/js/7.edffe57c.js"><link rel="prefetch" href="/assets/js/70.75827cae.js"><link rel="prefetch" href="/assets/js/71.225214a5.js"><link rel="prefetch" href="/assets/js/72.a84f7192.js"><link rel="prefetch" href="/assets/js/73.ffe311be.js"><link rel="prefetch" href="/assets/js/74.3b69b9c2.js"><link rel="prefetch" href="/assets/js/75.aaf712aa.js"><link rel="prefetch" href="/assets/js/76.c3292f62.js"><link rel="prefetch" href="/assets/js/77.7fb25a78.js"><link rel="prefetch" href="/assets/js/8.2fb98e50.js"><link rel="prefetch" href="/assets/js/9.c640c61b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5f87357d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210312/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210312/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#string-vs-str">String vs str</a><ul><li><a href="#相互转化">相互转化</a></li><li><a href="#内存的分配">内存的分配</a></li><li><a href="#应该使用哪一个">应该使用哪一个？</a></li></ul></li><li><a href="#life-time">Life Time</a><ul><li><a href="#引用传参">引用传参</a></li><li><a href="#返回引用">返回引用</a></li><li><a href="#结构体">结构体</a></li><li><a href="#多个生命周期参数">多个生命周期参数</a></li></ul></li><li><a href="#trait">Trait</a></li><li><a href="#与-c-结合">与 C++ 结合</a></li><li><a href="#杂项">杂项</a></li><li><a href="#安全性">安全性</a><ul><li><a href="#c-的情况">C++的情况</a></li><li><a href="#rust是怎么做的">Rust是怎么做的</a></li></ul></li><li><a href="#references">References</a></li></ul></div><p></p> <h1 id="rust-基础备忘"><a href="#rust-基础备忘" class="header-anchor">#</a> Rust 基础备忘</h1> <p>转载和记录一些印象不深的碎片知识</p> <h2 id="string-vs-str"><a href="#string-vs-str" class="header-anchor">#</a> String vs str</h2> <p>当我们需要引用一个被拥有的UTF-8文本的区间(range)，或者当我们使用字符串字面量(string literals)时，我们就需要使用字符串切片(也就是 <code>str</code>)。<code>&amp;str</code> 不负责任地说，可以理解成 C++ 中的 <code>char *</code> 和 <code>string_view</code>。<code>string_view</code>是 C++17 中为解决字符串频繁拷贝问题而提出的 ，在一些只需要做查找、遍历、打印的函数中，参数的常量引用传递并不能完全解决拷贝问题，如果传参时候传的是常量引用传递，内部一旦使用赋值等运算仍然会发生拷贝，会在堆上重新分配空间浪费时间，所以它和<code>&amp;str</code>都相当于是字符指针的包装类型，不拥有数据，只是划一个区间。</p> <p><code>String</code> 则可以认为和 C++ 中相同，是一个会自动分配空间的容器（而 Java 的 String 是常量）。</p> <h3 id="相互转化"><a href="#相互转化" class="header-anchor">#</a> 相互转化</h3> <p>像<code>println!</code>，<code>format!</code> 这些宏都是要传 <code>&amp;str</code> 的。</p> <p><code>String</code> 转 <code>&amp;str</code>：</p> <ul><li><code>String</code> 类型在引用时， <code>&amp;String</code> 可以自动转化为 <code>&amp;str</code>，编译器会帮忙干活，该特性叫 <code>deref coercing</code></li> <li>使用<code>&amp;some_string[..]</code> 这样完整的写法，利用了String重载的Index操作</li> <li><code>as_str()</code>，<code>as_ref()</code>，<code>as_borrow()</code></li></ul> <p><code>&amp;str</code> 转 <code>String</code>：</p> <ul><li><code>into()</code> （这本质上是因为 <code>String</code> 实现了 <code>From&lt;&amp;'_ str&gt;</code> 这个 trait ，调用了<code>to_owned()</code></li> <li>to_owned()，因为原来没有所有权么，所以要 <code>to_owned</code> 成 <code>String</code> 拿到所有权</li> <li><code>to_string()</code> 调用的是 <code>String::from()</code></li> <li><code>String::from()</code></li></ul> <h3 id="内存的分配"><a href="#内存的分配" class="header-anchor">#</a> 内存的分配</h3> <p>讨论内存分配的例子：</p> <p><code>let my_name = &quot;Pascal&quot;.to_string();</code></p> <p>那么</p> <div class="language-text extra-class"><pre class="language-text"><code>buffer
                   /   capacity
                 /   /  length
               /   /   /
            +–––+–––+–––+
stack frame │ • │ 8 │ 6 │ &amp;lt;- my_name: String
            +–│–+–––+–––+
              │
            [–│–––––––– capacity –––––––––––]
              │
            +–V–+–––+–––+–––+–––+–––+–––+–––+
       heap │ P │ a │ s │ c │ a │ l │   │   │
            +–––+–––+–––+–––+–––+–––+–––+–––+

            [––––––– length ––––––––]
</code></pre></div><p>Rust会在栈上存储<code>String</code>对象。这个对象里包含以下三个信息: 一个<strong>指针</strong>指向一块分配在堆上的缓冲区，这也是数据真正存储的地方，数据的<strong>容量</strong>和<strong>长度</strong>。因此，<code>String</code>对象本身长度总是固定的三个字(word)。</p> <p>如果我们只是对存储在<code>my_name</code>中的last name感兴趣，我们可以像下面这样来获取一个针对字符串中的特定部分的引用:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token keyword">mut</span> my_name <span class="token operator">=</span> <span class="token string">&quot;Pascal&quot;</span><span class="token punctuation">.</span><span class="token function">to_string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
my_name<span class="token punctuation">.</span><span class="token function">push_str</span><span class="token punctuation">(</span> <span class="token string">&quot; Precht&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> last_name <span class="token operator">=</span> <span class="token operator">&amp;</span>my_name<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>通过指定从第7个字节(因为有空格)开始一直到缓冲区的结尾(&quot;..&quot;)，<code>last_name</code>现在是一个引用自<code>my_name</code>拥有的文本的字符串切片(string slice)。它借用了这个文本。这里是它在内存中的样子:</p> <div class="language-text extra-class"><pre class="language-text"><code>my_name: String   last_name: &amp;amp;str
            [––––––––––––]    [–––––––]
            +–––+––––+––––+–––+–––+–––+
stack frame │ • │ 16 │ 13 │   │ • │ 6 │ 
            +–│–+––––+––––+–––+–│–+–––+
              │                 │
              │                 +–––––––––+
              │                           │
              │                           │
              │                         [–│––––––– str –––––––––]
            +–V–+–––+–––+–––+–––+–––+–––+–V–+–––+–––+–––+–––+–––+–––+–––+–––+
       heap │ P │ a │ s │ c │ a │ l │   │ P │ r │ e │ c │ h │ t │   │   │   │
            +–––+–––+–––+–––+–––+–––+–––+–––+–––+–––+–––+–––+–––+–––+–––+–––+
</code></pre></div><p>注意<code>last_name</code>没有在栈上存储容量信息。这是因为它只是对一个字符串切片的引用，而该字符串管理它的容量。这个字符串切片，即<code>str</code>本身，是不确定大小(unsized)的。 而且，在实际使用中，字符串切片总是以引用的形式出现，也就是它们的类型总是<code>&amp;str</code>而不是<code>str</code>。</p> <p>有两种情况我们需要使用字符串切片：要么创建一个对子字符串的引用，或者我们使用<strong>字符串字面量</strong>(string literals)。</p> <p>一个字符串字面量由一串被双引号包含的文本创建，就像这样：</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> my_name <span class="token operator">=</span> <span class="token string">&quot;Pascal Precht&quot;</span><span class="token punctuation">;</span> <span class="token comment">// This is a `&amp;str` not a `String`</span>
</code></pre></div><p>下一个问题是，如果<code>&amp;str</code>是一个引用了被(某人)拥有的<code>String</code>的切片，假定这个文本在适当的地方被创建，那么这么<code>String</code>的所有者是谁？</p> <p>很显然，字符串字面量有点特殊。他们是引用自“预分配文本(preallocated text)”的字符串切片，这个预分配文本存储在可执行程序的只读内存中。换句话说，这是装载我们程序的内存并且不依赖于在堆上分配的缓冲区。</p> <p>也就是说，栈上还有一个入口，指向当程序执行时预分配的内存。</p> <div class="language-text extra-class"><pre class="language-text"><code>my_name: &amp;amp;str
            [–––––––––––]
            +–––+–––+
stack frame │ • │ 6 │ 
            +–│–+–––+
              │                 
              +––+                
                 │
 preallocated  +–V–+–––+–––+–––+–––+–––+
 read-only     │ P │ a │ s │ c │ a │ l │
 memory        +–––+–––+–––+–––+–––+–––+
</code></pre></div><p>当我们对<code>String</code>和<code>&amp;str</code>的区别有了更好的理解之后，另一个问题也就随之而来了。</p> <h3 id="应该使用哪一个"><a href="#应该使用哪一个" class="header-anchor">#</a> 应该使用哪一个？</h3> <p>显然，这取决于很多因素，但是一般地，保守来讲，如果我们正在构建的API不需要拥有或者修改使用的文本，那么应该使用<code>&amp;str</code>而不是<code>String</code>。</p> <h2 id="life-time"><a href="#life-time" class="header-anchor">#</a> Life Time</h2> <p>仅在编译期存在，与运行无关</p> <p>生命周期参数类似模板参数，可以任意指定名称，除了保留的 <code>'static</code></p> <p>当生命周期的名称不重要的时候，可以使用 <code>'_</code> 代表一个不具名的生命周期参数。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">Config</span> <span class="token punctuation">{</span>
  <span class="token punctuation">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">App</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Config</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果像上面这么直接用一个引用，无法通过编译，需要提供一个具名生命周期参数，如下</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">App</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token class-name">Config</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当提供了这样一个生命周期后，编译器可以保证引用类型 <code>&amp;Config</code> 变量 <code>config</code> 和 <code>App</code> 具有相同的生命周期，所以不会出现野指针。即编译器会根据编程者对生命周期的描述，进行检查保证引用都会在声明周期之内。</p> <p>回顾所有权的定义，在变量超出所有权上下文后，就会被自动 drop 掉，对于引用也是如此</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> <span class="token operator">&amp;</span>x<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该程序会报错 x 的生命周期不够长，在被 drop 后，r 仍然持有对 x 的引用。</p> <h3 id="引用传参"><a href="#引用传参" class="header-anchor">#</a> 引用传参</h3> <p>当传递引用时</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">some_function</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">i32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>some_function</code> 接收一个对于<code>i32</code> 类型的引用，随便给了一个生命周期参数<code>'a</code>。于是编译器就知道<code>some_function</code> 不会也不应该去把 <code>val</code> 存储到任何一个可能超出该函数生命周期的地方。</p> <p>如果 <code>some_function</code> 采用生命周期参数<code>'static</code>就不同了，Rust 会认为该参数是一个全局变量。这种情况下，只有<code>static</code> 变量才能作为函数参数。</p> <h3 id="返回引用"><a href="#返回引用" class="header-anchor">#</a> 返回引用</h3> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">smallest_number</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>n<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token punctuation">[</span><span class="token keyword">i32</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">i32</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> s <span class="token operator">=</span> <span class="token operator">&amp;</span>n<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> r <span class="token keyword">in</span> <span class="token operator">&amp;</span>n<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> r <span class="token operator">&lt;</span> s <span class="token punctuation">{</span>
            s <span class="token operator">=</span> r<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    s
<span class="token punctuation">}</span>
</code></pre></div><p>上面的生命周期标识表明返回值和参数的生命周期是相同的，在调用函数处，如果输入参数的生命周期结束了，返回值也就不能再被引用了。事实上，上面的代码中不显式地标明生命周期参数也可以，编译器会自动完成推导。</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> s<span class="token punctuation">;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">let</span> numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    s <span class="token operator">=</span> <span class="token function">smallest_number</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
</code></pre></div><p>也就是说，这段代码会报错，因为在括号外，<code>numbers</code>  被 drop 掉了，所以 <code>s</code>也就无法引用函数返回值了。</p> <h3 id="结构体"><a href="#结构体" class="header-anchor">#</a> 结构体</h3> <p>也就是一开始的那段代码。为什么编译器不能自动帮我们拓展一下生命周期？事实上在早期的编译器实现中，确实是这么干的，但是开发者发现有时会引发歧义，不如明确标识出引用的生命周期。</p> <p>需要注意的是，当前面代码中的 <code>App</code>结构体被其他类型借用时，也需要提供生命周期参数，即</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">struct</span> <span class="token type-definition class-name">Platform</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">:</span> <span class="token class-name">App</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="多个生命周期参数"><a href="#多个生命周期参数" class="header-anchor">#</a> 多个生命周期参数</h3> <p>考虑下面两种定义，第二种才是符合调用时要求的定义</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">/// The same lifetime annotation</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">i32</span>
<span class="token punctuation">}</span>
<span class="token comment">/// Different lifetime annotation</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">Point</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token lifetime-annotation symbol">'b</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    x<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">i32</span><span class="token punctuation">,</span>
    y<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'b</span> <span class="token keyword">i32</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> r<span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">let</span> y <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> point <span class="token operator">=</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token operator">&amp;</span>x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token operator">&amp;</span>y <span class="token punctuation">}</span><span class="token punctuation">;</span>
        r <span class="token operator">=</span> point<span class="token punctuation">.</span>x
    <span class="token punctuation">}</span>
    <span class="token macro property">println!</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在第一种定义下，编译器会自动选择更短的生命周期，即成员<code>x</code> 和 <code>y</code> 都会被当做 <code>y</code> 的生命周期。</p> <h2 id="trait"><a href="#trait" class="header-anchor">#</a> Trait</h2> <ul><li>Trait 比较烦的一点是在使用相关的类的时候，记得把它实现的 trait 也要 use 到。</li> <li>递归相关的 trait、复制相关的 trait 遇到问题可以回顾过往的笔记。</li></ul> <h2 id="与-c-结合"><a href="#与-c-结合" class="header-anchor">#</a> 与 C++ 结合</h2> <p>标准库中几个常用的</p> <ul><li>std::os::raw</li> <li>std::ffi</li></ul> <p>http://crates.io/ 上的库</p> <ul><li>clib</li> <li>inx</li></ul> <p><code>std::io::Error::last_os_error</code> 这个函数，是用来捕获函数操作失败后，内核反馈给我们的错误。</p> <h2 id="杂项"><a href="#杂项" class="header-anchor">#</a> 杂项</h2> <ul><li><p>关键字 <code>ref</code>，<code>deref</code> 等价于 <code>&amp;</code> 和 <code>*</code>，即</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token number">3u8</span> <span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token keyword">ref</span> b <span class="token operator">=</span> <span class="token number">3u8</span><span class="token punctuation">;</span>
<span class="token macro property">assert_eq!</span><span class="token punctuation">(</span><span class="token operator">*</span>a<span class="token punctuation">,</span><span class="token operator">*</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>2018 版里，不用 <code>extern crate</code> 了，可以直接 <code>use</code></p></li></ul> <h2 id="安全性"><a href="#安全性" class="header-anchor">#</a> 安全性</h2> <blockquote><p>If it compiles, then it works.</p></blockquote> <h3 id="c-的情况"><a href="#c-的情况" class="header-anchor">#</a> C++的情况</h3> <p>C++把内存使用分为两种情况：值对象和指针对象。值语义的对象超出作用域会自动调用析构函数销毁，传递或者赋值的时候会进行一次拷贝。指针语义则交给人肉来管理，或者使用智能指针来引用计数。值对象在传递赋值中拷贝一次比较浪费，所以C++后来有了移动构造函数。值在移动以后，关联的数据移动到新值。</p> <h3 id="rust是怎么做的"><a href="#rust是怎么做的" class="header-anchor">#</a> Rust是怎么做的</h3> <p>Rust则是在C++的基础上进一步优化。Rust的对象有一个所有者，和多个引用。Rust只允许值有一个所有者，传递和赋值会导致所有权移动。这看起来像C++的 <code>unique_ptr</code>，但实际上更像C++的移动语义。也就是说C++拷贝是隐式的移动是显式的，Rust移动是隐式的。当然Rust在这里有编译器的静态分析，没有运行时开销。很多地方并不想移动值，只是借用一下，Rust也使用了引用的概念，来表达指针语义。一个常见内存问题是指针指向了一个无效的内存地址，Rust却没这个问题。Rust编译器强制让你证明值的生命周期大于它的引用的生命周期。有些编译器搞不清楚的地方需要添加生命周期标记，来告诉编译器。</p> <h2 id="references"><a href="#references" class="header-anchor">#</a> References</h2> <p><a href="https://blog.thoughtram.io/string-vs-str-in-rust/" target="_blank" rel="noopener noreferrer">String vs str in Rust<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://zhuanlan.zhihu.com/p/61652809" target="_blank" rel="noopener noreferrer">知乎专栏：使用套接字联网 API<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/12/26 上午11:00:37</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f299d9eb.js" defer></script><script src="/assets/js/1.489a6dc0.js" defer></script><script src="/assets/js/61.cf2b696f.js" defer></script><script src="/assets/js/13.e56158ac.js" defer></script>
  </body>
</html>
