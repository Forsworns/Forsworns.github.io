<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>eBPF ç”¨æˆ·ç©ºé—´è™šæ‹Ÿæœºå®ç°ç›¸å…³ | Sharlayan</title>
    <meta name="description" content="ç”¨æˆ·æ€è™šæ‹Ÿæœºå®ç°ã€eBPF çš„æ›´å¤šçŸ¥è¯†">
    <link rel="preload stylesheet" href="/assets/style.3ef9b918.css" as="style">
    <link rel="modulepreload" href="/assets/chunks/VPAlgoliaSearchBox.1a1cd53f.js">
    <link rel="modulepreload" href="/assets/app.a19c101b.js">
    <link rel="modulepreload" href="/assets/zh_blogs_20210329_index.md.ad8fa8fd.lean.js">
    
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
  <link rel="icon" type="image/png" href="/logo.png">
  <meta name="author" content="Peihao Yang">
  <meta property="og:title" content="Home">
  <meta property="og:description" content="Home of Peihao Yang">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><!--[--><div class="Layout" data-v-b617430f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-d4120332></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-d4120332> Skip to content </a><!--]--><!----><header class="VPNav no-sidebar" data-v-b617430f data-v-aa1cde23><div class="VPNavBar" data-v-aa1cde23 data-v-cbdd8588><div class="container" data-v-cbdd8588><div class="title" data-v-cbdd8588><div class="VPNavBarTitle" data-v-cbdd8588 data-v-730d6dd1><a class="title" href="/zh/" data-v-730d6dd1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/assets/logo.png" alt data-v-0f13a436><!--]--><!----><!--[--><!--]--></a></div></div><div class="content" data-v-cbdd8588><div class="curtain" data-v-cbdd8588></div><!--[--><!--]--><div class="VPNavBarSearch search" data-v-cbdd8588 style="--699c4559:&#39;Meta&#39;;"><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-cbdd8588 data-v-2d3a777e><span id="main-nav-aria-label" class="visually-hidden" data-v-2d3a777e>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/zh/" data-v-2d3a777e data-v-f559a019 data-v-1a0f9836><!--[-->ğŸ¡ä¸»é¡µ<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/zh/about-me/" data-v-2d3a777e data-v-f559a019 data-v-1a0f9836><!--[-->ğŸ¦¹â€â™‚ï¸å…³äºæˆ‘<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-2d3a777e data-v-fc33d832><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-fc33d832><span class="text" data-v-fc33d832><!----> ğŸ““åšå®¢ <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-fc33d832><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-fc33d832><div class="VPMenu" data-v-fc33d832 data-v-ecf4e7d9><div class="items" data-v-ecf4e7d9><!--[--><!--[--><div class="VPMenuLink" data-v-ecf4e7d9 data-v-c7da634f><a class="VPLink link" href="/zh/blogs/" data-v-c7da634f data-v-1a0f9836><!--[-->ğŸ“ƒæ‰€æœ‰åšå®¢<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-ecf4e7d9 data-v-c7da634f><a class="VPLink link" href="/zh/blogs/tags/" data-v-c7da634f data-v-1a0f9836><!--[-->ğŸ”–æ ‡ç­¾åˆ†ç±»<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="https://forsworns.github.io/feed.xml" target="_blank" rel="noreferrer" data-v-2d3a777e data-v-f559a019 data-v-1a0f9836><!--[-->ğŸ”¥RSS<!--]--><!----></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-cbdd8588 data-v-7cdc304e data-v-fc33d832><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-fc33d832><span class="text" data-v-fc33d832><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-fc33d832><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg>  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-fc33d832><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-fc33d832><div class="VPMenu" data-v-fc33d832 data-v-ecf4e7d9><!----><!--[--><!--[--><div class="items" data-v-7cdc304e><p class="title" data-v-7cdc304e>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-7cdc304e data-v-c7da634f><a class="VPLink link" href="/" data-v-c7da634f data-v-1a0f9836><!--[-->English<!--]--><!----></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-cbdd8588 data-v-7f24c201><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-7f24c201 data-v-2b897f09 data-v-ab7cdc04><span class="check" data-v-ab7cdc04><span class="icon" data-v-ab7cdc04><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-2b897f09><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-2b897f09><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-cbdd8588 data-v-a5afa74d data-v-80c99471><!--[--><a class="VPSocialLink" href="https://github.com/forsworns/blog-vitepress" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="mailto:peihao.young@gmail.com" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="20">
            <path d="M874.666667 375.189333V746.666667a64 64 0 0 1-64 64H213.333333a64 64 0 0 1-64-64V375.189333l266.090667 225.6a149.333333 149.333333 0 0 0 193.152 0L874.666667 375.189333zM810.666667 213.333333a64.789333 64.789333 0 0 1 22.826666 4.181334 63.616 63.616 0 0 1 26.794667 19.413333 64.32 64.32 0 0 1 9.344 15.466667c2.773333 6.570667 4.48 13.696 4.906667 21.184L874.666667 277.333333v21.333334L553.536 572.586667a64 64 0 0 1-79.893333 2.538666l-3.178667-2.56L149.333333 298.666667v-21.333334a63.786667 63.786667 0 0 1 35.136-57.130666A63.872 63.872 0 0 1 213.333333 213.333333h597.333334z" ></path>
            </svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-cbdd8588 data-v-e459e5dc data-v-fc33d832><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-fc33d832><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-fc33d832><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-fc33d832><div class="VPMenu" data-v-fc33d832 data-v-ecf4e7d9><!----><!--[--><!--[--><div class="group" data-v-e459e5dc><p class="trans-title" data-v-e459e5dc>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-e459e5dc data-v-c7da634f><a class="VPLink link" href="/" data-v-c7da634f data-v-1a0f9836><!--[-->English<!--]--><!----></a></div><!--]--></div><div class="group" data-v-e459e5dc><div class="item appearance" data-v-e459e5dc><p class="label" data-v-e459e5dc>Appearance</p><div class="appearance-action" data-v-e459e5dc><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e459e5dc data-v-2b897f09 data-v-ab7cdc04><span class="check" data-v-ab7cdc04><span class="icon" data-v-ab7cdc04><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-2b897f09><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-2b897f09><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-e459e5dc><div class="item social-links" data-v-e459e5dc><div class="VPSocialLinks social-links-list" data-v-e459e5dc data-v-80c99471><!--[--><a class="VPSocialLink" href="https://github.com/forsworns/blog-vitepress" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="mailto:peihao.young@gmail.com" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="20">
            <path d="M874.666667 375.189333V746.666667a64 64 0 0 1-64 64H213.333333a64 64 0 0 1-64-64V375.189333l266.090667 225.6a149.333333 149.333333 0 0 0 193.152 0L874.666667 375.189333zM810.666667 213.333333a64.789333 64.789333 0 0 1 22.826666 4.181334 63.616 63.616 0 0 1 26.794667 19.413333 64.32 64.32 0 0 1 9.344 15.466667c2.773333 6.570667 4.48 13.696 4.906667 21.184L874.666667 277.333333v21.333334L553.536 572.586667a64 64 0 0 1-79.893333 2.538666l-3.178667-2.56L149.333333 298.666667v-21.333334a63.786667 63.786667 0 0 1 35.136-57.130666A63.872 63.872 0 0 1 213.333333 213.333333h597.333334z" ></path>
            </svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-cbdd8588 data-v-d6834c14><span class="container" data-v-d6834c14><span class="top" data-v-d6834c14></span><span class="middle" data-v-d6834c14></span><span class="bottom" data-v-d6834c14></span></span></button></div></div></div><!----></header><!----><!----><div class="VPContent" id="VPContent" data-v-b617430f data-v-f32377af><div class="VPDoc has-aside" data-v-f32377af data-v-1e970af1><div class="container" data-v-1e970af1><div class="aside" data-v-1e970af1><div class="aside-curtain" data-v-1e970af1></div><div class="aside-container" data-v-1e970af1><div class="aside-content" data-v-1e970af1><div class="VPDocAside" data-v-1e970af1 data-v-b1723386><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-b1723386 data-v-0980ba1d><div class="content" data-v-0980ba1d><div class="outline-marker" data-v-0980ba1d></div><div class="outline-title" data-v-0980ba1d>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-0980ba1d><span class="visually-hidden" id="doc-outline-aria-label" data-v-0980ba1d> Table of Contents for current page </span><ul class="root" data-v-0980ba1d data-v-6f4caaf4><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-b1723386></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-1e970af1><div class="content-container" data-v-1e970af1><!--[--><!--]--><main class="main" data-v-1e970af1><div style="position:relative;" class="vp-doc _zh_blogs_20210329_index" data-v-1e970af1><div><nav class="table-of-contents"><ul><li><a href="#linux-å†…æ ¸ç›¸å…³">Linux å†…æ ¸ç›¸å…³</a></li><li><a href="#bpf-æŒ‡ä»¤é›†">BPF æŒ‡ä»¤é›†</a><ul><li><a href="#alu-æŒ‡ä»¤">ALU æŒ‡ä»¤</a></li><li><a href="#memory-æŒ‡ä»¤">Memory æŒ‡ä»¤</a></li><li><a href="#branch-æŒ‡ä»¤">Branch æŒ‡ä»¤</a></li></ul></li><li><a href="#å¸¸è§çš„-bpf-prog-type">å¸¸è§çš„ bpf_prog_type</a></li><li><a href="#å…¶ä»–çš„-bpf-ç›¸å…³æ¦‚å¿µ">å…¶ä»–çš„ BPF ç›¸å…³æ¦‚å¿µ</a><ul><li><a href="#helper-function">Helper Function</a></li><li><a href="#verifier">Verifier</a></li><li><a href="#maps">Maps</a></li><li><a href="#object-pinning">Object Pinning</a></li><li><a href="#tail-calls">Tail Calls</a></li><li><a href="#bpf-to-bpf-calls">BPF to BPF Calls</a></li><li><a href="#jit">JIT</a></li><li><a href="#hardening">Hardening</a></li><li><a href="#offloads">Offloads</a></li></ul></li><li><a href="#bpf-è™šæ‹Ÿæœºçš„å…·ä½“å®ç°">BPF è™šæ‹Ÿæœºçš„å…·ä½“å®ç°</a></li><li><a href="#è¡¥å……">è¡¥å……</a><ul><li><a href="#calling-convention">Calling Convention</a></li><li><a href="#gnu-asm">GNU ASM</a></li><li><a href="#x86-64">x86-64</a></li><li><a href="#armv7-m">ARMv7-M</a></li></ul></li></ul></nav><h1 id="ebpf-ç”¨æˆ·ç©ºé—´è™šæ‹Ÿæœºå®ç°ç›¸å…³" tabindex="-1">eBPF ç”¨æˆ·ç©ºé—´è™šæ‹Ÿæœºå®ç°ç›¸å…³ <a class="header-anchor" href="#ebpf-ç”¨æˆ·ç©ºé—´è™šæ‹Ÿæœºå®ç°ç›¸å…³" aria-hidden="true">#</a></h1><p>ç»­ä¸Šä¸€ç¯‡<a href="/zh/blogs/20210311/">BPFç¬”è®°</a>ï¼Œè¿™æ¬¡è®°å½•ä¸€äº›å®è·µç›¸å…³çš„å†…å®¹ã€‚ä¸å†åŒºåˆ†classical BPFå’ŒeBPFï¼Œç»Ÿç§°BPFã€‚</p><p>å¼€å‘æ¿ç›¸å…³çš„å†…å®¹åœ¨<a href="/zh/blogs/20210223/">å¦ä¸€ç¯‡ç¬”è®°</a>ã€‚</p><h2 id="linux-å†…æ ¸ç›¸å…³" tabindex="-1">Linux å†…æ ¸ç›¸å…³ <a class="header-anchor" href="#linux-å†…æ ¸ç›¸å…³" aria-hidden="true">#</a></h2><p>Linux å†…æ ¸ä¸­çš„ BPF å®ç°æœ‰ä¸¤ä¸ªé¡¹ç›®ï¼Œåˆ†åˆ«éƒ½åªæœ‰ä¸€æ¡ç‹¬ç«‹çš„masteråˆ†æ”¯ï¼ˆé¿å…ç»´æŠ¤æ—¶ rebase èµ·æ¥æ··ä¹±ï¼‰ï¼Œ<a href="https://kernel.googlesource.com/pub/scm/linux/kernel/git/bpf/bpf" target="_blank" rel="noreferrer">bpf</a> åˆ†æ”¯å’Œ <a href="https://kernel.googlesource.com/pub/scm/linux/kernel/git/bpf/bpf-next/" target="_blank" rel="noreferrer">bpf-next</a> åˆ†æ”¯ã€‚ç±»ä¼¼äº net åˆ†æ”¯å’Œ net-next åˆ†æ”¯ï¼Œbpf åˆ†æ”¯æ˜¯è¾ƒä¸ºå›ºå®šçš„ï¼Œç”¨æ¥åšäº›ä¿®è¡¥å·¥ä½œï¼›bpf-next æ˜¯ç”¨æ¥å¼€å‘ä¸€äº›ä¹‹åçš„ featureï¼Œæˆ–è€…åšæ”¹è¿›ç”¨çš„åˆ†æ”¯ã€‚æºç åœ¨<code>/kernel/bpf</code> ä¸‹ã€‚</p><p>æ–‡æ¡£åœ¨ <code>/Documentation/bpf/btf.rst</code> ã€‚</p><p><code>/include/uapi/linux/bpf_common.h</code> å’Œ <code>/include/uapi/linux/bpf.h</code> å®šä¹‰äº†æŒ‡ä»¤é›†ã€‚</p><p><code>/samples/bpf</code> æ˜¯ä¸€äº› bpf ç›¸å…³çš„æ ·ä¾‹ï¼ˆå¼€å‘æ—¶çš„æµ‹è¯•ä»£ç ä¸åº”è¯¥æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸‹ï¼Œå› ä¸ºé€»è¾‘å¯èƒ½æ¯”ä¸€èˆ¬çš„æ ·ä¾‹å¤æ‚ï¼Œéœ€è¦æµ‹è¯•è¾¹ç•Œæƒ…å†µï¼‰ï¼Œ</p><p><code>/tools/bpf/bpftool</code> ä¸‹é¢æ”¾ä¸€äº›ç”¨æˆ·ç©ºé—´ç”¨æ¥ debug ebpf ç¨‹åºçš„å·¥å…·ã€‚</p><p><code>/tools/testing/selftests/bpf</code> ä¸‹æ˜¯æµ‹è¯•ä»£ç ã€‚</p><p>å¯¹ BPF æŒ‡ä»¤çš„æµ‹è¯•å†™åœ¨ <code>/lib/test_bpf.c</code> å’Œ <code>/lib/test_verifier.c</code> ä¸­ã€‚</p><p>æµ‹è¯• BPFï¼ˆç›¸å…³æ–‡æ¡£ä¸º <code>/Documentation/dev-tools/kselftest.rst</code> ï¼‰ï¼š</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tools/testing/selftests/bpf/</span></span>
<span class="line"><span style="color:#FFCB6B;">make</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./test_verifier</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># This will generate `Summary: 418 PASSED, 0 FAILED`</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># to run all of the tests</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run_tests</span></span>
<span class="line"></span></code></pre></div><p><code>llc --version</code> æŸ¥çœ‹ LLVM æ˜¯å¦æ”¯æŒ BPFï¼šæŸ¥çœ‹è¾“å‡ºçš„ <code>Registered Targets</code>ã€‚</p><p><code>llc -march bpf -mcpu=help</code> å¯ä»¥ç”¨æ¥æŸ¥çœ‹å’Œè®¾ç½®æ”¯æŒçš„ BPF æŒ‡ä»¤é›†ã€‚</p><p>ä½¿ç”¨ <code>clang</code> å‰ç«¯ç¼–è¯‘ C ä»£ç  <code>test.c</code> åˆ°ä¸­é—´ BPF ä»£ç  <code>test.o</code>ï¼š</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">clang</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-target</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bpf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-c</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test.c</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test.o</span></span>
<span class="line"></span></code></pre></div><p>ç”¨ <code>readelf</code> å»è¯»<code>test.o</code>ï¼š</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">readelf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test.o</span></span>
<span class="line"></span></code></pre></div><p>åœ¨å†…æ ¸ä¸­ï¼ŒBPF ç›¸å…³çš„è°ƒç”¨éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªæ ¸å¿ƒçš„ç³»ç»Ÿè°ƒç”¨ <code>bpf()</code> æ¥æ‰§è¡Œçš„ï¼Œä¾‹å¦‚åŠ è½½ç¨‹åºåˆ°å†…æ ¸ã€ç®¡ç† BPF mapsã€ç®¡ç† map entriesã€ç¨‹åºå’Œ map çš„æŒä¹…åŒ–ï¼ˆé€šè¿‡ <a href="#Object-Pinning">Pinning</a> å®ç°ï¼‰ç­‰æ“ä½œã€‚</p><p>åœ¨å†…æ ¸ä¸­çš„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="/assets/bpf_inkernel.f1db3900.png" alt=""></p><p><img src="/assets/bpf_process.e6595ba4.png" alt=""></p><p>BPF åœ¨å†…æ ¸ä¸­çš„æ‰§è¡Œéƒ½æ˜¯äº‹ä»¶é©±åŠ¨çš„ï¼Œä¾‹å¦‚ï¼š</p><ul><li>æŒ‚è½½äº† BPF ç¨‹åºçš„ç½‘ç»œè®¾å¤‡å°†ä¼šåœ¨å®ƒæ¥æ”¶åˆ°åŒ…çš„æ—¶å€™æ‰§è¡Œç¨‹åº</li><li>å†…æ ¸åœ°å€ä¸ŠæŒ‚è½½äº† BPF ç¨‹åºçš„ kprobe æ—¶ï¼Œåªè¦è¯¥åœ°å€çš„ç¨‹åºæ‰§è¡Œäº†ï¼Œå°±ä¼šè§¦å‘ kprobe çš„å›è°ƒå‡½æ•°ï¼Œæ¥ç€è§¦å‘ BPF ç¨‹åº</li></ul><p>ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><p><img src="/assets/ebpf_event.b918a5ac.png" alt=""></p><h2 id="bpf-æŒ‡ä»¤é›†" tabindex="-1">BPF æŒ‡ä»¤é›† <a class="header-anchor" href="#bpf-æŒ‡ä»¤é›†" aria-hidden="true">#</a></h2><p>è¿™éƒ¨åˆ†ç¿»è¯‘è‡ª uBPF çš„æ–‡æ¡£ï¼Œå®ƒæ˜¯ä¸Šé¢æåˆ°çš„ä¸€ä¸ª BPF JIT Complier çš„å®ç°ã€‚</p><p>BPF ä½¿ç”¨äº† 11 ä¸ª 64ä½å¯„å­˜å™¨ï¼Œ32ä½ç§°ä¸ºåŠå¯„å­˜å™¨ï¼ˆsubregisterï¼‰å’Œä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼ˆprogram counterï¼‰ï¼Œä¸€ä¸ªå¤§å°ä¸º 512 å­—èŠ‚çš„ BPF æ ˆã€‚å¯„å­˜å™¨ä»¥ r0 - r10 å‘½åï¼Œr0 - r9 æ˜¯æŒ‡ä»¤å¯ä»¥ä½¿ç”¨çš„å¯„å­˜å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿è¡Œæ¨¡å¼æ˜¯ 64 ä½çš„ã€‚</p><p>BPF ç¨‹åºæŒ‡ä»¤éƒ½æ˜¯64ä½çš„ï¼Œå‡è®¾ BPF è™šæ‹ŸæœºæŒ‡ä»¤é›†çš„ç¼–ç é¡ºåºå’Œå®¿ä¸»æœºçš„é¡ºåºç›¸åŒï¼Œäºæ˜¯åœ¨ä¸‹é¢çš„æè¿°ä¸­ä¸å…³å¿ƒå¤§ç«¯å°ç«¯çš„é—®é¢˜ã€‚</p><p>æ‰€æœ‰çš„ BPF æŒ‡ä»¤éƒ½æœ‰ç€ç›¸åŒçš„ç¼–ç æ–¹å¼ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">msb                                                        lsb</span></span>
<span class="line"><span style="color:#A6ACCD;">+------------------------+----------------+----+----+--------+</span></span>
<span class="line"><span style="color:#A6ACCD;">|immediate               |offset          |src |dst |opcode  |</span></span>
<span class="line"><span style="color:#A6ACCD;">+------------------------+----------------+----+----+--------+</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>ä»æœ€ä½ä½åˆ°æœ€é«˜ä½åˆ†åˆ«æ˜¯ï¼š</p><ul><li>8 ä½çš„ opcodeï¼Œæœ‰ BPF_X ç±»å‹çš„åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤ï¼Œä¹Ÿæœ‰ BPF_K ç±»å‹çš„åŸºäºç«‹å³æ•°çš„æŒ‡ä»¤</li><li>4 ä½çš„ç›®æ ‡å¯„å­˜å™¨ (dst)</li><li>4 ä½çš„åŸå§‹å¯„å­˜å™¨ (src)</li><li>16 ä½çš„åç§»ï¼ˆæœ‰ç¬¦å·ï¼‰ï¼Œæ˜¯ç›¸å¯¹äºæ ˆã€æ˜ å°„å€¼ï¼ˆmap valuesï¼‰ã€æ•°æ®åŒ…ï¼ˆpacket dataï¼‰ç­‰çš„ç›¸å¯¹åç§»é‡</li><li>32 ä½çš„ç«‹å³æ•° (imm)ï¼ˆæœ‰ç¬¦å·ï¼‰</li></ul><p>å¤§å¤šæ•°æŒ‡ä»¤éƒ½ä¸ä¼šä½¿ç”¨æ‰€æœ‰çš„åŸŸï¼Œæœªè¢«ä½¿ç”¨çš„éƒ¨åˆ†å°±ä¼šè¢«ç½®ä¸º0ã€‚</p><p>opcode ä¸­æœ€ä½çš„ 3 ä½æ˜¯ <code>instruction class</code> (<code>cls</code>)ï¼Œå°† opcodes åˆ†äº†ç»„ï¼Œå…·ä½“ä¸ºä¸‹é¢å‡ ç§</p><p>LD/LDX/ST/STX opcode å…·æœ‰å¦‚ä¸‹ç»“æ„</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">msb      lsb</span></span>
<span class="line"><span style="color:#A6ACCD;">+---+--+---+</span></span>
<span class="line"><span style="color:#A6ACCD;">|mde|sz|cls|</span></span>
<span class="line"><span style="color:#A6ACCD;">+---+--+---+</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>å…¶ä¸­ä¸¤ä½çš„ <code>sz</code> åŸŸæŒ‡å®šäº†å†…å­˜ä½ç½®çš„å¤§å°ï¼Œ3 ä½çš„ <code>mde</code> åŸŸæ˜¯å†…å­˜è·å–æ¨¡å¼ï¼ŒuBPF åªæ”¯æŒé€šç”¨çš„ &quot;MEM&quot; è·å–æ–¹å¼ã€‚</p><p>ALU/ALU64/JMP opcode å…·æœ‰å¦‚ä¸‹ç»“æ„</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">msb      lsb</span></span>
<span class="line"><span style="color:#A6ACCD;">+----+-+---+</span></span>
<span class="line"><span style="color:#A6ACCD;">|op  |s|cls|</span></span>
<span class="line"><span style="color:#A6ACCD;">+----+-+---+</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>å¦‚æœ <code>s</code> ä½æ˜¯ 0ï¼Œé‚£ä¹ˆ source operand å°±ä¼šæ˜¯æŒ‡ä»¤ä¸­ç«‹å³æ•° <code>imm</code> å¯¹åº”çš„åŸŸã€‚å¦‚æœ <code>s</code> æ˜¯ 1ï¼Œé‚£ä¹ˆ source operand å°±ä¼šæ˜¯æŒ‡ä»¤ä¸­ <code>src</code> åŸŸã€‚4 ä½çš„ <code>op</code> åŸŸåˆ™æŒ‡å®šäº†å°†è¦æ‰§è¡Œå“ªä¸ª ALU æˆ– branch æ“ä½œã€‚</p><h3 id="alu-æŒ‡ä»¤" tabindex="-1">ALU æŒ‡ä»¤ <a class="header-anchor" href="#alu-æŒ‡ä»¤" aria-hidden="true">#</a></h3><h4 id="_64-bit" tabindex="-1">64-bit <a class="header-anchor" href="#_64-bit" aria-hidden="true">#</a></h4><table><thead><tr><th>Opcode</th><th>Mnemonic</th><th>Pseudocode</th></tr></thead><tbody><tr><td>0x07</td><td>add dst, imm</td><td>dst += imm</td></tr><tr><td>0x0f</td><td>add dst, src</td><td>dst += src</td></tr><tr><td>0x17</td><td>sub dst, imm</td><td>dst -= imm</td></tr><tr><td>0x1f</td><td>sub dst, src</td><td>dst -= src</td></tr><tr><td>0x27</td><td>mul dst, imm</td><td>dst *= imm</td></tr><tr><td>0x2f</td><td>mul dst, src</td><td>dst *= src</td></tr><tr><td>0x37</td><td>div dst, imm</td><td>dst /= imm</td></tr><tr><td>0x3f</td><td>div dst, src</td><td>dst /= src</td></tr><tr><td>0x47</td><td>or dst, imm</td><td>dst |= imm</td></tr><tr><td>0x4f</td><td>or dst, src</td><td>dst |= src</td></tr><tr><td>0x57</td><td>and dst, imm</td><td>dst &amp;= imm</td></tr><tr><td>0x5f</td><td>and dst, src</td><td>dst &amp;= src</td></tr><tr><td>0x67</td><td>lsh dst, imm</td><td>dst &lt;&lt;= imm</td></tr><tr><td>0x6f</td><td>lsh dst, src</td><td>dst &lt;&lt;= src</td></tr><tr><td>0x77</td><td>rsh dst, imm</td><td>dst &gt;&gt;= imm (logical)</td></tr><tr><td>0x7f</td><td>rsh dst, src</td><td>dst &gt;&gt;= src (logical)</td></tr><tr><td>0x87</td><td>neg dst</td><td>dst = -dst</td></tr><tr><td>0x97</td><td>mod dst, imm</td><td>dst %= imm</td></tr><tr><td>0x9f</td><td>mod dst, src</td><td>dst %= src</td></tr><tr><td>0xa7</td><td>xor dst, imm</td><td>dst ^= imm</td></tr><tr><td>0xaf</td><td>xor dst, src</td><td>dst ^= src</td></tr><tr><td>0xb7</td><td>mov dst, imm</td><td>dst = imm</td></tr><tr><td>0xbf</td><td>mov dst, src</td><td>dst = src</td></tr><tr><td>0xc7</td><td>arsh dst, imm</td><td>dst &gt;&gt;= imm (arithmetic)</td></tr><tr><td>0xcf</td><td>arsh dst, src</td><td>dst &gt;&gt;= src (arithmetic)</td></tr></tbody></table><h4 id="_32-bit" tabindex="-1">32-bit <a class="header-anchor" href="#_32-bit" aria-hidden="true">#</a></h4><p>è¿™äº›æŒ‡ä»¤åªä½¿ç”¨ä½çš„ 32 ä½ï¼Œå¹¶ä¸”ä¼šå°†ç›®æ ‡å¯„å­˜å™¨çš„é«˜ 32 ä½ç½®é›¶ã€‚</p><table><thead><tr><th>Opcode</th><th>Mnemonic</th><th>Pseudocode</th></tr></thead><tbody><tr><td>0x04</td><td>add32 dst, imm</td><td>dst += imm</td></tr><tr><td>0x0c</td><td>add32 dst, src</td><td>dst += src</td></tr><tr><td>0x14</td><td>sub32 dst, imm</td><td>dst -= imm</td></tr><tr><td>0x1c</td><td>sub32 dst, src</td><td>dst -= src</td></tr><tr><td>0x24</td><td>mul32 dst, imm</td><td>dst *= imm</td></tr><tr><td>0x2c</td><td>mul32 dst, src</td><td>dst *= src</td></tr><tr><td>0x34</td><td>div32 dst, imm</td><td>dst /= imm</td></tr><tr><td>0x3c</td><td>div32 dst, src</td><td>dst /= src</td></tr><tr><td>0x44</td><td>or32 dst, imm</td><td>dst |= imm</td></tr><tr><td>0x4c</td><td>or32 dst, src</td><td>dst |= src</td></tr><tr><td>0x54</td><td>and32 dst, imm</td><td>dst &amp;= imm</td></tr><tr><td>0x5c</td><td>and32 dst, src</td><td>dst &amp;= src</td></tr><tr><td>0x64</td><td>lsh32 dst, imm</td><td>dst &lt;&lt;= imm</td></tr><tr><td>0x6c</td><td>lsh32 dst, src</td><td>dst &lt;&lt;= src</td></tr><tr><td>0x74</td><td>rsh32 dst, imm</td><td>dst &gt;&gt;= imm (logical)</td></tr><tr><td>0x7c</td><td>rsh32 dst, src</td><td>dst &gt;&gt;= src (logical)</td></tr><tr><td>0x84</td><td>neg32 dst</td><td>dst = -dst</td></tr><tr><td>0x94</td><td>mod32 dst, imm</td><td>dst %= imm</td></tr><tr><td>0x9c</td><td>mod32 dst, src</td><td>dst %= src</td></tr><tr><td>0xa4</td><td>xor32 dst, imm</td><td>dst ^= imm</td></tr><tr><td>0xac</td><td>xor32 dst, src</td><td>dst ^= src</td></tr><tr><td>0xb4</td><td>mov32 dst, imm</td><td>dst = imm</td></tr><tr><td>0xbc</td><td>mov32 dst, src</td><td>dst = src</td></tr><tr><td>0xc4</td><td>arsh32 dst, imm</td><td>dst &gt;&gt;= imm (arithmetic)</td></tr><tr><td>0xcc</td><td>arsh32 dst, src</td><td>dst &gt;&gt;= src (arithmetic)</td></tr></tbody></table><h4 id="byteswap-æŒ‡ä»¤" tabindex="-1">Byteswap æŒ‡ä»¤ <a class="header-anchor" href="#byteswap-æŒ‡ä»¤" aria-hidden="true">#</a></h4><table><thead><tr><th>Opcode</th><th>Mnemonic</th><th>Pseudocode</th></tr></thead><tbody><tr><td>0xd4 (imm == 16)</td><td>le16 dst</td><td>dst = htole16(dst)</td></tr><tr><td>0xd4 (imm == 32)</td><td>le32 dst</td><td>dst = htole32(dst)</td></tr><tr><td>0xd4 (imm == 64)</td><td>le64 dst</td><td>dst = htole64(dst)</td></tr><tr><td>0xdc (imm == 16)</td><td>be16 dst</td><td>dst = htobe16(dst)</td></tr><tr><td>0xdc (imm == 32)</td><td>be32 dst</td><td>dst = htobe32(dst)</td></tr><tr><td>0xdc (imm == 64)</td><td>be64 dst</td><td>dst = htobe64(dst)</td></tr></tbody></table><h3 id="memory-æŒ‡ä»¤" tabindex="-1">Memory æŒ‡ä»¤ <a class="header-anchor" href="#memory-æŒ‡ä»¤" aria-hidden="true">#</a></h3><table><thead><tr><th>Opcode</th><th>Mnemonic</th><th>Pseudocode</th></tr></thead><tbody><tr><td>0x18</td><td>lddw dst, imm</td><td>dst = imm</td></tr><tr><td>0x20</td><td>ldabsw src, dst, imm</td><td>See kernel documentation</td></tr><tr><td>0x28</td><td>ldabsh src, dst, imm</td><td>...</td></tr><tr><td>0x30</td><td>ldabsb src, dst, imm</td><td>...</td></tr><tr><td>0x38</td><td>ldabsdw src, dst, imm</td><td>...</td></tr><tr><td>0x40</td><td>ldindw src, dst, imm</td><td>...</td></tr><tr><td>0x48</td><td>ldindh src, dst, imm</td><td>...</td></tr><tr><td>0x50</td><td>ldindb src, dst, imm</td><td>...</td></tr><tr><td>0x58</td><td>ldinddw src, dst, imm</td><td>...</td></tr><tr><td>0x61</td><td>ldxw dst, [src+off]</td><td>dst = *(uint32_t *) (src + off)</td></tr><tr><td>0x69</td><td>ldxh dst, [src+off]</td><td>dst = *(uint16_t *) (src + off)</td></tr><tr><td>0x71</td><td>ldxb dst, [src+off]</td><td>dst = *(uint8_t *) (src + off)</td></tr><tr><td>0x79</td><td>ldxdw dst, [src+off]</td><td>dst = *(uint64_t *) (src + off)</td></tr><tr><td>0x62</td><td>stw [dst+off], imm</td><td>*(uint32_t *) (dst + off) = imm</td></tr><tr><td>0x6a</td><td>sth [dst+off], imm</td><td>*(uint16_t *) (dst + off) = imm</td></tr><tr><td>0x72</td><td>stb [dst+off], imm</td><td>*(uint8_t *) (dst + off) = imm</td></tr><tr><td>0x7a</td><td>stdw [dst+off], imm</td><td>*(uint64_t *) (dst + off) = imm</td></tr><tr><td>0x63</td><td>stxw [dst+off], src</td><td>*(uint32_t *) (dst + off) = src</td></tr><tr><td>0x6b</td><td>stxh [dst+off], src</td><td>*(uint16_t *) (dst + off) = src</td></tr><tr><td>0x73</td><td>stxb [dst+off], src</td><td>*(uint8_t *) (dst + off) = src</td></tr><tr><td>0x7b</td><td>stxdw [dst+off], src</td><td>*(uint64_t *) (dst + off) = src</td></tr></tbody></table><h3 id="branch-æŒ‡ä»¤" tabindex="-1">Branch æŒ‡ä»¤ <a class="header-anchor" href="#branch-æŒ‡ä»¤" aria-hidden="true">#</a></h3><table><thead><tr><th>Opcode</th><th>Mnemonic</th><th>Pseudocode</th></tr></thead><tbody><tr><td>0x05</td><td>ja +off</td><td>PC += off</td></tr><tr><td>0x15</td><td>jeq dst, imm, +off</td><td>PC += off if dst == imm</td></tr><tr><td>0x1d</td><td>jeq dst, src, +off</td><td>PC += off if dst == src</td></tr><tr><td>0x25</td><td>jgt dst, imm, +off</td><td>PC += off if dst &gt; imm</td></tr><tr><td>0x2d</td><td>jgt dst, src, +off</td><td>PC += off if dst &gt; src</td></tr><tr><td>0x35</td><td>jge dst, imm, +off</td><td>PC += off if dst &gt;= imm</td></tr><tr><td>0x3d</td><td>jge dst, src, +off</td><td>PC += off if dst &gt;= src</td></tr><tr><td>0xa5</td><td>jlt dst, imm, +off</td><td>PC += off if dst &lt; imm</td></tr><tr><td>0xad</td><td>jlt dst, src, +off</td><td>PC += off if dst &lt; src</td></tr><tr><td>0xb5</td><td>jle dst, imm, +off</td><td>PC += off if dst &lt;= imm</td></tr><tr><td>0xbd</td><td>jle dst, src, +off</td><td>PC += off if dst &lt;= src</td></tr><tr><td>0x45</td><td>jset dst, imm, +off</td><td>PC += off if dst &amp; imm</td></tr><tr><td>0x4d</td><td>jset dst, src, +off</td><td>PC += off if dst &amp; src</td></tr><tr><td>0x55</td><td>jne dst, imm, +off</td><td>PC += off if dst != imm</td></tr><tr><td>0x5d</td><td>jne dst, src, +off</td><td>PC += off if dst != src</td></tr><tr><td>0x65</td><td>jsgt dst, imm, +off</td><td>PC += off if dst &gt; imm (signed)</td></tr><tr><td>0x6d</td><td>jsgt dst, src, +off</td><td>PC += off if dst &gt; src (signed)</td></tr><tr><td>0x75</td><td>jsge dst, imm, +off</td><td>PC += off if dst &gt;= imm (signed)</td></tr><tr><td>0x7d</td><td>jsge dst, src, +off</td><td>PC += off if dst &gt;= src (signed)</td></tr><tr><td>0xc5</td><td>jslt dst, imm, +off</td><td>PC += off if dst &lt; imm (signed)</td></tr><tr><td>0xcd</td><td>jslt dst, src, +off</td><td>PC += off if dst &lt; src (signed)</td></tr><tr><td>0xd5</td><td>jsle dst, imm, +off</td><td>PC += off if dst &lt;= imm (signed)</td></tr><tr><td>0xdd</td><td>jsle dst, src, +off</td><td>PC += off if dst &lt;= src (signed)</td></tr><tr><td>0x85</td><td>call imm</td><td>Function call</td></tr><tr><td>0x95</td><td>exit</td><td>return r0</td></tr></tbody></table><p>æ›´åŠ è¯¦ç»†çš„åè®®å‚è€ƒ<a href="#Reference">å†…æ ¸ bpf ç›¸å…³æ–‡æ¡£</a></p><h2 id="å¸¸è§çš„-bpf-prog-type" tabindex="-1">å¸¸è§çš„ bpf_prog_type <a class="header-anchor" href="#å¸¸è§çš„-bpf-prog-type" aria-hidden="true">#</a></h2><table><thead><tr><th><strong>bpf_prog_type</strong></th><th><strong>BPF prog</strong> å…¥å£å‚æ•°ï¼ˆR1)</th><th><strong>ç¨‹åºç±»å‹</strong></th></tr></thead><tbody><tr><td><strong>BPF_PROG_TYPE_SOCKET_FILTER</strong></td><td><strong>struct __sk_buff</strong></td><td>ç”¨äºè¿‡æ»¤è¿›å‡ºå£ç½‘ç»œæŠ¥æ–‡ï¼ŒåŠŸèƒ½ä¸Šå’Œ cBPF ç±»ä¼¼ã€‚</td></tr><tr><td><strong>BPF_PROG_TYPE_KPROBE</strong></td><td><strong>struct</strong> <strong>pt_regs</strong></td><td>ç”¨äº kprobe åŠŸèƒ½çš„ BPF ä»£ç ã€‚</td></tr><tr><td><strong>BPF_PROG_TYPE_TRACEPOINT</strong></td><td>è¿™ç±» BPF çš„å‚æ•°æ¯”è¾ƒç‰¹æ®Šï¼Œæ ¹æ® tracepoint ä½ç½®çš„ä¸åŒè€Œä¸åŒã€‚</td><td>ç”¨äºåœ¨å„ä¸ª tracepoint èŠ‚ç‚¹è¿è¡Œã€‚</td></tr><tr><td><strong>BPF_PROG_TYPE_XDP</strong></td><td><strong>struct</strong> <strong>xdp_md</strong></td><td>ç”¨äºæ§åˆ¶ XDP(eXtreme Data Path)çš„ BPF ä»£ç ã€‚</td></tr><tr><td><strong>BPF_PROG_TYPE_PERF_EVENT</strong></td><td><strong>struct bpf_perf_event_data</strong></td><td>ç”¨äºå®šä¹‰ perf event å‘ç”Ÿæ—¶å›è°ƒçš„ BPF ä»£ç ã€‚</td></tr><tr><td><strong>BPF_PROG_TYPE_CGROUP_SKB</strong></td><td><strong>struct __sk_buff</strong></td><td>ç”¨äºåœ¨ network cgroup ä¸­è¿è¡Œçš„ BPF ä»£ç ã€‚åŠŸèƒ½ä¸Šå’Œ Socket_Filter è¿‘ä¼¼ã€‚å…·ä½“ç”¨æ³•å¯ä»¥å‚è€ƒèŒƒä¾‹ test_cgrp2_attachã€‚</td></tr><tr><td><strong>BPF_PROG_TYPE_CGROUP_SOCK</strong></td><td><strong>struct bpf_sock</strong></td><td>å¦ä¸€ä¸ªç”¨äºåœ¨ network cgroup ä¸­è¿è¡Œçš„ BPF ä»£ç ï¼ŒèŒƒä¾‹ test_cgrp2_sock2 ä¸­å°±å±•ç¤ºäº†ä¸€ä¸ªåˆ©ç”¨ BPF æ¥æ§åˆ¶ host å’Œ netns é—´é€šä¿¡çš„ä¾‹å­ã€‚</td></tr></tbody></table><p>ä¸ç½‘ç»œç›¸å…³çš„æœ‰XDPã€socketã€tcç­‰ã€‚</p><p>äº‹å®ä¸Š BPF ç¨‹åºç±»å‹å°±æ˜¯ç”± BPF side çš„ä»£ç çš„å‡½æ•°å‚æ•°ç¡®å®šçš„ï¼Œæ¯”å¦‚å†™äº†ä¸€ä¸ªå‡½æ•°ï¼Œå‚æ•°æ˜¯ <code>struct __sk_buff</code> ç±»å‹çš„ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ª <strong>BPF_PROG_TYPE_SOCKET_FILTER</strong> ç±»å‹çš„ BPF ç¨‹åºã€‚</p><h2 id="å…¶ä»–çš„-bpf-ç›¸å…³æ¦‚å¿µ" tabindex="-1">å…¶ä»–çš„ BPF ç›¸å…³æ¦‚å¿µ <a class="header-anchor" href="#å…¶ä»–çš„-bpf-ç›¸å…³æ¦‚å¿µ" aria-hidden="true">#</a></h2><h3 id="helper-function" tabindex="-1">Helper Function <a class="header-anchor" href="#helper-function" aria-hidden="true">#</a></h3><p>BPF ç³»ç»Ÿè°ƒç”¨çš„åŸå‹å¦‚ä¸‹ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">linux/bpf.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">bpf</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">cmd</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">union</span><span style="color:#A6ACCD;"> bpf_attr </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">attr</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">unsigned</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">size</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p>bpfç³»ç»Ÿè°ƒç”¨è¦æ‰§è¡Œçš„æ“ä½œç”± <code>cmd</code> å‚æ•°ç¡®å®šã€‚æ¯ä¸ªæ“ä½œéƒ½æœ‰ä¸€ä¸ªé™„å¸¦çš„å‚æ•°ï¼Œé€šè¿‡ <code>attr</code> æä¾›ï¼Œ<code>size</code> å‚æ•°æ˜¯ <code>attr</code> çš„å¤§å°ã€‚</p><p><code>cmd</code> å‚æ•°å¯ä»¥æ˜¯ä¸€ç³»åˆ— helper çš„å®å®šä¹‰ï¼Œå¦‚ BPF_MAP_CREATEã€ BPF_MAP_LOOKUP_ELEMã€BPF_MAP_UPDATE_ELEMã€BPF_MAP_DELETE_ELEMã€BPF_MAP_GET_NEXT_KEYã€BPF_PROG_LOADï¼›åˆ†åˆ«æ˜¯å¯¹åº” map åˆ›å»ºã€map ä¸­å…ƒç´ æŸ¥æ‰¾ã€map ä¸­æ›´æ–°å…ƒç´ ã€map ä¸­åˆ é™¤å…ƒç´ ã€è·å–ç›¸é‚»çš„ keyã€åŠ è½½ bpf ç¨‹åºã€‚<code>bpf_attr</code> åˆ™ç›¸å½“å¤æ‚ï¼Œä¸å±•å¼€è¯´äº†ï¼Œå®é™…ä¸Šä¹Ÿå¾ˆå°‘ç›´æ¥ä½¿ç”¨è¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œéƒ½æ˜¯ä½¿ç”¨ BPF helper å‡½æ•°çš„ã€‚</p><p>Helper functions æ˜¯ä¸€äº›ä¸å†…æ ¸äº¤äº’çš„å¸¸ç”¨ APIï¼Œ å¯ä»¥ä»å†…æ ¸è·å–æˆ–å†™å…¥æ•°æ®ã€‚ä¸åŒçš„ BPF ç¨‹åºç±»å‹ <code>bpf_prog_type</code> å¯ç”¨çš„ helper function ä¸åŒï¼Œä¾‹å¦‚ä¸ socket æœ‰å…³çš„ BPF å‡½æ•°å°±åªå…è®¸ä½¿ç”¨ä¸€å°éƒ¨åˆ†çš„ helpersï¼Œè€Œä¸ tc ï¼ˆtraffic control çš„ç¼©å†™ï¼Œæ›´åŠ é è¿‘ä¼ è¾“å±‚ï¼Œè€Œä¸”æ­¤æ—¶åŒ…éƒ½è¿˜æ²¡è§£æï¼‰ç›¸å…³çš„ BPF å‡½æ•°å¯ä»¥è°ƒç”¨æ›´å¤šçš„ helpersã€‚</p><p>å†…æ ¸å°† helper å‡½æ•°æŠ½è±¡åˆ°äº†å® <code>BPF_CALL_0()</code> åˆ° <code>BPF_CALL_5()</code>ï¼Œè®©å®šä¹‰è¿‡ç¨‹æ›´åŠ ç®€å•ï¼Œæ›´åŠ å¯è¯»ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å°±èŠ‚é€‰è‡ªä¸€ä¸ªç”¨æ¥æ›´æ–°æ˜ å°„å…ƒç´ çš„ helper functionï¼Œå®ƒè°ƒç”¨äº†æ˜ å°„ä¸Šå®ç°çš„ç›¸å…³çš„å›è°ƒå‡½æ•°</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// æ³¨æ„è¿™æ˜¯ä¸€ä¸ªå®</span></span>
<span class="line"><span style="color:#82AAFF;">BPF_CALL_4</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">bpf_map_update_elem</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> bpf_map </span><span style="color:#89DDFF;">*,</span><span style="color:#A6ACCD;"> map</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*,</span><span style="color:#A6ACCD;"> key</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">*,</span><span style="color:#A6ACCD;"> value</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> u64</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> flags</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#82AAFF;">WARN_ON_ONCE</span><span style="color:#89DDFF;">(!</span><span style="color:#82AAFF;">rcu_read_lock_held</span><span style="color:#89DDFF;">());</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#A6ACCD;">map</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#A6ACCD;">ops</span><span style="color:#89DDFF;">-&gt;</span><span style="color:#82AAFF;">map_update_elem</span><span style="color:#89DDFF;">(</span><span style="color:#F07178;">map</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> key</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> value</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> flags</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> bpf_func_proto bpf_map_update_elem_proto </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    .func           </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> bpf_map_update_elem</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    .gpl_only       </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">false,</span></span>
<span class="line"><span style="color:#F07178;">    .ret_type       </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> RET_INTEGER</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    .arg1_type      </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ARG_CONST_MAP_PTR</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    .arg2_type      </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ARG_PTR_TO_MAP_KEY</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    .arg3_type      </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ARG_PTR_TO_MAP_VALUE</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">    .arg4_type      </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> ARG_ANYTHING</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"></span></code></pre></div><p>è¿™ç§æå‰å®šä¹‰å®çš„å¥½å¤„æ˜¯ï¼šåœ¨ cBPF ä¸­ï¼Œå½“æ·»åŠ æ–°çš„ helperæ—¶ï¼ŒJIT éœ€è¦å¯¹è¿™ç§æ‰©å±•åšæ”¯æŒï¼›ä½†æ˜¯åœ¨ eBPF ä¸­ï¼Œåº•å±‚çš„ BPF å¯„å­˜å™¨çš„åˆ†é…å·²ç»æå‰åšå¥½äº†ï¼ŒJIT æ­¤æ—¶åªéœ€è¦è§¦å‘ä¸€ä¸ªè°ƒç”¨æŒ‡ä»¤ã€‚å› æ­¤ eBPF çš„ helper functions æ›´å®¹æ˜“æ‹“å±•ã€‚</p><p>helper functions æ•°é‡ä¼—å¤šï¼Œå¯ä»¥å‚è€ƒé™„å½•ä¸­çš„<a href="https://github.com/iovisor/bpf-docs/blob/master/bpf_helpers.rst/" target="_blank" rel="noreferrer">eBPF-Helpers</a>ã€‚</p><h3 id="verifier" tabindex="-1">Verifier <a class="header-anchor" href="#verifier" aria-hidden="true">#</a></h3><p>ä¸Šé¢ helper function ä»£ç ä¸­çš„ <code>bpf_func_proto</code> æ˜¯ç”¨æ¥ä¼ é€’ verifier çš„å¿…è¦æ•°æ®çš„ï¼Œç”¨æ¥éªŒè¯ helper æä¾›çš„å‚æ•°ç±»å‹å’Œå½“ä¸‹ BPF å¯„å­˜å™¨ä¸­çš„å†…å®¹ç¬¦åˆã€‚å‚æ•°ç±»å‹å¯ä»¥æ˜¯ä»»æ„çš„å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯é’ˆå¯¹ä¸€ä¸ª buffer çš„ &lt;æŒ‡é’ˆï¼Œå¤§å°&gt; çš„æ•°æ®å¯¹ï¼Œå‘Šè¯‰ helper å®ƒåº”è¯¥ä»å“ªé‡Œè¯»å–æ•°æ®æˆ–å†™å…¥æ•°æ®ï¼Œ verifier ä¼šéªŒè¯ buffer ä¹‹å‰æ˜¯å¦æœ‰è¢«åˆå§‹åŒ–è¿‡ã€‚</p><p>In-kernel Verifierè¿˜ä¼šéªŒè¯ï¼š</p><ul><li>å¯¹æ³¨å…¥ä»£ç è¿›è¡Œä¸€æ¬¡ DAG(Directed Acyclic Graphï¼Œæœ‰å‘æ— ç¯å›¾)æ£€æµ‹ï¼Œä»¥ä¿è¯å…¶ä¸­æ²¡æœ‰å¾ªç¯å­˜åœ¨</li><li>eBPF çš„ä»£ç é•¿åº¦ä¸Šé™ä¸º 4096 æ¡ BPF æŒ‡ä»¤ï¼ˆåœ¨å†…æ ¸ 5.1 ç‰ˆæœ¬ä»¥ä¸Šï¼Œè¿™ä¸ªä¸Šé™æå‡åˆ°äº† 100 ä¸‡ï¼‰ã€‚</li><li>å­˜åœ¨å¯èƒ½ä¼šè·³å‡º eBPF ä»£ç èŒƒå›´çš„ JMP</li><li>åˆ†æ”¯(branch)ä¸å…è®¸è¶…è¿‡ 1024 ä¸ªï¼›ç»æ£€æµ‹çš„æŒ‡ä»¤æ•°ä¹Ÿå¿…é¡»åœ¨ 96K ä»¥å†…</li><li>æ”¯æŒè¿è¡Œå°¾è°ƒç”¨ï¼ˆtail callsï¼‰ï¼Œå³åœ¨ eBPF ç¨‹åºæœ«å°¾è°ƒç”¨å¦ä¸€ä¸ª eBPF ç¨‹åºï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰é™åˆ¶çš„ï¼Œæœ€å¤šå¯ä»¥åµŒå¥— 33 æ¬¡ å°¾è°ƒç”¨</li><li>BPF helper å‡½æ•°ä¸­æœ€å¤šå…è®¸5ä¸ªå‡½æ•°å‚æ•°</li></ul><p>verifieræ‰§è¡Œçš„ç¬¬ä¸€ä¸ªæ£€æŸ¥æ˜¯å¯¹VMå°†è¦åŠ è½½çš„ä»£ç çš„é™æ€åˆ†æã€‚ç¬¬ä¸€æ¬¡æ£€æŸ¥çš„ç›®çš„æ˜¯ç¡®ä¿ç¨‹åºæœ‰ä¸€ä¸ªé¢„æœŸçš„ç»“æŸã€‚ä¸ºæ­¤ï¼Œverifier ä½¿ç”¨ä»£ç åˆ›å»ºä¸€ä¸ªç›´æ¥éå¾ªç¯å›¾ï¼ˆDAGï¼‰ã€‚verifier åˆ†æçš„æ¯æ¡æŒ‡ä»¤éƒ½æˆä¸ºå›¾ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½é“¾æ¥åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚åœ¨ verifier ç”Ÿæˆè¿™ä¸ªå›¾ä¹‹åï¼Œå®ƒå°†æ‰§è¡Œæ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰ï¼Œä»¥ç¡®ä¿ç¨‹åºå®Œæˆå¹¶ä¸”ä»£ç ä¸åŒ…å«å±é™©è·¯å¾„ã€‚è¿™æ„å‘³ç€å®ƒå°†éå†å›¾çš„æ¯ä¸ªåˆ†æ”¯ï¼Œä¸€ç›´éå†åˆ°åˆ†æ”¯çš„åº•éƒ¨ï¼Œä»¥ç¡®ä¿æ²¡æœ‰é€’å½’å¾ªç¯ã€‚</p><p>verifier æ‰§è¡Œçš„ç¬¬äºŒä¸ªæ£€æŸ¥æ˜¯BPFç¨‹åºçš„ä¸€ä¸ªç©ºè¿è¡Œã€‚è¿™æ„å‘³ç€verifierå°†å°è¯•åˆ†æç¨‹åºå°†è¦æ‰§è¡Œçš„æ¯æ¡æŒ‡ä»¤ï¼Œä»¥ç¡®ä¿å®ƒä¸ä¼šæ‰§è¡Œä»»ä½•æ— æ•ˆçš„æŒ‡ä»¤ã€‚æ­¤æ‰§è¡Œè¿˜æ£€æŸ¥æ˜¯å¦æ­£ç¡®è®¿é—®å’Œå–æ¶ˆå¼•ç”¨äº†æ‰€æœ‰å†…å­˜æŒ‡é’ˆã€‚æœ€åï¼Œç©ºè¿è¡Œå°†ç¨‹åºä¸­çš„æ§åˆ¶æµé€šçŸ¥ verifierï¼Œä»¥ç¡®ä¿æ— è®ºç¨‹åºé‡‡ç”¨å“ªç§æ§åˆ¶è·¯å¾„ï¼Œå®ƒéƒ½ä¼šåˆ°è¾¾ BPF_EXIT æŒ‡ä»¤ã€‚ä¸ºæ­¤ï¼Œverifier è·Ÿè¸ªå †æ ˆä¸­æ‰€æœ‰å·²è®¿é—®çš„åˆ†æ”¯è·¯å¾„ï¼Œåœ¨é€‰æ‹©æ–°è·¯å¾„ä¹‹å‰å¯¹å…¶è¿›è¡Œè¯„ä¼°ï¼Œä»¥ç¡®ä¿ä¸ä¼šå¤šæ¬¡è®¿é—®ç‰¹å®šè·¯å¾„ã€‚åœ¨è¿™ä¸¤ä¸ªæ£€æŸ¥é€šè¿‡ä¹‹åï¼Œverifier è®¤ä¸ºç¨‹åºå¯ä»¥å®‰å…¨åœ°æ‰§è¡Œã€‚</p><p>bpf ç³»ç»Ÿè°ƒç”¨å…è®¸æ‚¨ debug verifier çš„æ£€æŸ¥ï¼Œå¦‚æœæ‚¨å¯¹åˆ†æç¨‹åºå¦‚ä½•è¢«åˆ†ææ„Ÿå…´è¶£çš„è¯ã€‚ä½¿ç”¨æ­¤ç³»ç»Ÿè°ƒç”¨åŠ è½½ç¨‹åºæ—¶ï¼Œå¯ä»¥è®¾ç½®å‡ ä¸ªå±æ€§ï¼Œä½¿éªŒè¯å™¨æ‰“å°å…¶æ“ä½œæ—¥å¿—ã€‚</p><h3 id="maps" tabindex="-1">Maps <a class="header-anchor" href="#maps" aria-hidden="true">#</a></h3><p>BPF æ˜ å°„æ˜¯å†…æ ¸ä¸­çš„é”®å€¼å‹æ•°æ®ç»“æ„ï¼Œä»–ä»¬èƒ½å¤Ÿä» BPF ç¨‹åºä¸­è·å–ï¼Œæ¥åœ¨ä¸åŒçš„ BPF è°ƒç”¨ä¹‹é—´ä¼ é€’çŠ¶æ€ä¿¡æ¯ã€‚ä»–ä»¬ä¹Ÿèƒ½é€šè¿‡ç”¨æˆ·ç©ºé—´çš„æ–‡ä»¶æè¿°ç¬¦æ¥è·å–ï¼Œä¹Ÿèƒ½åœ¨ BPF ç¨‹åºæˆ–ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ä¹‹é—´å…±äº«ã€‚æ³¨æ„å…±äº« BPF æ˜ å°„çš„ BPF ç¨‹åºä¸ä¸€å®šæ˜¯ç›¸åŒçš„ç¨‹åºç±»å‹ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ª tracing ç¨‹åºä¹Ÿå¯èƒ½å¯ä»¥å’Œç½‘ç»œç¨‹åºå…±äº«æ˜ å°„ï¼Œå½“ä¸‹ä¸€ä¸ªå•ç‹¬çš„ BPF ç¨‹åºæœ€å¤šå¯ä»¥åŒæ—¶è·å–åˆ° 64 ä¸ªä¸åŒçš„æ˜ å°„ã€‚</p><p><img src="/assets/bpf_map.a3baa525.png" alt="bpf_map.png"></p><p>æ˜ å°„çš„å®ç°æ˜¯åœ¨å†…æ ¸ä¸­ï¼Œæœ‰é€šç”¨çš„ï¼Œä¹Ÿæœ‰ä»…èƒ½åœ¨å°‘æ•° helper functions ä¸­ä½¿ç”¨çš„ã€‚é€šç”¨çš„æ˜ å°„æœ‰<code>BPF_MAP_TYPE_HASH</code>, <code>BPF_MAP_TYPE_ARRAY</code>, <code>BPF_MAP_TYPE_PERCPU_HASH</code>, <code>BPF_MAP_TYPE_PERCPU_ARRAY</code>, <code>BPF_MAP_TYPE_LRU_HASH</code>, <code>BPF_MAP_TYPE_LRU_PERCPU_HASH</code> and <code>BPF_MAP_TYPE_LPM_TRIE</code>ã€‚ä»–ä»¬éƒ½æ˜¯ç”¨çš„æ˜¯ç›¸åŒçš„ BPF helper functions æ¥å®ç°å¢åˆ æŸ¥æ”¹ï¼ŒåŒæ—¶é’ˆå¯¹ä¸åŒçš„è¯­ä¹‰å’Œåº”ç”¨ç‰¹å¾å®ç°äº†ä¸åŒçš„åç«¯æ“ä½œã€‚</p><p>ç°æœ‰çš„ä¸é€šç”¨çš„æ˜ å°„æœ‰ <code>BPF_MAP_TYPE_PROG_ARRAY</code>, <code>BPF_MAP_TYPE_PERF_EVENT_ARRAY</code>, <code>BPF_MAP_TYPE_CGROUP_ARRAY</code>, <code>BPF_MAP_TYPE_STACK_TRACE</code>, <code>BPF_MAP_TYPE_ARRAY_OF_MAPS</code>, <code>BPF_MAP_TYPE_HASH_OF_MAPS</code>ã€‚ä¾‹å¦‚ï¼Œ<code>BPF_MAP_TYPE_PROG_ARRAY</code> æ˜¯ä¸€ä¸ªåŒ…å«æœ‰å…¶ä»– BPF ç¨‹åºçš„æ•°ç»„ï¼Œ <code>BPF_MAP_TYPE_ARRAY_OF_MAPS</code> å’Œ <code>BPF_MAP_TYPE_HASH_OF_MAPS</code> éƒ½æŒæœ‰ç€æŒ‡å‘å…¶ä»–æ˜ å°„çš„æŒ‡é’ˆï¼Œä¸ºäº†åœ¨è¿è¡Œæ—¶èƒ½åŸå­åœ°æ›´æ¢ BPF æ˜ å°„ã€‚é€šè¿‡è¿™ç§å®ç°æ»¡è¶³äº†è¿™ä¸ªç‰¹æ®Šçš„éœ€æ±‚ã€‚å› ä¸ºçŠ¶æ€æ˜¯éœ€è¦åœ¨ä¸åŒçš„ BPF ç¨‹åºè°ƒç”¨ä¸­å…±äº«çš„ï¼Œæ‰€ä»¥ä¸èƒ½å•ç‹¬é€šè¿‡ä¸€ä¸ª BPF helper functionå®ç°ï¼Œè€Œæ˜¯è¦ç”¨è¿™ç§æ–¹æ³•ã€‚</p><p>è¡¥å…… MAP ç±»å‹ç»†èŠ‚ï¼š</p><ul><li>BPF_MAP_TYPE_HASHï¼šç¬¬ä¸€ä¸ªæ·»åŠ åˆ°BPFçš„é€šç”¨ mapã€‚å®ƒä»¬çš„å®ç°å’Œç”¨æ³•ç±»ä¼¼äºæ‚¨å¯èƒ½ç†Ÿæ‚‰çš„å…¶ä»–å“ˆå¸Œè¡¨ã€‚</li><li>BPF_MAP_TYPE_ARRAYï¼šæ·»åŠ åˆ°å†…æ ¸çš„ç¬¬äºŒç§ BPF æ˜ å°„ã€‚å®ƒçš„æ‰€æœ‰å…ƒç´ éƒ½åœ¨å†…å­˜ä¸­é¢„å…ˆåˆ†é…å¹¶è®¾ç½®ä¸ºé›¶å€¼ã€‚é”®æ˜¯æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œå®ƒä»¬çš„å¤§å°å¿…é¡»æ­£å¥½æ˜¯4ä¸ªå­—èŠ‚ã€‚ä½¿ç”¨ Array maps çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯ä¸èƒ½åˆ é™¤mapä¸­çš„å…ƒç´ ã€‚å¦‚æœå°è¯•åœ¨ array maps ä¸Šä½¿ç”¨map_delete_elemï¼Œåˆ™è°ƒç”¨å°†å¤±è´¥ï¼Œç»“æœå°†å¯¼è‡´é”™è¯¯ EINVALã€‚</li><li>BPF_MAP_TYPE_PROG_ARRAYï¼šæ‚¨å¯ä»¥ä½¿ç”¨è¿™ç§ç±»å‹çš„ map,æ¥å­˜å‚¨BPFç¨‹åºçš„æ–‡ä»¶æè¿°ã€‚ä¸ bpf_tail_call è°ƒç”¨ç»“åˆï¼Œæ­¤ map å…è®¸æ‚¨åœ¨ç¨‹åºä¹‹é—´è·³è½¬ï¼Œç»•è¿‡å•ä¸ª bpf ç¨‹åºçš„æœ€å¤§æŒ‡ä»¤é™åˆ¶ï¼Œå¹¶é™ä½å®ç°å¤æ‚æ€§ã€‚</li><li>BPF_MAP_TYPE_PERF_EVENT_ARRAYï¼šè¿™äº›ç±»å‹çš„ map å°† perf_events æ•°æ®å­˜å‚¨åœ¨ç¼“å†²ç¯ä¸­ï¼Œç¼“å†²ç¯åœ¨BPFç¨‹åºå’Œç”¨æˆ·ç©ºé—´ç¨‹åºä¹‹é—´å®æ—¶é€šä¿¡ã€‚å®ƒä»¬è¢«è®¾è®¡ç”¨æ¥å°†å†…æ ¸çš„è·Ÿè¸ªå·¥å…·å‘å‡ºçš„äº‹ä»¶è½¬å‘ç»™ç”¨æˆ·ç©ºé—´ç¨‹åºè¿›è¡Œè¿›ä¸€æ­¥å¤„ç†ã€‚</li><li>BPF_MAP_TYPE_PERCPU_HASHï¼šPer-CPU Hash Maps æ˜¯ BPF_MAP_TYPE_HASH çš„æ”¹è¿›ç‰ˆæœ¬ã€‚å½“æ‚¨åˆ†é…å…¶ä¸­ä¸€ä¸ª map æ—¶ï¼Œæ¯ä¸ªCPUéƒ½ä¼šçœ‹åˆ°è‡ªå·±ç‹¬ç«‹çš„mapç‰ˆæœ¬ï¼Œè¿™ä½¿å¾—å®ƒæ›´é«˜æ•ˆåœ°è¿›è¡Œé«˜æ€§èƒ½çš„æŸ¥æ‰¾å’Œèšåˆã€‚å¦‚æœæ‚¨çš„BPFç¨‹åºæ”¶é›†åº¦é‡å¹¶å°†å®ƒä»¬èšåˆåˆ° hash-table mapsä¸­ï¼Œé‚£ä¹ˆè¿™ç§mapéå¸¸æœ‰ç”¨ã€‚</li><li>BPF_MAP_TYPE_PERCPU_ARRAYï¼šPer-CPU Array Maps æ˜¯ BPF_MAP_TYPE_ARRAY çš„æ”¹è¿›ç‰ˆæœ¬ã€‚å½“æ‚¨åˆ†é…è¿™äº› map ä¸­çš„ä¸€ä¸ªæ—¶ï¼Œæ¯ä¸ªCPUéƒ½ä¼šçœ‹åˆ°è‡ªå·±çš„ç‹¬ç«‹ç‰ˆæœ¬çš„ mapï¼Œè¿™ä½¿å¾—å®ƒæ›´é«˜æ•ˆåœ°è¿›è¡Œé«˜æ€§èƒ½çš„æŸ¥æ‰¾å’Œèšåˆã€‚</li><li>BPF_MAP_TYPE_STACK_TRACEï¼šè¿™ç§ç±»å‹çš„ map å­˜å‚¨è¿è¡Œè¿›ç¨‹çš„å †æ ˆè·Ÿè¸ªã€‚é™¤äº†è¿™ä¸ª map ä¹‹å¤–ï¼Œå†…æ ¸å¼€å‘äººå‘˜å·²ç»æ·»åŠ äº†å¸®åŠ©å‡½æ•°bpf_get_stackidæ¥å¸®åŠ©æ‚¨ç”¨å †æ ˆè·Ÿè¸ªå¡«å……è¿™ä¸ªæ˜ å°„ã€‚</li><li>BPF_MAP_TYPE_CGROUP_ARRAYï¼šè¿™ç§ç±»å‹çš„ map å­˜å‚¨æŒ‡å‘ cgroup çš„æ–‡ä»¶æè¿°ç¬¦æ ‡è¯†ç¬¦ã€‚ BPF_MAP_TYPE_LRU_HASH and BPF_MAP_TYPE_LRU_PERCPU_HASHï¼šå¦‚æœ map æ»¡äº†ï¼Œåˆ é™¤ä¸å¸¸ä½¿ç”¨çš„ mapï¼Œä¸ºæ–°å…ƒç´ æä¾›ç©ºé—´ã€‚percpu åˆ™æ˜¯é’ˆå¯¹æ¯ä¸ª cpuã€‚</li><li>BPF_MAP_TYPE_LPM_TRIEï¼šä¸€ä¸ªåŒ¹é…æœ€é•¿å‰ç¼€çš„å­—å…¸æ ‘æ•°æ®ç»“æ„ï¼Œé€‚ç”¨äºå°† IP åœ°å€åŒ¹é…åˆ°ä¸€ä¸ªèŒƒå›´ã€‚è¿™äº› map è¦æ±‚å…¶ key å¤§å°ä¸º 8 çš„å€æ•°ï¼ŒèŒƒå›´ä¸º 8 åˆ° 2048ã€‚å¦‚æœæ‚¨ä¸æƒ³å®ç°è‡ªå·±çš„ keyï¼Œé‚£ä¹ˆå†…æ ¸æä¾›äº†ä¸€ä¸ªå¯ä»¥ç”¨äºè¿™äº› key çš„ç»“æ„ï¼Œç§°ä¸º bpf_lpm_trie_keyã€‚</li><li>BPF_MAP_TYPE_ARRAY_OF_MAPS and BPF_MAP_TYPE_HASH_OF_MAPSï¼šå­˜å‚¨å¯¹å…¶ä»–æ˜ å°„çš„å¼•ç”¨çš„ä¸¤ç§ç±»å‹çš„æ˜ å°„ã€‚å®ƒä»¬åªæ”¯æŒä¸€ä¸ªçº§åˆ«çš„é—´æ¥å¯»å€ã€‚</li><li>BPF_MAP_TYPE_DEVMAPï¼šå­˜å‚¨å¯¹ç½‘ç»œè®¾å¤‡çš„å¼•ç”¨ã€‚å¯ä»¥æ„å»ºæŒ‡å‘ç‰¹å®šç½‘ç»œè®¾å¤‡çš„ç«¯å£çš„è™šæ‹Ÿæ˜ å°„ï¼Œç„¶åä½¿ç”¨ bpf_redirect_map é‡å®šå‘æ•°æ®åŒ…ã€‚</li><li>BPF_MAP_TYPE_CPUMAPï¼šå¯ä»¥å°†æ•°æ®åŒ…è½¬å‘åˆ°ä¸åŒçš„ cpu</li><li>BPF_MAP_TYPE_XSKMAPï¼šä¸€ç§å­˜å‚¨å¯¹æ‰“å¼€çš„å¥—æ¥å­—çš„å¼•ç”¨çš„æ˜ å°„ç±»å‹ã€‚ç”¨äºå¥—æ¥å­—è½¬å‘ã€‚</li><li>BPF_MAP_TYPE_SOCKMAPå’ŒBPF_MAP_TYPE_SOCKHASH æ˜¯ä¸¤ä¸ªä¸“é—¨çš„ mapã€‚å®ƒä»¬å­˜å‚¨å¯¹å†…æ ¸ä¸­æ‰“å¼€çš„å¥—æ¥å­—çš„å¼•ç”¨ã€‚ä¸å‰é¢çš„æ˜ å°„ä¸€æ ·ï¼Œè¿™ç§ç±»å‹çš„æ˜ å°„ä¸ bpf_redirect_map ä¸€èµ·ä½¿ç”¨ï¼Œå°†å¥—æ¥å­—ç¼“å†²åŒºä»å½“å‰ XDP ç¨‹åºè½¬å‘åˆ°ä¸åŒçš„å¥—æ¥å­—ã€‚</li><li>BPF_MAP_TYPE_CGROUP_STORAGE å’Œ BPF_MAP_TYPE_PERCPU_CGROUP_STORAGEï¼šç•¥</li><li>BPF_MAP_TYPE_REUSEPORT_SOCKARRAYï¼šç•¥</li><li>BPF_MAP_TYPE_QUEUEï¼šé˜Ÿåˆ—æ˜ å°„ä½¿ç”¨å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰å­˜å‚¨æ¥ä¿å­˜æ˜ å°„ä¸­çš„å…ƒç´ ã€‚å®ƒä»¬æ˜¯ç”¨ BPF_MAP_TYPE_QUEUE ç±»å‹å®šä¹‰çš„ã€‚FIFO æ„å‘³ç€ï¼Œå½“æ‚¨ä»æ˜ å°„ä¸­è·å–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œç»“æœå°†æ˜¯æ˜ å°„ä¸­å­˜åœ¨æ—¶é—´æœ€é•¿çš„å…ƒç´ ã€‚ BPF_MAP_TYPE_STACKï¼šæ ˆæ˜ å°„ä½¿ç”¨åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰å­˜å‚¨æ¥ä¿å­˜æ˜ å°„ä¸­çš„å…ƒç´ ã€‚å®ƒä»¬æ˜¯ç”¨ç±»å‹ BPF_MAP_TYPE_STACK å®šä¹‰çš„ã€‚åè¿›å…ˆå‡ºæ„å‘³ç€ï¼Œå½“æ‚¨ä»æ˜ å°„ä¸­è·å–å…ƒç´ æ—¶ï¼Œç»“æœå°†æ˜¯æœ€è¿‘æ·»åŠ åˆ°æ˜ å°„ä¸­çš„å…ƒç´ ã€‚</li></ul><h3 id="object-pinning" tabindex="-1">Object Pinning <a class="header-anchor" href="#object-pinning" aria-hidden="true">#</a></h3><p>BPF æ˜ å°„å’Œç¨‹åºæ˜¯ä¸€ç§å†…æ ¸èµ„æºï¼Œåªèƒ½é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„ API æ¥è·å–å®ƒä»¬ã€‚æ›´åº•å±‚çš„æ˜¯åŒ¿åçš„ç´¢å¼•èŠ‚ç‚¹ï¼ˆå†…æ ¸ä¸­çš„ inodesï¼‰ã€‚è¿™ç§åšæ³•æœ‰è®¸å¤šä¼˜åŠ¿å’ŒåŠ£åŠ¿ï¼š</p><p>ç”¨æˆ·ç©ºé—´çš„åº”ç”¨ç¨‹åºèƒ½å¤Ÿä½¿ç”¨å¤§å¤šæ•°æ–‡ä»¶æè¿°ç¬¦ç›¸å…³çš„ APIï¼Œæ–‡ä»¶æè¿°ç¬¦åœ¨ Unix å†…éƒ¨çš„ socket é€šè®¯ä¸­æ˜¯é€æ˜çš„ï¼Œä½†æ˜¯ä¸æ­¤åŒæ—¶ï¼Œæ–‡ä»¶æè¿°ç¬¦åˆåªèƒ½åœ¨ç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…ä½¿ç”¨ï¼Œè¿™ä½¿å¾—æ˜ å°„çš„å…±äº«éš¾ä»¥å®ç°ã€‚</p><p>å› æ­¤å®ƒå¸¦æ¥äº†ä¸€ç³»åˆ—æ£˜æ‰‹çš„å¤æ‚æƒ…å†µï¼Œä¾‹å¦‚åœ¨ iproute2 ä¸­ï¼Œtc å’Œ XDP åœ¨å†…æ ¸ä¸­å¯åŠ¨å¹¶åŠ è½½åæœ€ç»ˆä¼šæ¶ˆäº¡æ‰ã€‚è¿™æ ·ä¸å¯èƒ½ä»ç”¨æˆ·ç©ºé—´è·å–æ˜ å°„äº†ã€‚ä½†æ˜¯ä»ç”¨æˆ·ç©ºé—´è·å–æ˜ å°„æ˜¯å¾ˆæœ‰ç”¨çš„ï¼Œä¾‹å¦‚ï¼Œå½“æ˜ å°„åœ¨ data path çš„å…¥å£ä½ç½®å’Œå‡ºå£ä½ç½®ä¹‹é—´å…±äº«æ—¶ã€‚åŒæ—¶ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ä¹Ÿå¯èƒ½æƒ³è¦åœ¨ BPF ç¨‹åºè¿è¡Œæ—¶å»ç›‘æµ‹æˆ–æ›´æ–°æ˜ å°„å†…å®¹ã€‚</p><p><img src="/assets/bpf_fs.228a5a21.png" alt=""></p><p>ä¸ºäº†çªç ´è¿™ç§é™åˆ¶ï¼Œå®ç°äº†ä¸€å°éƒ¨åˆ†å†…æ ¸ç©ºé—´çš„ BPF æ–‡ä»¶ç³»ç»Ÿã€‚åœ¨è¿™é‡Œï¼Œ BPF æ˜ å°„å’Œç¨‹åºèƒ½å¤Ÿè¢«é’‰åœ¨ä¸Šé¢ï¼Œä¹Ÿå«ä½œ object pinningã€‚BPF ç³»ç»Ÿè°ƒç”¨ä¹Ÿè¿›è¡Œäº†ä¸€å®šæ‹“å±•ï¼Œæ”¯æŒäº†ä¸¤ä¸ªæ–°çš„å‘½ä»¤ï¼Œå¯ä»¥æ”¯æŒé’‰ä¸Šï¼ˆ<code>BPF_OBJ_PIN</code>ï¼‰æˆ–è·å–ï¼ˆ<code>BPF_OBJ_GET</code>ï¼‰è¿™ä¸¤ç§è¡Œä¸ºã€‚</p><p>BPF çš„æ–‡ä»¶ç³»ç»Ÿä¸æ˜¯å•ä¾‹ï¼Œå®ƒæ”¯æŒæŒ‚è½½å¤šä¸ªå®ä¾‹ã€ç¡¬æˆ–è½¯é“¾æ¥ã€‚</p><h3 id="tail-calls" tabindex="-1">Tail Calls <a class="header-anchor" href="#tail-calls" aria-hidden="true">#</a></h3><p>å°¾è°ƒç”¨èƒ½å¤Ÿå…è®¸ä¸€ä¸ª BPF ç¨‹åºå»è°ƒç”¨å¦ä¸€ä¸ªï¼Œä¸éœ€è¦è¿”å›æ—§çš„ç¨‹åºä¸­ã€‚è¿™ç§è°ƒç”¨æ–¹å¼å¼€é”€å¾ˆå°ï¼Œå’Œå‡½æ•°è°ƒç”¨ä¸åŒï¼Œå®ƒåœ¨æ˜¯ç”¨ long jump å‘½ä»¤å®ç°çš„ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ç›¸åŒçš„æ ˆå¸§ï¼ˆå³å¸¸è§çš„å°¾é€’å½’ä¼˜åŒ–ï¼‰ã€‚</p><p><img src="/assets/bpf_tailcall.9d1cbb79.png" alt=""></p><p>è¿™æ ·çš„ç¨‹åºèƒ½å¤Ÿç‹¬ç«‹è¿›è¡ŒéªŒè¯ã€‚ä½†æ˜¯åªæœ‰ç›¸åŒç±»å‹çš„ BPF ç¨‹åºï¼ˆå³ bpf_prog_type ç›¸åŒï¼‰æ‰èƒ½è¿›è¡Œå°¾è°ƒç”¨ï¼›åŒæ—¶åœ¨ JIT æ–¹é¢ä¹Ÿè¦åŒ¹é…ï¼Œ å³å°¾è°ƒç”¨ä¸­ JIT ä»£ç åªèƒ½æ¥åœ¨ JIT ä»£ç åï¼Œç›´æ¥è§£é‡Šçš„ä»£ç åªèƒ½æ¥åœ¨ç›´æ¥è§£é‡Šçš„ä»£ç åï¼Œä¸èƒ½åœ¨å¦ä¸€ç±»ä»£ç åè¿›è¡Œå°¾è°ƒç”¨ã€‚</p><p>å°¾è°ƒç”¨ç›¸å…³æ“ä½œæœ‰ä¸¤éƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†æ˜¯å»ºç«‹ä¸€ä¸ªå«åšç¨‹åºæ•°ç»„çš„ç‰¹æ®Šçš„æ˜ å°„ï¼ˆ<code>BPF_MAP_TYPE_PROG_ARRAY</code>ï¼‰ï¼Œèƒ½åœ¨ç”¨æˆ·ç©ºé—´è¿›è¡Œé”®å€¼æ•°æ®çš„ä¿®æ”¹ï¼Œå€¼å°±æ˜¯å°¾è°ƒç”¨ BPF ç¨‹åºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ç¬¬äºŒéƒ¨åˆ†æ˜¯<code>bpf_tail_call()</code>å¸®åŠ©å‡½æ•°ï¼Œå®ƒéœ€è¦ä¼ å…¥ä¸Šä¸‹æ–‡ï¼ˆcontextï¼‰ã€ç¨‹åºæ•°ç»„çš„å¼•ç”¨ã€å’Œæƒ³æŸ¥è¯¢çš„é”®ã€‚å†…æ ¸ä¼šæŠŠè¿™ä¸ªå¸®åŠ©å‡½æ•°å†…è”åˆ°ç‰¹å®šçš„ BPF æŒ‡ä»¤ä¸­ã€‚è¿™ä¸ªç¨‹åºæ•°ç»„åœ¨ç”¨æˆ·ç©ºé—´æ˜¯ write-only çš„ã€‚</p><p>å†…æ ¸æ ¹æ®æä¾›çš„æ–‡ä»¶æè¿°ç¬¦æŸ¥æ‰¾ç›¸å…³çš„ BPF ç¨‹åºï¼ŒåŸå­åœ°æ›¿æ¢æ‰ç»™å®šçš„æ˜ å°„æ§½å¤„çš„ç¨‹åºæŒ‡é’ˆã€‚å½“åœ¨æ˜ å°„ä¸­æŒ‰ç…§æ‰€ç»™é”®å€¼æ‰¾ä¸åˆ°æŒ‡é’ˆæ—¶ï¼Œå†…æ ¸ä¼šè·³è¿‡å®ƒç„¶åæ¥ç€æ‰§è¡Œ<code>bpf_tail_call()</code> ä¹‹åçš„å‡½æ•°ã€‚å°¾è°ƒç”¨å¾ˆæœ‰ç”¨ï¼Œä¾‹å¦‚åœ¨è§£æç½‘ç»œæ•°æ®åŒ…æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨å°¾è°ƒç”¨é€å±‚è§£æã€‚</p><h3 id="bpf-to-bpf-calls" tabindex="-1">BPF to BPF Calls <a class="header-anchor" href="#bpf-to-bpf-calls" aria-hidden="true">#</a></h3><p><img src="/assets/bpf_call.04b8f4c0.png" alt=""></p><p>é™¤äº† BPF helper å‡½æ•°å’Œ BPF å°¾è°ƒç”¨ï¼Œä¸€ä¸ªæ–°æ·»åŠ çš„ç‰¹æ€§æ˜¯ BPF ç¨‹åºè°ƒç”¨ BPF ç¨‹åºã€‚åœ¨è¿™ä¸ªç‰¹æ€§è¢«å¼•å…¥å†…æ ¸ä¹‹å‰ï¼Œä¸€èˆ¬ BPF C ç¨‹åºéœ€è¦å®šä¹‰ä¸€äº›å¯é‡ç”¨ä»£ç ï¼Œå•ç‹¬å­˜åœ¨ä¸€ä¸ªå¤´æ–‡ä»¶ä¸­ï¼Œä»–ä»¬éƒ½æ˜¯ <code>always_inline</code> çš„ã€‚ä½¿ç”¨ LLVM è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ï¼Œè¿™äº›å¯é‡ç”¨ä»£ç ä¼šè¢«å†…è”åˆ°éœ€è¦çš„åœ°æ–¹ï¼Œå¯¼è‡´ç”Ÿæˆçš„ä»£ç ä½“ç§¯å¾ˆå¤§ã€‚å…·ä½“å½¢å¼å¦‚ä¸‹ï¼š</p><div class="language-C"><button title="Copy Code" class="copy"></button><span class="lang">C</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">linux/bpf.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifndef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__section</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__section</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">NAME</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">                  \</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">__attribute__</span><span style="color:#89DDFF;">((</span><span style="color:#82AAFF;">section</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">NAME</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> used</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifndef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__inline</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__inline</span><span style="color:#A6ACCD;">                         \</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#C792EA;">inline</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__attribute__</span><span style="color:#89DDFF;">((</span><span style="color:#A6ACCD;">always_inline</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> __inline </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">foo</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XDP_DROP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">__section</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">prog</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">xdp_drop</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> xdp_md </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">ctx</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">foo</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">char</span><span style="color:#A6ACCD;"> __license</span><span style="color:#C792EA;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__section</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">license</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">GPL</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>è¿™ä¹ˆå¹²çš„åŸå› å°±æ˜¯åœ¨ BPF éªŒè¯å™¨ã€åŠ è½½å™¨ã€è§£é‡Šå™¨ã€JIT ä¸­éƒ½ç¼ºå°‘å¯¹å‡½æ•°çš„æ”¯æŒã€‚ä»Linux 4.16ï¼Œ LLVM 6.0 å¼€å§‹ï¼Œå°±æ”¯æŒè¿™ä¸ªç‰¹æ€§äº†ã€‚BPF ç¨‹åºä¸å¿…å†åˆ°å¤„ä½¿ç”¨ <code>always_inline</code> æ ‡ç­¾äº†ï¼Œå‰é¢çš„ä»£ç å¯ä»¥è¢«æ›´è‡ªç„¶åœ°è¡¨è¾¾ä¸º</p><div class="language-C"><button title="Copy Code" class="copy"></button><span class="lang">C</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#include</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">linux/bpf.h</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#ifndef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__section</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;"># define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__section</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">NAME</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">                  \</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#82AAFF;">__attribute__</span><span style="color:#89DDFF;">((</span><span style="color:#82AAFF;">section</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">NAME</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> used</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">foo</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">void</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> XDP_DROP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">__section</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">prog</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">xdp_drop</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> xdp_md </span><span style="color:#89DDFF;">*</span><span style="color:#A6ACCD;font-style:italic;">ctx</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">foo</span><span style="color:#89DDFF;">();</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">char</span><span style="color:#A6ACCD;"> __license</span><span style="color:#C792EA;">[]</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__section</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">license</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">GPL</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>ä¸»æµçš„ BPF JIT ç¼–è¯‘å™¨ä¾‹å¦‚åœ¨ <code>x86_64</code> å’Œ <code>arm64</code> ä¸Šçš„ä¼šæ”¯æŒ BPF åˆ° BPF çš„è°ƒç”¨ï¼Œå…¶ä»–åˆ™ä¼šæ·»åŠ ç±»ä¼¼çš„ç‰¹æ€§ã€‚è¿™ä¸ªç‰¹æ€§å¯¹æ€§èƒ½ä¼˜åŒ–æ„ä¹‰é‡å¤§ï¼Œå› ä¸ºå®ƒæ˜¾è‘—å‡å°‘äº†ç”Ÿæˆçš„ BPF ä»£ç çš„å¤§å°ã€‚å› æ­¤ä»æŒ‡ä»¤ç¼“å­˜çš„è§’åº¦ï¼Œè¿™æ ·ç”Ÿæˆçš„æœºå™¨ç å¯¹ CPU æ›´åŠ å‹å¥½ã€‚</p><p>BPF å‡½æ•°ä¹‹é—´çš„è°ƒç”¨æ–¹æ³•å’Œ BPF helper å‡½æ•°çš„è°ƒç”¨æ–¹æ³•ä¸€è‡´ï¼Œæ„å‘³ç€ä» <code>r1</code> åˆ° <code>r5</code> è¿™äº”ä¸ªå¯„å­˜å™¨éƒ½æ˜¯ç”¨æ¥å‘è¢«è°ƒç”¨çš„å‡½æ•°ä¼ é€’å‚æ•°çš„ï¼ˆå›å¿†ï¼šBPF helper å‡½æ•°ä¸­æœ€å¤šå…è®¸5ä¸ªå‡½æ•°å‚æ•°ï¼‰ï¼Œå‡½æ•°è¿è¡Œç»“æœè¿”å›åˆ°å¯„å­˜å™¨<code>r0</code>ã€‚å¯„å­˜å™¨ <code>r1</code> åˆ° <code>r5</code> éƒ½æ˜¯æš‚å­˜å¯„å­˜å™¨ï¼Œè€Œå¯„å­˜å™¨<code>r6</code> åˆ° <code>r9</code> åˆ™å¯ä»¥åœ¨ä¸åŒè°ƒç”¨ä¹‹é—´ä¿å­˜æ•°æ®ã€‚æœ€å¤§å…è®¸çš„è°ƒç”¨æ·±åº¦æ˜¯8ã€‚ä¸€ä¸ªè°ƒç”¨è€…å¯ä»¥ä¼ é€’æŒ‡é’ˆï¼ˆå¦‚è°ƒç”¨è€…çš„æ ˆå¸§ï¼‰ç»™è¢«è°ƒç”¨æ–¹ï¼Œåè¿‡æ¥ä¸è¡Œã€‚</p><p>BPF JIT ç¼–è¯‘å™¨ä¸ºæ¯ä¸ªå‡½æ•°ç¼–è¯‘å‡ºå•ç‹¬çš„æ˜ åƒï¼ŒJIT æœ€ç»ˆä¼šä¿®æ­£æ˜ åƒä¸­çš„å‡½æ•°è°ƒç”¨åœ°å€å°†ä»–ä»¬ä¸²è”èµ·æ¥ã€‚äº‹å®è¯æ˜ï¼Œè¿™æ ·å¯¹ JIT è¿›è¡Œçš„æ”¹åŠ¨æœ€å°ï¼Œå› ä¸ºä½¿ç”¨è¿™ç§æ–¹æ³• JIT å¯ä»¥å°†BPFåˆ°BPFçš„è°ƒç”¨è§†ä¸ºå¸¸è§„çš„ BPF helper å‡½æ•°è°ƒç”¨ã€‚</p><p>çŸ¥é“ Linux 5.9ï¼ŒBPF å°¾è°ƒç”¨å’Œ BPF å­ç¨‹åºéƒ½ç›¸äº’æ’æ–¥ï¼Œä½¿ç”¨äº†å°¾è°ƒç”¨çš„ BPF ç¨‹åºä¸èƒ½ä½¿ç”¨ BPF å­ç¨‹åºæ¥å‡å°ç”Ÿæˆçš„ç¨‹åºæ˜ åƒå¤§å°ã€åŠ é€Ÿç¨‹åºåŠ è½½ã€‚ä¹‹åçš„ Linux 5.10 æœ€ç»ˆå…è®¸äº†ç”¨æˆ·èƒ½å¤ŸåŒæ—¶åˆ©ç”¨äºŒè€…çš„ä¼˜ç‚¹ï¼Œä½¿å¾— BPF å­ç¨‹åºå’Œå°¾é€’å½’å¯ä»¥åŒæ—¶ä½¿ç”¨äº†ã€‚</p><p>è¿™ä¸ªæ”¹è¿›æ˜¯æœ‰ä»£ä»·çš„ï¼Œå°†è¿™ä¸¤ä¸ªç‰¹æ€§æ··åˆåœ¨ä¸€èµ·å¯èƒ½ä¼šé€ æˆå†…æ ¸å †æ ˆæº¢å‡ºã€‚ä¸ºäº†ä¸€çª¥å…¶ä¸­å¥¥ç§˜ï¼Œå¯ä»¥çœ‹ä¸‹é¢è¿™å¼ å›¾ç‰‡ï¼Œå®ƒå°±è§£é‡Šäº†äºŒè€…æ˜¯å¦‚ä½•æ··åˆçš„ï¼š</p><p><img src="/assets/bpf_tailcall_subprograms.2eb92eec.png" alt="bpf_tailcall_subprograms.png"></p><p>å°¾è°ƒç”¨ä¸æ”¹å˜æ ˆé¡¶æŒ‡é’ˆä½ç½®ï¼Œåœ¨çœŸæ­£è·³è½¬åˆ°ç›®æ ‡ç¨‹åºåœ°å€ä¹‹å‰ï¼Œä¼šæŠŠå½“å‰æ ˆå¸§é‡Šæ”¾æ‰ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šé¢ä¾‹å­é‡Œçœ‹åˆ°çš„ï¼Œå¦‚æœä¸€ä¸ªå°¾è°ƒç”¨åœ¨å­å‡½æ•° <code>subfunc1</code> ä¸­å‘ç”Ÿäº†ï¼Œè°ƒç”¨äº†<code>func2</code>ï¼Œé‚£ä¹ˆ <code>func1</code> çš„æ ˆå¸§å°†ä¼šåœ¨æ ˆä¸­å­˜åœ¨ä¸‹å»ã€‚ä¸€æ—¦æœ€ç»ˆçš„ <code>func3</code> å‡½æ•°ç»ˆç»“äº†ï¼Œæ‰€æœ‰å‰é¢çš„æ ˆå¸§éƒ½ä¼šè¢«å±•å¼€æ§åˆ¶æƒä¼šå›åˆ° BPF å‡½æ•°è°ƒç”¨æ–¹ã€‚</p><p>å†…æ ¸å¼•å…¥äº†åˆ«çš„é€»è¾‘æ¥æ£€æµ‹è¿™ä¸¤ä¸ªç‰¹æ€§çš„ç»“åˆã€‚åœ¨ä¸Šå›¾çš„æ•´ä¸ªé“¾å¼è°ƒç”¨ä¸­ï¼Œå¯¹æ¯ä¸ªå­ç¨‹åºçš„æ ˆçš„å¤§å°é™åˆ¶ä¸º 256 å­—èŠ‚ï¼Œæ³¨æ„å¦‚æœéªŒè¯å™¨æ£€æµ‹åˆ°äº† BPF2BPF è°ƒç”¨ï¼Œé‚£ä¹ˆä¸»å‡½æ•°ä¹Ÿä¼šè¢«è§†ä¸ºæ˜¯ä¸€ä¸ªå­å‡½æ•°ï¼ˆå³æ•´ä¸ªé“¾ä¸Šå¤§å®¶éƒ½æœ‰è¿™ä¸ªæ ˆå¤§å°çš„é™åˆ¶ï¼‰ã€‚å‡­å€Ÿè¿™ä¸ªé™åˆ¶ï¼ŒBPF ç¨‹åºè°ƒç”¨é“¾æœ€å¤šèƒ½å¤Ÿæ¶ˆè€— 8KB å¤§å°çš„æ ˆç©ºé—´ã€‚è¿™ä¸ªä¸Šé™çš„è®¡ç®—æ–¹å¼æ˜¯æ¯ä¸ªæ ˆå¸§ 256 å­—èŠ‚ï¼Œä¹˜ä¸Šå°¾è°ƒç”¨ä¸Šé™ 33ã€‚æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼ŒBPF ç¨‹åºèƒ½å¤Ÿä½¿ç”¨512 å­—èŠ‚çš„æ ˆç©ºé—´ï¼Œåˆ™æœ€å¤§å¯èƒ½ä¼šå ç”¨ 16KB çš„æ ˆï¼Œæœ€ç»ˆå¯èƒ½ä¼šåœ¨æŸäº›æ¶æ„çš„æœºå™¨ä¸Šå°±å †æ ˆæº¢å‡ºäº†ã€‚</p><p>å¦ä¸€ä¸ªå€¼å¾—ä¸€æçš„ç‚¹æ˜¯è¿™ç§ç‰¹æ€§çš„ç»“åˆé™åˆ¶åªåœ¨ x86-64 æ¶æ„ä¸Šå¾—åˆ°äº†æ”¯æŒã€‚</p><h3 id="jit" tabindex="-1">JIT <a class="header-anchor" href="#jit" aria-hidden="true">#</a></h3><p><img src="/assets/bpf_jit.1bf3968c.png" alt="bpf_jit.png"></p><p>64 ä½çš„ <code>x86_64</code>ã€ <code>arm64</code>ã€ <code>ppc64</code>ã€ <code>s390x</code>ã€ <code>mips64</code>ã€ <code>sparc64</code> å’Œ 32 ä½çš„ <code>arm</code>ã€<code>x86_32</code> æ¶æ„éƒ½åœ¨å†…æ ¸ä¸­å†™å¥½äº†eBPF JIT ç¼–è¯‘å™¨ï¼Œä»–ä»¬éƒ½æœ‰ç€ç›¸åŒçš„ç‰¹æ€§ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼æ¿€æ´»</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># echo 1 &gt; /proc/sys/net/core/bpf_jit_enable</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>32 ä½çš„ <code>mips</code>ã€ <code>ppc</code> å’Œ<code>sparc</code> çš„æ¶æ„ç°åœ¨æœ‰ä¸€ä¸ª cBPF JIT ç¼–è¯‘å™¨ã€‚ä¸Šé¢æåˆ°çš„æ¶æ„ä¹Ÿä¾ç„¶æœ‰ cBPF JITï¼Œå…¶ä»–æ¶æ„æ²¡æœ‰ JITï¼Œåªèƒ½é€šè¿‡å†…æ ¸ä¸­çš„è§£é‡Šå™¨æ¥è·‘ã€‚</p><p>åœ¨å†…æ ¸æºç æ ‘ä¸­ï¼Œèƒ½å¤Ÿè½»æ˜“åœ°è¢«æ‰¾åˆ° eBPF JIT çš„ç›¸å…³æ”¯æŒï¼Œåªéœ€è¦ <code>git grep</code> ä¸€ä¸‹ <code>HAVE_EBPF_JIT</code>:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># git grep HAVE_EBPF_JIT arch/</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/arm/Kconfig:       select HAVE_EBPF_JIT   if !CPU_ENDIAN_BE32</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/arm64/Kconfig:     select HAVE_EBPF_JIT</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/powerpc/Kconfig:   select HAVE_EBPF_JIT   if PPC64</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/mips/Kconfig:      select HAVE_EBPF_JIT   if (64BIT &amp;&amp; !CPU_MICROMIPS)</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/s390/Kconfig:      select HAVE_EBPF_JIT   if PACK_STACK &amp;&amp; HAVE_MARCH_Z196_FEATURES</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/sparc/Kconfig:     select HAVE_EBPF_JIT   if SPARC64</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/x86/Kconfig:       select HAVE_EBPF_JIT   if X86_64</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>JIT ç¼–è¯‘å™¨èƒ½å¤Ÿæ˜¾è‘—åŠ é€Ÿ BPF ç¨‹åºçš„æ‰§è¡Œï¼Œå› ä¸ºç›¸æ¯”äºè§£é‡Šå™¨ä»–ä»¬å‡å°‘äº†å•æŒ‡ä»¤çš„å¼€é”€ã€‚é€šå¸¸æŒ‡ä»¤éƒ½èƒ½å¤Ÿä¸€ä¸€æ˜ å°„åˆ°åº•å±‚æ¶æ„ä¸Šçš„åŸå§‹æŒ‡ä»¤ä¸Šã€‚è¿™ä¹Ÿå‡å°‘äº†æœ€ç»ˆçš„å¯æ‰§è¡Œæ˜ åƒå¤§å°ï¼Œå› è€Œå¯¹ CPU æŒ‡ä»¤ç¼“å­˜æ¥è¯´æ›´ä¸ºå‹å¥½ã€‚ç‰¹åˆ«æ˜¯åœ¨å¤æ‚çš„ CISC æŒ‡ä»¤é›†ä¸‹ï¼Œä¾‹å¦‚ <code>x86</code>ï¼ŒJITs éƒ½ä¼šè¢«ä¼˜åŒ–ä»¥ç”Ÿæˆæœ€ç²¾æ‚çš„æŒ‡ä»¤ï¼Œæ¥å‡å°‘ç¨‹åºç¿»è¯‘åçš„å¤§å°ã€‚</p><h3 id="hardening" tabindex="-1">Hardening <a class="header-anchor" href="#hardening" aria-hidden="true">#</a></h3><p>BPF å°†æ•´ä¸ª BPF è§£é‡Šå™¨æ˜ åƒï¼ˆ<code>struct bpf_prog</code>ï¼‰å’Œ JIT ç¼–è¯‘å‡ºçš„æ˜ åƒï¼ˆ<code>struct bpf_binary_header</code>ï¼‰åœ¨ç¨‹åºç”Ÿå‘½å‘¨æœŸå†…åœ¨å†…æ ¸ä¸­æ˜¯åªè¯»çš„ï¼Œä»¥é˜²æ­¢æ½œåœ¨çš„ä»£ç æŸåã€‚ä¾‹å¦‚å‡ºäºå†…æ ¸çš„ bugï¼Œä»£ç å¯èƒ½ä¼šæŸåï¼Œè¿›è€Œå¯¼è‡´å†…æ ¸å®•æœºã€‚</p><p>æ”¯æŒå°†å°†æ˜ åƒè®¾ç½®ä¸ºåªè¯»çš„æ¶æ„èƒ½å¤Ÿé€šè¿‡ä¸‹é¢çš„æ–¹å¼æŸ¥çœ‹ï¼ŒåŒæ ·æ˜¯ä½¿ç”¨<code>git grep</code>ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">$ git grep ARCH_HAS_SET_MEMORY | grep select</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/arm/Kconfig:    select ARCH_HAS_SET_MEMORY</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/arm64/Kconfig:  select ARCH_HAS_SET_MEMORY</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/s390/Kconfig:   select ARCH_HAS_SET_MEMORY</span></span>
<span class="line"><span style="color:#A6ACCD;">arch/x86/Kconfig:    select ARCH_HAS_SET_MEMORY</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>é€‰é¡¹ <code>CONFIG_ARCH_HAS_SET_MEMORY</code> ä¸æ˜¯å¯é…ç½®çš„ï¼Œå®ƒæ€»æ˜¯å†…ç½®çš„ã€‚å…¶ä»–æ¶æ„åœ¨æœªæ¥ä¹Ÿå¯èƒ½ä¼šæ”¯æŒè¿™ä¸€ç‰¹æ€§ã€‚</p><p>å¯¹äº<code>x86_64</code> JIT ç¼–è¯‘å™¨ï¼Œå‡è®¾å®ƒåœ¨å†™æ“ä½œä¼šè®¾ç½® <code>CONFIG_RETPOLINE</code> é¡¹ï¼ˆé€šå¸¸ç°ä»£æ“ä½œç³»ç»Ÿéƒ½ä¼šè¿™ä¹ˆå¹²ï¼‰ï¼Œé‚£ä¹ˆJIT åœ°ä»å°¾è°ƒç”¨ä¸­ç¼–è¯‘ indirect jump æ˜¯é€šè¿‡ä¸€ä¸ª retpoline æ¥å®ç°çš„ï¼ˆ<a href="https://stackoverflow.com/questions/48089426/what-is-a-retpoline-and-how-does-it-work?r=SearchResults" target="_blank" rel="noreferrer">retpoline</a> æ˜¯ç”¨æ¥ç¼“è§£å†…æ ¸æˆ–è·¨è¿›ç¨‹å†…å­˜æ³„éœ²çš„ï¼Œåˆç§° <a href="https://spectreattack.com/spectre.pdf" target="_blank" rel="noreferrer">Spectre </a>æ”»å‡»ï¼Œå‚è€ƒ<a href="https://lkml.org/lkml/2018/1/3/780" target="_blank" rel="noreferrer">lkml é‚®ä»¶</a>ï¼‰ã€‚</p><p>å½“ <code>/proc/sys/net/core/bpf_jit_harden</code> è®¾ç½®ä¸º <code>1</code> çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªé’ˆå¯¹éç®¡ç†å‘˜ç”¨æˆ·çš„ JIT ç¼–è¯‘çš„ hardening æ“ä½œç”Ÿæ•ˆäº†ã€‚è¿™ä¼šç¨å¾®ç‰ºç‰²æ€§èƒ½ï¼Œä»¥å‡å°‘æ¥è‡ªæœªä¿¡ä»»çš„ç”¨æˆ·çš„æ½œåœ¨çš„æ”»å‡»ã€‚å³ä½¿ç‰ºç‰²äº†æ€§èƒ½ï¼Œè¡¨ç°ä»ç„¶æ˜¯æ¯”ç›´æ¥å®Œå…¨åœ°ä½¿ç”¨è§£é‡Šå™¨è¦å¥½ã€‚</p><p>å½“ä¸‹ï¼Œæ¿€æ´» hardening åï¼Œä½¿ç”¨ JIT ç¼–è¯‘ BPF ç¨‹åºï¼Œä¼šå±è”½ BPF ç¨‹åºä¸­æ‰€æœ‰ç”¨æˆ·æä¾›çš„ 32 ä½å’Œ 64 ä½å¸¸é‡ï¼Œä»¥åº”å¯¹ JIT spraying attacksã€‚JIT spraying attacks ä¼šæ³¨å…¥åŸç”ŸæŒ‡ä»¤çš„ opcode ä½œä¸ºç«‹å³æ•°ã€‚è¿™ä¼šå¸¦æ¥å¾ˆå¤§çš„é—®é¢˜ï¼Œå› ä¸ºè¿™äº›ç«‹å³æ•°æ˜¯å­˜å‚¨åœ¨å¯æ‰§è¡Œçš„å†…æ ¸å†…å­˜åŒºåŸŸä¸­ã€‚å¦‚æœå› ä¸ºæŸäº›å†…æ ¸ bugï¼Œç¨‹åºè®¡æ•°å™¨è·³è½¬åˆ°äº†è¢«æ³¨å…¥çš„æŒ‡ä»¤å¤„ï¼Œå¯èƒ½ä¼šæ‰§è¡Œè¿™äº›è¢«æ³¨å…¥çš„ç¨‹åºã€‚</p><p>JIT å¸¸é‡å±è”½å¯ä»¥é€šè¿‡éšæœºåŒ–çœŸæ­£çš„æŒ‡ä»¤é¿å…è¿™ç§æƒ…å†µï¼Œæ„å‘³ç€æœ€åçš„æŒ‡ä»¤è¿ç®—é€šè¿‡é‡å†™æŒ‡ä»¤ï¼Œå°†ä¸€ä¸ªåŸºäºç«‹å³æ•°çš„æŒ‡ä»¤ç ï¼Œè½¬æ¢åˆ°äº†åŸºäºå¯„å­˜å™¨çš„æŒ‡ä»¤ç ã€‚é‡å†™æŒ‡ä»¤çš„æ–¹æ³•å…±ä¸¤æ­¥ï¼šåŠ è½½ä¸€ä¸ªè¢«éšæœºå±è”½çš„ç«‹å³æ•° <code>rnd ^ imm</code> åˆ°å¯„å­˜å™¨ä¸­ï¼Œä½¿ç”¨<code>rnd</code> ä¸å¯„å­˜å™¨ä¸­çš„å€¼åšå¼‚æˆ–ï¼Œåœ¨å¯„å­˜å™¨ä¸­å¾—åˆ°åˆå§‹çš„ <code>imm</code> ç«‹å³æ•°ï¼Œèƒ½å¤Ÿç”¨æ¥åšçœŸæ­£çš„æŒ‡ä»¤è¿ç®—ã€‚ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº†ä¸€ä¸ª load æŒ‡ä»¤æ“ä½œï¼Œå…¶ä»–å¸¸è§çš„æŒ‡ä»¤ä¹Ÿéƒ½æ˜¯è¿™ä¹ˆå±è”½çš„ã€‚åœ¨ hardening ç¦ç”¨çš„æƒ…å†µä¸‹ä½¿ç”¨ JIT ç¼–è¯‘ä¸€ä¸ªç¨‹åºçš„ä¾‹å­:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># echo 0 &gt; /proc/sys/net/core/bpf_jit_harden</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  ffffffffa034f5e9 + &lt;x&gt;:</span></span>
<span class="line"><span style="color:#A6ACCD;">  [...]</span></span>
<span class="line"><span style="color:#A6ACCD;">  39:   mov    $0xa8909090,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  3e:   mov    $0xa8909090,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  43:   mov    $0xa8ff3148,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  48:   mov    $0xa89081b4,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  4d:   mov    $0xa8900bb0,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  52:   mov    $0xa810e0c1,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  57:   mov    $0xa8908eb4,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  5c:   mov    $0xa89020b0,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  [...]</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>ç›¸åŒçš„ç¨‹åºï¼Œå½“å¼€å¯äº† hardening æ—¶ï¼Œä»¥éç®¡ç†å‘˜ç”¨æˆ·åŠ è½½ BPF ç¨‹åºæ—¶ï¼Œå¸¸é‡ä¼šè¢«å±è”½ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># echo 1 &gt; /proc/sys/net/core/bpf_jit_harden</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">  ffffffffa034f1e5 + &lt;x&gt;:</span></span>
<span class="line"><span style="color:#A6ACCD;">  [...]</span></span>
<span class="line"><span style="color:#A6ACCD;">  39:   mov    $0xe1192563,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  3f:   xor    $0x4989b5f3,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  46:   mov    %r10d,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  49:   mov    $0xb8296d93,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  4f:   xor    $0x10b9fd03,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  56:   mov    %r10d,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  59:   mov    $0x8c381146,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  5f:   xor    $0x24c7200e,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  66:   mov    %r10d,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  69:   mov    $0xeb2a830e,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  6f:   xor    $0x43ba02ba,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  76:   mov    %r10d,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  79:   mov    $0xd9730af,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  7f:   xor    $0xa5073b1f,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  86:   mov    %r10d,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  89:   mov    $0x9a45662b,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  8f:   xor    $0x325586ea,%r10d</span></span>
<span class="line"><span style="color:#A6ACCD;">  96:   mov    %r10d,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  [...]</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>ä¸¤ä¸ªç¨‹åºåœ¨è¯­ä¹‰ä¸Šæ˜¯ç­‰ä»·çš„ï¼Œé™¤äº†åŸå§‹ä»£ç ä¸­çš„ç«‹å³æ•°åœ¨ç¬¬äºŒä¸ªç¨‹åºçš„åæ±‡ç¼–ä¸­éƒ½æ— æ³•å†çœ‹å¾—åˆ°äº†ã€‚</p><p>ä¸æ­¤åŒæ—¶ï¼Œhardening ä¹Ÿç¦ç”¨äº†å¯¹ç®¡ç†å‘˜ç”¨æˆ·çš„ JIT kallsyms exposureï¼ŒJIT æ˜ åƒçš„åœ°å€ä¸å†æš´éœ²ç»™ <code>/proc/kallsyms</code> ã€‚</p><p>å¦å¤–ï¼Œ Linux å†…æ ¸ä¹Ÿæä¾›äº†é€‰é¡¹ <code>CONFIG_BPF_JIT_ALWAYS_ON</code>ï¼Œä»å†…æ ¸ä¸­ç§»é™¤æ•´ä¸ª BPF è§£é‡Šå™¨å¹¶æ°¸ä¹…åœ°æ¿€æ´» JIT ç¼–è¯‘å™¨ã€‚åœ¨ä½¿ç”¨åŸºäº VM çš„è®¾ç½®çš„ Spectre v2 ç¯å¢ƒä¸‹ï¼Œå½“å®¢æˆ·æœºä¸æ‰“ç®—ä½¿ç”¨å®¿ä¸»æœºå†…æ ¸çš„ BPF è§£é‡Šå™¨æ¥è£…è½½ Spectre æ”»å‡»çš„æ—¶å€™ï¼Œè¿™ä¹Ÿè¢«å‘å±•æˆäº†å†…æ ¸ç§»æ¤çš„ä¸€éƒ¨åˆ†ã€‚å¯¹äºåŸºäºå®¹å™¨çš„ç¯å¢ƒï¼Œé€‰é¡¹ <code>CONFIG_BPF_JIT_ALWAYS_ON</code> æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯åœ¨ JIT è¢«æ¿€æ´»çš„æƒ…å†µä¸‹ï¼Œè§£é‡Šå™¨å¯èƒ½ä¹Ÿè¢«ç¼–è¯‘å‡ºæ¥äº†ä»¥å‡è½»å†…æ ¸çš„å¤æ‚ç¨‹åº¦ã€‚å› æ­¤ï¼Œåœ¨ä¸»æµçš„ç»“æ„ä¸­ï¼Œä¾‹å¦‚<code>x86_64</code> å’Œ <code>arm64</code> ä¸­ï¼Œå¯¹å¹¿æ³›ä½¿ç”¨çš„ JITï¼Œé€šå¸¸ä¹Ÿå»ºè®®å¼€å¯è¿™ä¸ªé€‰é¡¹ã€‚</p><p>æœ€åï¼Œå†…æ ¸æä¾›äº†ä¸€ä¸ªé€‰é¡¹æ¥ç¦æ­¢éç®¡ç†å‘˜ç”¨æˆ·ä½¿ç”¨ <code>bpf(2)</code> ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯é€šè¿‡ <code>/proc/sys/kernel/unprivileged_bpf_disabled</code> sysctl knob å®ç°çš„ã€‚è¿™æ˜¯ä¸€ä¸ªä¸€æ¬¡æ€§çš„å¼€å…³ï¼Œæ„å‘³ç€ä¸€æ—¦è®¾ç½®ä¸º <code>1</code>ï¼Œæ²¡æœ‰å…¶ä»–é€‰é¡¹èƒ½å¤ŸæŠŠå®ƒå˜ä¸º <code>0</code>ï¼Œç›´åˆ°å†…æ ¸é‡å¯ã€‚å½“åªè®¾ç½® <code>CAP_SYS_ADMIN</code> æ—¶ï¼Œç¦»å¼€åˆå§‹ç©ºé—´çš„ç®¡ç†å‘˜è¿›ç¨‹ä»è¿™ä¹‹åå°±èƒ½å¤Ÿä½¿ç”¨ <code>bpf(2)</code> ç³»ç»Ÿè°ƒç”¨ã€‚</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;"># echo 1 &gt; /proc/sys/kernel/unprivileged_bpf_disabled</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h3 id="offloads" tabindex="-1">Offloads <a class="header-anchor" href="#offloads" aria-hidden="true">#</a></h3><p><img src="/assets/bpf_offload.0c1515c2.png" alt="bpf_offload.png"></p><p>BPF å†™çš„ç½‘ç»œç›¸å…³çš„ç¨‹åºï¼Œç‰¹åˆ«æ˜¯ tc å’Œ XDP ç›¸å…³ç¨‹åºï¼Œéƒ½æœ‰ offload-interfaceï¼Œå¯ä»¥è„±ç¦»å†…æ ¸åœ¨ç½‘å¡ä¸­æ‰§è¡Œ BPF ä»£ç ï¼ˆç›´æ¥åœ¨ç½‘å¡ä¸­å¤„ç†å› è€Œå› è€Œæ›´åŠ é«˜æ•ˆç”šè‡³ä¸ç”¨å†…æ ¸å‚ä¸ï¼‰ã€‚</p><p>å½“ä¸‹ï¼ŒNetronome çš„é©±åŠ¨ <code>nfp</code> å·²ç»æ”¯æŒäº†é€šè¿‡ JIT ç¼–è¯‘å™¨å°† BPF ç¨‹åºç¼–è¯‘åˆ°ç½‘å¡ä¸Šç‰¹å®šæŒ‡ä»¤é›†ã€‚ä¹Ÿæ”¯æŒäº† BPF mapsï¼Œå› æ­¤åœ¨ç½‘å¡ä¸Š BPF ç¨‹åºä¹Ÿèƒ½å®ç°æ˜ å°„çš„æŸ¥è¯¢ã€æ›´æ–°å’Œåˆ é™¤ã€‚</p><h2 id="bpf-è™šæ‹Ÿæœºçš„å…·ä½“å®ç°" tabindex="-1">BPF è™šæ‹Ÿæœºçš„å…·ä½“å®ç° <a class="header-anchor" href="#bpf-è™šæ‹Ÿæœºçš„å…·ä½“å®ç°" aria-hidden="true">#</a></h2><p>Linux å†…æ ¸ä¸­å½“ç„¶æ˜¯æœ‰ BPF çš„ è™šæ‹Ÿæœºå®ç°çš„ï¼Œä½†æ˜¯å†…æ ¸ä»£ç æµ©å¦‚çƒŸæµ·ï¼Œè€Œä¸”æ˜¯å†…æ ¸æ€çš„å®ç°ã€‚</p><p>ç”¨æˆ·æ€çš„è™šæ‹Ÿæœºå®ç°æœ‰ï¼š</p><p>iovisor ç»„ç»‡ç”¨ C é‡å†™äº†ä¸€ä¸ª <a href="https://github.com/iovisor/ubpf/" target="_blank" rel="noreferrer">ubpf</a>ã€‚ç±»ä¼¼çš„æœ‰ä»¿ç…§ ubpf å†™çš„ rust ç‰ˆæœ¬ <a href="https://github.com/qmonnet/rbpf" target="_blank" rel="noreferrer">rbpf</a>ã€‚</p><p>ä½†æ˜¯ubpf åªæ”¯æŒ <code>x86-64</code>ï¼Œrbpf ä»¿ç…§äº†å‰è€…çš„ä»£ç ï¼Œä½œè€…è¡¨ç¤ºæ²¡æœ‰æ—¶é—´å»åšå…¶ä»–æ¶æ„çš„æ”¯æŒã€‚</p><p>åŒæ—¶ä»–ä»¬éƒ½æ˜¯åœ¨è¿è¡ŒæœŸé—´åšçš„åœ°å€éªŒè¯ï¼Œå®é™…ä¸Šæ²¡æœ‰æå‰åšéªŒè¯ã€‚å¦‚ ubpf å¯¹ memory ç›¸å…³ load/ store æŒ‡ä»¤çš„åœ°å€éªŒè¯å°±æ˜¯åªèƒ½åœ¨è¿è¡ŒæœŸè¿›è¡Œï¼ŒåŒæ—¶å®ƒæ²¡æœ‰å¯¹æ ˆçš„åœ°å€åšéªŒè¯ (æ‰€ä»¥ ubpf å’Œ rbpf ä¸ºå•¥è¦åšä¸¤æ¬¡å¾ªç¯â€¦â€¦ä¸€æ¬¡éªŒè¯ä¸€æ¬¡è¿è¡Œâ€¦â€¦)ã€‚</p><p><a href="/zh/blogs/20210223/">STM32MP157</a> å¼€å‘æ¿ä¸Šï¼Œå°æ ¸æ˜¯ Cortex-M4ï¼ŒCortex-M4 æ˜¯ä½¿ç”¨çš„æ˜¯ ARMv7-M æ¶æ„ï¼Œå¯ä»¥å‚è€ƒ<a href="https://developer.arm.com/documentation/ddi0403/d/Application-Level-Architecture/The-ARMv7-M-Instruction-Set/About-the-instruction-set?lang=en" target="_blank" rel="noreferrer">ARMV7-M Documentation â€“ Arm Developer</a>ã€‚</p><p>ä»¿ç…§ x86-64 çš„å®ç°å»ä¸º ARM v7-M å®ç°ä¸€å¥—ã€‚é¦–å…ˆçœ‹å­—èŠ‚åºï¼Œx86-64 æ˜¯å°ç«¯çš„ï¼ŒARM v7-M é»˜è®¤ä¹Ÿæ˜¯å°ç«¯ï¼Œè¿™ç‚¹å¯ä»¥æ”¾å¿ƒäº†ã€‚</p><p>ä¸‹é¢çš„ç« èŠ‚åˆ†æä¸€ä¸‹ <a href="#x86-64">x86-64</a> å’Œ <a href="#ARMv7-M">ARMv7-M</a> å¯„å­˜å™¨çš„æ˜ å°„ï¼Œç„¶åå°±å¯ä»¥ç€æ‰‹çœ‹æ€ä¹ˆæ”¹äº†ã€‚</p><p>æœ€å<a href="/zh/blogs/20210223/">ç§»æ¤</a>åˆ°å¼€å‘æ¿ä¸Šè¯•ä¸€ä¸‹~æ•ˆæœå¦‚ä¸‹å›¾ã€‚</p><p>åç»­çš„å·¥ä½œçš„è¯ï¼š</p><ul><li><p>è€ƒè™‘æŠŠè…¾è®¯çš„é‚£ä¸ªç‰©è”ç½‘å®æ—¶æ“ä½œç³»ç»Ÿçš„ç§»æ¤å’Œè¿™é‡Œ BPF è™šæ‹Ÿæœºçš„ç§»æ¤æ•´åˆä¸€ä¸‹ï¼Œå®ç°å¤šä»»åŠ¡å¤„ç†~</p></li><li><p>æœ‰ç©ºç»™ubpf å’Œ rbpf éƒ½è´¡çŒ®ä¸€ä¸‹ï¼ŒåŒæ—¶å¯ä»¥è€ƒè™‘ç»™ RISC-V æ¶æ„ä¹Ÿéƒ½æä¸€è½®â€¦â€¦ï¼ˆé€ƒ</p></li></ul><h2 id="è¡¥å……" tabindex="-1">è¡¥å…… <a class="header-anchor" href="#è¡¥å……" aria-hidden="true">#</a></h2><p>è¿™éƒ¨åˆ†åªåšäº†è§£ï¼Œä¸ºäº†ä¾¿äºé˜…è¯»å’Œä¿®æ”¹ BPF è™šæ‹Ÿæœºå®ç°ä»£ç ã€‚å…³äºè·¨å¹³å°ï¼Œè¯¥<a href="https://sourceforge.net/p/predef/wiki/Home/" target="_blank" rel="noreferrer">ç«™ç‚¹</a>æ”¶å½•äº†ç›¸å…³çš„å®å®šä¹‰ï¼Œéå¸¸å®ç”¨ã€‚</p><h3 id="calling-convention" tabindex="-1">Calling Convention <a class="header-anchor" href="#calling-convention" aria-hidden="true">#</a></h3><p>Caller-saved register(åˆåæ˜“å¤±æ€§å¯„å­˜å™¨AKA volatile registers, or call-clobberedï¼‰ç”¨äºä¿å­˜ä¸éœ€è¦åœ¨å„ä¸ªè°ƒç”¨ä¹‹é—´ä¿ç•™çš„ä¸´æ—¶æ•°é‡ã€‚å› æ­¤ï¼Œå¦‚æœè¦åœ¨è¿‡ç¨‹è°ƒç”¨åæ¢å¤è¯¥å€¼ï¼Œåˆ™è°ƒç”¨æ–¹æœ‰è´£ä»»å°†è¿™äº›å¯„å­˜å™¨å‹å…¥å †æ ˆæˆ–å°†å…¶å¤åˆ¶åˆ°å…¶ä»–ä½ç½®ã€‚ä¸è¿‡ï¼Œè®©è°ƒç”¨é”€æ¯è¿™äº›å¯„å­˜å™¨ä¸­çš„ä¸´æ—¶å€¼æ˜¯æ­£å¸¸çš„ã€‚ä»è¢«è°ƒç”¨æ–¹çš„è§’åº¦æ¥çœ‹ï¼Œæ‚¨çš„å‡½æ•°å¯ä»¥è‡ªç”±è¦†ç›–ï¼ˆä¹Ÿå°±æ˜¯ç ´åï¼‰è¿™äº›å¯„å­˜å™¨ï¼Œè€Œæ— éœ€ä¿å­˜/æ¢å¤ã€‚</p><p>Callee-saved registerï¼ˆåˆç§°éæ˜“å¤±æ€§å¯„å­˜å™¨AKA non-volatile registers, or call-preservedï¼‰ç”¨äºä¿å­˜åº”åœ¨æ¯æ¬¡è°ƒç”¨ä¸­ä¿ç•™çš„é•¿å¯¿å‘½å€¼ã€‚å½“è°ƒç”¨è€…è¿›è¡Œè¿‡ç¨‹è°ƒç”¨æ—¶ï¼Œå¯ä»¥æœŸæœ›è¿™äº›å¯„å­˜å™¨åœ¨è¢«è°ƒç”¨è€…è¿”å›åå°†ä¿æŒç›¸åŒçš„å€¼ï¼Œè¿™ä½¿è¢«è°ƒç”¨è€…æœ‰è´£ä»»åœ¨è¿”å›è°ƒç”¨è€…ä¹‹å‰ä¿å­˜å®ƒä»¬å¹¶æ¢å¤å®ƒä»¬, è¿˜æ˜¯ä¸è¦ç¢°å®ƒä»¬ã€‚</p><p>æ›´é€šä¿—çš„ç†è§£ï¼š</p><p>â€œ è°ƒç”¨è€…ä¿å­˜â€ï¼ˆ caller saving ï¼‰æ–¹æ³•ï¼šå¦‚æœé‡‡ç”¨è°ƒç”¨è€…ä¿å­˜ç­–ç•¥ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªè°ƒç”¨è€…è°ƒç”¨åˆ«çš„è¿‡ç¨‹æ—¶ï¼Œå¿…é¡»ä¿å­˜è°ƒç”¨è€…æ‰€è¦ä¿å­˜çš„å¯„å­˜å™¨ï¼Œä»¥å¤‡è°ƒç”¨ç»“æŸè¿”å›åï¼Œèƒ½å¤Ÿå†æ¬¡è®¿é—®è°ƒç”¨è€…ã€‚ â€œ è¢«è°ƒç”¨è€…ä¿å­˜â€ï¼ˆ callee saving ï¼‰æ–¹æ³•ï¼šå¦‚æœé‡‡ç”¨è¢«è°ƒç”¨è€…ä¿å­˜ç­–ç•¥ï¼Œé‚£ä¹ˆè¢«è°ƒç”¨çš„è¿‡ç¨‹å¿…é¡»ä¿å­˜å®ƒè¦ç”¨çš„å¯„å­˜å™¨ï¼Œä¿è¯ä¸ä¼šç ´åè¿‡ç¨‹è°ƒç”¨è€…çš„ç¨‹åºæ‰§è¡Œç¯å¢ƒï¼Œå¹¶åœ¨è¿‡ç¨‹è°ƒç”¨ç»“æŸè¿”å›æ—¶ï¼Œæ¢å¤è¿™äº›å¯„å­˜å™¨çš„å†…å®¹ã€‚</p><h3 id="gnu-asm" tabindex="-1">GNU ASM <a class="header-anchor" href="#gnu-asm" aria-hidden="true">#</a></h3><p>ä¸‹é¢ x86-64 çš„ç¤ºä¾‹ç¨‹åºï¼Œé‡‡ç”¨çš„éƒ½æ˜¯ AT&amp;T è¯­æ³•ï¼Œä¹Ÿæ˜¯ GNU æµè¡Œçš„è¯­æ³•ï¼Œå’Œä¹‹å‰æ±‡ç¼–è¯¾ä¸Šçš„è¯­æ³•ç•¥æœ‰åŒºåˆ«ï¼šéœ€è¦åœ¨å¯„å­˜å™¨å‰é¢æ·»åŠ å‰ç¼€%ï¼Œä¾‹å¦‚<code>%eax</code>ï¼›åœ¨AT&amp;Tè¯­æ³•ä¸­ï¼Œç¬¬ä¸€ä¸ªæ˜¯æºæ“ä½œæ•°ï¼Œç¬¬äºŒä¸ªæ˜¯ç›®æ ‡æ“ä½œæ•°ã€‚Intel è¯­æ³•å’Œ AT&amp;T è¯­æ³•çš„å¸¸è§æŒ‡ä»¤æ ¼å¼å¯¹æ¯”å¦‚ä¸‹</p><p><img src="/assets/asm_grammar.e04195ab.jpg" alt=""></p><p>åªéœ€è¦ä½¿ç”¨ asm å°±å¯ä»¥åœ¨ C/C++ ä¸‹å†™æ±‡ç¼–ç¨‹åº</p><div class="language-C"><button title="Copy Code" class="copy"></button><span class="lang">C</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#ifdef</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__x86_64__</span></span>
<span class="line"><span style="color:#C792EA;">asm</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">mov $0xf0, %rax;</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#elif</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">__ARM_ARCH_7__</span></span>
<span class="line"><span style="color:#C792EA;">asm</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">volatile</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;">mov r0, #0xf0;</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#endif</span></span>
<span class="line"></span></code></pre></div><p>æœ‰ä¸€ä¸ªå¾ˆæœ‰è¶£çš„ç°è±¡æ˜¯ï¼Œå†™ ARM çš„æ±‡ç¼–æŒ‡ä»¤å´ä¸éœ€è¦éµå®ˆç±»ä¼¼ä¸Šé¢ AT&amp;Y çš„è¯­æ³•è§„åˆ™ï¼Œå¯ä»¥ç›´æ¥æŒ‰ ARM å®˜æ–¹æ–‡æ¡£çš„å†™æ³•ã€‚ä¹Ÿæœ‰è€å“¥åœ¨ <a href="https://stackoverflow.com/questions/43574163/why-is-gnu-as-syntax-different-between-x86-and-arm" target="_blank" rel="noreferrer">StackOverflow</a> ä¸Šé—®äº†è¿™ä¸ªé—®é¢˜ã€‚è§£ç­”æ˜¯ï¼š</p><p>ä¸ºå•¥ GNU Assembler (GAS) åœ¨ x86 ä¸Šç”¨ AT&amp;T è¯­æ³•å‘¢ï¼Ÿæ˜¯è€ƒè™‘åˆ°äº† x86 ä¸Š AT&amp;T&#39;s æ±‡ç¼–å™¨çš„å¯ç§»æ¤æ€§ã€‚AT&amp;T æ²¡æœ‰ä½¿ç”¨ Intel å®˜æ–¹çš„ x86 æ±‡ç¼–è¯­æ³•ï¼Œè€Œæ˜¯é€‰æ‹©äº†åŸºäºä»–ä»¬æ—©æœŸçš„ 68000 å’Œ PDP-11 æ±‡ç¼–å™¨åˆ›å»ºæ–°çš„è¯­æ³•ã€‚å½“ x86 æ”¯æŒè¢«æ·»åŠ åˆ°äº† GNU compiler (GCC) çš„æ—¶å€™ï¼Œå®ƒç”Ÿæˆçš„æ˜¯ AT&amp;T è¯­æ³•çš„æ±‡ç¼–ç¨‹åºï¼Œå› ä¸ºä»–ä»¬ç”¨çš„æ±‡ç¼–å™¨å°±æ˜¯è¿™æ ·çš„ã€‚</p><p>ç„¶è€Œæ²¡æœ‰ AT&amp;T ä¸º ARM CPU å†™çš„æ±‡ç¼–å™¨ï¼Œå½“ GNU å¼€å§‹ä¸€ç›´ GCC å’Œ GAS åˆ° ARM ç›®æ ‡æœºå™¨ä¸Šçš„æ—¶å€™ï¼Œæ²¡ç†ç”±ç»§ç»­åˆ›å»ºä¸€ä¸ªæ–°çš„ã€ç§»æ¤æ€§å·®çš„è¯­æ³•äº†ã€‚äºæ˜¯ä»–ä»¬å°±é€‰ç”¨äº† ARM çš„å®˜æ–¹è¯­æ³•ã€‚è¿™å°±æ„å‘³ç€ä½ èƒ½å¤ŸæŸ¥è¯¢ ARM çš„å®˜æ–¹æ–‡æ¡£ï¼Œåœ¨ GNU æ±‡ç¼–å™¨ä¸­ä½¿ç”¨ä¸Šé¢çš„æ ‡å‡†çš„ ARM æŒ‡ä»¤ã€‚</p><h3 id="x86-64" tabindex="-1">x86-64 <a class="header-anchor" href="#x86-64" aria-hidden="true">#</a></h3><p>Intel æœ€åˆæå‡ºçš„æ˜¯ IA-64ï¼Œä½†æ˜¯ç”±äºä¸å…¼å®¹ IA-32ï¼ˆx86-32ï¼‰ï¼Œé”€é‡å¹¶ä¸ç†æƒ³ã€‚AMD äºæ˜¯æ¨å‡ºäº†ä¸€æ¬¾å…¼å®¹ IA-32 çš„æŒ‡ä»¤ï¼Œå« x86-64ï¼Œå¹²è„†å–åä¸º AMD64ã€‚x86-64 ä¸Šä¸åŒæ•°æ®ç±»å‹çš„é•¿åº¦ï¼Œå…¶ä¸­ long double å¤šä½™çš„ä½æ˜¯ä¸ºäº†å¯¹é½ã€‚</p><p><img src="/assets/x86_type.c3f06e44.jpg" alt="è¿™é‡Œå†™å›¾ç‰‡æè¿°"></p><p>General purpose registers (GPRs) åœ¨ x86-32ï¼Œx86-64 ä¸Šåˆ†åˆ«å¦‚ä¸‹</p><p><img src="/assets/x86_32register.c16a1836.jpg" alt=""></p><p>x86-32 æ‰©å±•äº† x86-16 çš„å¯„å­˜å™¨ï¼ŒåŠ äº†å­—æ¯ E æ¥æ ‡è¯†ï¼Œä½ä½ä»ç„¶å¯ä»¥è§†ä½œ 16 ä½çš„å¯„å­˜å™¨ã€‚åŒæ ·çš„ï¼Œx86-64 è¿›ä¸€æ­¥æ‰©å±•äº† x86-32 çš„å¯„å­˜å™¨ï¼Œç”¨ Ræ¥æ ‡è¯†ï¼Œå¦‚ä¸‹å›¾</p><p><img src="/assets/x86_64register.09040f0b.jpg" alt=""></p><p>å…·ä½“çš„ä½¿ç”¨æ–¹é¢å¦‚ä¸‹å›¾ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åç§°ä¸Šéœ€è¦å–ä½ä½çš„æ—¶å€™ï¼Œæ—§çš„æ¶æ„ä¸­å­˜åœ¨çš„å¯„å­˜å™¨ï¼Œä»ç„¶å¯ä»¥ç”¨æ—§çš„æ¶æ„ä¸­çš„åå­—ï¼›æ–°å¢çš„å¯„å­˜å™¨ï¼Œåˆ™é€šè¿‡åç¼€ Byte ï¼ˆBï¼‰ã€Word ï¼ˆWï¼‰ã€Double Wordï¼ˆDWï¼‰æ¥åŒºåˆ†ã€‚</p><p><img src="/assets/x86_64use.017200ee.jpg" alt=""></p><p>ä¸‹é¢çš„å›¾é˜è¿°äº†å¯„å­˜å™¨ä»¬å…·ä½“çš„åŠŸèƒ½ï¼ŒåŒæ—¶é™¤äº† <code>rsp</code> å’Œæ˜ç¡®æ ‡è¯†è¢«è°ƒç”¨è€…ä¿æŠ¤çš„ <code>rbx</code>ï¼Œ<code>rbp</code>ï¼Œ<code>r12</code>ï¼Œ<code>r13</code>ï¼Œ<code>r14</code>ï¼Œ<code>r15</code>ï¼Œå…¶ä½™éƒ½æ˜¯è°ƒç”¨è€…éœ€è¦ä¿æŠ¤çš„å¯„å­˜å™¨ã€‚</p><p><img src="/assets/x86_64bank.7ea384d6.jpg" alt=""></p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼è¿ç®—çš„ä¾‹å­ï¼Œå…ˆè¿›è¡Œç±»å‹è½¬æ¢ï¼Œä¸è¿ç®—ä¸­æ›´é•¿çš„ç±»å‹ç»Ÿä¸€ä½æ•°åå†è¿›è¡Œè®¡ç®—</p><p><img src="/assets/x86_cal.580390a8.jpg" alt=""></p><p>å‡½æ•°è°ƒç”¨çš„ä¾‹å­ï¼Œåœ¨ x86-32 ä¸­éœ€è¦ç”¨åˆ°æ ˆï¼Œä½†æ˜¯åœ¨ x86-64 ä¸­å¯ä»¥æ›´ç®€å•åœ°ç›´æ¥è°ƒç”¨å¯„å­˜å™¨</p><p><img src="/assets/x86_call.7c8ce408.jpg" alt=""></p><p>æ›´åŠ è¯¦ç»†çš„è¿‡ç¨‹è°ƒç”¨å‚æ•°ä¼ é€’è§„èŒƒï¼Œæœ‰ä¸‹è¡¨</p><p><img src="/assets/x86_specification.f0431170.jpg" alt=""></p><p>æ ¹æ®ä¸Šè¡¨ï¼Œä¸€ä¸ªè¾ƒä¸ºå¤æ‚çš„ä¾‹å­å¦‚ä¸‹</p><p><img src="/assets/x86_example.f3b2f569.jpg" alt=""></p><h3 id="armv7-m" tabindex="-1">ARMv7-M <a class="header-anchor" href="#armv7-m" aria-hidden="true">#</a></h3><p>å¦‚ä¹‹å‰<a href="/zh/blogs/20210311/">ç¬”è®°</a>æ‰€è¿°ï¼ŒARMv7-M é€‚ç”¨äºåµŒå…¥å¼ç³»ç»Ÿç­‰åŠŸè€—ä½çš„åœºæ™¯ï¼Œåªæ”¯æŒThumbæŒ‡ä»¤é›†ï¼Œç”¨äºå¾®å¤„ç†å™¨é¢†åŸŸã€‚å®ƒçš„å¯„å­˜å™¨ä¸º 32 ä½ã€‚ä»¥ Cortex-M4 ä¸ºä¾‹ï¼Œå®ƒåŒ…å«äº† 32 ä¸ªå¯„å­˜å™¨ï¼Œå…¶ä¸­ 13 ä¸ªæ˜¯é€šç”¨å¯„å­˜å™¨ï¼ˆGPRï¼‰ï¼Œè¿˜æœ‰ä¸€äº›æ˜¯å…·æœ‰ç‰¹æ®Šæ„ä¹‰çš„å¯„å­˜å™¨ã€‚å…·ä½“è€Œè¨€ï¼ŒGPR ä¸º R0-R12ï¼ŒR13 æ˜¯ Stack Pointerï¼ˆSPï¼‰ï¼ŒR14 æ˜¯ Link Register ï¼ˆLRï¼‰ï¼ŒR15 æ˜¯ Program Counterï¼ˆPCï¼‰ï¼Œå…¶ä½™éƒ½æ˜¯ Special-purpose Program Status Registers, (xPSR)ã€‚</p><p><img src="/assets/arm_register.7dce44e8.png" alt=""></p><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºé€šç”¨å¯„å­˜å™¨åˆ†ä¸º</p><ul><li>low registers æ˜¯ R0 åˆ° R7ï¼Œæ‰€æœ‰æŒ‡ä»¤éƒ½èƒ½ä½¿ç”¨ä»–ä»¬</li><li>high registers æ˜¯ R8 åˆ° R12ï¼Œ32 ä½æŒ‡ä»¤å¯ä»¥ä½¿ç”¨ï¼Œéƒ½æ˜¯16ä½æŒ‡ä»¤ä¸èƒ½ä½¿ç”¨</li></ul><p>ç‰¹æ®Šçš„å¯„å­˜å™¨ï¼š</p><ul><li>SPï¼šR13 ä¼šå¿½ç•¥æ‰ä½ [1:0] çš„å†™æ“ä½œï¼Œå› æ­¤å®ƒè‡ªåŠ¨æ˜¯æŒ‰ word å¯¹é½çš„ï¼ˆ4ä¸ªByteï¼‰ã€‚å¤„ç†å¼‚å¸¸çš„ Handler æ¨¡å¼ä¸‹æ€»æ˜¯ä½¿ç”¨ SP_mainï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥é…ç½® Thread æ¨¡å¼ä½¿ç”¨ SP_main æˆ– SP_processã€‚&quot;Thumb&quot; æ¨¡å¼ä¸‹çš„ Push/Pop æŒ‡ä»¤ç”¨è¿™ä¸ªå¯„å­˜å™¨ã€‚</li><li>LRï¼šR14 æ˜¯é“¾æ¥å­ç¨‹åºçš„å¯„å­˜å™¨ã€‚å½“æ‰§è¡Œ Branch and Link (BL) æˆ– Branch and Link with Exchange (BLX) æŒ‡ä»¤çš„æ—¶å€™ï¼ŒLR æ¥æ”¶ä» PC è¿”å›çš„åœ°å€ã€‚LR ä¹Ÿç”¨æ¥å¤„ç†å¼‚å¸¸çš„è¿”å›ã€‚åœ¨å…¶ä»–æ—¶å€™ï¼Œä¹Ÿå¯ä»¥æŠŠå®ƒå½“åšé€šç”¨å¯„å­˜å™¨ã€‚</li><li>PCï¼šR15 çš„ç¬¬ 0 ä½æ€»æ˜¯0ï¼ŒæŒ‡ä»¤åœ°å€éƒ½æ˜¯æŒ‰ word æˆ– half-word ä¸ºç•Œå¯¹é½çš„ã€‚</li></ul><p>è‡³äºå…¶ä»– 16 ä¸ªå¯„å­˜å™¨ï¼Œä¸€èˆ¬éƒ½æ˜¯ç”¨äºç³»ç»Ÿæ§åˆ¶ï¼Œè§<a href="https://developer.arm.com/documentation/100166/0001/System-Control?search=5eec6e71e24a5e02d07b259a" target="_blank" rel="noreferrer">Cortex-M4 Manual</a>ç¬¬å››ç« ï¼šSystem Controlã€‚</p><p>åœ¨å¤„ç†å‡½æ•°è°ƒç”¨æ—¶ï¼Œå‚è€ƒ <a href="https://en.wikipedia.org/wiki/Calling_convention" target="_blank" rel="noreferrer">ç»´åŸºç™¾ç§‘</a> å’Œ <a href="https://stackoverflow.com/questions/261419/what-registers-to-save-in-the-arm-c-calling-convention" target="_blank" rel="noreferrer">StackOverflow</a>ï¼Œ32 ä½ ARM çš„ Calling Convention ï¼ˆå³ caller-saved è¿˜æ˜¯ callee-savedï¼‰æ˜¯éµä» <a href="https://developer.arm.com/documentation/ihi0042/f/" target="_blank" rel="noreferrer">AAPCS</a> ç¬¬5.1.1 å¯„å­˜å™¨ç›¸å…³ç« èŠ‚ã€‚ä»åŠŸèƒ½ä¸Šæ¥è®²</p><ul><li>R12ï¼šIntra-Procedure-call scratch registerï¼Œè°ƒç”¨è€…ä¿å­˜</li><li>R4 ~ R11ï¼šå±€éƒ¨å˜é‡ï¼Œé™¤äº† R9 éƒ½æ˜¯è¢«è°ƒç”¨è€…å­˜å‚¨çš„å¯„å­˜å™¨ï¼ŒR9åœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ç‰¹æ®Šå¯„å­˜å™¨</li><li>R0 ~ R3ï¼šä¼ é€’ç»™å­ç¨‹åºçš„å‚æ•°å’Œå­ç¨‹åºè¿”å›çš„ç»“æœï¼Œè°ƒç”¨è€…ä¿å­˜</li></ul><p>ç”¨ä¸€å¼ è¡¨æè¿°</p><p><img src="/assets/arm_calling.c338cfe1.png" alt=""></p><p>ä¾‹å­ï¼š</p><p><img src="/assets/arm_convention1.4b1a03de.png" alt=""></p><p><img src="/assets/arm_convention2.142127d4.png" alt=""></p><h1 id="reference" tabindex="-1">Reference <a class="header-anchor" href="#reference" aria-hidden="true">#</a></h1><p><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/bpf/bpf_devel_QA.rst" target="_blank" rel="noreferrer">BPF</a> å¼€å‘QAï¼šè§£é‡Šäº†ä¸¤æ¡bpfç›¸å…³çš„å†…æ ¸åˆ†æ”¯çš„ä½œç”¨ï¼Œè§„å®šäº†æ±‡æŠ¥bugã€æäº¤è¡¥ä¸çš„æ–¹æ³•ã€‚</p><p>Facebook çš„ BPF ç›¸å…³å›¢é˜Ÿæˆå‘˜<a href="https://nakryiko.com/" target="_blank" rel="noreferrer">åšå®¢</a>ï¼Œå¤§éƒ¨åˆ†å†…å®¹éƒ½æ‘˜å½•ã€ç¿»è¯‘è‡ªè¿™é‡Œã€‚</p><p><a href="https://github.com/iovisor/bpf-docs/blob/master/bpf_helpers.rst/" target="_blank" rel="noreferrer">eBPF-Helpers</a>ï¼Œebpf ç¨‹åºçš„ API å‡½æ•°æ–‡æ¡£ï¼Œè²Œä¼¼å’Œ<a href="https://man7.org/linux/man-pages/man7/bpf-helpers.7.html" target="_blank" rel="noreferrer">è¿™é‡Œçš„å†…å®¹é‡å¤</a>ã€‚</p><p><a href="https://docs.cilium.io/en/latest/bpf/" target="_blank" rel="noreferrer">Cilium æ–‡æ¡£</a> è¯¦ç»†è®²è§£äº† bpf å’Œ xdpã€‚</p><p><a href="https://github.com/iovisor/bpf-docs/blob/master/eBPF.md" target="_blank" rel="noreferrer">iovisor eBPF spec</a> åˆ—å‡ºäº† eBPF opcodeï¼Œé¡¹ç›®æ˜¯ iovisor æ€»ç»“çš„ç³»åˆ—æ–‡æ¡£ã€preã€‚</p><p><a href="https://www.kernel.org/doc/Documentation/networking/filter.txt" target="_blank" rel="noreferrer">å†…æ ¸ bpf ç›¸å…³æ–‡æ¡£</a></p><p>æ¶æ„ã€æŒ‡ä»¤é›†ç›¸å…³ï¼š</p><p><a href="https://blog.csdn.net/l919898756/article/details/103142439" target="_blank" rel="noreferrer">Caller-saved register and Callee-saved register</a></p><p><a href="https://blog.csdn.net/yongchaocsdn/article/details/78336233" target="_blank" rel="noreferrer">X86-64æŒ‡ä»¤ç³»ç»Ÿ_yongchaocsdnçš„åšå®¢-CSDNåšå®¢</a></p><p><a href="https://developer.arm.com/documentation/ddi0403/d/Application-Level-Architecture/The-ARMv7-M-Instruction-Set/About-the-instruction-set?lang=en" target="_blank" rel="noreferrer">ARMv7-M Documentation â€“ Arm Developer</a></p><p><a href="https://developer.arm.com/documentation/100166/0001/System-Control?search=5eec6e71e24a5e02d07b259a" target="_blank" rel="noreferrer">ARM Cortex-M4 Processor Technical Reference Manual</a></p><p><a href="https://www.ic.unicamp.br/~celio/mc404-2014/docs/gnu-arm-directives.pdf" target="_blank" rel="noreferrer">GNU ARM Quick Reference</a></p><p><a href="https://sourceforge.net/p/predef/wiki/Home/" target="_blank" rel="noreferrer">C/C++è·¨å¹³å°å®å®šä¹‰</a></p><p><a href="https://blog.csdn.net/sinat_38816924/article/details/115607570" target="_blank" rel="noreferrer">bpf mapç®€ä»‹</a></p></div></div></main><!--[--><!--]--><!----><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div><!----><footer data-v-4f0db67d> Powered by <a href="https://github.com/forsworns/" target="_blank" title="Author" data-v-4f0db67d>Peihao Yang</a> | Copyright Â© 2019-2024 | MIT License </footer><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"zh_blogs_20190721_index.md\":\"a5f6365d\",\"zh_blogs_20190824_index.md\":\"b39fa276\",\"index.md\":\"3b0bb023\",\"zh_blogs_20190901_index.md\":\"bd63dbe1\",\"zh_blogs_20190919_index.md\":\"071ad5c0\",\"zh_about-me_index.md\":\"06db9775\",\"about-me_index.md\":\"61df0572\",\"zh_blogs_20190908_index.md\":\"fe35bae0\",\"zh_blogs_20201023_index.md\":\"4a0ff3be\",\"zh_blogs_20191109_index.md\":\"c5f84e5f\",\"zh_blogs_20200816_index.md\":\"95878f02\",\"zh_blogs_20191112_index.md\":\"c53564eb\",\"zh_blogs_20210310_index.md\":\"f9e8c066\",\"zh_blogs_20210203_index.md\":\"de612515\",\"zh_blogs_20200818_index.md\":\"9cc20080\",\"zh_blogs_20210223_index.md\":\"0af2d01f\",\"zh_blogs_20210120_index.md\":\"1c227e15\",\"zh_blogs_20210226_index.md\":\"aec2d002\",\"zh_blogs_20210412_index.md\":\"564a42bc\",\"zh_blogs_20210430_index.md\":\"1d1d74c3\",\"zh_blogs_20210204_index.md\":\"6f237d69\",\"zh_blogs_20200616_index.md\":\"c3591887\",\"zh_blogs_20210312_index.md\":\"38625e6d\",\"zh_blogs_20200817_index.md\":\"453aa9e2\",\"zh_blogs_20210123_index.md\":\"bcb41c5b\",\"zh_blogs_20210315_index.md\":\"71263163\",\"zh_blogs_20210224_index.md\":\"42f020f0\",\"zh_blogs_20230322_index.md\":\"34f8705e\",\"zh_blogs_20230125_index.md\":\"0f387ae5\",\"zh_blogs_20230201_index.md\":\"eb997fc7\",\"zh_blogs_20230201_repost.md\":\"8f68b3f9\",\"zh_blogs_20230209_index.md\":\"24098285\",\"zh_blogs_20230126_index.md\":\"7ca2c4b0\",\"zh_blogs_20230121_index.md\":\"2eccda15\",\"zh_blogs_20240423_index.md\":\"d1ac5acb\",\"zh_blogs_20240215_index.md\":\"a185b9a1\",\"zh_blogs_20240513_index.md\":\"20cb378b\",\"zh_blogs_20240427_index.md\":\"0a9fbc5b\",\"zh_blogs_20240128_index.md\":\"14420c07\",\"zh_blogs_20240220_index.md\":\"e17cc53d\",\"zh_blogs_20240413_index.md\":\"02f328f8\",\"zh_blogs_20230601_index.md\":\"fe17d1ac\",\"zh_blogs_index.md\":\"85e75fd3\",\"zh_blogs_tags_index.md\":\"e2805e63\",\"zh_blogs_20210506_index.md\":\"3524f0a7\",\"zh_blogs_20210311_index.md\":\"cc78f3af\",\"zh_blogs_20210409_index.md\":\"5090bd7b\",\"zh_blogs_20221108_index.md\":\"39f21936\",\"zh_blogs_20210627_index.md\":\"77f263c5\",\"zh_index.md\":\"580dffd0\",\"zh_blogs_20210822_index.md\":\"9c404eff\",\"zh_blogs_20220105_index.md\":\"4383b03b\",\"zh_blogs_20230101_index.md\":\"afb17742\",\"zh_blogs_20210329_index.md\":\"ad8fa8fd\",\"zh_blogs_20211130_index.md\":\"2c8c19bf\",\"zh_blogs_20211120_index.md\":\"0557fa72\",\"zh_blogs_20221228_index.md\":\"50c741d7\",\"zh_blogs_20210706_index.md\":\"deca96b8\",\"zh_blogs_20210728_index.md\":\"c27eda6d\",\"zh_blogs_20210801_index.md\":\"d8fecd9e\",\"zh_blogs_20220611_index.md\":\"b88ac4eb\",\"zh_blogs_20211210_index.md\":\"e5633938\",\"zh_blogs_20211002_index.md\":\"9a4fffab\",\"zh_blogs_20191103_index.md\":\"c3922c4f\",\"zh_blogs_20220224_index.md\":\"57acca4e\",\"zh_blogs_20210715_index.md\":\"4a168546\",\"zh_blogs_20191102_index.md\":\"e2aea59f\",\"zh_blogs_20220101_index.md\":\"576a2dfc\",\"zh_blogs_20221024_index.md\":\"09926e65\",\"zh_blogs_20220316_index.md\":\"29dcfdf0\"}")</script>
    <script type="module" async src="/assets/app.a19c101b.js"></script>
    
  </body>
</html>