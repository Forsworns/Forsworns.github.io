<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Makefile 笔记 | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.c401dc4c.css" as="style"><link rel="preload" href="/assets/js/app.64e41af0.js" as="script"><link rel="preload" href="/assets/js/1.b822baa6.js" as="script"><link rel="preload" href="/assets/js/63.d8ac060f.js" as="script"><link rel="preload" href="/assets/js/12.331c1b95.js" as="script"><link rel="prefetch" href="/assets/js/10.70c355fc.js"><link rel="prefetch" href="/assets/js/11.753893eb.js"><link rel="prefetch" href="/assets/js/13.a4e8aabf.js"><link rel="prefetch" href="/assets/js/14.24b3becc.js"><link rel="prefetch" href="/assets/js/15.00ff0e6a.js"><link rel="prefetch" href="/assets/js/16.d99681a9.js"><link rel="prefetch" href="/assets/js/17.e83aede1.js"><link rel="prefetch" href="/assets/js/18.c101c0e5.js"><link rel="prefetch" href="/assets/js/19.dcc78c73.js"><link rel="prefetch" href="/assets/js/20.521a8bf7.js"><link rel="prefetch" href="/assets/js/21.7bd51a4c.js"><link rel="prefetch" href="/assets/js/22.5734c1b8.js"><link rel="prefetch" href="/assets/js/23.3019517c.js"><link rel="prefetch" href="/assets/js/24.f10332fd.js"><link rel="prefetch" href="/assets/js/25.8a6166c9.js"><link rel="prefetch" href="/assets/js/26.a0f9572e.js"><link rel="prefetch" href="/assets/js/27.6fbd40e6.js"><link rel="prefetch" href="/assets/js/28.412744c7.js"><link rel="prefetch" href="/assets/js/29.61bdab72.js"><link rel="prefetch" href="/assets/js/3.462f36af.js"><link rel="prefetch" href="/assets/js/30.502699f8.js"><link rel="prefetch" href="/assets/js/31.e54d3e42.js"><link rel="prefetch" href="/assets/js/32.cb38bcb3.js"><link rel="prefetch" href="/assets/js/33.35a0d2a0.js"><link rel="prefetch" href="/assets/js/34.dfb7a7d8.js"><link rel="prefetch" href="/assets/js/35.d5480fa9.js"><link rel="prefetch" href="/assets/js/36.7dd0e3f3.js"><link rel="prefetch" href="/assets/js/37.ef5781a6.js"><link rel="prefetch" href="/assets/js/38.953c02c4.js"><link rel="prefetch" href="/assets/js/39.74890a7e.js"><link rel="prefetch" href="/assets/js/4.ecd12c72.js"><link rel="prefetch" href="/assets/js/40.227ad2e8.js"><link rel="prefetch" href="/assets/js/41.5db4f49f.js"><link rel="prefetch" href="/assets/js/42.62bbf1aa.js"><link rel="prefetch" href="/assets/js/43.0c221fa7.js"><link rel="prefetch" href="/assets/js/44.9cace7d0.js"><link rel="prefetch" href="/assets/js/45.b212e848.js"><link rel="prefetch" href="/assets/js/46.389632d3.js"><link rel="prefetch" href="/assets/js/47.2c698c81.js"><link rel="prefetch" href="/assets/js/48.a5fd78b8.js"><link rel="prefetch" href="/assets/js/49.a9e74e3e.js"><link rel="prefetch" href="/assets/js/5.5b6ccdda.js"><link rel="prefetch" href="/assets/js/50.5f58b67b.js"><link rel="prefetch" href="/assets/js/51.648fc41d.js"><link rel="prefetch" href="/assets/js/52.82fa340f.js"><link rel="prefetch" href="/assets/js/53.d2bd7567.js"><link rel="prefetch" href="/assets/js/54.0e48d9bf.js"><link rel="prefetch" href="/assets/js/55.df8d58d2.js"><link rel="prefetch" href="/assets/js/56.628aafb9.js"><link rel="prefetch" href="/assets/js/57.70a594da.js"><link rel="prefetch" href="/assets/js/58.7cee13f9.js"><link rel="prefetch" href="/assets/js/59.c6a690f4.js"><link rel="prefetch" href="/assets/js/6.38321375.js"><link rel="prefetch" href="/assets/js/60.92f8a773.js"><link rel="prefetch" href="/assets/js/61.b9000fcd.js"><link rel="prefetch" href="/assets/js/62.b24c5821.js"><link rel="prefetch" href="/assets/js/64.e408e5a8.js"><link rel="prefetch" href="/assets/js/65.67665fed.js"><link rel="prefetch" href="/assets/js/66.bdaea6cf.js"><link rel="prefetch" href="/assets/js/67.cf2ee58d.js"><link rel="prefetch" href="/assets/js/68.49432d26.js"><link rel="prefetch" href="/assets/js/69.aba46e78.js"><link rel="prefetch" href="/assets/js/7.ab777b2a.js"><link rel="prefetch" href="/assets/js/70.42396fff.js"><link rel="prefetch" href="/assets/js/71.170b2f05.js"><link rel="prefetch" href="/assets/js/72.d017290f.js"><link rel="prefetch" href="/assets/js/73.a7c0bf95.js"><link rel="prefetch" href="/assets/js/74.0796c0ed.js"><link rel="prefetch" href="/assets/js/8.6e1963ab.js"><link rel="prefetch" href="/assets/js/9.197a57a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c401dc4c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210409/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210409/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#伪目标-phony-target">伪目标 Phony Target</a></li><li><a href="#预定义的变量">预定义的变量</a></li><li><a href="#默认cc">默认CC</a></li><li><a href="#内存泄漏检测">内存泄漏检测</a></li><li><a href="#代码覆盖率">代码覆盖率</a></li><li><a href="#为目录下所有文件生成目标代码">为目录下所有文件生成目标代码</a></li><li><a href="#特殊符号">特殊符号</a></li><li><a href="#赋值符号">赋值符号</a></li><li><a href="#递归编译多目录">递归编译多目录</a></li><li><a href="#编译时添加宏定义">编译时添加宏定义</a></li><li><a href="#杂项">杂项</a></li><li><a href="#指定安装目录">指定安装目录</a></li><li><a href="#多级目录、多个链接库">多级目录、多个链接库</a></li></ul></div><p></p> <h1 id="makefile-笔记"><a href="#makefile-笔记" class="header-anchor">#</a> Makefile 笔记</h1> <p>记录一些遇到的问题</p> <h2 id="伪目标-phony-target"><a href="#伪目标-phony-target" class="header-anchor">#</a> 伪目标 Phony Target</h2> <p>当目录下路径或文件与 Makefile中 的目标名冲突的时候，可以通过定义伪目标的方式避免冲突：</p> <p>如下面这个例子</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">touch</span> clean
<span class="token function">make</span> clean
</code></pre></div><p>这样不会执行 Makefile 中定义的 clean 目标，而是会提示我们 <code>clean is up to date</code></p> <p>此时需要使用 <code>.PHONY</code> 关键字来定义 clean</p> <p>在 Makefile 中需要写</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token builtin">.PHONY</span><span class="token punctuation">:</span> clean
</code></pre></div><h2 id="预定义的变量"><a href="#预定义的变量" class="header-anchor">#</a> 预定义的变量</h2> <table><thead><tr><th>预定义变量</th> <th>含义</th></tr></thead> <tbody><tr><td>AR</td> <td>库文件维护程序的名称，默认值为ar</td></tr> <tr><td>AS</td> <td>汇编程序的名称，默认值为as</td></tr> <tr><td>CC</td> <td>C 编译器的名称，默认值为cc</td></tr> <tr><td>CPP</td> <td>C 预编译器的名称，默认值为$(CC) –E</td></tr> <tr><td>CXX</td> <td>C++编译器的名称，默认值为g++</td></tr> <tr><td>FC</td> <td>FORTARAN 编译器的名称，默认值为f77</td></tr> <tr><td>RM</td> <td>文件删除程序的名称，默认值为rm -f</td></tr> <tr><td>ARFLAGS</td> <td>库文件维护程序的选项，无默认值</td></tr> <tr><td>ASFLAGS</td> <td>汇编程序的选项，无默认值</td></tr> <tr><td>CFLAGS</td> <td>C 编译器的选项，无默认值</td></tr> <tr><td>CPPFLAGS</td> <td>C 预编译的选项，无默认值</td></tr> <tr><td>CXXFLAGS</td> <td>C++编译器的选项，无默认值</td></tr> <tr><td>FFLAGS</td> <td>Fortran 编译器的选项，无默认值</td></tr></tbody></table> <h2 id="默认cc"><a href="#默认cc" class="header-anchor">#</a> 默认CC</h2> <p>在默认情况下，编译器使用 <code>cc</code>，可以通过<code>update-alternatives --list cc</code> 命令查看安装的 C 编译器种类，然后使用 <code>update-alternatives --set cc</code> 按照提示设置。</p> <h2 id="内存泄漏检测"><a href="#内存泄漏检测" class="header-anchor">#</a> 内存泄漏检测</h2> <p>之前用过 valgrind 工具辅助分析。还有一个比较好用的是 sanitize，可以在编译时作为 <code>CFLAGS</code> 添加，比如使用 address 选项检测非法内存地址</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>ASAN<span class="token punctuation">)</span>,1<span class="token punctuation">)</span> <span class="token comment"># 需要定义该参数</span>
CFLAGS <span class="token operator">+=</span> -fsanitize<span class="token operator">=</span>address
LDFLAGS <span class="token operator">+=</span> -fsanitize<span class="token operator">=</span>address
<span class="token keyword">endif</span>
</code></pre></div><p><code>-fsanitize=leak</code> 则可以检查泄漏</p> <h2 id="代码覆盖率"><a href="#代码覆盖率" class="header-anchor">#</a> 代码覆盖率</h2> <p>gcov是在代码运行时统计代码覆盖率的工具，随着gcc一起发布的。
它的使用很简单，需要在编译和链接时增加-fprofile-arcs -ftest-coverage生成二进制文件。</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token keyword">ifeq</span> <span class="token punctuation">(</span><span class="token variable">$</span><span class="token punctuation">(</span>COVERAGE<span class="token punctuation">)</span>,1<span class="token punctuation">)</span>
CFLAGS <span class="token operator">+=</span> -fprofile-arcs -ftest-coverage
LDFLAGS <span class="token operator">+=</span> -fprofile-arcs
<span class="token keyword">endif</span>
</code></pre></div><p>gcov主要使用.gcno和.gcda两个文件。
.gcno是由-ftest-coverage产生的，它包含了重建基本块图和相应的块的源码的行号的信息。
.gcda是由加了-fprofile-arcs编译参数的编译后的文件运行所产生的，它包含了弧跳变的次数和其他的概要信息。</p> <h2 id="为目录下所有文件生成目标代码"><a href="#为目录下所有文件生成目标代码" class="header-anchor">#</a> 为目录下所有文件生成目标代码</h2> <p>可以使用例如下面 Makefile 的写法，使用通配符</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code>SOURCES <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">wildcard</span> *.c<span class="token punctuation">)</span>
OBJS <span class="token operator">=</span> <span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">patsubst</span> %.c,%.o,<span class="token variable">$</span><span class="token punctuation">(</span>SOURCES<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token symbol">All</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>OBJS<span class="token punctuation">)</span>
</code></pre></div><h2 id="特殊符号"><a href="#特殊符号" class="header-anchor">#</a> 特殊符号</h2> <p><code>$@</code> 表示目标文件</p> <p><code>$^</code> 表示所有的依赖文件</p> <p><code>$&lt;</code> 表示第一个依赖文件</p> <p><code>$?</code> 表示比目标还要新的依赖文件列表</p> <p><code>$%</code> 仅当目标是函数库文件中，表示规则中的目标成员名。例如，如果一个目标是<code>foo.a(bar.o)</code>，那么，<code>$%</code>就是<code>bar.o</code>，<code>$@</code>就是<code>foo.a</code>。如果目标不是函数库文件，那么，其值为空。</p> <p><code>$+</code> 这个变量很像<code>$^</code>，也是所有依赖目标的集合。只是它不去除重复的依赖目标。</p> <p><code>$*</code> 这个变量表示目标模式中 <code>%</code>及其之前的部分。如果目标是 <code>dir/a.foo.b</code>，并且目标的模式是<code>a.%.b</code>，那么，<code>$*</code>的值就是<code>dir/a.foo</code>。这个变量对于构造有关联的文件名是比较有较。如果目标中没有模式的定义，那么“*”也就不能被推导出，但是，如果目标文件的后缀是make所识别的，那么“*”就是除了后缀的那一部分。例如：如果目标是“foo.c”，因为“.c”是make所能识别的后缀名，所以，<code>$*</code>的值就是<code>foo</code>。这个特性是GNU make的，很有可能不兼容于其它版本的make，所以，你应该尽量避免使用<code>$*</code>，除非是在隐含规则或是静态模式中。如果目标中的后缀是make所不能识别的，那么<code>$*</code>就是空值。</p> <h2 id="赋值符号"><a href="#赋值符号" class="header-anchor">#</a> 赋值符号</h2> <ul><li><code>=</code> 是最基本的赋值</li> <li><code>:=</code> 是覆盖之前的值</li> <li><code>?=</code> 是如果没有被赋值过就赋予等号后面的值</li> <li><code>+=</code> 是添加等号后面的值</li></ul> <h2 id="递归编译多目录"><a href="#递归编译多目录" class="header-anchor">#</a> 递归编译多目录</h2> <p>假设目标代码和可执行文件都在 <code>debug</code> 目录下，其他都是源代码文件，则根目录下 Makefile</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token comment">#设置编译器</span>
CC<span class="token operator">=</span>gcc
<span class="token comment">#debug文件夹里的makefile文件需要最后执行，所以这里需要执行的子目录要排除debug文件夹，这里使用awk排除了debug文件夹，读取剩下的文件夹</span>
SUBDIRS<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> ls -l <span class="token operator">|</span> grep ^d <span class="token operator">|</span> awk <span class="token string">'{if($$9 != &quot;debug&quot;) print $$9}'</span><span class="token punctuation">)</span>
<span class="token comment">#无需下一行的注释代码，因为我们已经知道debug里的makefile是最后执行的，所以最后直接去debug目录下执行指定的makefile文件就行，具体下面有注释</span>
<span class="token comment">#DEBUG=$(shell ls -l | grep ^d | awk '{if($$9 == &quot;debug&quot;) print $$9}')</span>
<span class="token comment">#记住当前工程的根目录路径</span>
ROOT_DIR<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> pwd<span class="token punctuation">)</span>
<span class="token comment">#最终bin文件的名字，可以更改为自己需要的</span>
BIN<span class="token operator">=</span>myapp
<span class="token comment">#目标文件所在的目录</span>
OBJS_DIR<span class="token operator">=</span>debug/obj
<span class="token comment">#bin文件所在的目录</span>
BIN_DIR<span class="token operator">=</span>debug/bin
<span class="token comment">#获取当前目录下的c文件集，放在变量CUR_SOURCE中</span>
CUR_SOURCE<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">{</span>wildcard *.c<span class="token punctuation">}</span>
<span class="token comment">#将对应的c文件名转为o文件后放在下面的CUR_OBJS变量中</span>
CUR_OBJS<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">{</span>patsubst %.c, %.o, <span class="token variable">$</span><span class="token punctuation">(</span>CUR_SOURCE<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token comment">#将以下变量导出到子shell中，本次相当于导出到子目录下的makefile中</span>
<span class="token keyword">export</span> CC BIN OBJS_DIR BIN_DIR ROOT_DIR
<span class="token comment">#注意这里的顺序，需要先执行SUBDIRS最后才能是DEBUG</span>
<span class="token symbol">all</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>SUBDIRS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CUR_OBJS<span class="token punctuation">)</span> DEBUG
<span class="token comment">#递归执行子目录下的makefile文件，这是递归执行的关键</span>
<span class="token symbol"><span class="token variable">$</span>(SUBDIRS)</span><span class="token punctuation">:</span>ECHO
    make -C <span class="token variable">$@</span>
<span class="token symbol">DEBUG</span><span class="token punctuation">:</span>ECHO
    <span class="token comment">#直接去debug目录下执行makefile文件</span>
    make -C debug
<span class="token symbol">ECHO</span><span class="token punctuation">:</span>
    <span class="token operator">@</span>echo <span class="token variable">$</span><span class="token punctuation">(</span>SUBDIRS<span class="token punctuation">)</span>
<span class="token comment">#将c文件编译为o文件，并放在指定放置目标文件的目录中即OBJS_DIR</span>
<span class="token symbol"><span class="token variable">$</span>(CUR_OBJS)</span><span class="token punctuation">:</span>%.o<span class="token punctuation">:</span>%.c
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -c <span class="token variable">$^</span> -o <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>OBJS_DIR<span class="token punctuation">)</span>/<span class="token variable">$@</span>
<span class="token symbol">CLEAN</span><span class="token punctuation">:</span>
    <span class="token operator">@</span>rm <span class="token variable">$</span><span class="token punctuation">(</span>OBJS_DIR<span class="token punctuation">)</span>/*.o
    <span class="token operator">@</span>rm -rf <span class="token variable">$</span><span class="token punctuation">(</span>BIN_DIR<span class="token punctuation">)</span>/*
</code></pre></div><p>子目录 makefile</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token comment">#子目录的Makefile直接读取其子目录就行，使用 grep 过滤出来目录（ls 后会以d为标识开头）</span>
SUBDIRS<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span><span class="token keyword">shell</span> ls -l <span class="token operator">|</span> grep ^d <span class="token operator">|</span> awk <span class="token string">'{print $$9}'</span><span class="token punctuation">)</span>
<span class="token comment">#以下同根目录下的makefile的相同代码的解释</span>
CUR_SOURCE<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">{</span>wildcard *.c<span class="token punctuation">}</span>
CUR_OBJS<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">{</span>patsubst %.c, %.o, <span class="token variable">$</span><span class="token punctuation">(</span>CUR_SOURCE<span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token symbol">ALL</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>SUBDIRS<span class="token punctuation">)</span> <span class="token variable">$</span><span class="token punctuation">(</span>CUR_OBJS<span class="token punctuation">)</span>
<span class="token symbol"><span class="token variable">$</span>(SUBDIRS)</span><span class="token punctuation">:</span>ECHO
    make -C <span class="token variable">$@</span>
<span class="token symbol"><span class="token variable">$</span>(CUR_OBJS)</span><span class="token punctuation">:</span>%.o<span class="token punctuation">:</span>%.c
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -c <span class="token variable">$^</span> -o <span class="token variable">$</span><span class="token punctuation">(</span>ROOT_DIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>OBJS_DIR<span class="token punctuation">)</span>/<span class="token variable">$@</span>
<span class="token symbol">ECHO</span><span class="token punctuation">:</span>
    <span class="token operator">@</span>echo <span class="token variable">$</span><span class="token punctuation">(</span>SUBDIRS<span class="token punctuation">)</span>
</code></pre></div><p>生成的目标文件和可执行文件目录<code>debug</code>下 makefile</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code>OBJS<span class="token operator">=</span>*.o
ODIR<span class="token operator">=</span>obj
<span class="token symbol"><span class="token variable">$</span>(ROOT_DIR)/<span class="token variable">$</span>(BIN_DIR)/<span class="token variable">$</span>(BIN)</span><span class="token punctuation">:</span><span class="token variable">$</span><span class="token punctuation">(</span>ODIR<span class="token punctuation">)</span>/<span class="token variable">$</span><span class="token punctuation">(</span>OBJS<span class="token punctuation">)</span>
    <span class="token variable">$</span><span class="token punctuation">(</span>CC<span class="token punctuation">)</span> -o <span class="token variable">$@</span> <span class="token variable">$^</span>
</code></pre></div><h2 id="编译时添加宏定义"><a href="#编译时添加宏定义" class="header-anchor">#</a> 编译时添加宏定义</h2> <p>假设代码如下，检查是否存在</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token comment">// test.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span>  </span>
  
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
<span class="token punctuation">{</span>  
      
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">A_MACRO</span></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>
</code></pre></div><p>命令行直接使用 gcc 编译时，可以传递 <code>-D</code> 参数来定义</p> <div class="language-bash extra-class"><pre class="language-bash"><code>gcc test.c -D A_MACRO
</code></pre></div><p>在 Makefile 中，当然可以在 gcc 后面写 -D，也可以直接加在 <code>CFLAGS</code> 中，同时也可以用下面的方式给 make 传递参数决定是否定义该宏</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code>MACROS<span class="token operator">=</span>
CFLAGS<span class="token operator">=</span>-g <span class="token variable">$</span><span class="token punctuation">(</span>MACROS<span class="token punctuation">)</span>
<span class="token symbol">all</span><span class="token punctuation">:</span>a.out
g++ CFLAGS -o a.out
</code></pre></div><p>使用 make 时，便可以这样写</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">make</span> <span class="token assign-left variable">DEBUG</span><span class="token operator">=</span><span class="token string">'-D A_MACRO'</span>
</code></pre></div><h2 id="杂项"><a href="#杂项" class="header-anchor">#</a> 杂项</h2> <ul><li><p>当没有指明目标时，make 默认执行 Makefile 中定义的第一个目标，也称为默认目标</p></li> <li><p>在 Makefile 中，使用 <code>@echo</code> 可以执行 <code>echo</code> 命令</p></li> <li><p>在 Makefile 中，目标后可以添加其他目标，表示依赖关系，即当前目标需要这些目标作为支持，会先构建依赖着的其他目标，再执行剩下的命令，即基本语法是</p> <div class="language-makefile extra-class"><pre class="language-makefile"><code><span class="token symbol">target</span><span class="token punctuation">:</span> prerequisites
	command
</code></pre></div></li> <li><p>直接使用 <code>=</code> 就可以在 Makefile 中定义变量如 <code>CC = gcc</code>，使用 <code>$(CC)</code> 可以读取它</p></li></ul> <h1 id="cmake-笔记"><a href="#cmake-笔记" class="header-anchor">#</a> cmake 笔记</h1> <p>使用 cmake 读取 CMakeList.txt 可以自动生成需要的 Makefile。CMakeList 的语法：</p> <h2 id="指定安装目录"><a href="#指定安装目录" class="header-anchor">#</a> 指定安装目录</h2> <p>通过定义 <code>CMAKE_INSTALL_PREFIX:PATH</code> 更改安装路径，在无法获取 sudo 权限时候可以使用这种方式安到当前用户目录下？</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">mkdir</span> build
<span class="token builtin class-name">cd</span> build
cmake -DCMAKE_INSTALL_PREFIX:<span class="token environment constant">PATH</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>realpath <span class="token punctuation">..</span>/install<span class="token variable">)</span></span> <span class="token punctuation">..</span>
<span class="token function">make</span> -j N <span class="token function">install</span>
</code></pre></div><p>例如这个例子中，通过 <code>realpath</code> 获取相对路径的绝对路径名，从而安装在上级的 install 目录下</p> <h2 id="多级目录、多个链接库"><a href="#多级目录、多个链接库" class="header-anchor">#</a> 多级目录、多个链接库</h2> <p>例如这里我有一个</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">.</span>
├── main.c
├── first.c
├── first.h
└── second
</code></pre></div><p>这样的文件目录，怎么在根目录下构建 <code>main.c</code> 呢？同时依赖于 <code>first.c</code> 文件和 <code>second</code> 目录下的两个库（均为 C 实现），同时 <code>first.c</code> 又依赖于 <code>second</code>目录下的库。</p> <p>在根目录下，编写</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">cmake_minimum_required</span> <span class="token punctuation">(</span><span class="token property">VERSION</span> <span class="token number">3.10.2</span><span class="token punctuation">)</span>
<span class="token keyword">project</span> <span class="token punctuation">(</span>laser<span class="token punctuation">)</span>

<span class="token keyword">set</span><span class="token punctuation">(</span><span class="token variable">CMAKE_C_FLAGS</span> <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">CMAKE_C_FLAGS</span><span class="token punctuation">}</span></span> -Wall&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">add_definitions</span><span class="token punctuation">(</span>-DENABLE_DBG<span class="token punctuation">)</span>

<span class="token comment"># second lib</span>
<span class="token keyword">add_subdirectory</span><span class="token punctuation">(</span>second<span class="token punctuation">)</span> <span class="token comment"># add this directory to project, traverse it, and apply the `CMakeLists.txt` inside it</span>
<span class="token keyword">list</span><span class="token punctuation">(</span>APPEND EXTRA_INCLUDES <span class="token string">&quot;<span class="token interpolation"><span class="token punctuation">${</span><span class="token variable">PROJECT_SOURCE_DIR</span><span class="token punctuation">}</span></span>/second&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">set_target_properties</span><span class="token punctuation">(</span>second <span class="token namespace">PROPERTIES</span> <span class="token property">LINKER_LANGUAGE</span> C<span class="token punctuation">)</span>

<span class="token comment"># lib for first main logic</span>
<span class="token keyword">add_library</span><span class="token punctuation">(</span>first first.c<span class="token punctuation">)</span>
<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>first second<span class="token punctuation">)</span> <span class="token comment"># built target for `first` lib would be dependent on on second lib</span>
<span class="token keyword">target_include_directories</span><span class="token punctuation">(</span>first <span class="token namespace">PUBLIC</span>
  <span class="token punctuation">${</span><span class="token variable">PROJECT_BINARY_DIR</span><span class="token punctuation">}</span>
  <span class="token punctuation">${</span>EXTRA_INCLUDES<span class="token punctuation">}</span>
  <span class="token punctuation">)</span> <span class="token comment"># the headers in the second lib would be added to include path, so that we do not need to configure relative paths when include them in codes</span>

<span class="token comment"># main executable file</span>
<span class="token keyword">set</span><span class="token punctuation">(</span>SRC_LIST main.c<span class="token punctuation">)</span>
<span class="token keyword">add_executable</span><span class="token punctuation">(</span>laser <span class="token punctuation">${</span>SRC_LIST<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">target_link_libraries</span><span class="token punctuation">(</span>laser first<span class="token punctuation">)</span>
<span class="token comment"># or target_link_libraries(laser first second), up to your requirements on second lib</span>
</code></pre></div><p>对 first 和 second 两个库和 main.c 对应的代码都构建编译 target，通过 <code>target_link_libraries</code> 去声明依赖关系，这样会自动先编译 second 库，再编译 first 库，把 second 库链接给它，再链接 first 库编译 main.c 对应的可执行文件。使用 cmake 就是一个声明依赖关系的过程，而且很多步骤 cmake 都会自动帮忙干。</p> <p>那么在 second 目录下，还需要加一个，定义一个名为 second 的库，并用 <code>file()</code> 函数方便地选取目录下所有文件</p> <div class="language-cmake extra-class"><pre class="language-cmake"><code><span class="token keyword">file</span><span class="token punctuation">(</span>GLOB <span class="token property">SOURCES</span> *.c<span class="token punctuation">)</span>
<span class="token keyword">file</span><span class="token punctuation">(</span>GLOB HEADERS *.h<span class="token punctuation">)</span>

<span class="token keyword">add_library</span><span class="token punctuation">(</span>second <span class="token punctuation">${</span><span class="token property">SOURCES</span><span class="token punctuation">}</span> <span class="token punctuation">${</span>HEADERS<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h1 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h1> <p><a href="http://www.gnu.org/software/make/" target="_blank" rel="noopener noreferrer">Make - GNU Project - Free Software Foundation<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://github.com/seisman/how-to-write-makefile" target="_blank" rel="noopener noreferrer">seisman/how-to-write-makefile: 跟我一起写Makefile重制版 (github.com)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://blog.csdn.net/u014470361/article/details/103447678" target="_blank" rel="noopener noreferrer">gcc编译选项-fprofile-arcs -ftest-coverage之代码覆盖率_夜风的博客-CSDN博客<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://www.cnblogs.com/Shirlies/p/4282182.html" target="_blank" rel="noopener noreferrer">多文件目录下makefile文件递归执行编译所有c文件 - Shirlies - 博客园 (cnblogs.com)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/2/15 下午12:23:37</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.64e41af0.js" defer></script><script src="/assets/js/1.b822baa6.js" defer></script><script src="/assets/js/63.d8ac060f.js" defer></script><script src="/assets/js/12.331c1b95.js" defer></script>
  </body>
</html>
