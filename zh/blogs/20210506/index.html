<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SJTU HPC 使用笔记 | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.83acc708.css" as="style"><link rel="preload" href="/assets/js/app.e20ee45c.js" as="script"><link rel="preload" href="/assets/js/1.489a6dc0.js" as="script"><link rel="preload" href="/assets/js/64.a2e5a572.js" as="script"><link rel="preload" href="/assets/js/13.1be78326.js" as="script"><link rel="prefetch" href="/assets/js/10.cad57680.js"><link rel="prefetch" href="/assets/js/11.30d692aa.js"><link rel="prefetch" href="/assets/js/12.13c4f3e7.js"><link rel="prefetch" href="/assets/js/14.dad01fde.js"><link rel="prefetch" href="/assets/js/15.dab14606.js"><link rel="prefetch" href="/assets/js/16.81b53128.js"><link rel="prefetch" href="/assets/js/17.4e546b34.js"><link rel="prefetch" href="/assets/js/18.ee20e865.js"><link rel="prefetch" href="/assets/js/19.413a43b3.js"><link rel="prefetch" href="/assets/js/20.d0743f7f.js"><link rel="prefetch" href="/assets/js/21.6fb5574c.js"><link rel="prefetch" href="/assets/js/22.da977171.js"><link rel="prefetch" href="/assets/js/23.45381ef0.js"><link rel="prefetch" href="/assets/js/24.38d9dd4c.js"><link rel="prefetch" href="/assets/js/25.5db9e4c1.js"><link rel="prefetch" href="/assets/js/26.80db83e6.js"><link rel="prefetch" href="/assets/js/27.a83b4387.js"><link rel="prefetch" href="/assets/js/28.06b9589c.js"><link rel="prefetch" href="/assets/js/29.73cd5ef9.js"><link rel="prefetch" href="/assets/js/3.f34d884e.js"><link rel="prefetch" href="/assets/js/30.e1abbf1f.js"><link rel="prefetch" href="/assets/js/31.a626951c.js"><link rel="prefetch" href="/assets/js/32.94966377.js"><link rel="prefetch" href="/assets/js/33.d2c521bc.js"><link rel="prefetch" href="/assets/js/34.34f7d3af.js"><link rel="prefetch" href="/assets/js/35.d85216a3.js"><link rel="prefetch" href="/assets/js/36.ca54e505.js"><link rel="prefetch" href="/assets/js/37.d5208cb4.js"><link rel="prefetch" href="/assets/js/38.4b405137.js"><link rel="prefetch" href="/assets/js/39.7e030510.js"><link rel="prefetch" href="/assets/js/4.76f729c6.js"><link rel="prefetch" href="/assets/js/40.34d04083.js"><link rel="prefetch" href="/assets/js/41.f3512b86.js"><link rel="prefetch" href="/assets/js/42.335cb33e.js"><link rel="prefetch" href="/assets/js/43.5b6fd6c5.js"><link rel="prefetch" href="/assets/js/44.c55d0f35.js"><link rel="prefetch" href="/assets/js/45.f07d95ce.js"><link rel="prefetch" href="/assets/js/46.a3a65fea.js"><link rel="prefetch" href="/assets/js/47.9b0ada11.js"><link rel="prefetch" href="/assets/js/48.9eaab22b.js"><link rel="prefetch" href="/assets/js/49.727f6647.js"><link rel="prefetch" href="/assets/js/5.b4527e5b.js"><link rel="prefetch" href="/assets/js/50.ef2b4cd0.js"><link rel="prefetch" href="/assets/js/51.de50578a.js"><link rel="prefetch" href="/assets/js/52.3de8cb04.js"><link rel="prefetch" href="/assets/js/53.0fc39334.js"><link rel="prefetch" href="/assets/js/54.d2fc8318.js"><link rel="prefetch" href="/assets/js/55.26c3bd92.js"><link rel="prefetch" href="/assets/js/56.d73d8ed7.js"><link rel="prefetch" href="/assets/js/57.b83c8a85.js"><link rel="prefetch" href="/assets/js/58.21b3c441.js"><link rel="prefetch" href="/assets/js/59.7ea75a77.js"><link rel="prefetch" href="/assets/js/6.1632bb8f.js"><link rel="prefetch" href="/assets/js/60.8bb3f815.js"><link rel="prefetch" href="/assets/js/61.c3ce4537.js"><link rel="prefetch" href="/assets/js/62.f9a8f980.js"><link rel="prefetch" href="/assets/js/63.f4f21d25.js"><link rel="prefetch" href="/assets/js/65.fcadeb7e.js"><link rel="prefetch" href="/assets/js/66.64e2bfe0.js"><link rel="prefetch" href="/assets/js/67.43d60bda.js"><link rel="prefetch" href="/assets/js/68.584a1d82.js"><link rel="prefetch" href="/assets/js/69.134eaf20.js"><link rel="prefetch" href="/assets/js/7.2bde248f.js"><link rel="prefetch" href="/assets/js/70.289946fe.js"><link rel="prefetch" href="/assets/js/71.e5d6db5e.js"><link rel="prefetch" href="/assets/js/72.568228d9.js"><link rel="prefetch" href="/assets/js/73.3f4f5d3a.js"><link rel="prefetch" href="/assets/js/74.a4d77c9e.js"><link rel="prefetch" href="/assets/js/75.c9d6eda1.js"><link rel="prefetch" href="/assets/js/8.37029413.js"><link rel="prefetch" href="/assets/js/9.963a8ee4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.83acc708.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210506/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210506/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#使用方法">使用方法</a></li><li><a href="#邮件提醒">邮件提醒</a></li><li><a href="#pytorch-使用示例">Pytorch 使用示例</a></li><li><a href="#关于计费">关于计费</a></li><li><a href="#tmux">Tmux</a></li><li><a href="#常用命令">常用命令</a></li></ul></div><p></p> <h1 id="sjtu-hpc-使用笔记"><a href="#sjtu-hpc-使用笔记" class="header-anchor">#</a> SJTU HPC 使用笔记</h1> <p><a href="https://docs.hpc.sjtu.edu.cn/" target="_blank" rel="noopener noreferrer">上海交大超算平台用户手册 文档 (sjtu.edu.cn)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>登录节点 <code>ssh user@login.hpc.sjtu.edu.cn</code></p> <p>可视化平台 https://studio.hpc.sjtu.edu.cn/</p> <p>安装包、编译最好提前申请计算资源，在登陆节点运行计算密集的作业，将会被程序自动查杀，您的账号会被加入到黑名单，并在30-120 分钟内无法登陆，申请节点方法如下</p> <div class="language-bash extra-class"><pre class="language-bash"><code>srun -p small -n <span class="token number">1</span> --pty /bin/bash
</code></pre></div><p>数据传输用 scp 传给 data 节点：<strong>data.hpc.sjtu.edu.cn</strong></p> <p>远程桌面会计费</p> <p>默认单作业最长运行 7 天</p> <p>不提供商业软件，开源软件需要查看列表，没有的写邮件申请</p> <p>moudle av 查看有啥能加载的模块， moudle list 查看加载了什么模块</p> <p>交互命令行下，记得设置发送心跳包，XShell 是在会话属性—连接——保持活动状态中</p> <p>没法用任何涉及 sudo 的命令，但是好像是不让自己安装软件的（把软件安装到用户空间……逃</p> <p>vscode 的 remote explorer 里创建 ssh target 连过去还是很爽的</p> <p>HPC 提供的是 32 GB 的 V100，既然是按时计费没用满血亏</p> <h2 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> 使用方法</h2> <p>使用前请阅读文档！不要在登录节点进行大型任务以防影像别人的正常登录。有两种提交任务的方法：</p> <ol><li><p>使用hpc教程中推荐的任务脚本提交方式。好处是可以在hpc占用高时，由系统调度任务，不必等待分配，坏处是在不确定程序正确性时可能空跑很久浪费资金，且查看实验输出时不方便</p></li> <li><p>请求节点开启bash进行交互，例如，可以使用以下命令申请一个带单个GPU，六个CPU的节点：
srun -n 1 -p dgx2 --gres=gpu:1 --cpus-per-task=6 --pty /bin/bash
等待分配好节点，配合 tmux/screen 使用</p></li></ol> <h2 id="邮件提醒"><a href="#邮件提醒" class="header-anchor">#</a> 邮件提醒</h2> <p>邮件提醒的 slurm 示例脚本，提醒事件的可选项有 ALL, BEGIN, END, FAIL</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment">#SBATCH --job-name=test</span>
<span class="token comment">#SBATCH --partition=small</span>
<span class="token comment">#SBATCH -n 20</span>
<span class="token comment">#SBATCH --ntasks-per-node=20</span>
<span class="token comment">#SBATCH --output=%j.out</span>
<span class="token comment">#SBATCH --error=%j.err</span>
<span class="token comment">#SBATCH --mail-type=end           # 作业结束时，邮件提醒</span>
<span class="token comment">#SBATCH --mail-user=XX@sjtu.edu.cn</span>
</code></pre></div><h2 id="pytorch-使用示例"><a href="#pytorch-使用示例" class="header-anchor">#</a> Pytorch 使用示例</h2> <p><code>module load miniconda3</code> 加载 miniconda3 模块</p> <p>在 DGX-2 上使用 pytorch。作业使用单节点，分配 2 块 GPU，GPU:CPU 配比 1:6。脚本名称可设为 slurm.test</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#SBATCH -J test</span>
<span class="token comment">#SBATCH -p dgx2</span>
<span class="token comment">#SBATCH -o %j.out</span>
<span class="token comment">#SBATCH -e %j.err</span>
<span class="token comment">#SBATCH -N 1</span>
<span class="token comment">#SBATCH --ntasks-per-node=1</span>
<span class="token comment">#SBATCH --cpus-per-task=12</span>
<span class="token comment">#SBATCH --gres=gpu:2</span>

<span class="token comment"># module load cuda # 在其他 partition 上不主动加载不行，可能 DGX-2 上默认加载了，不过可能其他分区也不应该使用显卡资源</span>
<span class="token comment"># 因为在装包的时候想看一下 cuda 版本，交互是用的 small 分区，不加载 cuda module 找不到 nvcc 应用</span>
module load miniconda3
<span class="token builtin class-name">source</span> activate pytorch-env

python -c <span class="token string">'import torch; print(torch.__version__); print(torch.zeros(10,10).cuda().shape)'</span>
</code></pre></div><p>其实就是把想要执行的任务写到脚本里，不想用脚本的话，看下面的笔记，tmux维持着交互式的窗口就行了</p> <p>conda init 过以后，<strong>切环境记得先 deactivate，再 activate 目标环境……（为什么不自动 deactivate 掉前一个环境呢？？？</strong></p> <p>使用以下指令提交作业</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ sbatch slurm.test
</code></pre></div><h2 id="关于计费"><a href="#关于计费" class="header-anchor">#</a> 关于计费</h2> <p><a href="https://studio.hpc.sjtu.edu.cn/pun/sys/activejobs" target="_blank" rel="noopener noreferrer">Active Jobs - HPC Studio (sjtu.edu.cn)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://account.hpc.sjtu.edu.cn/#/login" target="_blank" rel="noopener noreferrer">HPC与AI平台 (sjtu.edu.cn)<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>在 Active jobs 里可以看到自己的使用的计算资源，登录节点和数据节点是不计费的</p> <p>关闭 ssh 窗口后会话终止，会自动停止掉计费，使用类似 screen、tmux 的工具的话自然会接着计费</p> <h2 id="tmux"><a href="#tmux" class="header-anchor">#</a> Tmux</h2> <p>服务器装的是 tmux，和之前用过的 screen 类似，可以在 ssh 会话结束后保持会话期间的命令正常运行</p> <p>tmux 按 <code>ctrl+b</code> 后可以输入命令选项（类似 vim 的命令模式），比如<code>%</code>是左右分屏，<code>&quot;</code>是上下分屏，<code>d</code> 是退出当前 session，<code>x</code>  是关掉当前session</p> <p><strong>注意</strong>：在 login 节点创建的 tmux session 在退出后才会继续运行，如果是用计算节点创建的 tmux session，关掉本地命令行，远端计算资源和所有 session 也会随之释放。所以正确的使用姿势（不想用 slurm 脚本的话）是登录到 login 节点，创建 tmux session，进session 后再申请计算资源。但是此时如果用 tmux 分屏，默认还是 login 节点，所以想分屏后命令行仍然是计算节点的话，需要在计算节点的 session 下再次创建 session，但是 tmux 不推荐这么搞，会提示使用特殊的方式启动……</p> <p>如果用域名登陆服务器，每次登陆可能会给解析到不同节点，用ip登吧</p> <h2 id="常用命令"><a href="#常用命令" class="header-anchor">#</a> 常用命令</h2> <p>资源监视：<code>nvidia-smi</code> 查看显卡相关信息，<code>top</code> 查看 cpu、内存等资源，<code>df</code> 查看磁盘容量；可以配合 <code>watch</code> 命令使用，比如每十秒打印一次显卡情况 <code>watch -n 10 nvidia-smi</code></p> <p>有标准输出的程序，想在它执行中间干点别的事情。可以这样：或者直接把输出流重定向到文件里并且让它默认到后台去执行，比如<code>python main.py &gt; log.txt &amp;</code>。或者用<code>ctrl+z</code> 先把任务切到后台，然后再开别的任务，最后再用 <code>jobs</code> 配合 <code>fg</code> 命令切回来，比如 <code>jobs</code> 下看到它是 1 号，那<code>fg 1</code> 就又回来接着执行它了</p> <p>永远记住<code>man</code> 命令，想不起来 <code>man</code> 一下</p> <p>vi 和 vim 的一些区别，比如 vi 不允许在编辑模式下（按下 i 时）用方向键移动光标</p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/6/13 上午8:47:05</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e20ee45c.js" defer></script><script src="/assets/js/1.489a6dc0.js" defer></script><script src="/assets/js/64.a2e5a572.js" defer></script><script src="/assets/js/13.1be78326.js" defer></script>
  </body>
</html>
