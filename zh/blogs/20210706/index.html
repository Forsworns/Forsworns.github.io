<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BPF Type Format (BTF) | Sharlayan</title>
    <meta name="description" content="BPF Type Format (BTF) æ–‡ç« ç¿»è¯‘ç¬”è®°">
    <link rel="preload stylesheet" href="/assets/style.3ef9b918.css" as="style">
    <link rel="modulepreload" href="/assets/chunks/VPAlgoliaSearchBox.960fd572.js">
    <link rel="modulepreload" href="/assets/app.73f81c81.js">
    <link rel="modulepreload" href="/assets/zh_blogs_20210706_index.md.3a568024.lean.js">
    
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
  <link rel="icon" type="image/png" href="/logo.png">
  <meta name="author" content="Peihao Yang">
  <meta property="og:title" content="Home">
  <meta property="og:description" content="Home of Peihao Yang">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><!--[--><div class="Layout" data-v-b617430f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-d4120332></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-d4120332> Skip to content </a><!--]--><!----><header class="VPNav no-sidebar" data-v-b617430f data-v-aa1cde23><div class="VPNavBar" data-v-aa1cde23 data-v-cbdd8588><div class="container" data-v-cbdd8588><div class="title" data-v-cbdd8588><div class="VPNavBarTitle" data-v-cbdd8588 data-v-730d6dd1><a class="title" href="/zh/" data-v-730d6dd1><!--[--><!--]--><!--[--><img class="VPImage logo" src="/assets/logo.png" alt data-v-0f13a436><!--]--><!----><!--[--><!--]--></a></div></div><div class="content" data-v-cbdd8588><div class="curtain" data-v-cbdd8588></div><!--[--><!--]--><div class="VPNavBarSearch search" data-v-cbdd8588 style="--699c4559:&#39;Meta&#39;;"><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-cbdd8588 data-v-2d3a777e><span id="main-nav-aria-label" class="visually-hidden" data-v-2d3a777e>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/zh/" data-v-2d3a777e data-v-f559a019 data-v-1a0f9836><!--[-->ğŸ¡ä¸»é¡µ<!--]--><!----></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/zh/about-me/" data-v-2d3a777e data-v-f559a019 data-v-1a0f9836><!--[-->ğŸ¦¹â€â™‚ï¸å…³äºæˆ‘<!--]--><!----></a><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-2d3a777e data-v-fc33d832><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-fc33d832><span class="text" data-v-fc33d832><!----> ğŸ““åšå®¢ <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-fc33d832><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-fc33d832><div class="VPMenu" data-v-fc33d832 data-v-ecf4e7d9><div class="items" data-v-ecf4e7d9><!--[--><!--[--><div class="VPMenuLink" data-v-ecf4e7d9 data-v-c7da634f><a class="VPLink link" href="/zh/blogs/" data-v-c7da634f data-v-1a0f9836><!--[-->ğŸ“ƒæ‰€æœ‰åšå®¢<!--]--><!----></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-ecf4e7d9 data-v-c7da634f><a class="VPLink link" href="/zh/blogs/tags/" data-v-c7da634f data-v-1a0f9836><!--[-->ğŸ”–æ ‡ç­¾åˆ†ç±»<!--]--><!----></a></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="https://forsworns.github.io/feed.xml" target="_blank" rel="noreferrer" data-v-2d3a777e data-v-f559a019 data-v-1a0f9836><!--[-->ğŸ”¥RSS<!--]--><!----></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-cbdd8588 data-v-7cdc304e data-v-fc33d832><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-fc33d832><span class="text" data-v-fc33d832><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-fc33d832><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg>  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-fc33d832><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-fc33d832><div class="VPMenu" data-v-fc33d832 data-v-ecf4e7d9><!----><!--[--><!--[--><div class="items" data-v-7cdc304e><p class="title" data-v-7cdc304e>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-7cdc304e data-v-c7da634f><a class="VPLink link" href="/" data-v-c7da634f data-v-1a0f9836><!--[-->English<!--]--><!----></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-cbdd8588 data-v-7f24c201><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-7f24c201 data-v-2b897f09 data-v-ab7cdc04><span class="check" data-v-ab7cdc04><span class="icon" data-v-ab7cdc04><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-2b897f09><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-2b897f09><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-cbdd8588 data-v-a5afa74d data-v-80c99471><!--[--><a class="VPSocialLink" href="https://github.com/forsworns/blog-vitepress" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="mailto:peihao.young@gmail.com" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="20">
            <path d="M874.666667 375.189333V746.666667a64 64 0 0 1-64 64H213.333333a64 64 0 0 1-64-64V375.189333l266.090667 225.6a149.333333 149.333333 0 0 0 193.152 0L874.666667 375.189333zM810.666667 213.333333a64.789333 64.789333 0 0 1 22.826666 4.181334 63.616 63.616 0 0 1 26.794667 19.413333 64.32 64.32 0 0 1 9.344 15.466667c2.773333 6.570667 4.48 13.696 4.906667 21.184L874.666667 277.333333v21.333334L553.536 572.586667a64 64 0 0 1-79.893333 2.538666l-3.178667-2.56L149.333333 298.666667v-21.333334a63.786667 63.786667 0 0 1 35.136-57.130666A63.872 63.872 0 0 1 213.333333 213.333333h597.333334z" ></path>
            </svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-cbdd8588 data-v-e459e5dc data-v-fc33d832><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-fc33d832><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-fc33d832><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-fc33d832><div class="VPMenu" data-v-fc33d832 data-v-ecf4e7d9><!----><!--[--><!--[--><div class="group" data-v-e459e5dc><p class="trans-title" data-v-e459e5dc>ä¸­æ–‡</p><!--[--><div class="VPMenuLink" data-v-e459e5dc data-v-c7da634f><a class="VPLink link" href="/" data-v-c7da634f data-v-1a0f9836><!--[-->English<!--]--><!----></a></div><!--]--></div><div class="group" data-v-e459e5dc><div class="item appearance" data-v-e459e5dc><p class="label" data-v-e459e5dc>Appearance</p><div class="appearance-action" data-v-e459e5dc><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" aria-label="toggle dark mode" aria-checked="false" data-v-e459e5dc data-v-2b897f09 data-v-ab7cdc04><span class="check" data-v-ab7cdc04><span class="icon" data-v-ab7cdc04><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-2b897f09><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-2b897f09><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-e459e5dc><div class="item social-links" data-v-e459e5dc><div class="VPSocialLinks social-links-list" data-v-e459e5dc data-v-80c99471><!--[--><a class="VPSocialLink" href="https://github.com/forsworns/blog-vitepress" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="VPSocialLink" href="mailto:peihao.young@gmail.com" target="_blank" rel="noopener" data-v-80c99471 data-v-51b6609b><svg role="img" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="20">
            <path d="M874.666667 375.189333V746.666667a64 64 0 0 1-64 64H213.333333a64 64 0 0 1-64-64V375.189333l266.090667 225.6a149.333333 149.333333 0 0 0 193.152 0L874.666667 375.189333zM810.666667 213.333333a64.789333 64.789333 0 0 1 22.826666 4.181334 63.616 63.616 0 0 1 26.794667 19.413333 64.32 64.32 0 0 1 9.344 15.466667c2.773333 6.570667 4.48 13.696 4.906667 21.184L874.666667 277.333333v21.333334L553.536 572.586667a64 64 0 0 1-79.893333 2.538666l-3.178667-2.56L149.333333 298.666667v-21.333334a63.786667 63.786667 0 0 1 35.136-57.130666A63.872 63.872 0 0 1 213.333333 213.333333h597.333334z" ></path>
            </svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-cbdd8588 data-v-d6834c14><span class="container" data-v-d6834c14><span class="top" data-v-d6834c14></span><span class="middle" data-v-d6834c14></span><span class="bottom" data-v-d6834c14></span></span></button></div></div></div><!----></header><!----><!----><div class="VPContent" id="VPContent" data-v-b617430f data-v-f32377af><div class="VPDoc has-aside" data-v-f32377af data-v-1e970af1><div class="container" data-v-1e970af1><div class="aside" data-v-1e970af1><div class="aside-curtain" data-v-1e970af1></div><div class="aside-container" data-v-1e970af1><div class="aside-content" data-v-1e970af1><div class="VPDocAside" data-v-1e970af1 data-v-b1723386><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-b1723386 data-v-0980ba1d><div class="content" data-v-0980ba1d><div class="outline-marker" data-v-0980ba1d></div><div class="outline-title" data-v-0980ba1d>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-0980ba1d><span class="visually-hidden" id="doc-outline-aria-label" data-v-0980ba1d> Table of Contents for current page </span><ul class="root" data-v-0980ba1d data-v-6f4caaf4><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-b1723386></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-1e970af1><div class="content-container" data-v-1e970af1><!--[--><!--]--><main class="main" data-v-1e970af1><div style="position:relative;" class="vp-doc _zh_blogs_20210706_index" data-v-1e970af1><div><h1 id="bpf-type-format-btf" tabindex="-1">BPF Type Format (BTF) <a class="header-anchor" href="#bpf-type-format-btf" aria-hidden="true">#</a></h1><p>ç¿»è¯‘è‡ªï¼š<a href="https://www.kernel.org/doc/html/latest/bpf/btf.html" target="_blank" rel="noreferrer">Linux Kernel Doc</a></p><h2 id="_1-introduction" tabindex="-1">1. Introduction <a class="header-anchor" href="#_1-introduction" aria-hidden="true">#</a></h2><p>BTF (BPF Type Format) æ˜¯ç¼–ç  BPF ç¨‹åºã€æ˜ å°„ç›¸å…³çš„ debug ä¿¡æ¯çš„å…ƒæ•°æ®æ ¼å¼ã€‚åç§° BTF æœ€å¼€å§‹æ˜¯ç”¨æ¥æè¿°æ•°æ®ç±»å‹çš„ï¼Œä¹‹åè¢«æ‰©å±•ï¼ŒåŒ…å«äº†é¢„å®šä¹‰çš„å­ä¾‹ç¨‹çš„å‡½æ•°ä¿¡æ¯ä»¥åŠæºç ä¸­çš„ line infoã€‚</p><p>debug ä¿¡æ¯è¢«ç”¨æ¥æ ¼å¼åŒ–æ‰“å°å’Œæä¾›å‡½æ•°ç­¾åç­‰ä¿¡æ¯ã€‚å‡½æ•°ç­¾åä¼˜åŒ–äº† bpf ç¨‹åº/å‡½æ•°çš„å†…æ ¸ç¬¦å·ã€‚line info åˆ™å¯ä»¥ç”Ÿæˆç»è¿‡æ ‡æ³¨çš„å­—èŠ‚ç ï¼Œjited ä»£ç å’ŒéªŒè¯å™¨è®°å½•ã€‚</p><p>BTF åŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p><ul><li>BTF kernel API</li><li>BTF ELF file format</li></ul><p>å†…æ ¸ API æ˜¯ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ä¹‹é—´æ²Ÿé€šçš„æ¡¥æ¢ã€‚å†…æ ¸åœ¨ä½¿ç”¨ BTF ä¿¡æ¯ä¹‹å‰éªŒè¯äº†å®ƒã€‚ELF æ–‡ä»¶æ ¼å¼åˆ™æ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´çš„ ELF æ–‡ä»¶å’Œ libbpf loader ä¹‹é—´çš„åè®®ã€‚</p><p>ç±»å‹å’Œå­—ç¬¦ä¸²æ®µæ˜¯ BTF å†…æ ¸ API çš„ä¸€éƒ¨åˆ†ï¼Œæè¿°äº† bpf ç¨‹åºå¼•ç”¨åˆ°çš„ï¼ˆå‡ ä¹æ˜¯ç±»å‹ç›¸å…³çš„ï¼‰debug ä¿¡æ¯ã€‚</p><h2 id="_2-btf-type-and-string-encoding" tabindex="-1">2. BTF Type and String Encoding <a class="header-anchor" href="#_2-btf-type-and-string-encoding" aria-hidden="true">#</a></h2><p>å¤´æ–‡ä»¶ <code>include/uapi/linux/btf.h</code> ä¸­æä¾›äº†ç±»å‹å’Œå­—ç¬¦ä¸²æ˜¯å¦‚ä½•ç¼–ç çš„é«˜é˜¶å®šä¹‰ã€‚</p><p>data blob çš„å¼€å¤´å¿…é¡»æ˜¯ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> btf_header </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    __u16   magic</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u8    version</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u8    flags</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u32   hdr_len</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /* All offsets are in bytes relative to the end of this header */</span></span>
<span class="line"><span style="color:#F07178;">    __u32   type_off</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">       /* offset of type section       */</span></span>
<span class="line"><span style="color:#F07178;">    __u32   type_len</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">       /* length of type section       */</span></span>
<span class="line"><span style="color:#F07178;">    __u32   str_off</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">        /* offset of string section     */</span></span>
<span class="line"><span style="color:#F07178;">    __u32   str_len</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;">        /* length of string section     */</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>é­”æ•° <code>magic</code> æ˜¯ <code>0xeB9F</code>ï¼Œå®ƒåœ¨å¤§ç«¯å’Œå°ç«¯ç³»ç»Ÿä¸­ç¼–ç é¡ºåºä¸åŒï¼Œå› æ­¤å¯ä»¥ç”¨æ¥æ£€éªŒ BTF æ˜¯ç”±å¤§ç«¯è¿˜æ˜¯å°ç«¯ç›®æ ‡æœºå™¨ç”Ÿæˆçš„ã€‚<code>btf_header</code> è¢«è®¾è®¡æˆäº†å¯æ‹“å±•çš„ï¼Œå½“ data blob ç”Ÿæˆæ—¶ï¼Œå®ƒçš„<code>hdr_len</code> ç­‰äº<code>sizeof(struct btf_header)</code>ã€‚</p><h3 id="_2-1-string-encoding" tabindex="-1">2.1 String Encoding <a class="header-anchor" href="#_2-1-string-encoding" aria-hidden="true">#</a></h3><p>åœ¨ä¸Šé¢çš„ç»“æ„ä½“ä¸­ï¼Œå­—ç¬¦ä¸²æ®µç¬¬ä¸€ä¸ªå­—ç¬¦ä¸²ä¸€å®šæ˜¯ä¸€ä¸ªç©ºå­—ç¬¦ä¸²ã€‚å­—ç¬¦ä¸²è¡¨å‰©ä¸‹çš„éƒ¨åˆ†æ˜¯å…¶ä»–ä»¥ç©ºå­—ç¬¦ä¸ºç»“å°¾çš„å­—ç¬¦ä¸²çš„æ‹¼æ¥ã€‚</p><h3 id="_2-2-type-encoding" tabindex="-1">2.2 Type Encoding <a class="header-anchor" href="#_2-2-type-encoding" aria-hidden="true">#</a></h3><p>ç±»å‹ ID <code>0</code> é¢„ç•™ç»™äº† <code>void</code> ç±»å‹ã€‚ç±»å‹éƒ¨åˆ†æ˜¯é¡ºåºè§£æçš„ï¼Œå¹¶ä¸”åˆ†é…äº†ç±»å‹ ID ç»™å¯ä»¥è§£æçš„ç±»å‹ï¼Œæ˜¯ä» <code>1</code> å¼€å§‹çš„ã€‚ç›®å‰æ”¯æŒä¸‹é¢è¿™äº›ç±»å‹ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_INT</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">1</span><span style="color:#676E95;font-style:italic;">       /* Integer      */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_PTR</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">2</span><span style="color:#676E95;font-style:italic;">       /* Pointer      */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_ARRAY</span><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">3</span><span style="color:#676E95;font-style:italic;">       /* Array        */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_STRUCT</span><span style="color:#A6ACCD;">         </span><span style="color:#F78C6C;">4</span><span style="color:#676E95;font-style:italic;">       /* Struct       */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_UNION</span><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">5</span><span style="color:#676E95;font-style:italic;">       /* Union        */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_ENUM</span><span style="color:#A6ACCD;">           </span><span style="color:#F78C6C;">6</span><span style="color:#676E95;font-style:italic;">       /* Enumeration  */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_FWD</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">7</span><span style="color:#676E95;font-style:italic;">       /* Forward      */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_TYPEDEF</span><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">8</span><span style="color:#676E95;font-style:italic;">       /* Typedef      */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_VOLATILE</span><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">9</span><span style="color:#676E95;font-style:italic;">       /* Volatile     */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_CONST</span><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">10</span><span style="color:#676E95;font-style:italic;">      /* Const        */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_RESTRICT</span><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">11</span><span style="color:#676E95;font-style:italic;">      /* Restrict     */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_FUNC</span><span style="color:#A6ACCD;">           </span><span style="color:#F78C6C;">12</span><span style="color:#676E95;font-style:italic;">      /* Function     */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_FUNC_PROTO</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">13</span><span style="color:#676E95;font-style:italic;">      /* Function Proto       */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_VAR</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">14</span><span style="color:#676E95;font-style:italic;">      /* Variable     */</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">#define</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">BTF_KIND_DATASEC</span><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">15</span><span style="color:#676E95;font-style:italic;">      /* Section      */</span></span>
<span class="line"></span></code></pre></div><p>æ³¨æ„ç±»å‹æ®µä¸åªæ˜¯çº¯ç²¹çš„ç±»å‹ä¿¡æ¯ï¼Œè¿˜ç¼–ç äº†ä¸º debug è€Œå­˜åœ¨çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ <code>BTF_KIND_FUNC</code> å°±ä¸æ˜¯ä¸€ä¸ªç±»å‹ï¼Œå®ƒä»£è¡¨ç€ä¸€ä¸ªå®šä¹‰å¥½çš„ç¨‹åºã€‚æ¯ä¸ªç±»å‹éƒ½åŒ…å«æœ‰ä¸‹é¢çš„å…¬å…±æ•°æ®ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> btf_type </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    __u32 name_off</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /* 32 ä½çš„ &quot;info&quot; å˜é‡å„ä½çš„å«ä¹‰</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * bits  0-15: vlen (e.g. # of struct&#39;s members)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * bits 16-23: unused</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * bits 24-27: kind (e.g. int, ptr, array...etc)</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * bits 28-30: unused</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * bit     31: kind_flag, currently used by</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     *             struct, union and fwd</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#F07178;">    __u32 info</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /* &quot;size&quot; is used by INT, ENUM, STRUCT and UNION.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * &quot;size&quot; tells the size of the type it is describing.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     *</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * &quot;type&quot; is used by PTR, TYPEDEF, VOLATILE, CONST, RESTRICT,</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * FUNC and FUNC_PROTO.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     * &quot;type&quot; is a type_id referring to another type.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">     */</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">union</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">            __u32 size</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">            __u32 type</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>å¯¹äºç‰¹å®šçš„ç±»å‹ï¼Œå…¬å…±æ•°æ®ä¹‹åå°±æ˜¯ä»–ä»¬å„è‡ªç‹¬ç‰¹çš„æ•°æ®ã€‚ ç»“æ„ä½“<code>struct btf_type</code>ä¸­çš„<code>name_off</code> æŒ‡å®šäº†ç‰¹å®šç±»å‹åœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„åç§»ã€‚</p><h2 id="_3-btf-kernel-api" tabindex="-1">3. BTF Kernel API <a class="header-anchor" href="#_3-btf-kernel-api" aria-hidden="true">#</a></h2><p>ä¸‹åˆ— bpf ç³»ç»Ÿè°ƒç”¨å‘½ä»¤åŒ…å«äº† BTFï¼Œé™¤æ­¤ä»¥å¤–è¿˜æœ‰å¾ˆå¤š<a href="https://www.kernel.org/doc/html/latest/bpf/btf.html#btf-kernel-api" target="_blank" rel="noreferrer">å…¶ä»–è°ƒç”¨</a></p><ul><li><p>BPF_BTF_LOADï¼šå°†ä¸€ä¸ª blob çš„ BTF æ•°æ®åŠ è½½åˆ° kernel ä¸­ã€‚</p></li><li><p>BPF_MAP_CREATEï¼šåˆ›å»ºæœ‰ BTF é”®å’Œç±»å‹ä¿¡æ¯å€¼çš„æ˜ å°„ã€‚</p></li><li><p>BPF_PROG_LOADï¼šåŠ è½½æœ‰ BTF å‡½æ•°å’Œ line ä¿¡æ¯çš„ç¨‹åºã€‚</p></li><li><p>BPF_BTF_GET_FD_BY_IDï¼šå¾—åˆ°ä¸€ä¸ª BTF æ–‡ä»¶æè¿°ç¬¦ fdã€‚</p></li><li><p>BPF_OBJ_GET_INFO_BY_FDï¼šè¯¥å‡½æ•°å°†è¿”å› BTFï¼Œå‡½æ•°ä¿¡æ¯ï¼Œline ä¿¡æ¯å’Œå…¶ä»– BTF ç›¸å…³ä¿¡æ¯ã€‚</p></li></ul><p>å·¥ä½œæµé€šå¸¸çœ‹ä¸Šå»æ˜¯è¿™æ ·çš„ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">Application:</span></span>
<span class="line"><span style="color:#A6ACCD;">    BPF_BTF_LOAD</span></span>
<span class="line"><span style="color:#A6ACCD;">        |</span></span>
<span class="line"><span style="color:#A6ACCD;">        v</span></span>
<span class="line"><span style="color:#A6ACCD;">    BPF_MAP_CREATE and BPF_PROG_LOAD</span></span>
<span class="line"><span style="color:#A6ACCD;">        |</span></span>
<span class="line"><span style="color:#A6ACCD;">        V</span></span>
<span class="line"><span style="color:#A6ACCD;">    ......</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">Introspection tool:</span></span>
<span class="line"><span style="color:#A6ACCD;">    ......</span></span>
<span class="line"><span style="color:#A6ACCD;">    BPF_{PROG,MAP}_GET_NEXT_ID (get prog/map id&#39;s)</span></span>
<span class="line"><span style="color:#A6ACCD;">        |</span></span>
<span class="line"><span style="color:#A6ACCD;">        V</span></span>
<span class="line"><span style="color:#A6ACCD;">    BPF_{PROG,MAP}_GET_FD_BY_ID (get a prog/map fd)</span></span>
<span class="line"><span style="color:#A6ACCD;">        |</span></span>
<span class="line"><span style="color:#A6ACCD;">        V</span></span>
<span class="line"><span style="color:#A6ACCD;">    BPF_OBJ_GET_INFO_BY_FD (get bpf_prog_info/bpf_map_info with btf_id)</span></span>
<span class="line"><span style="color:#A6ACCD;">        |                                     |</span></span>
<span class="line"><span style="color:#A6ACCD;">        V                                     |</span></span>
<span class="line"><span style="color:#A6ACCD;">    BPF_BTF_GET_FD_BY_ID (get btf_fd)         |</span></span>
<span class="line"><span style="color:#A6ACCD;">        |                                     |</span></span>
<span class="line"><span style="color:#A6ACCD;">        V                                     |</span></span>
<span class="line"><span style="color:#A6ACCD;">    BPF_OBJ_GET_INFO_BY_FD (get btf)          |</span></span>
<span class="line"><span style="color:#A6ACCD;">        |                                     |</span></span>
<span class="line"><span style="color:#A6ACCD;">        V                                     V</span></span>
<span class="line"><span style="color:#A6ACCD;">    pretty print types, dump func signatures and line info, etc.</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="_4-elf-file-format-interface" tabindex="-1">4. ELF File Format Interface <a class="header-anchor" href="#_4-elf-file-format-interface" aria-hidden="true">#</a></h2><h3 id="_4-1-btf-section" tabindex="-1">4.1 .BTF section <a class="header-anchor" href="#_4-1-btf-section" aria-hidden="true">#</a></h3><p><code>.BTF</code> æ®µåŒ…å«ç€ç±»å‹æ•°æ®å’Œå­—ç¬¦ä¸²æ•°æ®ã€‚è¿™éƒ¨åˆ†çš„æ ¼å¼å’Œ <a href="https://www.kernel.org/doc/html/latest/bpf/btf.html#btf-type-and-string-encoding" target="_blank" rel="noreferrer">2. BTF Type and String Encoding</a> ä¸­æè¿°çš„ä¸€æ ·ã€‚</p><h3 id="_4-2-btf-ext-section" tabindex="-1">4.2 .BTF.ext section <a class="header-anchor" href="#_4-2-btf-ext-section" aria-hidden="true">#</a></h3><p><code>.BTF.ext</code> æ®µç¼–ç äº† func_info å’Œ line_infoï¼Œéœ€è¦ä½¿ç”¨ loader æ‰ä¼šè¢«åŠ è½½åˆ°å†…æ ¸ä¸­ã€‚</p><p><code>.BTF.ext </code> æ®µçš„è¯¦ç»†æ–‡æ¡£åœ¨æ–‡ä»¶ <code>tools/lib/bpf/btf.h</code> å’Œ <code>tools/lib/bpf/btf.c</code>ã€‚</p><p>å½“å‰ç›¸å…³çš„å¤´æ–‡ä»¶ä¸­çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> btf_ext_header </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    __u16   magic</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u8    version</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u8    flags</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u32   hdr_len</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    /* All offsets are in bytes relative to the end of this header */</span></span>
<span class="line"><span style="color:#F07178;">    __u32   func_info_off</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u32   func_info_len</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u32   line_info_off</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    __u32   line_info_len</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>ç±»ä¼¼äº <code>.BTF</code> æ®µï¼Œ ä½†æ˜¯ä¸æ˜¯ <code>string/info</code> æ®µï¼Œå®ƒåŒ…å«çš„æ˜¯ <code>func_info</code> å’Œ <code>line_info</code> æ®µã€‚</p><p>å¯ä»¥å‚è€ƒ <a href="https://www.kernel.org/doc/html/latest/bpf/btf.html#bpf-prog-load" target="_blank" rel="noreferrer">3.3 BPF_PROG_LOAD</a> ä¸­ <code>func_info</code> å’Œ <code>line_info</code> çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><p><code>func_info</code> å¦‚ä¸‹ç»„ç»‡ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">func_info_rec_size</span></span>
<span class="line"><span style="color:#A6ACCD;">btf_ext_info_sec for section #1 /* func_info for section #1 */</span></span>
<span class="line"><span style="color:#A6ACCD;">btf_ext_info_sec for section #2 /* func_info for section #2 */</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>å½“ <code>.BTF.ext</code> ç”Ÿæˆæ—¶ï¼Œ<code>func_info_rec_size</code> å®šä¹‰äº†<code>bpf_func_info</code> ç»“æ„çš„å¤§å°ã€‚åœ¨ä¸‹é¢å®šä¹‰çš„ <code>btf_ext_info_sec</code> æ˜¯æ¯ä¸ªç‰¹å®šçš„ ELF æ®µä¸­çš„ä¸€ç³»åˆ— <code>func_info</code>ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> btf_ext_info_sec </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">   __u32   sec_name_off</span><span style="color:#89DDFF;">;</span><span style="color:#676E95;font-style:italic;"> /* offset to section name */</span></span>
<span class="line"><span style="color:#F07178;">   __u32   num_info</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">   /* Followed by num_info * record_size number of bytes */</span></span>
<span class="line"><span style="color:#F07178;">   __u8    </span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">];</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"></span></code></pre></div><p>è¿™é‡Œçš„ <code>num_info</code> å¿…é¡»å¤§äº 0ã€‚</p><p><code>line_info</code> å¦‚ä¸‹ç»„ç»‡ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">line_info_rec_size</span></span>
<span class="line"><span style="color:#A6ACCD;">btf_ext_info_sec for section #1 /* line_info for section #1 */</span></span>
<span class="line"><span style="color:#A6ACCD;">btf_ext_info_sec for section #2 /* line_info for section #2 */</span></span>
<span class="line"><span style="color:#A6ACCD;">...</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>å½“ <code>.BTF.ext</code> ç”Ÿæˆæ—¶ï¼Œ<code>line_info_rec_size</code> å®šä¹‰äº† <code>bpf_line_info</code> ç»“æ„çš„å¤§å°ã€‚</p><p><code>bpf_func_info-&gt;insn_off</code> å’Œ <code>bpf_line_info-&gt;insn_off</code> åœ¨å†…æ ¸ API å’Œ ELF API ä¸­æœ‰ç€ä¸åŒçš„é˜é‡Šã€‚åœ¨å†…æ ¸ API ä¸­ï¼Œ<code>insn_off</code> æ˜¯æŒ‡ä»¤åœ¨ <code>struct bpf_insn</code> å†…çš„åç§»ã€‚å¯¹äº ELF APIï¼Œ<code>insn_off</code> æ˜¯ç›¸å¯¹äºæ®µ <code>btf_ext_info_sec-&gt;sec_name_off</code>å¼€å§‹çš„å­—èŠ‚åç§»ã€‚</p><h3 id="_4-2-btf-ids-section" tabindex="-1">4.2 .BTF_ids section <a class="header-anchor" href="#_4-2-btf-ids-section" aria-hidden="true">#</a></h3><p><code>.BTF_ids</code> æ®µç¼–ç äº†å†…æ ¸ä¸­å®šä¹‰çš„ BTF ID å€¼ã€‚å€ŸåŠ©å¤´æ–‡ä»¶ <code>include/linux/btf_ids.h</code> ä¸­å®šä¹‰çš„å®ï¼Œå¯ä»¥åœ¨å†…æ ¸ç¼–è¯‘æ—¶åˆ›å»ºè¿™ä¸€æ®µæ•°æ®ã€‚å†…æ ¸ä»£ç èƒ½å¤Ÿä½¿ç”¨ä¸‹é¢çš„è¯­æ³•æ¥åˆ›å»º BTF ID å€¼çš„åˆ—è¡¨å’Œæœ‰åºåˆ—è¡¨ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">BTF_ID_LIST</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">list</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">BTF_ID</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">type1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> name1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">BTF_ID</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">type2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> name2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>è¿™å°†ä¼šç”Ÿæˆä¸‹é¢çš„ .BTF_ids æ®µçš„å¸ƒå±€ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">__BTF_ID__type1__name1__1:</span></span>
<span class="line"><span style="color:#A6ACCD;">.zero 4</span></span>
<span class="line"><span style="color:#A6ACCD;">__BTF_ID__type2__name2__2:</span></span>
<span class="line"><span style="color:#A6ACCD;">.zero 4</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><code>u32 list[];</code> å˜é‡è¢«å®šä¹‰æ¥è·å–åˆ—è¡¨ã€‚</p><p><code>BTF_ID_UNUSED</code> å®å®šä¹‰äº†å››ä¸ªé›¶å­—èŠ‚ã€‚å½“æˆ‘ä»¬æƒ³è¦åœ¨ BTF_ID_LIST ä¸­å®šä¹‰ unused entryï¼Œå¯ä»¥è¿™æ ·åšï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">BTF_ID_LIST</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">bpf_skb_output_btf_ids</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">BTF_ID</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> sk_buff</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">BTF_ID_UNUSED</span></span>
<span class="line"><span style="color:#82AAFF;">BTF_ID</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">struct</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> task_struct</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p><code>BTF_SET_START/END</code> è¿™ä¸€å¯¹å®å®šä¹‰äº†æœ‰åºåˆ—è¡¨ BTF ID å€¼å’Œå®ƒä»¬çš„è®¡æ•°å€¼ï¼Œå®ƒçš„è¯­æ³•å¦‚ä¸‹ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">BTF_SET_START</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">set</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">BTF_ID</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">type1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> name1</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">BTF_ID</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">type2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> name2</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#82AAFF;">BTF_SET_END</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">set</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>è¿™å°†ä¼šç”Ÿæˆä¸‹é¢çš„ .BTF_ids æ®µçš„å¸ƒå±€ï¼š</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">A__BTF_ID__set__set:</span></span>
<span class="line"><span style="color:#A6ACCD;">.zero 4</span></span>
<span class="line"><span style="color:#A6ACCD;">__BTF_ID__type1__name1__3:</span></span>
<span class="line"><span style="color:#A6ACCD;">.zero 4</span></span>
<span class="line"><span style="color:#A6ACCD;">__BTF_ID__type2__name2__4:</span></span>
<span class="line"><span style="color:#A6ACCD;">.zero 4</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><code>struct btf_id_set set;</code> å˜é‡å¯ä»¥è·å–åˆ°åˆ—è¡¨ã€‚<code>typeX</code> åå­—å¯ä»¥æ˜¯ä¸‹é¢çš„ä»»ä¸€é¡¹ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">struct</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">union</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">typedef</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> func</span></span>
<span class="line"></span></code></pre></div><p>å¹¶ä¸”å¯ä»¥è¢«ç”¨æ¥åœ¨è§£æ BTF ID å€¼çš„æ—¶å€™ä½œä¸ºè¿‡æ»¤å™¨ä½¿ç”¨ã€‚æ‰€æœ‰çš„ BTF ID åˆ—è¡¨å’Œæœ‰åºåˆ—è¡¨éƒ½è¢«ç¼–è¯‘åˆ°äº† <code>.BTF_ids</code> æ®µï¼Œå®ƒåœ¨<code>resolve_btfids</code>æ„å»ºå‡ºçš„å†…æ ¸çš„é“¾æ¥é˜¶æ®µè§£æã€‚</p><h2 id="_5-using-btf" tabindex="-1">5. Using BTF <a class="header-anchor" href="#_5-using-btf" aria-hidden="true">#</a></h2><h3 id="_5-1-bpftool-map-pretty-print" tabindex="-1">5.1 bpftool map pretty print <a class="header-anchor" href="#_5-1-bpftool-map-pretty-print" aria-hidden="true">#</a></h3><p>å€ŸåŠ© BTFï¼Œæ˜ å°„çš„å¥å€¼èƒ½å¤Ÿä»¥åŸŸçš„å½¢å¼æ‰“å°å‡ºæ¥ï¼Œè€Œä¸æ˜¯ä»…ä»…æ‰“å°å‡ºè£¸å­—èŠ‚ã€‚è¿™å¯¹äºå¤§å‹çš„ç»“æ„æˆ–æ˜¯ä½ çš„æ•°æ®ç»“æ„ä¸­å„æ¯”ç‰¹ä½æœ‰ç‹¬ç«‹æ„ä¹‰æ—¶å¾ˆæœ‰ä»·å€¼ã€‚ä¾‹å¦‚ä¸‹é¢çš„æ˜ å°„ï¼š</p><div class="language-c"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> A </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> A1</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> A2</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> A3</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> A4</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> A5 </span><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#F78C6C;">typedef</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">enum</span><span style="color:#A6ACCD;"> A ___A</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">tmp_t</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#C792EA;">char</span><span style="color:#F07178;"> a1:</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#C792EA;">int</span><span style="color:#F07178;">  a2:</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#C792EA;">int</span><span style="color:#F07178;">  :</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     __u32 a3:</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#C792EA;">int</span><span style="color:#F07178;"> b</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     ___A b1:</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#C792EA;">enum</span><span style="color:#F07178;"> A b2:</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> bpf_map_def </span><span style="color:#82AAFF;">SEC</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">maps</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> tmpmap </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">     .type </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> BPF_MAP_TYPE_ARRAY</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#F07178;">     .key_size </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#F07178;">__u32</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">     .value_size </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">sizeof(</span><span style="color:#C792EA;">struct</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">tmp_t</span><span style="color:#89DDFF;">),</span></span>
<span class="line"><span style="color:#F07178;">     .max_entries </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#89DDFF;">};</span></span>
<span class="line"><span style="color:#82AAFF;">BPF_ANNOTATE_KV_PAIR</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">tmpmap</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">int</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">tmp_t</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p>å¯ä»¥è¿™æ ·ä½¿ç”¨ bpftool æ¥ä¼˜é›…åœ°æ‰“å°ï¼š</p><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;">[{</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">key</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C792EA;">value</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">a1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">x</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">a2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">x</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">a3</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">x</span><span style="color:#F78C6C;">6</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">b</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">b1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">x</span><span style="color:#F78C6C;">8</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">          </span><span style="color:#89DDFF;">&quot;</span><span style="color:#FFCB6B;">b2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">xa</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre></div><h3 id="_5-2-bpftool-prog-dump" tabindex="-1">5.2 bpftool prog dump <a class="header-anchor" href="#_5-2-bpftool-prog-dump" aria-hidden="true">#</a></h3><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº† func_info å’Œ line_info èƒ½å¤Ÿæ›´å¥½åœ°å¸®åŠ© dump å‡ºå†…æ ¸ç¬¦å·åç§°ã€å‡½æ•°åŸå‹å’Œ line ä¿¡æ¯ï¼š</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bpftool</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">prog</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dump</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">jited</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pinned</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/sys/fs/bpf/test_btf_haskv</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">...</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test_long_fname_2</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dummy_tracepoint_args</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arg</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">:</span></span>
<span class="line"><span style="color:#FFCB6B;">bpf_prog_44a040bf25481309_test_long_fname_2:</span></span>
<span class="line"><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">static</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test_long_fname_2</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dummy_tracepoint_args</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">arg</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">0:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">push</span><span style="color:#A6ACCD;">   %rbp</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">1:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %rsp,%rbp</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">4:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">sub</span><span style="color:#A6ACCD;">    $0x30</span><span style="color:#C3E88D;">,%rsp</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">b:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">sub</span><span style="color:#A6ACCD;">    $0x28</span><span style="color:#C3E88D;">,%rbp</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">f:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %rbx,0x0</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">%</span><span style="color:#FFCB6B;">rbp</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">13:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %r13,0x8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">%</span><span style="color:#FFCB6B;">rbp</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">17:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %r14,0x10</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">%</span><span style="color:#FFCB6B;">rbp</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">1b:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %r15,0x18</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">%</span><span style="color:#FFCB6B;">rbp</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">1f:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">xor</span><span style="color:#A6ACCD;">    %eax,%eax</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">21:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %rax,0x20</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">%</span><span style="color:#FFCB6B;">rbp</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">25:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">xor</span><span style="color:#A6ACCD;">    %esi,%esi</span></span>
<span class="line"><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">key</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">27:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %esi,-0x4</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">%</span><span style="color:#FFCB6B;">rbp</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#FFCB6B;">arg-&gt;sock</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">2a:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">0x8</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">%</span><span style="color:#FFCB6B;">rdi</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">,%rdi</span></span>
<span class="line"><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(!</span><span style="color:#FFCB6B;">arg-&gt;sock</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">2e:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">cmp</span><span style="color:#A6ACCD;">    $0x0</span><span style="color:#C3E88D;">,%rdi</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">32:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">je</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">0x0000000000000070</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">34:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">mov</span><span style="color:#A6ACCD;">    %rbp,%rsi</span></span>
<span class="line"><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">counts</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bpf_map_lookup_elem</span><span style="color:#89DDFF;">(&amp;</span><span style="color:#FFCB6B;">btf_map,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;</span><span style="color:#FFCB6B;">key</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">...</span><span style="color:#89DDFF;">]</span></span>
<span class="line"></span></code></pre></div><h3 id="_5-3-verifier-log" tabindex="-1">5.3 Verifier Log <a class="header-anchor" href="#_5-3-verifier-log" aria-hidden="true">#</a></h3><p>ä¸‹é¢çš„ä¾‹å­å±•ç¤ºäº† line_info æ˜¯å¦‚ä½•å¸®åŠ© debug éªŒè¯é”™è¯¯çš„ï¼š</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">/*</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">The</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">code</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">at</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tools/testing/selftests/bpf/test_xdp_noinline.c</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">modified</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">below.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">*/</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">data</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">)(</span><span style="color:#FFCB6B;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">xdp-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">data_end</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">)(</span><span style="color:#FFCB6B;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">xdp-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">data_end</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">/*</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">data</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">data_end</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">XDP_DROP</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">*/</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">*(u32</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;">)data = dst-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">dst</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bpftool</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">prog</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">load</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">./test_xdp_noinline.o</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/sys/fs/bpf/test_xdp_noinline</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">type</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xdp</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">data</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">)(</span><span style="color:#FFCB6B;">long</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">xdp-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">data</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">224:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">79</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">r2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">u64</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">)(</span><span style="color:#FFCB6B;">r10</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-112</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">225:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">61</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">r2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">u32</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">)(</span><span style="color:#FFCB6B;">r2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">+</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">*(u32</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;">)data = dst-</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">dst</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">226:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">63</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">u32</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#89DDFF;">)(</span><span style="color:#FFCB6B;">r2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">+</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">r1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">invalid</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">access</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">packet,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">off=</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">size=</span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">R2</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">id</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#C3E88D;">,off=</span><span style="color:#F78C6C;">0</span><span style="color:#C3E88D;">,r=</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">R2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">offset</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">outside</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">of</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">packet</span></span>
<span class="line"></span></code></pre></div><h2 id="_6-btf-generation" tabindex="-1">6. BTF Generation <a class="header-anchor" href="#_6-btf-generation" aria-hidden="true">#</a></h2><p>ä½ éœ€è¦ä½¿ç”¨æœ€æ–°çš„ <a href="https://git.kernel.org/pub/scm/devel/pahole/pahole.git/" target="_blank" rel="noreferrer">pahole</a> æˆ– 8.0 ç‰ˆæœ¬ä»¥ä¸Šçš„ llvmæ¥ç”Ÿæˆ BTFã€‚</p><p>pahole æ˜¯ä¸€ä¸ª dwarf2btf è½¬æ¢å™¨ï¼Œå®ƒè¿˜ä¸æ”¯æŒ <code>.BTF.ext</code> å’Œ <code>btf</code> <code>BTF_KIND_FUNC</code> ç±»å‹ã€‚ä¾‹å¦‚ï¼š</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#FFCB6B;">-bash-4.4$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">t.c</span></span>
<span class="line"><span style="color:#FFCB6B;">struct</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">t</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a:</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">b:</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">c:</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">} g;</span></span>
<span class="line"><span style="color:#FFCB6B;">-bash-4.4$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gcc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-c</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-O2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-g</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">t.c</span></span>
<span class="line"><span style="color:#FFCB6B;">-bash-4.4$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pahole</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-JV</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">t.o</span></span>
<span class="line"><span style="color:#FFCB6B;">File</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">t.o:</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> STRUCT t kind_flag</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> size</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> vlen</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">type_id=</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bitfield_size=</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bits_offset=</span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">b</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">type_id=</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bitfield_size=</span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bits_offset=</span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">c</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">type_id=</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bitfield_size=</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bits_offset=</span><span style="color:#F78C6C;">5</span></span>
<span class="line"><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> INT int size</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">4</span><span style="color:#A6ACCD;"> bit_offset</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> nr_bits</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">32</span><span style="color:#A6ACCD;"> encoding</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">SIGNED</span></span>
<span class="line"></span></code></pre></div><p>llvm èƒ½å¤Ÿç›´æ¥ç”Ÿæˆ <code>.BTF</code> å’Œ <code>.BTF.ext</code>ï¼Œé€‰é¡¹æ˜¯ -gï¼Œç›®æ ‡é€‰é¡¹æ˜¯ bpfã€‚ ä½¿ç”¨ readelf å·¥å…·çš„ -S é€‰é¡¹èƒ½å¤Ÿæ˜¾ç¤ºå‡ºæ±‡ç¼–æ ¼å¼çš„ BTF ä»£ç ï¼š</p><div class="language-asm"><button title="Copy Code" class="copy"></button><span class="lang">asm</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">-bash-</span><span style="color:#F78C6C;">4.4</span><span style="color:#A6ACCD;">$ cat t2.c</span></span>
<span class="line"><span style="color:#A6ACCD;">typedef </span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> __int32</span><span style="color:#676E95;font-style:italic;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">struct t2 {</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> a2</span><span style="color:#676E95;font-style:italic;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> (*f2)(char q1, __int32 q2, ...)</span><span style="color:#676E95;font-style:italic;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> (*f3)()</span><span style="color:#676E95;font-style:italic;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">} g2</span><span style="color:#676E95;font-style:italic;">;</span></span>
<span class="line"><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> main() { return </span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">; }</span></span>
<span class="line"><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">test</span><span style="color:#A6ACCD;">() { return </span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">; }</span></span>
<span class="line"><span style="color:#A6ACCD;">-bash-</span><span style="color:#F78C6C;">4.4</span><span style="color:#A6ACCD;">$ clang -c -g -O2 -target bpf t2.c</span></span>
<span class="line"><span style="color:#A6ACCD;">-bash-</span><span style="color:#F78C6C;">4.4</span><span style="color:#A6ACCD;">$ readelf -S t2.o</span></span>
<span class="line"><span style="color:#A6ACCD;">  ......</span></span>
<span class="line"><span style="color:#A6ACCD;">  [ </span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">] .BTF              PROGBITS         </span><span style="color:#F78C6C;">0000000000000000</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">00000247</span></span>
<span class="line"><span style="color:#A6ACCD;">       000000000000016e  </span><span style="color:#F78C6C;">0000000000000000</span><span style="color:#A6ACCD;">           </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">  [ </span><span style="color:#F78C6C;">9</span><span style="color:#A6ACCD;">] .BTF.ext          PROGBITS         </span><span style="color:#F78C6C;">0000000000000000</span><span style="color:#A6ACCD;">  000003b5</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">0000000000000060</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0000000000000000</span><span style="color:#A6ACCD;">           </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">  [</span><span style="color:#F78C6C;">10</span><span style="color:#A6ACCD;">] .</span><span style="color:#C792EA;">rel</span><span style="color:#A6ACCD;">.BTF.ext      </span><span style="color:#C792EA;">REL</span><span style="color:#A6ACCD;">              </span><span style="color:#F78C6C;">0000000000000000</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">000007e0</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#F78C6C;">0000000000000040</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">0000000000000010</span><span style="color:#A6ACCD;">          </span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">9</span><span style="color:#A6ACCD;">     </span><span style="color:#F78C6C;">8</span></span>
<span class="line"><span style="color:#A6ACCD;">  ......</span></span>
<span class="line"><span style="color:#A6ACCD;">-bash-</span><span style="color:#F78C6C;">4.4</span><span style="color:#A6ACCD;">$ clang -S -g -O2 -target bpf t2.c</span></span>
<span class="line"><span style="color:#A6ACCD;">-bash-</span><span style="color:#F78C6C;">4.4</span><span style="color:#A6ACCD;">$ cat t2.s</span></span>
<span class="line"><span style="color:#A6ACCD;">  ......</span></span>
<span class="line"><span style="color:#A6ACCD;">        .section        .BTF,&quot;&quot;,@progbits</span></span>
<span class="line"><span style="color:#A6ACCD;">        .short  </span><span style="color:#F78C6C;">60319</span><span style="color:#A6ACCD;">                  </span><span style="color:#676E95;font-style:italic;"> # 0xeb9f</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">24</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">220</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">220</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">122</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">                      </span><span style="color:#676E95;font-style:italic;"> # BTF_KIND_FUNC_PROTO(id = 1)</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">218103808</span><span style="color:#A6ACCD;">              </span><span style="color:#676E95;font-style:italic;"> # 0xd000000</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">83</span><span style="color:#A6ACCD;">                     </span><span style="color:#676E95;font-style:italic;"> # BTF_KIND_INT(id = 2)</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">16777216</span><span style="color:#A6ACCD;">               </span><span style="color:#676E95;font-style:italic;"> # 0x1000000</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">4</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">16777248</span><span style="color:#A6ACCD;">               </span><span style="color:#676E95;font-style:italic;"> # 0x1000020</span></span>
<span class="line"><span style="color:#A6ACCD;">  ......</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">                      </span><span style="color:#676E95;font-style:italic;"> # string offset=0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .ascii  &quot;</span><span style="color:#FFCB6B;">.text</span><span style="color:#A6ACCD;">&quot;                </span><span style="color:#676E95;font-style:italic;"> # string offset=1</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .ascii  &quot;/home/yhs/tmp-pahole/t2.c&quot;</span><span style="color:#676E95;font-style:italic;"> # string offset=7</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .ascii  &quot;</span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> main() { return </span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">; }&quot; # string offset=33</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .ascii  &quot;</span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">test</span><span style="color:#A6ACCD;">() { return </span><span style="color:#F78C6C;">0</span><span style="color:#676E95;font-style:italic;">; }&quot; # string offset=58</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .ascii  &quot;</span><span style="color:#89DDFF;">int</span><span style="color:#A6ACCD;">&quot;                  </span><span style="color:#676E95;font-style:italic;"> # string offset=83</span></span>
<span class="line"><span style="color:#A6ACCD;">  ......</span></span>
<span class="line"><span style="color:#A6ACCD;">        .section        .BTF.ext,&quot;&quot;,@progbits</span></span>
<span class="line"><span style="color:#A6ACCD;">        .short  </span><span style="color:#F78C6C;">60319</span><span style="color:#A6ACCD;">                  </span><span style="color:#676E95;font-style:italic;"> # 0xeb9f</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">        .</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">24</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">28</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">28</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">44</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">8</span><span style="color:#A6ACCD;">                      </span><span style="color:#676E95;font-style:italic;"> # FuncInfo</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">                      </span><span style="color:#676E95;font-style:italic;"> # FuncInfo section string offset=1</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   .Lfunc_begin0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">3</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   .Lfunc_begin1</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">5</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">16</span><span style="color:#A6ACCD;">                     </span><span style="color:#676E95;font-style:italic;"> # LineInfo</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">                      </span><span style="color:#676E95;font-style:italic;"> # LineInfo section string offset=1</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">2</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   .Ltmp0</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">7</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">33</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">7182</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;font-style:italic;"> # Line 7 Col 14</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   .Ltmp3</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">7</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">58</span></span>
<span class="line"><span style="color:#A6ACCD;">        .long   </span><span style="color:#F78C6C;">8206</span><span style="color:#A6ACCD;">                   </span><span style="color:#676E95;font-style:italic;"> # Line 8 Col 14</span></span>
<span class="line"></span></code></pre></div></div></div></main><!--[--><!--]--><!----><!--[--><!--[--><!--[--><!----><!--]--><!--]--><!--]--></div></div></div></div></div><!----><!--[--><!--]--></div><!----><footer data-v-4f0db67d> Powered by <a href="https://github.com/forsworns/" target="_blank" title="Author" data-v-4f0db67d>Peihao Yang</a> | Copyright Â© 2019-2024 | MIT License </footer><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"index.md\":\"e0ba6ad2\",\"zh_blogs_20190901_index.md\":\"506c415e\",\"about-me_index.md\":\"846ea80d\",\"zh_blogs_20190824_index.md\":\"c631fdf0\",\"zh_about-me_index.md\":\"3ebfac3a\",\"zh_blogs_20190919_index.md\":\"a9ef4728\",\"zh_blogs_20190721_index.md\":\"9a1992f7\",\"zh_blogs_20190908_index.md\":\"0ae17c24\",\"zh_blogs_20210120_index.md\":\"46bc3a68\",\"zh_blogs_20200616_index.md\":\"24a6c73e\",\"zh_blogs_20191112_index.md\":\"52603db5\",\"zh_blogs_20200816_index.md\":\"634fb620\",\"zh_blogs_20200817_index.md\":\"b22a8d7c\",\"zh_blogs_20201023_index.md\":\"4c94be96\",\"zh_blogs_20210204_index.md\":\"922002e3\",\"zh_blogs_20200818_index.md\":\"73c493e7\",\"zh_blogs_20210123_index.md\":\"dd264596\",\"zh_blogs_20191109_index.md\":\"80d0c840\",\"zh_blogs_20210203_index.md\":\"ae20c5bd\",\"zh_blogs_20230201_index.md\":\"d65a7769\",\"zh_blogs_20230201_repost.md\":\"d6a8bf08\",\"zh_blogs_20230209_index.md\":\"3a12ac32\",\"zh_blogs_20230322_index.md\":\"8838bc28\",\"zh_blogs_20230601_index.md\":\"64d86526\",\"zh_blogs_20240128_index.md\":\"6e1d760d\",\"zh_blogs_20240215_index.md\":\"4139d8e8\",\"zh_blogs_20240220_index.md\":\"6d320fea\",\"zh_blogs_20240427_index.md\":\"ab744de2\",\"zh_blogs_20240413_index.md\":\"3307932c\",\"zh_blogs_20240513_index.md\":\"56ad3f14\",\"zh_blogs_20210409_index.md\":\"8932f02b\",\"zh_blogs_20240622_index.md\":\"e693b38c\",\"zh_blogs_20240423_index.md\":\"6c1114d2\",\"zh_blogs_20240526_index.md\":\"3f2d8a25\",\"zh_blogs_20240620_index.md\":\"69e37ac2\",\"zh_blogs_20240626_index.md\":\"c36ba82d\",\"zh_blogs_index.md\":\"a0e1cf19\",\"zh_blogs_20210430_index.md\":\"9c389873\",\"zh_blogs_20210311_index.md\":\"7de1b4a4\",\"zh_blogs_20240518_index.md\":\"d0555774\",\"zh_blogs_20191102_index.md\":\"53b363d5\",\"zh_blogs_20230101_index.md\":\"8bcd8a38\",\"zh_blogs_20210310_index.md\":\"b02adbe1\",\"zh_blogs_20210412_index.md\":\"56cbe3d4\",\"zh_blogs_20210315_index.md\":\"4e8d51fd\",\"zh_blogs_20220224_index.md\":\"cddc3efe\",\"zh_blogs_20221108_index.md\":\"1ecb2c5e\",\"zh_blogs_20220611_index.md\":\"c429e3ae\",\"zh_blogs_20210312_index.md\":\"c84a09fb\",\"zh_blogs_20240519_index.md\":\"3935f5d4\",\"zh_blogs_20230125_index.md\":\"b6270011\",\"zh_blogs_20240623_index.md\":\"c3cf8349\",\"zh_blogs_20230121_index.md\":\"0c062d60\",\"zh_blogs_20210728_index.md\":\"24673902\",\"zh_blogs_20221228_index.md\":\"b21decf6\",\"zh_blogs_20210506_index.md\":\"8c999b21\",\"zh_blogs_20230126_index.md\":\"0b38611b\",\"zh_blogs_20211120_index.md\":\"75f05041\",\"zh_blogs_tags_index.md\":\"95f669eb\",\"zh_blogs_20211210_index.md\":\"fd74a440\",\"zh_blogs_20210706_index.md\":\"3a568024\",\"zh_blogs_20210224_index.md\":\"c500882b\",\"zh_blogs_20211130_index.md\":\"c8bce327\",\"zh_blogs_20210329_index.md\":\"810ef071\",\"zh_blogs_20210226_index.md\":\"417a3ac5\",\"zh_blogs_20210801_index.md\":\"18df2595\",\"zh_blogs_20210223_index.md\":\"e7082a64\",\"zh_blogs_20220105_index.md\":\"273f914b\",\"zh_blogs_20220101_index.md\":\"ee91e215\",\"zh_blogs_20210822_index.md\":\"ad67ffd7\",\"zh_index.md\":\"8b832df8\",\"zh_blogs_20220316_index.md\":\"92bf9247\",\"zh_blogs_20221024_index.md\":\"28646e28\",\"zh_blogs_20191103_index.md\":\"816338e7\",\"zh_blogs_20210715_index.md\":\"8feff090\",\"zh_blogs_20211002_index.md\":\"d511de03\",\"zh_blogs_20210627_index.md\":\"9d791080\"}")</script>
    <script type="module" async src="/assets/app.73f81c81.js"></script>
    
  </body>
</html>