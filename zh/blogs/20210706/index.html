<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>BPF Type Format (BTF) | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.5f87357d.css" as="style"><link rel="preload" href="/assets/js/app.3ee0229c.js" as="script"><link rel="preload" href="/assets/js/1.489a6dc0.js" as="script"><link rel="preload" href="/assets/js/70.75827cae.js" as="script"><link rel="preload" href="/assets/js/13.e56158ac.js" as="script"><link rel="prefetch" href="/assets/js/10.0a8552e5.js"><link rel="prefetch" href="/assets/js/11.7544d912.js"><link rel="prefetch" href="/assets/js/12.4abf2689.js"><link rel="prefetch" href="/assets/js/14.84181d18.js"><link rel="prefetch" href="/assets/js/15.dab14606.js"><link rel="prefetch" href="/assets/js/16.98da8228.js"><link rel="prefetch" href="/assets/js/17.0ba0e8e3.js"><link rel="prefetch" href="/assets/js/18.d2c98111.js"><link rel="prefetch" href="/assets/js/19.86bdbfa9.js"><link rel="prefetch" href="/assets/js/20.22caf17f.js"><link rel="prefetch" href="/assets/js/21.c75712be.js"><link rel="prefetch" href="/assets/js/22.c0c99274.js"><link rel="prefetch" href="/assets/js/23.214355cd.js"><link rel="prefetch" href="/assets/js/24.a9557518.js"><link rel="prefetch" href="/assets/js/25.fb756fe5.js"><link rel="prefetch" href="/assets/js/26.88bc672c.js"><link rel="prefetch" href="/assets/js/27.a047953c.js"><link rel="prefetch" href="/assets/js/28.0aa927b7.js"><link rel="prefetch" href="/assets/js/29.599475e0.js"><link rel="prefetch" href="/assets/js/3.db885a38.js"><link rel="prefetch" href="/assets/js/30.ac4304d9.js"><link rel="prefetch" href="/assets/js/31.378fb91c.js"><link rel="prefetch" href="/assets/js/32.72e1c0ea.js"><link rel="prefetch" href="/assets/js/33.358b985a.js"><link rel="prefetch" href="/assets/js/34.92d54470.js"><link rel="prefetch" href="/assets/js/35.3ee5ae15.js"><link rel="prefetch" href="/assets/js/36.f3bd4bb7.js"><link rel="prefetch" href="/assets/js/37.27456d40.js"><link rel="prefetch" href="/assets/js/38.ac3e3512.js"><link rel="prefetch" href="/assets/js/39.623032e6.js"><link rel="prefetch" href="/assets/js/4.5ebe3061.js"><link rel="prefetch" href="/assets/js/40.81db8d94.js"><link rel="prefetch" href="/assets/js/41.dcc11868.js"><link rel="prefetch" href="/assets/js/42.5ad0c9c8.js"><link rel="prefetch" href="/assets/js/43.d8a7f45f.js"><link rel="prefetch" href="/assets/js/44.78c0feaa.js"><link rel="prefetch" href="/assets/js/45.1b1f0dc8.js"><link rel="prefetch" href="/assets/js/46.eed83510.js"><link rel="prefetch" href="/assets/js/47.6eac4cc5.js"><link rel="prefetch" href="/assets/js/48.b7e6b32a.js"><link rel="prefetch" href="/assets/js/49.bbb7666a.js"><link rel="prefetch" href="/assets/js/5.86d38cb0.js"><link rel="prefetch" href="/assets/js/50.2f8f6c98.js"><link rel="prefetch" href="/assets/js/51.cd539748.js"><link rel="prefetch" href="/assets/js/52.a4605abf.js"><link rel="prefetch" href="/assets/js/53.027cd8a1.js"><link rel="prefetch" href="/assets/js/54.d7e6f527.js"><link rel="prefetch" href="/assets/js/55.fdbf2d23.js"><link rel="prefetch" href="/assets/js/56.b88cb66b.js"><link rel="prefetch" href="/assets/js/57.eaebbeb1.js"><link rel="prefetch" href="/assets/js/58.a8aab8e9.js"><link rel="prefetch" href="/assets/js/59.c1102b5d.js"><link rel="prefetch" href="/assets/js/6.834bec42.js"><link rel="prefetch" href="/assets/js/60.1602d25a.js"><link rel="prefetch" href="/assets/js/61.cf2b696f.js"><link rel="prefetch" href="/assets/js/62.8659cf17.js"><link rel="prefetch" href="/assets/js/63.00655be8.js"><link rel="prefetch" href="/assets/js/64.669e347b.js"><link rel="prefetch" href="/assets/js/65.2bf8094b.js"><link rel="prefetch" href="/assets/js/66.327070d4.js"><link rel="prefetch" href="/assets/js/67.810b2fee.js"><link rel="prefetch" href="/assets/js/68.e3476a72.js"><link rel="prefetch" href="/assets/js/69.35da038b.js"><link rel="prefetch" href="/assets/js/7.edffe57c.js"><link rel="prefetch" href="/assets/js/71.225214a5.js"><link rel="prefetch" href="/assets/js/72.a84f7192.js"><link rel="prefetch" href="/assets/js/73.ffe311be.js"><link rel="prefetch" href="/assets/js/74.3b69b9c2.js"><link rel="prefetch" href="/assets/js/75.aaf712aa.js"><link rel="prefetch" href="/assets/js/76.c3292f62.js"><link rel="prefetch" href="/assets/js/77.7fb25a78.js"><link rel="prefetch" href="/assets/js/8.2fb98e50.js"><link rel="prefetch" href="/assets/js/9.c640c61b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5f87357d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210706/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20210706/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="bpf-type-format-btf"><a href="#bpf-type-format-btf" class="header-anchor">#</a> BPF Type Format (BTF)</h1> <p>翻译自：<a href="https://www.kernel.org/doc/html/latest/bpf/btf.html" target="_blank" rel="noopener noreferrer">Linux Kernel Doc<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="_1-introduction"><a href="#_1-introduction" class="header-anchor">#</a> 1. Introduction</h2> <p>BTF (BPF Type Format) 是编码 BPF 程序、映射相关的 debug 信息的元数据格式。名称 BTF 最开始是用来描述数据类型的，之后被扩展，包含了预定义的子例程的函数信息以及源码中的 line info。</p> <p>debug 信息被用来格式化打印和提供函数签名等信息。函数签名优化了 bpf 程序/函数的内核符号。line info 则可以生成经过标注的字节码，jited 代码和验证器记录。</p> <p>BTF 包含两部分：</p> <ul><li>BTF kernel API</li> <li>BTF ELF file format</li></ul> <p>内核 API 是用户空间和内核之间沟通的桥梁。内核在使用 BTF 信息之前验证了它。ELF 文件格式则是一个用户空间的 ELF 文件和 libbpf loader 之间的协议。</p> <p>类型和字符串段是 BTF 内核 API 的一部分，描述了 bpf 程序引用到的（几乎是类型相关的）debug 信息。</p> <h2 id="_2-btf-type-and-string-encoding"><a href="#_2-btf-type-and-string-encoding" class="header-anchor">#</a> 2. BTF Type and String Encoding</h2> <p>头文件 <code>include/uapi/linux/btf.h</code> 中提供了类型和字符串是如何编码的高阶定义。</p> <p>data blob 的开头必须是：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">btf_header</span> <span class="token punctuation">{</span>
    __u16   magic<span class="token punctuation">;</span>
    __u8    version<span class="token punctuation">;</span>
    __u8    flags<span class="token punctuation">;</span>
    __u32   hdr_len<span class="token punctuation">;</span>

    <span class="token comment">/* All offsets are in bytes relative to the end of this header */</span>
    __u32   type_off<span class="token punctuation">;</span>       <span class="token comment">/* offset of type section       */</span>
    __u32   type_len<span class="token punctuation">;</span>       <span class="token comment">/* length of type section       */</span>
    __u32   str_off<span class="token punctuation">;</span>        <span class="token comment">/* offset of string section     */</span>
    __u32   str_len<span class="token punctuation">;</span>        <span class="token comment">/* length of string section     */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>魔数 <code>magic</code> 是 <code>0xeB9F</code>，它在大端和小端系统中编码顺序不同，因此可以用来检验 BTF 是由大端还是小端目标机器生成的。<code>btf_header</code> 被设计成了可拓展的，当 data blob 生成时，它的<code>hdr_len</code> 等于<code>sizeof(struct btf_header)</code>。</p> <h3 id="_2-1-string-encoding"><a href="#_2-1-string-encoding" class="header-anchor">#</a> 2.1 String Encoding</h3> <p>在上面的结构体中，字符串段第一个字符串一定是一个空字符串。字符串表剩下的部分是其他以空字符为结尾的字符串的拼接。</p> <h3 id="_2-2-type-encoding"><a href="#_2-2-type-encoding" class="header-anchor">#</a> 2.2 Type Encoding</h3> <p>类型 ID  <code>0</code> 预留给了 <code>void</code> 类型。类型部分是顺序解析的，并且分配了类型 ID 给可以解析的类型，是从 <code>1</code> 开始的。目前支持下面这些类型：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_INT</span>            <span class="token expression"><span class="token number">1</span>       </span><span class="token comment">/* Integer      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_PTR</span>            <span class="token expression"><span class="token number">2</span>       </span><span class="token comment">/* Pointer      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_ARRAY</span>          <span class="token expression"><span class="token number">3</span>       </span><span class="token comment">/* Array        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_STRUCT</span>         <span class="token expression"><span class="token number">4</span>       </span><span class="token comment">/* Struct       */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_UNION</span>          <span class="token expression"><span class="token number">5</span>       </span><span class="token comment">/* Union        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_ENUM</span>           <span class="token expression"><span class="token number">6</span>       </span><span class="token comment">/* Enumeration  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_FWD</span>            <span class="token expression"><span class="token number">7</span>       </span><span class="token comment">/* Forward      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_TYPEDEF</span>        <span class="token expression"><span class="token number">8</span>       </span><span class="token comment">/* Typedef      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_VOLATILE</span>       <span class="token expression"><span class="token number">9</span>       </span><span class="token comment">/* Volatile     */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_CONST</span>          <span class="token expression"><span class="token number">10</span>      </span><span class="token comment">/* Const        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_RESTRICT</span>       <span class="token expression"><span class="token number">11</span>      </span><span class="token comment">/* Restrict     */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_FUNC</span>           <span class="token expression"><span class="token number">12</span>      </span><span class="token comment">/* Function     */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_FUNC_PROTO</span>     <span class="token expression"><span class="token number">13</span>      </span><span class="token comment">/* Function Proto       */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_VAR</span>            <span class="token expression"><span class="token number">14</span>      </span><span class="token comment">/* Variable     */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BTF_KIND_DATASEC</span>        <span class="token expression"><span class="token number">15</span>      </span><span class="token comment">/* Section      */</span></span>
</code></pre></div><p>注意类型段不只是纯粹的类型信息，还编码了为 debug 而存在的信息。例如 <code>BTF_KIND_FUNC</code> 就不是一个类型，它代表着一个定义好的程序。每个类型都包含有下面的公共数据：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">btf_type</span> <span class="token punctuation">{</span>
    __u32 name_off<span class="token punctuation">;</span>
    <span class="token comment">/* 32 位的 &quot;info&quot; 变量各位的含义
     * bits  0-15: vlen (e.g. # of struct's members)
     * bits 16-23: unused
     * bits 24-27: kind (e.g. int, ptr, array...etc)
     * bits 28-30: unused
     * bit     31: kind_flag, currently used by
     *             struct, union and fwd
     */</span>
    __u32 info<span class="token punctuation">;</span>
    <span class="token comment">/* &quot;size&quot; is used by INT, ENUM, STRUCT and UNION.
     * &quot;size&quot; tells the size of the type it is describing.
     *
     * &quot;type&quot; is used by PTR, TYPEDEF, VOLATILE, CONST, RESTRICT,
     * FUNC and FUNC_PROTO.
     * &quot;type&quot; is a type_id referring to another type.
     */</span>
    <span class="token keyword">union</span> <span class="token punctuation">{</span>
            __u32 size<span class="token punctuation">;</span>
            __u32 type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>对于特定的类型，公共数据之后就是他们各自独特的数据。 结构体<code>struct btf_type</code>中的<code>name_off</code> 指定了特定类型在字符串表中的偏移。</p> <h2 id="_3-btf-kernel-api"><a href="#_3-btf-kernel-api" class="header-anchor">#</a> 3. BTF Kernel API</h2> <p>下列 bpf 系统调用命令包含了 BTF，除此以外还有很多<a href="https://www.kernel.org/doc/html/latest/bpf/btf.html#btf-kernel-api" target="_blank" rel="noopener noreferrer">其他调用<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li><p>BPF_BTF_LOAD：将一个 blob 的 BTF 数据加载到 kernel 中。</p></li> <li><p>BPF_MAP_CREATE：创建有 BTF 键和类型信息值的映射。</p></li> <li><p>BPF_PROG_LOAD：加载有 BTF 函数和 line 信息的程序。</p></li> <li><p>BPF_BTF_GET_FD_BY_ID：得到一个 BTF 文件描述符 fd。</p></li> <li><p>BPF_OBJ_GET_INFO_BY_FD：该函数将返回 BTF，函数信息，line 信息和其他 BTF 相关信息。</p></li></ul> <p>工作流通常看上去是这样的：</p> <div class="language- extra-class"><pre class="language-text"><code>Application:
    BPF_BTF_LOAD
        |
        v
    BPF_MAP_CREATE and BPF_PROG_LOAD
        |
        V
    ......

Introspection tool:
    ......
    BPF_{PROG,MAP}_GET_NEXT_ID (get prog/map id's)
        |
        V
    BPF_{PROG,MAP}_GET_FD_BY_ID (get a prog/map fd)
        |
        V
    BPF_OBJ_GET_INFO_BY_FD (get bpf_prog_info/bpf_map_info with btf_id)
        |                                     |
        V                                     |
    BPF_BTF_GET_FD_BY_ID (get btf_fd)         |
        |                                     |
        V                                     |
    BPF_OBJ_GET_INFO_BY_FD (get btf)          |
        |                                     |
        V                                     V
    pretty print types, dump func signatures and line info, etc.
</code></pre></div><h2 id="_4-elf-file-format-interface"><a href="#_4-elf-file-format-interface" class="header-anchor">#</a> 4. ELF File Format Interface</h2> <h3 id="_4-1-btf-section"><a href="#_4-1-btf-section" class="header-anchor">#</a> 4.1 .BTF section</h3> <p><code>.BTF</code> 段包含着类型数据和字符串数据。这部分的格式和 <a href="https://www.kernel.org/doc/html/latest/bpf/btf.html#btf-type-and-string-encoding" target="_blank" rel="noopener noreferrer">2. BTF Type and String Encoding<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中描述的一样。</p> <h3 id="_4-2-btf-ext-section"><a href="#_4-2-btf-ext-section" class="header-anchor">#</a> 4.2 .BTF.ext section</h3> <p><code>.BTF.ext</code> 段编码了 func_info 和 line_info，需要使用 loader 才会被加载到内核中。</p> <p><code>.BTF.ext</code> 段的详细文档在文件 <code>tools/lib/bpf/btf.h</code> 和 <code>tools/lib/bpf/btf.c</code>。</p> <p>当前相关的头文件中的定义如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">btf_ext_header</span> <span class="token punctuation">{</span>
    __u16   magic<span class="token punctuation">;</span>
    __u8    version<span class="token punctuation">;</span>
    __u8    flags<span class="token punctuation">;</span>
    __u32   hdr_len<span class="token punctuation">;</span>

    <span class="token comment">/* All offsets are in bytes relative to the end of this header */</span>
    __u32   func_info_off<span class="token punctuation">;</span>
    __u32   func_info_len<span class="token punctuation">;</span>
    __u32   line_info_off<span class="token punctuation">;</span>
    __u32   line_info_len<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>类似于 <code>.BTF</code> 段， 但是不是 <code>string/info</code> 段，它包含的是 <code>func_info</code> 和 <code>line_info</code> 段。</p> <p>可以参考 <a href="https://www.kernel.org/doc/html/latest/bpf/btf.html#bpf-prog-load" target="_blank" rel="noopener noreferrer">3.3 BPF_PROG_LOAD<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 中 <code>func_info</code> 和 <code>line_info</code> 的详细信息。</p> <p><code>func_info</code> 如下组织：</p> <div class="language- extra-class"><pre class="language-text"><code>func_info_rec_size
btf_ext_info_sec for section #1 /* func_info for section #1 */
btf_ext_info_sec for section #2 /* func_info for section #2 */
...
</code></pre></div><p>当 <code>.BTF.ext</code> 生成时，<code>func_info_rec_size</code> 定义了<code>bpf_func_info</code> 结构的大小。在下面定义的 <code>btf_ext_info_sec</code> 是每个特定的 ELF 段中的一系列 <code>func_info</code>：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span> <span class="token class-name">btf_ext_info_sec</span> <span class="token punctuation">{</span>
   __u32   sec_name_off<span class="token punctuation">;</span> <span class="token comment">/* offset to section name */</span>
   __u32   num_info<span class="token punctuation">;</span>
   <span class="token comment">/* Followed by num_info * record_size number of bytes */</span>
   __u8    data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里的 <code>num_info</code> 必须大于 0。</p> <p><code>line_info</code> 如下组织：</p> <div class="language- extra-class"><pre class="language-text"><code>line_info_rec_size
btf_ext_info_sec for section #1 /* line_info for section #1 */
btf_ext_info_sec for section #2 /* line_info for section #2 */
...
</code></pre></div><p>当 <code>.BTF.ext</code> 生成时，<code>line_info_rec_size</code> 定义了 <code>bpf_line_info</code> 结构的大小。</p> <p><code>bpf_func_info-&gt;insn_off</code> 和 <code>bpf_line_info-&gt;insn_off</code> 在内核 API 和 ELF API 中有着不同的阐释。在内核 API 中，<code>insn_off</code> 是指令在 <code>struct bpf_insn</code> 内的偏移。对于 ELF API，<code>insn_off</code> 是相对于段 <code>btf_ext_info_sec-&gt;sec_name_off</code>开始的字节偏移。</p> <h3 id="_4-2-btf-ids-section"><a href="#_4-2-btf-ids-section" class="header-anchor">#</a> 4.2 .BTF_ids section</h3> <p><code>.BTF_ids</code> 段编码了内核中定义的 BTF ID 值。借助头文件 <code>include/linux/btf_ids.h</code> 中定义的宏，可以在内核编译时创建这一段数据。内核代码能够使用下面的语法来创建 BTF ID 值的列表和有序列表：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">BTF_ID_LIST</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span>
<span class="token function">BTF_ID</span><span class="token punctuation">(</span>type1<span class="token punctuation">,</span> name1<span class="token punctuation">)</span>
<span class="token function">BTF_ID</span><span class="token punctuation">(</span>type2<span class="token punctuation">,</span> name2<span class="token punctuation">)</span>
</code></pre></div><p>这将会生成下面的  .BTF_ids 段的布局：</p> <div class="language-assembly extra-class"><pre class="language-text"><code>__BTF_ID__type1__name1__1:
.zero 4
__BTF_ID__type2__name2__2:
.zero 4
</code></pre></div><p><code>u32 list[];</code> 变量被定义来获取列表。</p> <p><code>BTF_ID_UNUSED</code> 宏定义了四个零字节。当我们想要在 BTF_ID_LIST 中定义 unused entry，可以这样做：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">BTF_ID_LIST</span><span class="token punctuation">(</span>bpf_skb_output_btf_ids<span class="token punctuation">)</span>
<span class="token function">BTF_ID</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">,</span> sk_buff<span class="token punctuation">)</span>
BTF_ID_UNUSED
<span class="token function">BTF_ID</span><span class="token punctuation">(</span><span class="token keyword">struct</span><span class="token punctuation">,</span> task_struct<span class="token punctuation">)</span>
</code></pre></div><p><code>BTF_SET_START/END</code> 这一对宏定义了有序列表 BTF ID 值和它们的计数值，它的语法如下：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token function">BTF_SET_START</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span>
<span class="token function">BTF_ID</span><span class="token punctuation">(</span>type1<span class="token punctuation">,</span> name1<span class="token punctuation">)</span>
<span class="token function">BTF_ID</span><span class="token punctuation">(</span>type2<span class="token punctuation">,</span> name2<span class="token punctuation">)</span>
<span class="token function">BTF_SET_END</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span>
</code></pre></div><p>这将会生成下面的  .BTF_ids 段的布局：</p> <div class="language-assembly extra-class"><pre class="language-text"><code>A__BTF_ID__set__set:
.zero 4
__BTF_ID__type1__name1__3:
.zero 4
__BTF_ID__type2__name2__4:
.zero 4
</code></pre></div><p><code>struct btf_id_set set;</code> 变量可以获取到列表。<code>typeX</code> 名字可以是下面的任一项：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">struct</span><span class="token punctuation">,</span> <span class="token keyword">union</span><span class="token punctuation">,</span> <span class="token keyword">typedef</span><span class="token punctuation">,</span> func
</code></pre></div><p>并且可以被用来在解析 BTF ID 值的时候作为过滤器使用。所有的 BTF ID 列表和有序列表都被编译到了 <code>.BTF_ids</code> 段，它在<code>resolve_btfids</code>构建出的内核的链接阶段解析。</p> <h2 id="_5-using-btf"><a href="#_5-using-btf" class="header-anchor">#</a> 5. Using BTF</h2> <h3 id="_5-1-bpftool-map-pretty-print"><a href="#_5-1-bpftool-map-pretty-print" class="header-anchor">#</a> 5.1 bpftool map pretty print</h3> <p>借助 BTF，映射的健值能够以域的形式打印出来，而不是仅仅打印出裸字节。这对于大型的结构或是你的数据结构中各比特位有独立意义时很有价值。例如下面的映射：</p> <div class="language-c extra-class"><pre class="language-c"><code><span class="token keyword">enum</span> <span class="token class-name">A</span> <span class="token punctuation">{</span> A1<span class="token punctuation">,</span> A2<span class="token punctuation">,</span> A3<span class="token punctuation">,</span> A4<span class="token punctuation">,</span> A5 <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">enum</span> <span class="token class-name">A</span> ___A<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">tmp_t</span> <span class="token punctuation">{</span>
     <span class="token keyword">char</span> a1<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span>  a2<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span>  <span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
     __u32 a3<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
     <span class="token keyword">int</span> b<span class="token punctuation">;</span>
     ___A b1<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
     <span class="token keyword">enum</span> <span class="token class-name">A</span> b2<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">bpf_map_def</span> <span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">&quot;maps&quot;</span><span class="token punctuation">)</span> tmpmap <span class="token operator">=</span> <span class="token punctuation">{</span>
     <span class="token punctuation">.</span>type <span class="token operator">=</span> BPF_MAP_TYPE_ARRAY<span class="token punctuation">,</span>
     <span class="token punctuation">.</span>key_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__u32<span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">.</span>value_size <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">tmp_t</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
     <span class="token punctuation">.</span>max_entries <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">BPF_ANNOTATE_KV_PAIR</span><span class="token punctuation">(</span>tmpmap<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">tmp_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以这样使用 bpftool 来优雅地打印：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token property">&quot;key&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;value&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">&quot;a1&quot;</span><span class="token operator">:</span> 0x2<span class="token punctuation">,</span>
          <span class="token property">&quot;a2&quot;</span><span class="token operator">:</span> 0x4<span class="token punctuation">,</span>
          <span class="token property">&quot;a3&quot;</span><span class="token operator">:</span> 0x6<span class="token punctuation">,</span>
          <span class="token property">&quot;b&quot;</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
          <span class="token property">&quot;b1&quot;</span><span class="token operator">:</span> 0x8<span class="token punctuation">,</span>
          <span class="token property">&quot;b2&quot;</span><span class="token operator">:</span> 0xa
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><h3 id="_5-2-bpftool-prog-dump"><a href="#_5-2-bpftool-prog-dump" class="header-anchor">#</a> 5.2 bpftool prog dump</h3> <p>下面的例子展示了 func_info 和 line_info 能够更好地帮助 dump 出内核符号名称、函数原型和 line 信息：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ bpftool prog dump jited pinned /sys/fs/bpf/test_btf_haskv
<span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
int test_long_fname_2<span class="token punctuation">(</span>struct dummy_tracepoint_args * arg<span class="token punctuation">)</span>:
bpf_prog_44a040bf25481309_test_long_fname_2:
<span class="token punctuation">;</span> static int test_long_fname_2<span class="token punctuation">(</span>struct dummy_tracepoint_args *arg<span class="token punctuation">)</span>
   <span class="token number">0</span>:   push   %rbp
   <span class="token number">1</span>:   mov    %rsp,%rbp
   <span class="token number">4</span>:   sub    <span class="token variable">$0x30</span>,%rsp
   b:   sub    <span class="token variable">$0x28</span>,%rbp
   f:   mov    %rbx,0x0<span class="token punctuation">(</span>%rbp<span class="token punctuation">)</span>
  <span class="token number">13</span>:   mov    %r13,0x8<span class="token punctuation">(</span>%rbp<span class="token punctuation">)</span>
  <span class="token number">17</span>:   mov    %r14,0x10<span class="token punctuation">(</span>%rbp<span class="token punctuation">)</span>
  1b:   mov    %r15,0x18<span class="token punctuation">(</span>%rbp<span class="token punctuation">)</span>
  1f:   xor    %eax,%eax
  <span class="token number">21</span>:   mov    %rax,0x20<span class="token punctuation">(</span>%rbp<span class="token punctuation">)</span>
  <span class="token number">25</span>:   xor    %esi,%esi
<span class="token punctuation">;</span> int key <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token number">27</span>:   mov    %esi,-0x4<span class="token punctuation">(</span>%rbp<span class="token punctuation">)</span>
<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arg-<span class="token operator">&gt;</span>sock<span class="token punctuation">)</span>
  2a:   mov    0x8<span class="token punctuation">(</span>%rdi<span class="token punctuation">)</span>,%rdi
<span class="token punctuation">;</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>arg-<span class="token operator">&gt;</span>sock<span class="token punctuation">)</span>
  2e:   <span class="token function">cmp</span>    <span class="token variable">$0x0</span>,%rdi
  <span class="token number">32</span>:   je     0x0000000000000070
  <span class="token number">34</span>:   mov    %rbp,%rsi
<span class="token punctuation">;</span> counts <span class="token operator">=</span> bpf_map_lookup_elem<span class="token punctuation">(</span><span class="token operator">&amp;</span>btf_map, <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span><span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre></div><h3 id="_5-3-verifier-log"><a href="#_5-3-verifier-log" class="header-anchor">#</a> 5.3 Verifier Log</h3> <p>下面的例子展示了 line_info 是如何帮助 debug 验证错误的：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>   /* The code at tools/testing/selftests/bpf/test_xdp_noinline.c
    * is modified as below.
    */
   data <span class="token operator">=</span> <span class="token punctuation">(</span>void *<span class="token punctuation">)</span><span class="token punctuation">(</span>long<span class="token punctuation">)</span>xdp-<span class="token operator">&gt;</span>data<span class="token punctuation">;</span>
   data_end <span class="token operator">=</span> <span class="token punctuation">(</span>void *<span class="token punctuation">)</span><span class="token punctuation">(</span>long<span class="token punctuation">)</span>xdp-<span class="token operator">&gt;</span>data_end<span class="token punctuation">;</span>
   /*
   <span class="token keyword">if</span> <span class="token punctuation">(</span>data + <span class="token number">4</span> <span class="token operator">&gt;</span> data_end<span class="token punctuation">)</span>
           <span class="token builtin class-name">return</span> XDP_DROP<span class="token punctuation">;</span>
   */
   *<span class="token punctuation">(</span>u32 *<span class="token punctuation">)</span>data <span class="token operator">=</span> dst-<span class="token operator">&gt;</span>dst<span class="token punctuation">;</span>

$ bpftool prog load ./test_xdp_noinline.o /sys/fs/bpf/test_xdp_noinline <span class="token builtin class-name">type</span> xdp
    <span class="token punctuation">;</span> data <span class="token operator">=</span> <span class="token punctuation">(</span>void *<span class="token punctuation">)</span><span class="token punctuation">(</span>long<span class="token punctuation">)</span>xdp-<span class="token operator">&gt;</span>data<span class="token punctuation">;</span>
    <span class="token number">224</span>: <span class="token punctuation">(</span><span class="token number">79</span><span class="token punctuation">)</span> r2 <span class="token operator">=</span> *<span class="token punctuation">(</span>u64 *<span class="token punctuation">)</span><span class="token punctuation">(</span>r10 -112<span class="token punctuation">)</span>
    <span class="token number">225</span>: <span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">)</span> r2 <span class="token operator">=</span> *<span class="token punctuation">(</span>u32 *<span class="token punctuation">)</span><span class="token punctuation">(</span>r2 +0<span class="token punctuation">)</span>
    <span class="token punctuation">;</span> *<span class="token punctuation">(</span>u32 *<span class="token punctuation">)</span>data <span class="token operator">=</span> dst-<span class="token operator">&gt;</span>dst<span class="token punctuation">;</span>
    <span class="token number">226</span>: <span class="token punctuation">(</span><span class="token number">63</span><span class="token punctuation">)</span> *<span class="token punctuation">(</span>u32 *<span class="token punctuation">)</span><span class="token punctuation">(</span>r2 +0<span class="token punctuation">)</span> <span class="token operator">=</span> r1
    invalid access to packet, <span class="token assign-left variable">off</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">4</span>, R2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">0</span>,off<span class="token operator">=</span><span class="token number">0</span>,r<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    R2 offset is outside of the packet
</code></pre></div><h2 id="_6-btf-generation"><a href="#_6-btf-generation" class="header-anchor">#</a> 6. BTF Generation</h2> <p>你需要使用最新的 <a href="https://git.kernel.org/pub/scm/devel/pahole/pahole.git/" target="_blank" rel="noopener noreferrer">pahole<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或 8.0 版本以上的 llvm来生成 BTF。</p> <p>pahole 是一个 dwarf2btf 转换器，它还不支持 <code>.BTF.ext</code> 和 <code>btf</code> <code>BTF_KIND_FUNC</code> 类型。例如：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>-bash-4.4$ <span class="token function">cat</span> t.c
struct t <span class="token punctuation">{</span>
  int a:2<span class="token punctuation">;</span>
  int b:3<span class="token punctuation">;</span>
  int c:2<span class="token punctuation">;</span>
<span class="token punctuation">}</span> g<span class="token punctuation">;</span>
-bash-4.4$ gcc -c -O2 -g t.c
-bash-4.4$ pahole -JV t.o
File t.o:
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> STRUCT t <span class="token assign-left variable">kind_flag</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">vlen</span><span class="token operator">=</span><span class="token number">3</span>
        a <span class="token assign-left variable">type_id</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">bitfield_size</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">bits_offset</span><span class="token operator">=</span><span class="token number">0</span>
        b <span class="token assign-left variable">type_id</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">bitfield_size</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">bits_offset</span><span class="token operator">=</span><span class="token number">2</span>
        c <span class="token assign-left variable">type_id</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">bitfield_size</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">bits_offset</span><span class="token operator">=</span><span class="token number">5</span>
<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> INT int <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">bit_offset</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">nr_bits</span><span class="token operator">=</span><span class="token number">32</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span>SIGNED
</code></pre></div><p>llvm 能够直接生成 <code>.BTF</code> 和 <code>.BTF.ext</code>，选项是 -g，目标选项是 bpf。 使用 readelf 工具的 -S 选项能够显示出汇编格式的 BTF 代码：</p> <div class="language-asm extra-class"><pre class="language-text"><code>-bash-4.4$ cat t2.c
typedef int __int32;
struct t2 {
  int a2;
  int (*f2)(char q1, __int32 q2, ...);
  int (*f3)();
} g2;
int main() { return 0; }
int test() { return 0; }
-bash-4.4$ clang -c -g -O2 -target bpf t2.c
-bash-4.4$ readelf -S t2.o
  ......
  [ 8] .BTF              PROGBITS         0000000000000000  00000247
       000000000000016e  0000000000000000           0     0     1
  [ 9] .BTF.ext          PROGBITS         0000000000000000  000003b5
       0000000000000060  0000000000000000           0     0     1
  [10] .rel.BTF.ext      REL              0000000000000000  000007e0
       0000000000000040  0000000000000010          16     9     8
  ......
-bash-4.4$ clang -S -g -O2 -target bpf t2.c
-bash-4.4$ cat t2.s
  ......
        .section        .BTF,&quot;&quot;,@progbits
        .short  60319                   # 0xeb9f
        .byte   1
        .byte   0
        .long   24
        .long   0
        .long   220
        .long   220
        .long   122
        .long   0                       # BTF_KIND_FUNC_PROTO(id = 1)
        .long   218103808               # 0xd000000
        .long   2
        .long   83                      # BTF_KIND_INT(id = 2)
        .long   16777216                # 0x1000000
        .long   4
        .long   16777248                # 0x1000020
  ......
        .byte   0                       # string offset=0
        .ascii  &quot;.text&quot;                 # string offset=1
        .byte   0
        .ascii  &quot;/home/yhs/tmp-pahole/t2.c&quot; # string offset=7
        .byte   0
        .ascii  &quot;int main() { return 0; }&quot; # string offset=33
        .byte   0
        .ascii  &quot;int test() { return 0; }&quot; # string offset=58
        .byte   0
        .ascii  &quot;int&quot;                   # string offset=83
  ......
        .section        .BTF.ext,&quot;&quot;,@progbits
        .short  60319                   # 0xeb9f
        .byte   1
        .byte   0
        .long   24
        .long   0
        .long   28
        .long   28
        .long   44
        .long   8                       # FuncInfo
        .long   1                       # FuncInfo section string offset=1
        .long   2
        .long   .Lfunc_begin0
        .long   3
        .long   .Lfunc_begin1
        .long   5
        .long   16                      # LineInfo
        .long   1                       # LineInfo section string offset=1
        .long   2
        .long   .Ltmp0
        .long   7
        .long   33
        .long   7182                    # Line 7 Col 14
        .long   .Ltmp3
        .long   7
        .long   58
        .long   8206                    # Line 8 Col 14
</code></pre></div> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/12/26 上午11:00:37</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.3ee0229c.js" defer></script><script src="/assets/js/1.489a6dc0.js" defer></script><script src="/assets/js/70.75827cae.js" defer></script><script src="/assets/js/13.e56158ac.js" defer></script>
  </body>
</html>
