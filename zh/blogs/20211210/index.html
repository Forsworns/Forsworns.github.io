<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>工业物联网通讯笔记 | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.c401dc4c.css" as="style"><link rel="preload" href="/assets/js/app.bbd7242b.js" as="script"><link rel="preload" href="/assets/js/1.b822baa6.js" as="script"><link rel="preload" href="/assets/js/5.5b6ccdda.js" as="script"><link rel="preload" href="/assets/js/12.331c1b95.js" as="script"><link rel="prefetch" href="/assets/js/10.70c355fc.js"><link rel="prefetch" href="/assets/js/11.68897c51.js"><link rel="prefetch" href="/assets/js/13.585acca5.js"><link rel="prefetch" href="/assets/js/14.714db20d.js"><link rel="prefetch" href="/assets/js/15.00ff0e6a.js"><link rel="prefetch" href="/assets/js/16.d99681a9.js"><link rel="prefetch" href="/assets/js/17.e83aede1.js"><link rel="prefetch" href="/assets/js/18.c101c0e5.js"><link rel="prefetch" href="/assets/js/19.dcc78c73.js"><link rel="prefetch" href="/assets/js/20.521a8bf7.js"><link rel="prefetch" href="/assets/js/21.7bd51a4c.js"><link rel="prefetch" href="/assets/js/22.5734c1b8.js"><link rel="prefetch" href="/assets/js/23.3019517c.js"><link rel="prefetch" href="/assets/js/24.f10332fd.js"><link rel="prefetch" href="/assets/js/25.8a6166c9.js"><link rel="prefetch" href="/assets/js/26.648e243d.js"><link rel="prefetch" href="/assets/js/27.6fbd40e6.js"><link rel="prefetch" href="/assets/js/28.412744c7.js"><link rel="prefetch" href="/assets/js/29.61bdab72.js"><link rel="prefetch" href="/assets/js/3.462f36af.js"><link rel="prefetch" href="/assets/js/30.502699f8.js"><link rel="prefetch" href="/assets/js/31.e54d3e42.js"><link rel="prefetch" href="/assets/js/32.cb38bcb3.js"><link rel="prefetch" href="/assets/js/33.35a0d2a0.js"><link rel="prefetch" href="/assets/js/34.dfb7a7d8.js"><link rel="prefetch" href="/assets/js/35.d5480fa9.js"><link rel="prefetch" href="/assets/js/36.7dd0e3f3.js"><link rel="prefetch" href="/assets/js/37.ef5781a6.js"><link rel="prefetch" href="/assets/js/38.953c02c4.js"><link rel="prefetch" href="/assets/js/39.74890a7e.js"><link rel="prefetch" href="/assets/js/4.ecd12c72.js"><link rel="prefetch" href="/assets/js/40.227ad2e8.js"><link rel="prefetch" href="/assets/js/41.feb26ce6.js"><link rel="prefetch" href="/assets/js/42.62bbf1aa.js"><link rel="prefetch" href="/assets/js/43.0c221fa7.js"><link rel="prefetch" href="/assets/js/44.9cace7d0.js"><link rel="prefetch" href="/assets/js/45.b212e848.js"><link rel="prefetch" href="/assets/js/46.389632d3.js"><link rel="prefetch" href="/assets/js/47.2c698c81.js"><link rel="prefetch" href="/assets/js/48.a5fd78b8.js"><link rel="prefetch" href="/assets/js/49.a9e74e3e.js"><link rel="prefetch" href="/assets/js/50.5f58b67b.js"><link rel="prefetch" href="/assets/js/51.648fc41d.js"><link rel="prefetch" href="/assets/js/52.82fa340f.js"><link rel="prefetch" href="/assets/js/53.d2bd7567.js"><link rel="prefetch" href="/assets/js/54.0e48d9bf.js"><link rel="prefetch" href="/assets/js/55.df8d58d2.js"><link rel="prefetch" href="/assets/js/56.628aafb9.js"><link rel="prefetch" href="/assets/js/57.70a594da.js"><link rel="prefetch" href="/assets/js/58.7cee13f9.js"><link rel="prefetch" href="/assets/js/59.c6a690f4.js"><link rel="prefetch" href="/assets/js/6.38321375.js"><link rel="prefetch" href="/assets/js/60.92f8a773.js"><link rel="prefetch" href="/assets/js/61.b9000fcd.js"><link rel="prefetch" href="/assets/js/62.b24c5821.js"><link rel="prefetch" href="/assets/js/63.d8ac060f.js"><link rel="prefetch" href="/assets/js/64.e408e5a8.js"><link rel="prefetch" href="/assets/js/65.67665fed.js"><link rel="prefetch" href="/assets/js/66.bdaea6cf.js"><link rel="prefetch" href="/assets/js/67.cf2ee58d.js"><link rel="prefetch" href="/assets/js/68.49432d26.js"><link rel="prefetch" href="/assets/js/69.aba46e78.js"><link rel="prefetch" href="/assets/js/7.ab777b2a.js"><link rel="prefetch" href="/assets/js/70.42396fff.js"><link rel="prefetch" href="/assets/js/71.170b2f05.js"><link rel="prefetch" href="/assets/js/72.d017290f.js"><link rel="prefetch" href="/assets/js/73.9dc1131c.js"><link rel="prefetch" href="/assets/js/74.24563352.js"><link rel="prefetch" href="/assets/js/75.2a81c0ce.js"><link rel="prefetch" href="/assets/js/8.6e1963ab.js"><link rel="prefetch" href="/assets/js/9.197a57a3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c401dc4c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20211210/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20211210/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#igh-ethercat-开源主站安装及测试">IGH EtherCAT 开源主站安装及测试</a></li><li><a href="#基于-ethercat-的应用">基于 EtherCAT 的应用</a></li><li><a href="#常见-esc-设备">常见 ESC 设备</a></li><li><a href="#ethercat-主从环形架构">EtherCAT 主从环形架构</a></li><li><a href="#帧结构">帧结构</a></li><li><a href="#状态机">状态机</a></li><li><a href="#ethercat-取址">EtherCAT 取址</a></li><li><a href="#soes-库工作内容">SOES 库工作内容</a></li><li><a href="#soes-库设计">SOES 库设计</a><ul><li><a href="#ecat-slv-c-实现-slave-api">ecat_slv.c 实现 slave API</a></li><li><a href="#特别需要注意">特别需要注意</a></li><li><a href="#eep-c">eep.c</a></li><li><a href="#esc-coe-c">esc_coe.c</a></li><li><a href="#esc-eoe-c">esc_eoe.c</a></li><li><a href="#esc-foe-c">esc_foe.c</a></li><li><a href="#eep-c">eep.c</a></li><li><a href="#esc-c">esc.c</a></li><li><a href="#options-h">options.h</a></li></ul></li><li><a href="#soes-样例">SOES 样例</a></li><li><a href="#soes-中的一些数据规定">SOES 中的一些数据规定</a><ul><li><a href="#sii-pdo-和-esi-pdo">SII-PDO 和 ESI-PDO</a></li></ul></li><li><a href="#od">OD</a><ul><li><a href="#sm-事件类型">SM 事件类型</a></li></ul></li><li><a href="#实现">实现</a></li></ul></div><p></p> <h1 id="工业物联网通讯笔记"><a href="#工业物联网通讯笔记" class="header-anchor">#</a> 工业物联网通讯笔记</h1> <h1 id="ethercat"><a href="#ethercat" class="header-anchor">#</a> EtherCAT</h1> <p><a href="D:/aiit/ethercat/ethercat_esc_datasheet_sec1_technology_2i3.pdf">专有缩写</a></p> <p>思路：使用已有的网络连接透明传输构造EtherCAT帧的报文段。</p> <h2 id="igh-ethercat-开源主站安装及测试"><a href="#igh-ethercat-开源主站安装及测试" class="header-anchor">#</a> IGH EtherCAT 开源主站安装及测试</h2> <p>参考 <a href="https://zhuanlan.zhihu.com/p/150957429" target="_blank" rel="noopener noreferrer">知乎专栏<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>安装好后可以看到一系列参数
<img src="/assets/img/ethercat_tool.42460f0c.png" alt="img"></p> <p>如果开机没自动起来需要手动<code>/etc/init.d/ethercat start</code>。</p> <h2 id="基于-ethercat-的应用"><a href="#基于-ethercat-的应用" class="header-anchor">#</a> 基于 EtherCAT 的应用</h2> <p><img src="/assets/img/application_layer_protocols.d97db174.png" alt="img"></p> <h2 id="常见-esc-设备"><a href="#常见-esc-设备" class="header-anchor">#</a> 常见 ESC 设备</h2> <p><img src="/assets/img/ethercat_communication_modules.f5bbb220.png" alt="img"></p> <h2 id="ethercat-主从环形架构"><a href="#ethercat-主从环形架构" class="header-anchor">#</a> EtherCAT 主从环形架构</h2> <p><img src="/assets/img/EthercatOperatingPrinciple.669e820e.svg" alt=""></p> <p><img src="/assets/img/Architecture.d77088f0.png" alt=""></p> <h2 id="帧结构"><a href="#帧结构" class="header-anchor">#</a> 帧结构</h2> <p><img src="/assets/img/ethercat_frame_datagram.8606699c.png" alt=""></p> <h2 id="状态机"><a href="#状态机" class="header-anchor">#</a> 状态机</h2> <p><img src="/assets/img/ethercat_state_machine_ESM.2720e449.png" alt=""></p> <p>下方介绍的 SOES 库在 <code>esc.h</code> 中定义了状态和状态的转移：</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESCinit</span>                  <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESCpreop</span>                 <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESCboot</span>                  <span class="token expression"><span class="token number">0x03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESCsafeop</span>                <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESCop</span>                    <span class="token expression"><span class="token number">0x08</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESCerror</span>                 <span class="token expression"><span class="token number">0x10</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_TO_INIT</span>             <span class="token expression"><span class="token number">0x11</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_TO_PREOP</span>            <span class="token expression"><span class="token number">0x21</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_TO_BOOT</span>             <span class="token expression"><span class="token number">0x31</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_TO_SAFEOP</span>           <span class="token expression"><span class="token number">0x41</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">INIT_TO_OP</span>               <span class="token expression"><span class="token number">0x81</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PREOP_TO_INIT</span>            <span class="token expression"><span class="token number">0x12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PREOP_TO_PREOP</span>           <span class="token expression"><span class="token number">0x22</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PREOP_TO_BOOT</span>            <span class="token expression"><span class="token number">0x32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PREOP_TO_SAFEOP</span>          <span class="token expression"><span class="token number">0x42</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PREOP_TO_OP</span>              <span class="token expression"><span class="token number">0x82</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOOT_TO_INIT</span>             <span class="token expression"><span class="token number">0x13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOOT_TO_PREOP</span>            <span class="token expression"><span class="token number">0x23</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOOT_TO_BOOT</span>             <span class="token expression"><span class="token number">0x33</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOOT_TO_SAFEOP</span>           <span class="token expression"><span class="token number">0x43</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BOOT_TO_OP</span>               <span class="token expression"><span class="token number">0x83</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SAFEOP_TO_INIT</span>           <span class="token expression"><span class="token number">0x14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SAFEOP_TO_PREOP</span>          <span class="token expression"><span class="token number">0x24</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SAFEOP_TO_BOOT</span>           <span class="token expression"><span class="token number">0x34</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SAFEOP_TO_SAFEOP</span>         <span class="token expression"><span class="token number">0x44</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SAFEOP_TO_OP</span>             <span class="token expression"><span class="token number">0x84</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OP_TO_INIT</span>               <span class="token expression"><span class="token number">0x18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OP_TO_PREOP</span>              <span class="token expression"><span class="token number">0x28</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OP_TO_BOOT</span>               <span class="token expression"><span class="token number">0x38</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OP_TO_SAFEOP</span>             <span class="token expression"><span class="token number">0x48</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OP_TO_OP</span>                 <span class="token expression"><span class="token number">0x88</span></span></span>
</code></pre></div><p><img src="/assets/img/ESM_transitions.e0d52235.png" alt=""></p> <h2 id="ethercat-取址"><a href="#ethercat-取址" class="header-anchor">#</a> EtherCAT 取址</h2> <p><img src="/assets/img/address.7916d7a8.png" alt=""> <img src="/assets/img/address_fmmu.27b9c0f6.png" alt=""></p> <h1 id="soes"><a href="#soes" class="header-anchor">#</a> SOES</h1> <p>开源 EtherCAT Slave 实现，对应有 SOEM 是 EtherCAT Master 实现。
通过配置文件配置 ESC，之后通过 <code>ESC_read</code> 和 <code>ESC_write</code> 与 ESC 交互数据，由 ESC 负责接收发送。这两个函数是硬件相关的，需要针对硬件实现（参考 <code>hal/linux-lan9252</code> 对 lan9252 的实现，<code>rt-kernel-xmc4/esc_hw.h</code> 中 <code>esc_registers</code> 定义，把指针 <code>esc_registers_t * ecat0</code> 指向了 <code>ECAT0_BASE</code>，即寄存器的起始地址）。</p> <h2 id="soes-库工作内容"><a href="#soes-库工作内容" class="header-anchor">#</a> SOES 库工作内容</h2> <ul><li>ESC（EtherCAT Slave Controller）硬件初始化
<ul><li>ESC 重置</li> <li>ESC 初始化，init SPI</li> <li>等待 ESC 初始化成功（轮询 ESC 的 DL 寄存器）</li></ul></li> <li>软件初始化
<ul><li>重置 Slave 状态（覆写 ESC AL 状态寄存器）</li> <li>重置错误信息 （清除 ESC AL 错误码寄存器）</li> <li>中止之前的应用层程序（可能有 SyncManager 在 block，等待接收EtherCAT 包）</li></ul></li> <li>应用
<ul><li>应用层事件（ALevent）处理，ALevent 携带了 ALControl 或 SyncManagers 的更改信息。ALControl 是用来控制状态改变的，SyncManagers 是用来将 EtherCAT 的改动写入到本地内存中的。</li> <li>ESC_state 用来处理状态，例如状态变化、错误处理、告知接收到信息。</li> <li>Mailbox handler，提供应用层协议使用的 mailboxes。</li> <li>在 mailbox 中，也会检查是否需要使用特定协议的 handler 来处理接收/发送的数据。</li></ul></li></ul> <h2 id="soes-库设计"><a href="#soes-库设计" class="header-anchor">#</a> SOES 库设计</h2> <h3 id="ecat-slv-c-实现-slave-api"><a href="#ecat-slv-c-实现-slave-api" class="header-anchor">#</a> <code>ecat_slv.c</code> 实现 slave API</h3> <h4 id="全局变量"><a href="#全局变量" class="header-anchor">#</a> 全局变量</h4> <ul><li>定义全局变量 <code>_ESCvar</code> 类型（定义在 <code>esc.h</code> 中）的 <code>ESCvar</code>，负责存储 ESC 状态信息。</li> <li>全局变量 <code>MBX</code> 是 Mailbox，存储 <code>MBXBUFFERS * MAX(MBXSIZE,MBXSIZEBOOT)</code> 规模的 <code>uint8_t</code> 数据；<code>_MBXcontrol</code> 则是 Mailbox 对应的 Controller。</li> <li>全局变量 <code>_SMmap</code> 类型的 <code>SMmap2</code> 和 <code>SMmap3</code> 分别映射输出、输入的 SM（SyncManager）。</li></ul> <h4 id="初始化"><a href="#初始化" class="header-anchor">#</a> 初始化</h4> <p><code>ecat_slv_init</code> 接收 <code>esc_cfg_t</code> 类型的设置选项进行初始化。</p> <h4 id="应用处理"><a href="#应用处理" class="header-anchor">#</a> 应用处理</h4> <p><code>ecat_slv</code> 是一个需要周期性调用的函数，它内部会调用 ecat_slv_poll 和 DIG_process。前者 poll EtherCAT event，检查状态机，检查 SM，检查 Mailbox，如果收到数据就根据编译选项依次检查是否为 CoE（CAN over EtherCAT）、EoE（EtherNet over EtherCAT）、FoE （File over EtherCAT），最后检查是否为 XoE（错误的报文）应用，视需要处理 eeprom；后者更新局部变量，读入收到的 EtherCAT 帧，写出发送帧。</p> <h4 id="应用相关"><a href="#应用相关" class="header-anchor">#</a> 应用相关</h4> <p><code>DIG_process</code> 会阅读、修改 <code>ESCvar</code>。首先检查是否处于可以修改 Output 信息的的状态下，即 Operational state。</p> <h5 id="output-esc-视角的-ouput-即用户态的接收"><a href="#output-esc-视角的-ouput-即用户态的接收" class="header-anchor">#</a> Output：ESC 视角的 Ouput，即用户态的接收</h5> <ul><li>如果我们在 OP 状态下，我们能够阅读 3-buffer SM 中被映射到输出的 SM 中的 PDO（Process Data Objects）数据, 默认的是 SyncManager2。我们阅读 SM2 的 ESC RAM 地址，存储到本地。我们将会读入 RXPDOsize bytes 的数据来触发一个完整的 SM 读操作。</li> <li>在局部变量被更新后，我们将本地的 PDO 变量传递到用户应用中。</li> <li>这个函数也包含了 watchdog 机制的实现，如果触发了它，会关闭输出，状态机改变到 Safe Operational。会更新 AlError 信息，告知 Master 发生了错误。</li></ul> <h5 id="input-esc-视角的-input-即用户态的发送"><a href="#input-esc-视角的-input-即用户态的发送" class="header-anchor">#</a> Input：ESC 视角的 Input，即用户态的发送</h5> <ul><li>和输出类似，是反过来的，但是更加简单。即使是在 Safe Operational 状态下也会继续更新输入信息。</li> <li>首先阅读用户应用数据，写入到本地的 PDO 变量中。在局部变量刷新后，把他们写入到 Input 对应的 SM，一般是 SyncManager3。这样就可以使用用户应用数据更新 ESC 的 RAM了。</li></ul> <h3 id="特别需要注意"><a href="#特别需要注意" class="header-anchor">#</a> 特别需要注意</h3> <p>在实现应用的时候，必须自己定义回调函数 <code>cb_get_inputs</code> 和 <code>cb_get_outputs</code>，这两者声明在 <code>ecat_slv.h</code> 中，会在 <code>DIG_process</code> 中获取输入和输出时分别触发。</p> <p><code>esc_cfg_t</code> 设置项中也有定义不同的hook，是可选的。</p> <h3 id="eep-c"><a href="#eep-c" class="header-anchor">#</a> <code>eep.c</code></h3> <p>ESI EEPROM 模拟模块。</p> <h3 id="esc-coe-c"><a href="#esc-coe-c" class="header-anchor">#</a> <code>esc_coe.c</code></h3> <h3 id="esc-eoe-c"><a href="#esc-eoe-c" class="header-anchor">#</a> <code>esc_eoe.c</code></h3> <p>ESI EEPROM 模拟模块。</p> <h3 id="esc-foe-c"><a href="#esc-foe-c" class="header-anchor">#</a> <code>esc_foe.c</code></h3> <p>ESI EEPROM 模拟模块。</p> <h3 id="eep-c-2"><a href="#eep-c-2" class="header-anchor">#</a> <code>eep.c</code></h3> <p>ESI EEPROM 模拟模块。</p> <h3 id="esc-c"><a href="#esc-c" class="header-anchor">#</a> <code>esc.c</code></h3> <p>全局变量：
<code>ESC_MBX1_sma</code> sm address？（参考<code>ESC_write (ESC_MBX1_sma, MBh, ESC_MBXHSIZE + length);</code>）
<code>ESC_MBX1_sml</code> sm length?
<code>ESC_MBX1_sme</code> sm end?
<code>ESC_MBX1_smc</code> sm controller?</p> <p>函数：
<code>ESC_xoeprocess</code> 负责处理错误的帧。
<code>ESC_read</code> 写 ESC 寄存器。
<code>ESC_write</code> 写 ESC 寄存器。
<code>ESC_ALeventmaskread</code> 读 ALeventMask 寄存器。
<code>ESC_ALeventmaskwrite</code> 写 ALeventMask 寄存器。</p> <p><code>ESC_outreqbuffer</code> 从全局的<code>MBXcontrol</code>中寻找请求发送到 outbox 的mailbox 的下标。
<code>ESC_mbxprocess</code> 是实现 mailbox protocol 的，负责 mailbox 的读、发送、重传、mailbox full event 处理。
<code>ESC_writembx</code>将 <code>esc_slv.c</code> 中的全局变量 MBX 中 <code>ESC_outreqbuffer</code> 查询到的 mailbox 发送出去。</p> <p>mailbox 的状态：</p> <ul><li>0 : idle</li> <li>1 : claimed for inbox</li> <li>2 : claimed for outbox</li> <li>3 : request post outbox</li> <li>4 : outbox posted not send</li> <li>5 : backup outbox</li> <li>6 : mailbox needs to be transmitted again
分别对应宏</li></ul> <div class="language-C extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MBXstate_idle</span>                   <span class="token expression"><span class="token number">0x00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MBXstate_inclaim</span>                <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MBXstate_outclaim</span>               <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MBXstate_outreq</span>                 <span class="token expression"><span class="token number">0x03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MBXstate_outpost</span>                <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MBXstate_backup</span>                 <span class="token expression"><span class="token number">0x05</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MBXstate_again</span>                  <span class="token expression"><span class="token number">0x06</span></span></span>
</code></pre></div><h3 id="options-h"><a href="#options-h" class="header-anchor">#</a> <code>options.h</code></h3> <p>默认的宏定义。用户程序可以通过定义 <code>ecat_options.h</code> 覆盖他们。</p> <h2 id="soes-样例"><a href="#soes-样例" class="header-anchor">#</a> SOES 样例</h2> <p>目录下的 <code>rtl_slave_demo</code> 是一个简短的led亮灯示例。在这个例子中，SOES 相关 API 的应用例子封装在了 <code>void soes (void *arg)</code> 函数中通过一个线程执行，另一个线程去读取 ESCvar.ALstatus 状态和 ESCvar.ALerror 错误码，根据状态机的状态和错误码来点亮 LED，设定闪烁频次。</p> <p><code>rtl_lwip_eoe</code> 是一个基于 lwip 的 EtherNet over EtherCAT 示例。<code>mbox_fetch_tmo/mbox_post_tmo</code> 是带 timeout（tmo）的 mailbox fetch/post API。</p> <h2 id="soes-中的一些数据规定"><a href="#soes-中的一些数据规定" class="header-anchor">#</a> SOES 中的一些数据规定</h2> <h3 id="sii-pdo-和-esi-pdo"><a href="#sii-pdo-和-esi-pdo" class="header-anchor">#</a> SII-PDO 和 ESI-PDO</h3> <p>为了通过总线获取 SII-EEPROM（Slave Information Interface）和 ESI（EtherCAT Slave Information, 存储在 SII-EEPROM），规定了相关数据结构。其中：必须的参数，mandatory 用 M 代表；可选的参数，optional 用 O 代表。</p> <p><img src="/assets/img/pdo1.f60ff31b.png" alt="img"></p> <p><img src="/assets/img/pdo2.00706bcf.png" alt="img"></p> <h2 id="od"><a href="#od" class="header-anchor">#</a> OD</h2> <p>同时，对于比较复杂的 Slave 还可以定义可选的 Object Dictionary（OD）。可以在 CoE 中使用它，它遵循 CANopen DS301。</p> <ul><li>0x0000 - 0x0FFF, Data Type Area</li> <li>0x1000 - 0x1FFF, Communication Area
<ul><li>RxPDO , 0x1600 - 0x17FF</li> <li>TxPDO , 0x1A00 - 0x1BFF</li></ul></li> <li>0x2000 - 0x5FFF, Manufacture specific area</li> <li>0x6000 - 0x6FFF, Input area</li> <li>0x7000 - 0x7FFF, Output area</li> <li>0x8000 - 0x8FFF, Configuration area</li> <li>0x9000 - 0x9FFF, Information area</li> <li>0xA000 - 0xAFFF, Diagnosis Area</li> <li>0xB000 - 0xBFFF, Service Transfer Area</li> <li>0xC000 - 0xEFFF, Reserved Area</li> <li>0xF000 - 0xFFFF, Device Area</li></ul> <h3 id="sm-事件类型"><a href="#sm-事件类型" class="header-anchor">#</a> SM 事件类型</h3> <ul><li>0, Unused</li> <li>1, MailBox Receive, master to slave</li> <li>2, MailBox Send, slave to master</li> <li>3, Processdata output, master to slave</li> <li>4, Processdata input, slave to master</li></ul> <h2 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h2> <p>HFA21 支持硬件offloading，上层透明。用透传来写的话，只需要在 UDP datagram 里去构造 EtherCAT 包，当然这样没有 ECS，而且在传输层之上，当作应用层协议来写了，也就不具备快速的on-the-fly能力了。</p> <p>为了方便做解析，这么写的（具体定义参考上面 EtherCAT 帧结构的图解）</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdint.h&gt;</span></span>

<span class="token comment">// gcc6 以上支持强制指定大小端（big-endian、little-endian、default）</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BIG_ENDIAN</span> <span class="token expression"><span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">,</span> <span class="token function">scalar_storage_order</span><span class="token punctuation">(</span></span><span class="token string">&quot;big-endian&quot;</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ETHERCAT_PORT</span> <span class="token expression"><span class="token number">34980</span> </span><span class="token comment">// 0x88A4</span></span>

<span class="token keyword">typedef</span> BIG_ENDIAN <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint16_t</span> type <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> res <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> length <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> EcatHeader<span class="token punctuation">,</span> <span class="token operator">*</span>EcatHeaderPtr<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> BIG_ENDIAN <span class="token keyword">union</span>
<span class="token punctuation">{</span>
    BIG_ENDIAN <span class="token keyword">struct</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> position<span class="token punctuation">;</span>
        <span class="token class-name">uint16_t</span> offset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> position<span class="token punctuation">;</span> <span class="token comment">// Position Addressing</span>
    BIG_ENDIAN <span class="token keyword">struct</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">uint16_t</span> address<span class="token punctuation">;</span>
        <span class="token class-name">uint16_t</span> offset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> node<span class="token punctuation">;</span> <span class="token comment">// Node Addressing</span>
    <span class="token class-name">uint32_t</span> logical<span class="token punctuation">;</span>
<span class="token punctuation">}</span> EcatAddress<span class="token punctuation">,</span> <span class="token operator">*</span>EcatAddressPtr<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> cmd<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> idx<span class="token punctuation">;</span>
    EcatAddress address<span class="token punctuation">;</span>
    BIG_ENDIAN <span class="token keyword">union</span>
    <span class="token punctuation">{</span>
        BIG_ENDIAN <span class="token keyword">struct</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">uint16_t</span> length <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
            <span class="token class-name">uint16_t</span> r <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token class-name">uint16_t</span> c <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token class-name">uint16_t</span> m <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// followed by more datagrams or not</span>
        <span class="token punctuation">}</span> s<span class="token punctuation">;</span>
        <span class="token class-name">uint16_t</span> u<span class="token punctuation">;</span> <span class="token comment">// for easy parse</span>
    <span class="token punctuation">}</span> suffix<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> irq <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> EcatDataHeader<span class="token punctuation">,</span> <span class="token operator">*</span>EcatDataHeaderPtr<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    EcatDataHeader header<span class="token punctuation">;</span> <span class="token comment">// 10 bytes</span>
    <span class="token class-name">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>         <span class="token comment">// 0-1486 bytes</span>
    <span class="token class-name">uint16_t</span> work_counter<span class="token punctuation">;</span> <span class="token comment">// 2bytes</span>
<span class="token punctuation">}</span> EcatDatagram<span class="token punctuation">,</span> <span class="token operator">*</span>EcatDatagramPtr<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    EcatHeader header<span class="token punctuation">;</span>
    EcatDatagram datagram<span class="token punctuation">;</span>
<span class="token punctuation">}</span> EcatData<span class="token punctuation">,</span> <span class="token operator">*</span>EcatDataPtr<span class="token punctuation">;</span>
</code></pre></div><p>用 union 来包裹位域，否则要挨个解析，即依次将相同的数字赋值给占用不同位域的变量，而用了union只需要赋值给对应的 <code>EcatDataHeader.suffix.u</code>。整个强制指定为符合网络序的大端，否则需要手动处理主机序的转换。
比如，假设收到的帧中， <code>EcatDataHeader.suffix</code> 对应的值是0x12345678。
当前可以这么赋值：</p> <div class="language-C extra-class"><pre class="language-c"><code>EcatDataHeader header<span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> suffix <span class="token operator">=</span> <span class="token number">0x1234</span><span class="token punctuation">;</span>
header<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>u <span class="token operator">=</span> suffix<span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%x,%x,%x,%x&quot;</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>s<span class="token punctuation">.</span>length<span class="token punctuation">,</span> header<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>s<span class="token punctuation">.</span>r<span class="token punctuation">,</span>header<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>s<span class="token punctuation">.</span>c<span class="token punctuation">,</span>header<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>s<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>但是如果</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{</span>
    <span class="token class-name">uint8_t</span> cmd<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> idx<span class="token punctuation">;</span>
    EcatAddress address<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> length <span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> r <span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> c <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> m <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// followed by more datagrams or not</span>
    <span class="token class-name">uint16_t</span> irq <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> EcatDataHeader<span class="token punctuation">,</span> <span class="token operator">*</span>EcatDataHeaderPtr<span class="token punctuation">;</span>

EcatDataHeader header<span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> suffix <span class="token operator">=</span> <span class="token number">0x1234</span><span class="token punctuation">;</span>
header<span class="token punctuation">.</span>length <span class="token operator">=</span> suffix<span class="token punctuation">;</span>
header<span class="token punctuation">.</span>r <span class="token operator">=</span> suffix<span class="token punctuation">;</span>
header<span class="token punctuation">.</span>c <span class="token operator">=</span> suffix<span class="token punctuation">;</span>
header<span class="token punctuation">.</span>m <span class="token operator">=</span> suffix<span class="token punctuation">;</span>
<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%x,%x,%x,%x&quot;</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span>length<span class="token punctuation">,</span> header<span class="token punctuation">.</span>r<span class="token punctuation">,</span>header<span class="token punctuation">.</span>c<span class="token punctuation">,</span>header<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>此时还会有大小端的问题，需要用 <code>htonl</code> 等转换。</p> <h1 id="s7-库"><a href="#s7-库" class="header-anchor">#</a> S7 库</h1> <p>关于 S7，有几篇不错的博客：</p> <p><a href="http://gmiru.com/article/s7comm/" target="_blank" rel="noopener noreferrer">The Siemens S7 Communication - Part 1 General Structure<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://gmiru.com/article/s7comm-part2/" target="_blank" rel="noopener noreferrer">The Siemens S7 Communication - Part 2 Job Requests and Ack Data<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://www.jianshu.com/p/0e9f74d683b4" target="_blank" rel="noopener noreferrer">上面两篇博客的翻译<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://blog.nsfocus.net/s7comm-readszl-0427/" target="_blank" rel="noopener noreferrer">对 ReadSZL 的详解<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，SZL 是系统状态列表（德语：System-ZustandsListen，英语：System Status Lists），用于描述PLC的当前状态，只能读取不能修改。</p> <p>注意在 wireshark 中可以用 <code>s7comm</code> 或 <code>tcp.port == 102</code> 来过滤 S7 的包，但是前者只能在展示时起效，后者可以在过滤时起效。</p> <p>该库是 Siemens 给自家 PLC 写的通讯库，使用时需要指定 IP、port、Rack，Slot。</p> <p>具体地：</p> <p>建立连接是用的TSnap7Peer的PeerConnect函数，调用了TIsoTcpSocket的 isoConnect。</p> <p>s7_isotcp.cpp
里面定义了TIsoTcpSocket的构造函数，设置的Timeout是3000，tcp port是用的102端口。（Rack默认是0，Slot默认是2，我们的设备Slot需要设置成1。）。</p> <p>发送过去的载荷是在TIsoTcpSocket 的 BuildControlPDU 里构造的 FControlPDU。</p> <p>Client 的具体的 Operation 都是通过 TSnap7Job 结构体代理的，定义在 s7_micro_client 中。在PerformOperation() 被调用后，就会填充它。</p> <p>填充方法是，比如TSnap7MicroClient::opGetOrderCode()中，在opReadSZL()中写入到TS7Buffer opData里将 void* 的TSnap7Job::pData 转换成目标类型的.。然后再从这个 TS7Buffer 里读取出来复制到TSnap7Job::pData的各个成员里。</p> <p>opReadMultiVars/opWriteMultiVars 会自动忽略掉Area不是DB的 DBNumber。把请求的DBNumber都填充到ReqParams里，随着首部PS7ReqHeader TSnap7Peer::PDUH_out 作为PDU的数据单元。</p> <p>opDBGet/opDBFill 调用了 opReadArea/opWriteArea。</p> <p>所有的operation都是通过PerformOperation()去管理的，而每个operation中，都是通过TIsoTcpSocket::isoExchangeBuffer来完成的发送和接收，这个函数可以接收data来修改发送出去的PDU.payload，如果接收了空指针（一半都会传入0），则会使用默认的 PDU.payload。</p> <p>接收到的数据会存储到ResData中，并复制到Target结束（Target是Job.pData偏移后 byte 类型的指针）。</p> <p>主要类的继承关系：</p> <p><img src="s7socket.png" alt="img"></p> <p><img src="s7server.png" alt="img"></p> <p>测试情况：</p> <p><img src="/assets/img/multiread.2fd10fcc.png" alt="img"></p> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/2/24 下午4:48:19</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.bbd7242b.js" defer></script><script src="/assets/js/1.b822baa6.js" defer></script><script src="/assets/js/5.5b6ccdda.js" defer></script><script src="/assets/js/12.331c1b95.js" defer></script>
  </body>
</html>
