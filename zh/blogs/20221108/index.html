<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mimic Generic Specialization in Rust | Blog</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdn.staticfile.org/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdn.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/autoload.js"></script>
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.5f87357d.css" as="style"><link rel="preload" href="/assets/js/app.8a71fa9b.js" as="script"><link rel="preload" href="/assets/js/1.0d3f5407.js" as="script"><link rel="preload" href="/assets/js/32.a4decb12.js" as="script"><link rel="preload" href="/assets/js/13.0b8f69bf.js" as="script"><link rel="prefetch" href="/assets/js/10.f185e824.js"><link rel="prefetch" href="/assets/js/11.5b47cb29.js"><link rel="prefetch" href="/assets/js/12.1aefa809.js"><link rel="prefetch" href="/assets/js/14.65c55c5b.js"><link rel="prefetch" href="/assets/js/15.6f479178.js"><link rel="prefetch" href="/assets/js/16.be0357cf.js"><link rel="prefetch" href="/assets/js/17.b23d5d24.js"><link rel="prefetch" href="/assets/js/18.a713061d.js"><link rel="prefetch" href="/assets/js/19.7cbdd573.js"><link rel="prefetch" href="/assets/js/20.2c8d9022.js"><link rel="prefetch" href="/assets/js/21.f832c1d5.js"><link rel="prefetch" href="/assets/js/22.d849a848.js"><link rel="prefetch" href="/assets/js/23.c7b0f8af.js"><link rel="prefetch" href="/assets/js/24.5cfa3357.js"><link rel="prefetch" href="/assets/js/25.5734f2a9.js"><link rel="prefetch" href="/assets/js/26.ec1f02c1.js"><link rel="prefetch" href="/assets/js/27.04ed5c55.js"><link rel="prefetch" href="/assets/js/28.59003c9a.js"><link rel="prefetch" href="/assets/js/29.a1596266.js"><link rel="prefetch" href="/assets/js/3.7e143bb3.js"><link rel="prefetch" href="/assets/js/30.2a986820.js"><link rel="prefetch" href="/assets/js/31.60fb3447.js"><link rel="prefetch" href="/assets/js/33.19c13d91.js"><link rel="prefetch" href="/assets/js/34.860038b3.js"><link rel="prefetch" href="/assets/js/35.9ff8afd6.js"><link rel="prefetch" href="/assets/js/36.98355663.js"><link rel="prefetch" href="/assets/js/37.5d6bfae5.js"><link rel="prefetch" href="/assets/js/38.410b61f3.js"><link rel="prefetch" href="/assets/js/39.2b6de04b.js"><link rel="prefetch" href="/assets/js/4.a6d4f924.js"><link rel="prefetch" href="/assets/js/40.380a085f.js"><link rel="prefetch" href="/assets/js/41.40b7b75e.js"><link rel="prefetch" href="/assets/js/42.28f14454.js"><link rel="prefetch" href="/assets/js/43.4d0cea48.js"><link rel="prefetch" href="/assets/js/44.9059c3cf.js"><link rel="prefetch" href="/assets/js/45.a469afec.js"><link rel="prefetch" href="/assets/js/46.47f55f41.js"><link rel="prefetch" href="/assets/js/47.27371930.js"><link rel="prefetch" href="/assets/js/48.e3782d4a.js"><link rel="prefetch" href="/assets/js/49.2a7cec5c.js"><link rel="prefetch" href="/assets/js/5.9d9ce47c.js"><link rel="prefetch" href="/assets/js/50.bad172c2.js"><link rel="prefetch" href="/assets/js/51.6ca67f11.js"><link rel="prefetch" href="/assets/js/52.07534a08.js"><link rel="prefetch" href="/assets/js/53.fc2e98e5.js"><link rel="prefetch" href="/assets/js/54.ae56cb99.js"><link rel="prefetch" href="/assets/js/55.caa38232.js"><link rel="prefetch" href="/assets/js/56.3895da78.js"><link rel="prefetch" href="/assets/js/57.c618137d.js"><link rel="prefetch" href="/assets/js/58.83219ae3.js"><link rel="prefetch" href="/assets/js/59.3f6fda66.js"><link rel="prefetch" href="/assets/js/6.ede0ec8a.js"><link rel="prefetch" href="/assets/js/60.71fee065.js"><link rel="prefetch" href="/assets/js/61.86cb3713.js"><link rel="prefetch" href="/assets/js/62.3ccc2745.js"><link rel="prefetch" href="/assets/js/63.7f37832d.js"><link rel="prefetch" href="/assets/js/64.fbf5c608.js"><link rel="prefetch" href="/assets/js/65.b2da7c8b.js"><link rel="prefetch" href="/assets/js/66.969a1abc.js"><link rel="prefetch" href="/assets/js/67.ecd64256.js"><link rel="prefetch" href="/assets/js/68.16b99a64.js"><link rel="prefetch" href="/assets/js/69.38117192.js"><link rel="prefetch" href="/assets/js/7.a7a745d5.js"><link rel="prefetch" href="/assets/js/70.caf9f72d.js"><link rel="prefetch" href="/assets/js/71.e64ce24a.js"><link rel="prefetch" href="/assets/js/72.9dfc7344.js"><link rel="prefetch" href="/assets/js/73.ef6a84f4.js"><link rel="prefetch" href="/assets/js/74.a751b7c0.js"><link rel="prefetch" href="/assets/js/75.a2c6c957.js"><link rel="prefetch" href="/assets/js/76.ba83a835.js"><link rel="prefetch" href="/assets/js/77.6524eeb6.js"><link rel="prefetch" href="/assets/js/78.c502106b.js"><link rel="prefetch" href="/assets/js/8.b248f5c8.js"><link rel="prefetch" href="/assets/js/9.067e129a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5f87357d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/title.png" alt="Blog" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20221108/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/zh/about-me/" class="nav-link">
  关于我
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="博客" class="dropdown-title"><span class="title">博客</span> <span class="arrow down"></span></button> <button type="button" aria-label="博客" class="mobile-dropdown-title"><span class="title">博客</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/zh/blogs/" class="nav-link router-link-active">
  所有博客
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/category/" class="nav-link">
  标签分类
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/zh/blogs/20221108/" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/Forsworns/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#background">Background</a></li><li><a href="#how-the-problem-arose">How the problem arose?</a></li><li><a href="#mimic-the-sfinae">Mimic the SFINAE!</a></li><li><a href="#is-it-perfect">Is it perfect?</a></li><li><a href="#fine-i-give-up">Fine, I give up ...</a></li><li><a href="#related-questions">Related questions</a></li><li><a href="#appendix">Appendix</a><ul><li><a href="#constraints-on-gat">Constraints on GAT</a></li><li><a href="#differences-between-tower-and-motore">Differences between Tower and Motore</a></li><li><a href="#erase-message-from-the-request-in-tonic">Erase message from the Request in Tonic</a></li></ul></li></ul></div><p></p> <h1 id="mimic-generic-specialization-in-rust"><a href="#mimic-generic-specialization-in-rust" class="header-anchor">#</a> Mimic Generic Specialization in Rust</h1> <p>Last weekend I tried to write the <a href="https://github.com/sentinel-group/sentinel-rust/" target="_blank" rel="noopener noreferrer">sentinel<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> middleware for <a href="https://github.com/hyperium/tonic/" target="_blank" rel="noopener noreferrer">tonic<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://github.com/cloudwego/volo/" target="_blank" rel="noopener noreferrer">volo<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, and struggled fighting against rustc again.</p> <h2 id="background"><a href="#background" class="header-anchor">#</a> Background</h2> <p>The tonic supports two ways to implement middleware.</p> <ul><li><a href="https://docs.rs/tower/latest/tower/trait.Service.html" target="_blank" rel="noopener noreferrer">tower service<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://docs.rs/tonic/latest/tonic/service/interceptor/index.html" target="_blank" rel="noopener noreferrer">tonic interceptor<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p>Different from tonic, volo utilizes <a href="https://docs.rs/motore/latest/motore/service/trait.Service.html" target="_blank" rel="noopener noreferrer">motore<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> as the service abstraction.</p> <h2 id="how-the-problem-arose"><a href="#how-the-problem-arose" class="header-anchor">#</a> How the problem arose?</h2> <p>I first implement the <code>tonic::Servie</code> .  Intuitively, I wrote</p> <div class="language-rust extra-class"><pre class="language-rust"><code> <span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>So what I expected is that: For tonic, whose request is in fact <code>http::Request&lt;http_body::combinators::UnsyncBoxBody&lt;bytes::Bytes, tonic::Status&gt;&gt;</code> , will be substituted in the first generic, instead of the second. In the first case, we can call methods on <code>http::Request</code> to provide a default resource extractor for <a href="https://github.com/sentinel-group/sentinel-rust/" target="_blank" rel="noopener noreferrer">sentinel<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, while in the second one, the custom resource extractor is necessary.</p> <p>I thought that there is a similar feature in rust as <strong>SFINAE</strong> in C++. The best specialization of the generic would be chosen.</p> <p>However, rustc reminded me that two implementation of trait <code>Service</code> was contradicted with each other. I realized that there was no <code>SFINAE</code> in rust!</p> <h2 id="mimic-the-sfinae"><a href="#mimic-the-sfinae" class="header-anchor">#</a> Mimic the SFINAE!</h2> <p>From <a href="https://stackoverflow.com/questions/65131776/pick-preferred-implementation-on-conflicting-trait-implementation-using-negativ" target="_blank" rel="noopener noreferrer">Pick preferred implementation on conflicting trait implementation (using negative bounds) - Stack Overflow<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, I learnt that we could use the unstable <a href="https://doc.rust-lang.org/beta/unstable-book/language-features/negative-impls.html" target="_blank" rel="noopener noreferrer">negative_impls<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://doc.rust-lang.org/nightly/unstable-book/language-features/auto-traits.html" target="_blank" rel="noopener noreferrer">auto_traits<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> feature, to do this magic</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#![cfg_attr(feature = <span class="token string">&quot;nightly&quot;</span>, feature(auto_traits, negative_impls))]</span>
<span class="token keyword">trait</span> <span class="token class-name">WithoutDefaultExtractor</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span> <span class="token operator">!</span><span class="token class-name">WithoutDefaultExtractor</span> <span class="token keyword">for</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">WithoutDefaultExtractor</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><center>ELEGANT! VERY ELEGANT!</center> <div align="center"><img src="/assets/img/Anya.0cbad49f.jpg" style="zoom:20%;"></div> <h2 id="is-it-perfect"><a href="#is-it-perfect" class="header-anchor">#</a> Is it perfect?</h2> <p>If the generic is the same, say, if we have the following code,</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">AnotherTrait</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>the above method does not work anymore. Or we can use a Higher-Rank Trait Bounds (HRTBs) and apply the similar method? I didn't try.</p> <h2 id="fine-i-give-up"><a href="#fine-i-give-up" class="header-anchor">#</a> Fine, I give up ...</h2> <p>Finally, I choose to add some feature items in my <code>Cargo.toml</code>, so that I can use the <code>#[cfg(feature=&quot;http&quot;)]</code> attribute to control the specialization by hand 😦</p> <p>Then the code becomes</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[cfg(feature = <span class="token string">&quot;http&quot;</span>)]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">B</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
<span class="token attribute attr-name">#[cfg(not(feature = <span class="token string">&quot;http&quot;</span>))]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">SentinelService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">R</span><span class="token operator">&gt;</span>
    <span class="token keyword">where</span>
        <span class="token class-name">S</span><span class="token punctuation">:</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><h2 id="related-questions"><a href="#related-questions" class="header-anchor">#</a> Related questions</h2> <p><a href="https://stackoverflow.com/questions/66832882/generics-partial-specialization-in-rust" target="_blank" rel="noopener noreferrer">Generics partial specialization in Rust - Stack Overflow<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://stackoverflow.com/questions/47675493/equivalent-of-specific-template-usage-in-c-for-rust" target="_blank" rel="noopener noreferrer">Equivalent of specific template usage in C++ for Rust - Stack Overflow<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="appendix"><a href="#appendix" class="header-anchor">#</a> Appendix</h2> <h3 id="constraints-on-gat"><a href="#constraints-on-gat" class="header-anchor">#</a> Constraints on GAT</h3> <p>During implementing the middleware, I work a lot around the GAT in <code>tower</code> and <code>motore</code>.
Generally I found there are two scenes where we may impose constraints on GAT.</p> <ul><li>impose a trait constraint on GAT</li> <li>instantiate the trait with specific GAT, <em>i.e.</em>, the equality constraint.</li></ul> <p>The first one is widely used in the source code of <code>tower</code> and <code>motore</code>, and the second one is related to a <a href="https://stackoverflow.com/questions/70531785/constraint-associated-type-of-a-generic-associated-type/74597129#74597129" target="_blank" rel="noopener noreferrer">question<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> on StackOverflow answered by me.</p> <p>Here I made a <a href="https://play.rust-lang.org/?version=nightly&amp;mode=debug&amp;edition=2021&amp;gist=d7b402b716b7c0911fe42b0984f32dd4" target="_blank" rel="noopener noreferrer">complied example<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to illustrate them.</p> <p>See how we impose constraints on GAT <code>Builder::InstanceForBuilder</code> and <code>Builder::Useless</code> and the differences between them.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// Trait definitions.</span>

<span class="token keyword">trait</span> <span class="token class-name">Builder</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">InstanceForBuilder</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token class-name">Instance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Useless</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">InstanceForBuilder</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">trait</span> <span class="token class-name">Instance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Some functions will only work when the instance has some concrete associated type.</span>
    <span class="token keyword">type</span> <span class="token class-name">InstanceProperty</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">build_with_42_for_bool_instance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">B</span><span class="token punctuation">,</span> <span class="token class-name">I</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>builder<span class="token punctuation">:</span> <span class="token class-name">B</span><span class="token punctuation">)</span>
<span class="token keyword">where</span>
    <span class="token class-name">B</span> <span class="token punctuation">:</span> <span class="token class-name">Builder</span><span class="token operator">&lt;</span><span class="token class-name">InstanceForBuilder</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;=</span><span class="token class-name">I</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token operator">&lt;</span><span class="token class-name">B</span> <span class="token keyword">as</span> <span class="token class-name">Builder</span><span class="token operator">&gt;</span><span class="token punctuation">::</span><span class="token class-name">Useless</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">:</span> <span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Debug</span><span class="token punctuation">,</span>
    <span class="token class-name">I</span> <span class="token punctuation">:</span> <span class="token class-name">Instance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token punctuation">,</span> <span class="token class-name">InstanceProperty</span><span class="token operator">=</span><span class="token keyword">bool</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token namespace">std<span class="token punctuation">::</span>fmt<span class="token punctuation">::</span></span><span class="token class-name">Debug</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Now try it out.</span>

<span class="token keyword">struct</span> <span class="token type-definition class-name">MyBuilder</span><span class="token punctuation">;</span>
<span class="token attribute attr-name">#[derive(Debug)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">MyInstance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    val<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">usize</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Builder</span> <span class="token keyword">for</span> <span class="token class-name">MyBuilder</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">InstanceForBuilder</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token class-name">MyInstance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token keyword">type</span> <span class="token class-name">Useless</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">str</span><span class="token punctuation">;</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">build</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> val<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'a</span> <span class="token keyword">usize</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">InstanceForBuilder</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyInstance</span> <span class="token punctuation">{</span> val <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token class-name">Instance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token keyword">for</span> <span class="token class-name">MyInstance</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'a</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">type</span> <span class="token class-name">InstanceProperty</span> <span class="token operator">=</span> <span class="token keyword">bool</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">fn</span> <span class="token function-definition function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> builder <span class="token operator">=</span> <span class="token class-name">MyBuilder</span><span class="token punctuation">;</span>
    <span class="token function">build_with_42_for_bool_instance</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// TODO: Doesn't work</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="differences-between-tower-and-motore"><a href="#differences-between-tower-and-motore" class="header-anchor">#</a> Differences between Tower and Motore</h3> <p>The <code>Service</code> trait in <code>motore</code> is different from that in tower. In the motore, the metadata and extension is moved to the context argument passed along the call chain, and the request is kept by another argument.</p> <p>The <code>poll_ready</code> is hided. In fact, <code>actix-web</code> shares similar opinions with <code>motore</code>, it provides <a href="https://docs.rs/actix-web/4.2.1/actix_web/dev/macro.forward_ready.html" target="_blank" rel="noopener noreferrer">actix_web::dev::forward_ready<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="https://docs.rs/actix-web/4.2.1/actix_web/dev/macro.always_ready.html" target="_blank" rel="noopener noreferrer">actix_web::dev::always_ready<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to help developers reduce boilerplate codes.</p> <h3 id="erase-message-from-the-request-in-tonic"><a href="#erase-message-from-the-request-in-tonic" class="header-anchor">#</a> Erase message from the Request in Tonic</h3> <p>In tower, the type of the message is erased in <code>tonic::service::interceptor::Interceptor</code> by the following magical code. The interceptor cannot modify the message of requests.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// tonic/tonic/src/service/interceptor.rs</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token punctuation">,</span> <span class="token class-name">ReqBody</span><span class="token punctuation">,</span> <span class="token class-name">ResBody</span><span class="token operator">&gt;</span> <span class="token class-name">Service</span><span class="token operator">&lt;</span><span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">ReqBody</span><span class="token operator">&gt;&gt;</span> <span class="token keyword">for</span> <span class="token class-name">InterceptedService</span><span class="token operator">&lt;</span><span class="token class-name">S</span><span class="token punctuation">,</span> <span class="token class-name">F</span><span class="token operator">&gt;</span>
<span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">call</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> req<span class="token punctuation">:</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token class-name">ReqBody</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Future</span> <span class="token punctuation">{</span>
        <span class="token comment">// It is bad practice to modify the body (i.e. Message) of the request via an interceptor.</span>
        <span class="token comment">// To avoid exposing the body of the request to the interceptor function, we first remove it</span>
        <span class="token comment">// here, allow the interceptor to modify the metadata and extensions, and then recreate the</span>
        <span class="token comment">// HTTP request with the body. Tonic requests do not preserve the URI, HTTP version, and</span>
        <span class="token comment">// HTTP method of the HTTP request, so we extract them here and then add them back in below.</span>
        <span class="token keyword">let</span> uri <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> version <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">version</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Request</span><span class="token punctuation">::</span><span class="token function">from_http</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> msg<span class="token punctuation">)</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">into_parts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Here the `msg` is erased from the `Request`:) </span>
        <span class="token keyword">match</span> <span class="token keyword">self</span>
            <span class="token punctuation">.</span>f
            <span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Request</span><span class="token punctuation">::</span><span class="token function">from_parts</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">into_parts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> req <span class="token operator">=</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Request</span><span class="token punctuation">::</span><span class="token function">from_parts</span><span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> extensions<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">let</span> req <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">into_http</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> method<span class="token punctuation">,</span> version<span class="token punctuation">,</span> <span class="token class-name">SanitizeHeaders</span><span class="token punctuation">::</span><span class="token class-name">No</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">ResponseFuture</span><span class="token punctuation">::</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>inner<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">ResponseFuture</span><span class="token punctuation">::</span><span class="token function">status</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div> <div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/12/28 下午12:12:57</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.8a71fa9b.js" defer></script><script src="/assets/js/1.0d3f5407.js" defer></script><script src="/assets/js/32.a4decb12.js" defer></script><script src="/assets/js/13.0b8f69bf.js" defer></script>
  </body>
</html>
